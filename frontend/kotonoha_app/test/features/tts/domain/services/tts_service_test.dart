/// TTSService ãƒ†ã‚¹ãƒˆ
///
/// TASK-0048: OSæ¨™æº–TTSé€£æºï¼ˆflutter_ttsï¼‰
/// ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: TC-048-001ã€œTC-048-015ï¼ˆæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»å¢ƒç•Œå€¤ï¼‰
///
/// ãƒ†ã‚¹ãƒˆå¯¾è±¡: lib/features/tts/domain/services/tts_service.dart
///
/// ã€TDD Redãƒ•ã‚§ãƒ¼ã‚ºã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ãŒæœªå®Ÿè£…ã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã¯ãš
library;

import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';
import 'package:kotonoha_app/features/tts/domain/services/tts_service.dart';
import 'package:kotonoha_app/features/tts/domain/models/tts_speed.dart';
import 'package:kotonoha_app/features/tts/domain/models/tts_state.dart';
import '../../../../mocks/mock_flutter_tts.dart';

void main() {
  group('TTSService', () {
    late MockFlutterTts mockFlutterTts;
    late TTSService service;

    setUpAll(() {
      // Mocktailã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã‚’ç™»éŒ²
      registerFallbackValue('');
      registerFallbackValue(0.0);
    });

    setUp(() {
      // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆãŒç‹¬ç«‹ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
      mockFlutterTts = MockFlutterTts();

      // ãƒ¢ãƒƒã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
      when(() => mockFlutterTts.setLanguage(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.setSpeechRate(any()))
          .thenAnswer((_) async => 1);
      when(() => mockFlutterTts.speak(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.stop()).thenAnswer((_) async => 1);

      service = TTSService(tts: mockFlutterTts);
    });

    // =========================================================================
    // 1. æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆåŸºæœ¬çš„ãªå‹•ä½œï¼‰
    // =========================================================================
    group('æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', () {
      /// TC-048-001: TTSServiceãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: REQ-401, AC-001
      /// æ¤œè¨¼å†…å®¹: initialize()ãŒæˆåŠŸã—ã€flutter_ttsãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-001: TTSServiceãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSService.initialize()ãŒæˆåŠŸã—ã€flutter_ttsãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: initialize()ã‚’å‘¼ã³å‡ºã—ã€æ—¥æœ¬èªï¼ˆja-JPï¼‰ã¨æ¨™æº–é€Ÿåº¦ï¼ˆ1.0ï¼‰ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸåŒ–ãŒæˆåŠŸã—ã€trueãŒè¿”ã•ã‚Œã‚‹ã€‚æ—¥æœ¬èªï¼ˆja-JPï¼‰ã¨æ¨™æº–é€Ÿåº¦ï¼ˆ1.0ï¼‰ãŒè¨­å®šã•ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.initialize()ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ119-126è¡Œç›®ï¼‰ã«åŸºã¥ã

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: initialize()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: flutter_ttsã®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        final result = await service.initialize();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸåŒ–ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: trueãŒè¿”ã•ã‚Œã€setLanguage("ja-JP")ã¨setSpeechRate(1.0)ãŒå‘¼ã°ã‚Œã‚‹
        expect(result, isTrue); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸåŒ–ãŒæˆåŠŸã—ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        verify(() => mockFlutterTts.setLanguage('ja-JP'))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: æ—¥æœ¬èªãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        verify(() => mockFlutterTts.setSpeechRate(1.0))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: æ¨™æº–é€Ÿåº¦ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-002: ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸¡ã™ã¨èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: REQ-401, AC-002
      /// æ¤œè¨¼å†…å®¹: speak(text)ã‚’å‘¼ã³å‡ºã™ã¨ã€æŒ‡å®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-002: ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸¡ã™ã¨èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSService.speak(text)ã‚’å‘¼ã³å‡ºã™ã¨ã€æŒ‡å®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: speak('ã“ã‚“ã«ã¡ã¯')ã‚’å‘¼ã³å‡ºã—ã€flutter_ttsã®speak()ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: flutter_ttsã®`speak(text)`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã€çŠ¶æ…‹ãŒ`TTSState.speaking`ã«ãªã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.speak(String text)ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ128-139è¡Œç›®ï¼‰ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: èª­ã¿ä¸Šã’ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’æº–å‚™
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
        await service.initialize();
        const testText = 'ã“ã‚“ã«ã¡ã¯';

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: æŒ‡å®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ã‚’é–‹å§‹
        await service.speak(testText);

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®speak()ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: speak('ã“ã‚“ã«ã¡ã¯')ãŒ1å›å‘¼ã°ã‚Œã€çŠ¶æ…‹ãŒspeakingã«ãªã‚‹
        verify(() => mockFlutterTts.speak(testText))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: æŒ‡å®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã§èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.state,
            TTSState.speaking); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-003: ç©ºæ–‡å­—åˆ—ã®èª­ã¿ä¸Šã’è©¦è¡Œæ™‚ã¯ä½•ã‚‚ã—ãªã„
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-3, AC-005
      /// æ¤œè¨¼å†…å®¹: ç©ºæ–‡å­—åˆ—ã‚’æ¸¡ã—ã¦speak()ã‚’å‘¼ã‚“ã å ´åˆã€èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œãšã€ã‚¨ãƒ©ãƒ¼ã‚‚ç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
      test('TC-048-003: ç©ºæ–‡å­—åˆ—ã®èª­ã¿ä¸Šã’è©¦è¡Œæ™‚ã¯ä½•ã‚‚ã—ãªã„', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ç©ºæ–‡å­—åˆ—ã‚’æ¸¡ã—ã¦speak()ã‚’å‘¼ã‚“ã å ´åˆã€èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œãšã€ã‚¨ãƒ©ãƒ¼ã‚‚ç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: speak('')ã‚’å‘¼ã³å‡ºã—ã€flutter_ttsã®speak()ãŒå‘¼ã°ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: flutter_ttsã®speak()ãŒå‘¼ã°ã‚Œãšã€çŠ¶æ…‹ãŒ`TTSState.idle`ã®ã¾ã¾ç¶­æŒã•ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.speak()ã®åˆ¶ç´„ã€ï¼ˆ133è¡Œç›®ï¼‰ã€ã€ŒEDGE-3: ç©ºæ–‡å­—åˆ—ã®èª­ã¿ä¸Šã’è©¦è¡Œã€ï¼ˆ483-489è¡Œç›®ï¼‰ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç©ºæ–‡å­—åˆ—ã‚’æº–å‚™
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã€idleçŠ¶æ…‹
        await service.initialize();

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ç©ºæ–‡å­—åˆ—ã§speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: ç©ºæ–‡å­—åˆ—ã®èª­ã¿ä¸Šã’ã‚’è©¦è¡Œ
        await service.speak('');

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®speak()ãŒå‘¼ã°ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: speak()ãŒå‘¼ã°ã‚Œãšã€çŠ¶æ…‹ãŒidleã®ã¾ã¾
        verifyNever(() =>
            mockFlutterTts.speak(any())); // ã€ç¢ºèªå†…å®¹ã€‘: speak()ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.state, TTSState.idle); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒidleã®ã¾ã¾ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-004: èª­ã¿ä¸Šã’ä¸­ã«stop()ã‚’å‘¼ã¶ã¨åœæ­¢ã™ã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: REQ-403, AC-003
      /// æ¤œè¨¼å†…å®¹: èª­ã¿ä¸Šã’ä¸­ã«stop()ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’ãŒå³åº§ã«åœæ­¢ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-004: èª­ã¿ä¸Šã’ä¸­ã«stop()ã‚’å‘¼ã¶ã¨åœæ­¢ã™ã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª­ã¿ä¸Šã’ä¸­ã«TTSService.stop()ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’ãŒå³åº§ã«åœæ­¢ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èª­ã¿ä¸Šã’é–‹å§‹å¾Œã«stop()ã‚’å‘¼ã³å‡ºã—ã€flutter_ttsã®stop()ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: flutter_ttsã®`stop()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã€çŠ¶æ…‹ãŒ`TTSState.stopped`ã«ãªã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.stop()ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ141-145è¡Œç›®ï¼‰ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: èª­ã¿ä¸Šã’ä¸­ã®çŠ¶æ…‹ã‚’ä½œã‚‹
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒèª­ã¿ä¸Šã’ä¸­ã®çŠ¶æ…‹
        await service.initialize();
        await service.speak('é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã§ã™');

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: stop()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: èª­ã¿ä¸Šã’ã‚’åœæ­¢
        await service.stop();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®stop()ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: stop()ãŒ1å›å‘¼ã°ã‚Œã€çŠ¶æ…‹ãŒstoppedã«ãªã‚‹
        verify(() => mockFlutterTts.stop())
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: stop()ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(
            service.state, TTSState.stopped); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒstoppedã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-005: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œé…ã„ã€ã«è¨­å®šã§ãã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: REQ-404, AC-004
      /// æ¤œè¨¼å†…å®¹: setSpeed(TTSSpeed.slow)ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’é€Ÿåº¦ãŒ0.7ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-005: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œé…ã„ã€ã«è¨­å®šã§ãã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSService.setSpeed(TTSSpeed.slow)ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’é€Ÿåº¦ãŒ0.7ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: setSpeed(TTSSpeed.slow)ã‚’å‘¼ã³å‡ºã—ã€flutter_ttsã®setSpeechRate(0.7)ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: flutter_ttsã®`setSpeechRate(0.7)`ãŒå‘¼ã°ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.setSpeed()ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ148-158è¡Œç›®ï¼‰ã€interfaces.dartã€ŒTTSSpeed enumã€ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
        await service.initialize();

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: setSpeed(TTSSpeed.slow)ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œé…ã„ã€ã«è¨­å®š
        await service.setSpeed(TTSSpeed.slow);

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®setSpeechRate(0.7)ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: setSpeechRate(0.7)ãŒå‘¼ã°ã‚Œã€currentSpeedãŒslowã«ãªã‚‹
        verify(() => mockFlutterTts.setSpeechRate(0.7))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: é€Ÿåº¦0.7ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.currentSpeed,
            TTSSpeed.slow); // ã€ç¢ºèªå†…å®¹ã€‘: å†…éƒ¨çŠ¶æ…‹ãŒslowã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-006: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œæ™®é€šã€ã«è¨­å®šã§ãã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: REQ-404, AC-004
      /// æ¤œè¨¼å†…å®¹: setSpeed(TTSSpeed.normal)ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’é€Ÿåº¦ãŒ1.0ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-006: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œæ™®é€šã€ã«è¨­å®šã§ãã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSService.setSpeed(TTSSpeed.normal)ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’é€Ÿåº¦ãŒ1.0ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: setSpeed(TTSSpeed.normal)ã‚’å‘¼ã³å‡ºã—ã€flutter_ttsã®setSpeechRate(1.0)ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: flutter_ttsã®`setSpeechRate(1.0)`ãŒå‘¼ã°ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.setSpeed()ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€interfaces.dartã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
        await service.initialize();

        // ãƒ¢ãƒƒã‚¯ã®å‘¼ã³å‡ºã—å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ï¼ˆinitialize()ã®å‘¼ã³å‡ºã—ã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
        clearInteractions(mockFlutterTts);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: setSpeed(TTSSpeed.normal)ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œæ™®é€šã€ã«è¨­å®š
        await service.setSpeed(TTSSpeed.normal);

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®setSpeechRate(1.0)ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: setSpeechRate(1.0)ãŒå‘¼ã°ã‚Œã€currentSpeedãŒnormalã«ãªã‚‹
        verify(() => mockFlutterTts.setSpeechRate(1.0))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: é€Ÿåº¦1.0ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.currentSpeed,
            TTSSpeed.normal); // ã€ç¢ºèªå†…å®¹ã€‘: å†…éƒ¨çŠ¶æ…‹ãŒnormalã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-007: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œé€Ÿã„ã€ã«è¨­å®šã§ãã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: REQ-404, AC-004
      /// æ¤œè¨¼å†…å®¹: setSpeed(TTSSpeed.fast)ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’é€Ÿåº¦ãŒ1.3ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-007: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œé€Ÿã„ã€ã«è¨­å®šã§ãã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSService.setSpeed(TTSSpeed.fast)ã‚’å‘¼ã¶ã¨ã€èª­ã¿ä¸Šã’é€Ÿåº¦ãŒ1.3ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: setSpeed(TTSSpeed.fast)ã‚’å‘¼ã³å‡ºã—ã€flutter_ttsã®setSpeechRate(1.3)ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: flutter_ttsã®`setSpeechRate(1.3)`ãŒå‘¼ã°ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService.setSpeed()ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€interfaces.dartã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
        await service.initialize();

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: setSpeed(TTSSpeed.fast)ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’ã€Œé€Ÿã„ã€ã«è¨­å®š
        await service.setSpeed(TTSSpeed.fast);

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®setSpeechRate(1.3)ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: setSpeechRate(1.3)ãŒå‘¼ã°ã‚Œã€currentSpeedãŒfastã«ãªã‚‹
        verify(() => mockFlutterTts.setSpeechRate(1.3))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: é€Ÿåº¦1.3ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.currentSpeed,
            TTSSpeed.fast); // ã€ç¢ºèªå†…å®¹ã€‘: å†…éƒ¨çŠ¶æ…‹ãŒfastã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-008: çŠ¶æ…‹ãŒæ­£ã—ãé·ç§»ã™ã‚‹ï¼ˆidleâ†’speakingâ†’completedï¼‰
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: AC-006
      /// æ¤œè¨¼å†…å®¹: èª­ã¿ä¸Šã’é–‹å§‹ã‹ã‚‰å®Œäº†ã¾ã§ã®çŠ¶æ…‹é·ç§»ãŒæ­£ã—ãè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-008: çŠ¶æ…‹ãŒæ­£ã—ãé·ç§»ã™ã‚‹ï¼ˆidleâ†’speakingâ†’completedï¼‰', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª­ã¿ä¸Šã’é–‹å§‹ã‹ã‚‰å®Œäº†ã¾ã§ã®çŠ¶æ…‹é·ç§»ãŒæ­£ã—ãè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: speak()ã‚’å‘¼ã³å‡ºã—ã€çŠ¶æ…‹ãŒidleâ†’speakingâ†’completedã¨é·ç§»ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: `idle` â†’ `speaking` â†’ `completed`ã®é †ã«çŠ¶æ…‹ãŒé·ç§»ã™ã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒTTSService state (TTSState)ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ168-176è¡Œç›®ï¼‰ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒidleçŠ¶æ…‹
        await service.initialize();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸçŠ¶æ…‹ãŒidleã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(service.state, TTSState.idle); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸçŠ¶æ…‹ãŒidleã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: èª­ã¿ä¸Šã’ã‚’é–‹å§‹
        await service.speak('ãƒ†ã‚¹ãƒˆ');

        // Then: ã€çµæœæ¤œè¨¼ã€‘: èª­ã¿ä¸Šã’é–‹å§‹ç›´å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
        expect(service.state,
            TTSState.speaking); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: èª­ã¿ä¸Šã’å®Œäº†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        // ã€å‡¦ç†å†…å®¹ã€‘: å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç™ºç«
        await service.onComplete();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: å®Œäº†å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
        expect(service.state,
            TTSState.completed); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒcompletedã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-009: èª­ã¿ä¸Šã’å®Œäº†å¾Œã«idleã«æˆ»ã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: AC-006
      /// æ¤œè¨¼å†…å®¹: èª­ã¿ä¸Šã’ãŒå®Œäº†ã™ã‚‹ã¨ã€çŠ¶æ…‹ãŒè‡ªå‹•çš„ã«`idle`ã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-009: èª­ã¿ä¸Šã’å®Œäº†å¾Œã«idleã«æˆ»ã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª­ã¿ä¸Šã’ãŒå®Œäº†ã™ã‚‹ã¨ã€çŠ¶æ…‹ãŒè‡ªå‹•çš„ã«`idle`ã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: èª­ã¿ä¸Šã’å®Œäº†å¾Œã€çŠ¶æ…‹ãŒè‡ªå‹•çš„ã«idleã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: `completed`çŠ¶æ…‹ã®å¾Œã€è‡ªå‹•çš„ã«`idle`ã«é·ç§»ã™ã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒçŠ¶æ…‹é·ç§»ã€ï¼ˆ168-176è¡Œç›®ï¼‰ã€dataflow.mdã€Œèª­ã¿ä¸Šã’ãƒ•ãƒ­ãƒ¼ã€ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ã—ã€èª­ã¿ä¸Šã’ã‚’é–‹å§‹
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒèª­ã¿ä¸Šã’ä¸­ã®çŠ¶æ…‹
        await service.initialize();
        await service.speak('çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆ');

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: èª­ã¿ä¸Šã’å®Œäº†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        // ã€å‡¦ç†å†…å®¹ã€‘: å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç™ºç«
        await service.onComplete();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: å®Œäº†æ™‚ã«completedã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(service.state,
            TTSState.completed); // ã€ç¢ºèªå†…å®¹ã€‘: ä¸€æ™‚çš„ã«completedã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æ™‚é–“çµŒéã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        // ã€å‡¦ç†å†…å®¹ã€‘: è‡ªå‹•çš„ã«idleã«æˆ»ã‚‹ã®ã‚’å¾…ã¤
        await Future.delayed(const Duration(milliseconds: 100));

        // Then: ã€çµæœæ¤œè¨¼ã€‘: idleã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(service.state, TTSState.idle); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒidleã«æˆ»ã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-010: è¤‡æ•°å›ã®speak()å‘¼ã³å‡ºã—ã§é€£ç¶šèª­ã¿ä¸Šã’ãŒã§ãã‚‹
      ///
      /// å„ªå…ˆåº¦: P1ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
      /// é–¢é€£è¦ä»¶: REQ-401
      /// æ¤œè¨¼å†…å®¹: èª­ã¿ä¸Šã’å®Œäº†å¾Œã€å†åº¦speak()ã‚’å‘¼ã¶ã¨æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-010: è¤‡æ•°å›ã®speak()å‘¼ã³å‡ºã—ã§é€£ç¶šèª­ã¿ä¸Šã’ãŒã§ãã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª­ã¿ä¸Šã’å®Œäº†å¾Œã€å†åº¦speak()ã‚’å‘¼ã¶ã¨æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 1å›ç›®ã®èª­ã¿ä¸Šã’å®Œäº†å¾Œã€2å›ç›®ã®speak()ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1å›ç›®ã®èª­ã¿ä¸Šã’å®Œäº†å¾Œã€2å›ç›®ã®speak()ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€Œãƒ‘ã‚¿ãƒ¼ãƒ³1: æ–‡å­—å…¥åŠ›ã‹ã‚‰ã®èª­ã¿ä¸Šã’ã€ï¼ˆ363-377è¡Œç›®ï¼‰ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒidleçŠ¶æ…‹
        await service.initialize();

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 1å›ç›®ã®speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ã‚’é–‹å§‹
        await service.speak('æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆ');
        await service.onComplete();
        await Future.delayed(const Duration(milliseconds: 100));

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 2å›ç›®ã®speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ã‚’é–‹å§‹
        await service.speak('æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆ');

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®speak()ãŒåˆè¨ˆ2å›å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: speak()ãŒ2å›å‘¼ã°ã‚Œã€ãã‚Œãã‚Œç•°ãªã‚‹ãƒ†ã‚­ã‚¹ãƒˆã§å‘¼ã°ã‚Œã‚‹
        verify(() => mockFlutterTts.speak('æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆ'))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: 1å›ç›®ã®speak()ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        verify(() => mockFlutterTts.speak('æ¬¡ã®ãƒ†ã‚­ã‚¹ãƒˆ'))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: 2å›ç›®ã®speak()ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });
    });

    // =========================================================================
    // 2. ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
    // =========================================================================
    group('ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', () {
      /// TC-048-011: TTSåˆæœŸåŒ–å¤±æ•—æ™‚ã‚‚ã‚¢ãƒ—ãƒªã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-4, AC-009, NFR-301
      /// æ¤œè¨¼å†…å®¹: flutter_ttsã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
      test('TC-048-011: TTSåˆæœŸåŒ–å¤±æ•—æ™‚ã‚‚ã‚¢ãƒ—ãƒªã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: flutter_ttsã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: setLanguage()ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹å ´åˆã€initialize()ãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸåŒ–å¤±æ•—æ™‚ã‚‚ã‚¢ãƒ—ãƒªã®åŸºæœ¬æ©Ÿèƒ½ï¼ˆæ–‡å­—ç›¤+ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºï¼‰ã¯ç¶™ç¶šå‹•ä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒEDGE-4: TTSåˆæœŸåŒ–å¤±æ•—ã€ï¼ˆ492-502è¡Œç›®ï¼‰ã€NFR-301ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: setLanguage()ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«è¨­å®š
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ¢ãƒƒã‚¯ã§ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹è¨­å®š
        when(() => mockFlutterTts.setLanguage(any()))
            .thenThrow(Exception('TTSåˆæœŸåŒ–å¤±æ•—'));

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: initialize()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: åˆæœŸåŒ–ã‚’è©¦è¡Œ
        final result = await service.initialize();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸåŒ–ãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: falseãŒè¿”ã•ã‚Œã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã‚‹
        expect(result, isFalse); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(
            service.errorMessage, isNotNull); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.errorMessage,
            contains('åˆæœŸåŒ–')); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€ŒåˆæœŸåŒ–ã€ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-012: èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¢ãƒ—ãƒªã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-004, AC-010
      /// æ¤œè¨¼å†…å®¹: èª­ã¿ä¸Šã’ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª
      test('TC-048-012: èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¢ãƒ—ãƒªã¯ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ãªã„', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: èª­ã¿ä¸Šã’ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: speak()ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹å ´åˆã€çŠ¶æ…‹ãŒerrorã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: èª­ã¿ä¸Šã’å¤±æ•—æ™‚ã‚‚ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã¯ç¶™ç¶šã—ã€å±¥æ­´ã«ä¿å­˜ã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€Œã‚¨ãƒ©ãƒ¼1: TTSèª­ã¿ä¸Šã’ä¸­ã®ã‚¨ãƒ©ãƒ¼ã€ï¼ˆ517-539è¡Œç›®ï¼‰ã€EDGE-004ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: speak()ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«è¨­å®š
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ¢ãƒƒã‚¯ã§ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹è¨­å®š
        await service.initialize();
        when(() => mockFlutterTts.speak(any())).thenThrow(Exception('èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼'));

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: èª­ã¿ä¸Šã’ã‚’è©¦è¡Œ
        await service.speak('ãƒ†ã‚¹ãƒˆ');

        // Then: ã€çµæœæ¤œè¨¼ã€‘: çŠ¶æ…‹ãŒerrorã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: çŠ¶æ…‹ãŒerrorã«ãªã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã‚‹
        expect(service.state, TTSState.error); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒerrorã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(
            service.errorMessage, isNotNull); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.errorMessage,
            contains('èª­ã¿ä¸Šã’')); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€Œèª­ã¿ä¸Šã’ã€ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-048-013: èª­ã¿ä¸Šã’ä¸­ã§ãªã„çŠ¶æ…‹ã§stop()ã‚’å‘¼ã‚“ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
      ///
      /// å„ªå…ˆåº¦: P1ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
      /// æ¤œè¨¼å†…å®¹: idleçŠ¶æ…‹ã§stop()ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã®å®‰å…¨å‡¦ç†ã‚’ç¢ºèª
      test('TC-048-013: èª­ã¿ä¸Šã’ä¸­ã§ãªã„çŠ¶æ…‹ã§stop()ã‚’å‘¼ã‚“ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: idleçŠ¶æ…‹ã§stop()ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã®å®‰å…¨å‡¦ç†ã‚’ç¢ºèª ğŸŸ¡
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: idleçŠ¶æ…‹ã§stop()ã‚’å‘¼ã³å‡ºã—ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã€çŠ¶æ…‹ã¯idleã®ã¾ã¾å¤‰åŒ–ã—ãªã„
        // ğŸŸ¡ é»„ä¿¡å·: æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆinput_buffer_provider_test.dart TC-013ï¼‰ã®å®‰å…¨å‡¦ç†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒidleçŠ¶æ…‹
        await service.initialize();

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: stop()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: idleçŠ¶æ…‹ã§stop()ã‚’å‘¼ã³å‡ºã™
        // Then: ã€çµæœæ¤œè¨¼ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œãšã€çŠ¶æ…‹ãŒidleã®ã¾ã¾
        expect(
            () => service.stop(), returnsNormally); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        expect(service.state, TTSState.idle); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒidleã®ã¾ã¾ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      });

      /// TC-048-014: åˆæœŸåŒ–å‰ã«speak()ã‚’å‘¼ã¶ã¨è‡ªå‹•åˆæœŸåŒ–ã•ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P1ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
      /// æ¤œè¨¼å†…å®¹: initialize()ã‚’å‘¼ã°ãšã«speak()ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã€è‡ªå‹•åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-048-014: åˆæœŸåŒ–å‰ã«speak()ã‚’å‘¼ã¶ã¨è‡ªå‹•åˆæœŸåŒ–ã•ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: initialize()ã‚’å‘¼ã°ãšã«speak()ã‚’å‘¼ã³å‡ºã—ãŸå ´åˆã€è‡ªå‹•åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åˆæœŸåŒ–å‰ã«speak()ã‚’å‘¼ã³å‡ºã—ã€è‡ªå‹•åˆæœŸåŒ–ã•ã‚Œã¦èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: è‡ªå‹•åˆæœŸåŒ–ãŒå®Ÿè¡Œã•ã‚Œã€æ­£å¸¸ã«èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹
        // ğŸŸ¡ é»„ä¿¡å·: NFR-301ï¼ˆåŸºæœ¬æ©Ÿèƒ½ã¯ç¶™ç¶šå‹•ä½œï¼‰ã®åŸå‰‡ã‚’é©ç”¨

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: åˆæœŸåŒ–ã›ãšã«speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: åˆæœŸåŒ–å‰ã«èª­ã¿ä¸Šã’ã‚’è©¦è¡Œï¼ˆè‡ªå‹•åˆæœŸåŒ–ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
        await service.speak('ãƒ†ã‚¹ãƒˆ');

        // Then: ã€çµæœæ¤œè¨¼ã€‘: è‡ªå‹•åˆæœŸåŒ–ãŒå®Ÿè¡Œã•ã‚Œã€èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã‚Šã€setLanguageã¨speakãŒå‘¼ã°ã‚Œã‚‹
        expect(service.state,
            TTSState.speaking); // ã€ç¢ºèªå†…å®¹ã€‘: è‡ªå‹•åˆæœŸåŒ–å¾Œã«speakingçŠ¶æ…‹ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        verify(() => mockFlutterTts.setLanguage('ja-JP'))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: è‡ªå‹•åˆæœŸåŒ–ã§æ—¥æœ¬èªãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        verify(() => mockFlutterTts.speak('ãƒ†ã‚¹ãƒˆ'))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: èª­ã¿ä¸Šã’ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      });
    });

    // =========================================================================
    // 3. å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆæœ€å°å€¤ã€æœ€å¤§å€¤ã€nullç­‰ï¼‰
    // =========================================================================
    group('å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', () {
      /// TC-048-015: 1æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæ­£å¸¸ã«èª­ã¿ä¸Šã’ã‚‰ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// æ¤œè¨¼å†…å®¹: ãƒ†ã‚­ã‚¹ãƒˆé•·ã®æœ€å°å€¤ï¼ˆ1æ–‡å­—ï¼‰ã§ã®å‹•ä½œç¢ºèª
      test('TC-048-015: 1æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæ­£å¸¸ã«èª­ã¿ä¸Šã’ã‚‰ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ†ã‚­ã‚¹ãƒˆé•·ã®æœ€å°å€¤ï¼ˆ1æ–‡å­—ï¼‰ã§ã®å‹•ä½œç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 1æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆã§èª­ã¿ä¸Šã’ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1æ–‡å­—ã§ã‚‚æ­£ã—ãèª­ã¿ä¸Šã’å‡¦ç†ãŒé–‹å§‹ã•ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: requirements.mdã€ŒåŸºæœ¬çš„ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: 1æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æº–å‚™
        // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
        await service.initialize();
        const testText = 'ã‚';

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: speak()ã‚’å‘¼ã³å‡ºã™
        // ã€å‡¦ç†å†…å®¹ã€‘: 1æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ã‚’é–‹å§‹
        await service.speak(testText);

        // Then: ã€çµæœæ¤œè¨¼ã€‘: flutter_ttsã®speak()ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…å€¤ç¢ºèªã€‘: speak('ã‚')ãŒå‘¼ã°ã‚Œã€çŠ¶æ…‹ãŒspeakingã«ãªã‚‹
        verify(() => mockFlutterTts.speak(testText))
            .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: 1æ–‡å­—ã§ã‚‚èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.state,
            TTSState.speaking); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });
    });
  });
}
