/// TTSServiceæœ€é©åŒ–ãƒ†ã‚¹ãƒˆï¼ˆRedãƒ•ã‚§ãƒ¼ã‚ºï¼‰
///
/// TASK-0090: TTSãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–
/// ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: TC-090-001ã€œTC-090-004, TC-090-009, TC-090-011, TC-090-014, TC-090-015
///
/// ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: flutter_test + mocktail
/// å¯¾è±¡: TTSServiceã€TTSNotifierã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
///
/// ã€TDD Redãƒ•ã‚§ãƒ¼ã‚ºã€‘: æœ€é©åŒ–ãƒ¡ã‚½ãƒƒãƒ‰æœªå®Ÿè£…ã®ãŸã‚ã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã¯ãš
///
/// ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«å‡¡ä¾‹:
/// - ğŸ”µ é’ä¿¡å·: è¦ä»¶å®šç¾©æ›¸ãƒ»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å®šç¾©æ›¸ã«åŸºã¥ãç¢ºå®Ÿãªãƒ†ã‚¹ãƒˆ
/// - ğŸŸ¡ é»„ä¿¡å·: è¦ä»¶å®šç¾©æ›¸ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆ
/// - ğŸ”´ èµ¤ä¿¡å·: è¦ä»¶å®šç¾©æ›¸ã«ãªã„æ¨æ¸¬ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆ
library;

import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:mocktail/mocktail.dart';
import 'package:kotonoha_app/features/tts/domain/services/tts_service.dart';
import 'package:kotonoha_app/features/tts/domain/models/tts_state.dart';
import 'package:kotonoha_app/features/tts/providers/tts_provider.dart';
import '../../../../mocks/mock_flutter_tts.dart';

void main() {
  group('TTSServiceæœ€é©åŒ–ãƒ†ã‚¹ãƒˆ - æ­£å¸¸ç³»', () {
    late MockFlutterTts mockFlutterTts;
    late TTSService service;

    setUpAll(() {
      // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: Mocktailã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã‚’ç™»éŒ²
      registerFallbackValue('');
      registerFallbackValue(0.0);
      registerFallbackValue(() {});
    });

    setUp(() {
      // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆãŒç‹¬ç«‹ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
      mockFlutterTts = MockFlutterTts();

      // ãƒ¢ãƒƒã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
      when(() => mockFlutterTts.setLanguage(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.setSpeechRate(any()))
          .thenAnswer((_) async => 1);
      when(() => mockFlutterTts.speak(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.stop()).thenAnswer((_) async => 1);

      service = TTSService(tts: mockFlutterTts);
    });

    // =========================================================================
    // TC-090-001: TTSäº‹å‰åˆæœŸåŒ–ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹
    // =========================================================================
    test('TC-090-001: TTSäº‹å‰åˆæœŸåŒ–ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œç¢ºèª', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSNotifierç”Ÿæˆæ™‚ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆæœŸåŒ–ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: TTSNotifierã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Ÿè¡Œå¾Œã€å³åº§ã«initialize()ãŒéåŒæœŸã§å‘¼ã³å‡ºã•ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: initialize()ãŒè‡ªå‹•çš„ã«1å›å‘¼ã³å‡ºã•ã‚Œã‚‹
      // ğŸ”µ é’ä¿¡å·: NFR-001ã€è¦ä»¶å®šç¾©æ›¸ã®å®Ÿè£…æ–¹é‡ã«åŸºã¥ã

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ãƒ¢ãƒƒã‚¯ã§ã®åˆæœŸåŒ–è¿½è·¡ç”¨
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: TTSNotifierã‚’ä½œæˆã—ã¦ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ã‚’é–‹å§‹

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: TTSNotifierã‚’ProviderContainerçµŒç”±ã§ä½œæˆ
      // ã€å‡¦ç†å†…å®¹ã€‘: build()ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ãŒé–‹å§‹ã•ã‚Œã‚‹ã¯ãš
      final container = ProviderContainer(
        overrides: [
          ttsProvider.overrideWith(() => TTSNotifier(
                serviceOverride: TTSService(
                  tts: mockFlutterTts,
                  onStateChanged: () {},
                ),
              )),
        ],
      );
      // Notifierã®build()ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«readã™ã‚‹
      container.read(ttsProvider);

      // ã€å¾…æ©Ÿã€‘: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤
      await Future.delayed(const Duration(milliseconds: 100));

      // Then: ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸåŒ–ãŒè‡ªå‹•çš„ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: setLanguage()ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ = åˆæœŸåŒ–ãŒå®Ÿè¡Œã•ã‚ŒãŸ
      // ğŸ”µ é’ä¿¡å·: äº‹å‰åˆæœŸåŒ–ã®ç¢ºèª
      verify(() => mockFlutterTts.setLanguage('ja-JP'))
          .called(1); // ã€ç¢ºèªå†…å®¹ã€‘: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆæœŸåŒ–ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ

      container.dispose();
    });

    // =========================================================================
    // TC-090-002: äº‹å‰åˆæœŸåŒ–å¾Œã®èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“ãŒ1ç§’ä»¥å†…
    // =========================================================================
    test('TC-090-002: TTSèª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“ã®è¨ˆæ¸¬ï¼ˆäº‹å‰åˆæœŸåŒ–æ¸ˆã¿ï¼‰', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: åˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹ã§speak()ã‚’å‘¼ã³å‡ºã—ãŸéš›ã®é–‹å§‹æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: speak()å‘¼ã³å‡ºã—ã‹ã‚‰èª­ã¿ä¸Šã’é–‹å§‹ã¾ã§1ç§’ä»¥å†…
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: speak()å‘¼ã³å‡ºã—ã‹ã‚‰èª­ã¿ä¸Šã’é–‹å§‹ã¾ã§1000msä»¥å†…
      // ğŸ”µ é’ä¿¡å·: NFR-001ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’äº‹å‰ã«åˆæœŸåŒ–
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: TTSServiceãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
      await service.initialize();
      const testText = 'ã“ã‚“ã«ã¡ã¯';

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: speak()ã‚’å‘¼ã³å‡ºã—ã¦æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€å‡¦ç†å†…å®¹ã€‘: Stopwatchã§èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“ã‚’è¨ˆæ¸¬
      final stopwatch = Stopwatch()..start();
      await service.speak(testText);
      stopwatch.stop();

      // Then: ã€çµæœæ¤œè¨¼ã€‘: 1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: çµŒéæ™‚é–“ãŒ1000msä»¥å†…
      expect(
        stopwatch.elapsedMilliseconds,
        lessThanOrEqualTo(1000),
      ); // ã€ç¢ºèªå†…å®¹ã€‘: èª­ã¿ä¸Šã’é–‹å§‹ã¾ã§1ç§’ä»¥å†… ğŸ”µ

      expect(
        service.state,
        TTSState.speaking,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ã¦ã„ã‚‹ã“ã¨ ğŸ”µ
    });

    // =========================================================================
    // TC-090-003: åˆæœŸåŒ–å‰ã§ã‚‚èª­ã¿ä¸Šã’ãŒ1ç§’ä»¥å†…ã«é–‹å§‹ã•ã‚Œã‚‹
    // =========================================================================
    test('TC-090-003: TTSè‡ªå‹•åˆæœŸåŒ–è¾¼ã¿ã®èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“è¨ˆæ¸¬', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: æœªåˆæœŸåŒ–çŠ¶æ…‹ã‹ã‚‰speak()ã‚’å‘¼ã³å‡ºã—ãŸéš›ã®ãƒˆãƒ¼ã‚¿ãƒ«æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: è‡ªå‹•åˆæœŸåŒ–ã‚’å«ã‚ã¦ã‚‚1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’é–‹å§‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: è‡ªå‹•åˆæœŸåŒ–ã‚’å«ã‚ã¦ã‚‚1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’é–‹å§‹
      // ğŸŸ¡ é»„ä¿¡å·: NFR-001ã‹ã‚‰æ¨æ¸¬ã€å®Ÿéš›ã®OSä¾å­˜æ€§ã‚ã‚Š

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: æœªåˆæœŸåŒ–ã®TTSService
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: initialize()ã‚’å‘¼ã°ãªã„çŠ¶æ…‹
      const testText = 'ãƒ†ã‚¹ãƒˆ';

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: æœªåˆæœŸåŒ–çŠ¶æ…‹ã‹ã‚‰speak()ã‚’å‘¼ã³å‡ºã—ã¦æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€å‡¦ç†å†…å®¹ã€‘: è‡ªå‹•åˆæœŸåŒ–ã‚’å«ã‚€ãƒˆãƒ¼ã‚¿ãƒ«æ™‚é–“ã‚’è¨ˆæ¸¬
      final stopwatch = Stopwatch()..start();
      await service.speak(testText);
      stopwatch.stop();

      // Then: ã€çµæœæ¤œè¨¼ã€‘: è‡ªå‹•åˆæœŸåŒ–è¾¼ã¿ã§1ç§’ä»¥å†…ã«é–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: è‡ªå‹•åˆæœŸåŒ–ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’å«ã‚ã¦ã‚‚1ç§’ä»¥å†…
      expect(
        stopwatch.elapsedMilliseconds,
        lessThanOrEqualTo(1000),
      ); // ã€ç¢ºèªå†…å®¹ã€‘: è‡ªå‹•åˆæœŸåŒ–è¾¼ã¿ã§1ç§’ä»¥å†… ğŸŸ¡

      expect(
        service.state,
        TTSState.speaking,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ã¦ã„ã‚‹ã“ã¨ ğŸŸ¡
    });

    // =========================================================================
    // TC-090-004: é€£ç¶šèª­ã¿ä¸Šã’ã§2å›ç›®ä»¥é™ã¯å³åº§ã«é–‹å§‹ã•ã‚Œã‚‹
    // =========================================================================
    test('TC-090-004: é€£ç¶šèª­ã¿ä¸Šã’ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: 2å›ç›®ä»¥é™ã®speak()å‘¼ã³å‡ºã—æ™‚ã®é–‹å§‹æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åˆæœŸåŒ–æ¸ˆã¿ã®ãŸã‚å³åº§ã«èª­ã¿ä¸Šã’é–‹å§‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 2å›ç›®ã¯100msä»¥å†…ã«é–‹å§‹
      // ğŸŸ¡ é»„ä¿¡å·: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®æœŸå¾…å€¤

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ã—ã¦1å›ç›®ã®èª­ã¿ä¸Šã’ã‚’å®Ÿè¡Œ
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: 1å›ç›®ã®èª­ã¿ä¸Šã’ãŒå®Œäº†ã—ãŸçŠ¶æ…‹
      await service.initialize();
      await service.speak('æœ€åˆ');
      await service.onComplete();
      await Future.delayed(const Duration(milliseconds: 150));

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 2å›ç›®ã®speak()ã‚’å‘¼ã³å‡ºã—ã¦æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€å‡¦ç†å†…å®¹ã€‘: åˆæœŸåŒ–æ¸ˆã¿çŠ¶æ…‹ã§ã®2å›ç›®ã®èª­ã¿ä¸Šã’
      final stopwatch = Stopwatch()..start();
      await service.speak('æ¬¡');
      stopwatch.stop();

      // Then: ã€çµæœæ¤œè¨¼ã€‘: 2å›ç›®ã¯100msä»¥å†…ã«é–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: åˆæœŸåŒ–æ¸ˆã¿ã®ãŸã‚ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãªã—
      expect(
        stopwatch.elapsedMilliseconds,
        lessThanOrEqualTo(100),
      ); // ã€ç¢ºèªå†…å®¹ã€‘: 2å›ç›®ã¯100msä»¥å†…ã«é–‹å§‹ ğŸŸ¡

      expect(
        service.state,
        TTSState.speaking,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ã¦ã„ã‚‹ã“ã¨ ğŸŸ¡
    });
  });

  group('TTSServiceæœ€é©åŒ–ãƒ†ã‚¹ãƒˆ - ç•°å¸¸ç³»', () {
    late MockFlutterTts mockFlutterTts;
    late TTSService service;

    setUpAll(() {
      registerFallbackValue('');
      registerFallbackValue(0.0);
      registerFallbackValue(() {});
    });

    setUp(() {
      mockFlutterTts = MockFlutterTts();
      when(() => mockFlutterTts.setLanguage(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.setSpeechRate(any()))
          .thenAnswer((_) async => 1);
      when(() => mockFlutterTts.speak(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.stop()).thenAnswer((_) async => 1);
      service = TTSService(tts: mockFlutterTts);
    });

    // =========================================================================
    // TC-090-009: TTSåˆæœŸåŒ–å¤±æ•—æ™‚ã‚‚èª­ã¿ä¸Šã’ãŒå®‰å…¨ã«å¤±æ•—ã™ã‚‹
    // =========================================================================
    test('TC-090-009: TTSåˆæœŸåŒ–å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åˆæœŸåŒ–å¤±æ•—æ™‚ã«state=errorã€errorMessageãŒè¨­å®šã•ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ã‚¢ãƒ—ãƒªã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’é˜²ãã€åŸºæœ¬æ©Ÿèƒ½ã‚’ç¶™ç¶š
      // ğŸ”µ é’ä¿¡å·: NFR-301ã€æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆTC-048-011ï¼‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: setLanguage()ãŒExceptionã‚’ã‚¹ãƒ­ãƒ¼
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ¢ãƒƒã‚¯ã§ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
      when(() => mockFlutterTts.setLanguage(any()))
          .thenThrow(Exception('TTSåˆæœŸåŒ–å¤±æ•—'));

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: initialize()ã‚’å‘¼ã³å‡ºã™
      // ã€å‡¦ç†å†…å®¹ã€‘: åˆæœŸåŒ–ã‚’è©¦è¡Œ
      final result = await service.initialize();

      // Then: ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸåŒ–ãŒå¤±æ•—ã—ã€ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: falseãŒè¿”ã•ã‚Œã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚Œã‚‹
      expect(result, isFalse); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      expect(
        service.errorMessage,
        isNotNull,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      expect(
        service.errorMessage,
        contains('åˆæœŸåŒ–'),
      ); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã€ŒåˆæœŸåŒ–ã€ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
    });

    // =========================================================================
    // TC-090-011: åˆæœŸåŒ–æœªå®Œäº†æ™‚ã®speak()å‘¼ã³å‡ºã—ã¯å¾…æ©Ÿå¾Œã«å®Ÿè¡Œ
    // =========================================================================
    test('TC-090-011: åˆæœŸåŒ–ä¸­ã®speak()å‘¼ã³å‡ºã—å‡¦ç†', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: åˆæœŸåŒ–å‡¦ç†ä¸­ã«speak()ãŒå‘¼ã°ã‚ŒãŸå ´åˆã®ç«¶åˆçŠ¶æ…‹é˜²æ­¢ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: åˆæœŸåŒ–ä¸­ã«speak()ã‚’å‘¼ã³å‡ºã—ã€ç«¶åˆãªãæ­£å¸¸å‡¦ç†ã•ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸåŒ–å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰èª­ã¿ä¸Šã’é–‹å§‹
      // ğŸŸ¡ é»„ä¿¡å·: å®Ÿè£…ä¸Šã®è€ƒæ…®äº‹é …

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: åˆæœŸåŒ–ã«æ™‚é–“ãŒã‹ã‹ã‚‹çŠ¶æ³ã‚’æ¨¡æ“¬
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: setLanguage()ã‚’é…å»¶ã•ã›ã‚‹
      when(() => mockFlutterTts.setLanguage(any())).thenAnswer((_) async {
        await Future.delayed(const Duration(milliseconds: 50));
        return 1;
      });

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: åˆæœŸåŒ–é–‹å§‹ç›´å¾Œã«speak()ã‚’å‘¼ã³å‡ºã™
      // ã€å‡¦ç†å†…å®¹ã€‘: ä¸¦è¡Œã—ã¦åˆæœŸåŒ–ã¨speak()ã‚’å®Ÿè¡Œ

      // åˆæœŸåŒ–ã‚’é–‹å§‹ï¼ˆå®Œäº†ã‚’å¾…ãŸãªã„ï¼‰
      final initFuture = service.initialize();

      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰speak()ã‚’å‘¼ã³å‡ºã™
      await Future.delayed(const Duration(milliseconds: 10));
      await service.speak('ãƒ†ã‚¹ãƒˆ');

      // åˆæœŸåŒ–ã®å®Œäº†ã‚’å¾…ã¤
      await initFuture;

      // Then: ã€çµæœæ¤œè¨¼ã€‘: ç«¶åˆçŠ¶æ…‹ãªãæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã‚Šã€èª­ã¿ä¸Šã’ãŒå®Ÿè¡Œã•ã‚Œã‚‹
      expect(
        service.state,
        TTSState.speaking,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: æ­£å¸¸ã«èª­ã¿ä¸Šã’çŠ¶æ…‹ã«ãªã‚‹ã“ã¨ ğŸŸ¡

      verify(
        () => mockFlutterTts.speak('ãƒ†ã‚¹ãƒˆ'),
      ).called(1); // ã€ç¢ºèªå†…å®¹ã€‘: speak()ãŒ1å›å‘¼ã°ã‚Œã‚‹ã“ã¨ ğŸŸ¡
    });
  });

  group('TTSServiceæœ€é©åŒ–ãƒ†ã‚¹ãƒˆ - å¢ƒç•Œå€¤', () {
    late MockFlutterTts mockFlutterTts;
    late TTSService service;

    setUpAll(() {
      registerFallbackValue('');
      registerFallbackValue(0.0);
      registerFallbackValue(() {});
    });

    setUp(() {
      mockFlutterTts = MockFlutterTts();
      when(() => mockFlutterTts.setLanguage(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.setSpeechRate(any()))
          .thenAnswer((_) async => 1);
      when(() => mockFlutterTts.speak(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.stop()).thenAnswer((_) async => 1);
      service = TTSService(tts: mockFlutterTts);
    });

    // =========================================================================
    // TC-090-014: 1æ–‡å­—ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“
    // =========================================================================
    test('TC-090-014: æœ€å°ãƒ†ã‚­ã‚¹ãƒˆã§ã®èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ†ã‚­ã‚¹ãƒˆæœ€å°å€¤ï¼ˆ1æ–‡å­—ï¼‰ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: 1æ–‡å­—ã§ã‚‚æ­£å¸¸ã«1ç§’ä»¥å†…ã«å‡¦ç†ã•ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’é–‹å§‹
      // ğŸ”µ é’ä¿¡å·: æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆTC-048-015ï¼‰

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: 1æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆ
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
      await service.initialize();
      const testText = 'ã‚';

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 1æ–‡å­—ãƒ†ã‚­ã‚¹ãƒˆã§èª­ã¿ä¸Šã’æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€å‡¦ç†å†…å®¹ã€‘: çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
      final stopwatch = Stopwatch()..start();
      await service.speak(testText);
      stopwatch.stop();

      // Then: ã€çµæœæ¤œè¨¼ã€‘: 1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã§ã‚‚é…å»¶ãªã—
      expect(
        stopwatch.elapsedMilliseconds,
        lessThanOrEqualTo(1000),
      ); // ã€ç¢ºèªå†…å®¹ã€‘: 1æ–‡å­—ã§ã‚‚1ç§’ä»¥å†… ğŸ”µ

      expect(
        service.state,
        TTSState.speaking,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ã¦ã„ã‚‹ã“ã¨ ğŸ”µ
    });

    // =========================================================================
    // TC-090-015: 1000æ–‡å­—ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“
    // =========================================================================
    test('TC-090-015: æœ€å¤§ãƒ†ã‚­ã‚¹ãƒˆã§ã®èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ†ã‚­ã‚¹ãƒˆæœ€å¤§å€¤ï¼ˆ1000æ–‡å­—ï¼‰ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: é•·æ–‡ã§ã‚‚1ç§’ä»¥å†…ã«é–‹å§‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’é–‹å§‹
      // ğŸ”µ é’ä¿¡å·: EDGE-101å¯¾å¿œ

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: 1000æ–‡å­—ã®ãƒ†ã‚­ã‚¹ãƒˆ
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆæœŸåŒ–æ¸ˆã¿ã®çŠ¶æ…‹
      await service.initialize();
      final testText = 'ã‚' * 1000;

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: 1000æ–‡å­—ãƒ†ã‚­ã‚¹ãƒˆã§èª­ã¿ä¸Šã’æ™‚é–“ã‚’è¨ˆæ¸¬
      // ã€å‡¦ç†å†…å®¹ã€‘: é•·æ–‡ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼
      final stopwatch = Stopwatch()..start();
      await service.speak(testText);
      stopwatch.stop();

      // Then: ã€çµæœæ¤œè¨¼ã€‘: 1ç§’ä»¥å†…ã«èª­ã¿ä¸Šã’ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: é•·æ–‡ã§ã‚‚çŸ­ã„ãƒ†ã‚­ã‚¹ãƒˆã¨åŒç­‰ã®é–‹å§‹æ™‚é–“
      expect(
        stopwatch.elapsedMilliseconds,
        lessThanOrEqualTo(1000),
      ); // ã€ç¢ºèªå†…å®¹ã€‘: 1000æ–‡å­—ã§ã‚‚1ç§’ä»¥å†… ğŸ”µ

      expect(
        service.state,
        TTSState.speaking,
      ); // ã€ç¢ºèªå†…å®¹ã€‘: çŠ¶æ…‹ãŒspeakingã«ãªã£ã¦ã„ã‚‹ã“ã¨ ğŸ”µ
    });
  });

  group('TTSNotifieræœ€é©åŒ–ãƒ†ã‚¹ãƒˆ - äº‹å‰åˆæœŸåŒ–', () {
    late MockFlutterTts mockFlutterTts;

    setUpAll(() {
      registerFallbackValue('');
      registerFallbackValue(0.0);
      registerFallbackValue(() {});
    });

    setUp(() {
      mockFlutterTts = MockFlutterTts();
      when(() => mockFlutterTts.setLanguage(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.setSpeechRate(any()))
          .thenAnswer((_) async => 1);
      when(() => mockFlutterTts.speak(any())).thenAnswer((_) async => 1);
      when(() => mockFlutterTts.stop()).thenAnswer((_) async => 1);
    });

    // =========================================================================
    // TC-090-001a: TTSNotifierç”Ÿæˆæ™‚ã«initialize()ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
    // =========================================================================
    test('TC-090-001a: TTSNotifierç”Ÿæˆæ™‚ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ãŒé–‹å§‹ã•ã‚Œã‚‹', () async {
      // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: TTSNotifierã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ãŒé–‹å§‹ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: Future.microtask()ã§åˆæœŸåŒ–ãŒéåŒæœŸå®Ÿè¡Œã•ã‚Œã‚‹
      // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: Notifierç”Ÿæˆå¾Œã€å³åº§ã«ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆæœŸåŒ–é–‹å§‹
      // ğŸ”µ é’ä¿¡å·: è¦ä»¶å®šç¾©æ›¸ã®å®Ÿè£…æ–¹é‡ï¼ˆ6.1ç¯€ï¼‰

      // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: åˆæœŸåŒ–è¿½è·¡ç”¨ã®ãƒ¢ãƒƒã‚¯è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: ãƒ¢ãƒƒã‚¯ãŒè¨­å®šæ¸ˆã¿

      // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: TTSNotifierã‚’ProviderContainerçµŒç”±ã§ç”Ÿæˆ
      // ã€å‡¦ç†å†…å®¹ã€‘: build()ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ãŒé–‹å§‹ã•ã‚Œã‚‹ã¯ãš
      final service = TTSService(
        tts: mockFlutterTts,
        onStateChanged: () {},
      );
      final container = ProviderContainer(
        overrides: [
          ttsProvider.overrideWith(() => TTSNotifier(serviceOverride: service)),
        ],
      );
      container.read(ttsProvider);

      // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ãŒå®Œäº†ã™ã‚‹ã®ã‚’å¾…ã¤
      await Future.delayed(const Duration(milliseconds: 200));

      // Then: ã€çµæœæ¤œè¨¼ã€‘: åˆæœŸåŒ–ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: setLanguage()ã¨setSpeechRate()ãŒå‘¼ã°ã‚Œã‚‹
      verify(
        () => mockFlutterTts.setLanguage('ja-JP'),
      ).called(1); // ã€ç¢ºèªå†…å®¹ã€‘: è¨€èªè¨­å®šãŒå®Ÿè¡Œã•ã‚ŒãŸ ğŸ”µ

      verify(
        () => mockFlutterTts.setSpeechRate(1.0),
      ).called(1); // ã€ç¢ºèªå†…å®¹ã€‘: é€Ÿåº¦è¨­å®šãŒå®Ÿè¡Œã•ã‚ŒãŸ ğŸ”µ

      container.dispose();
    });
  });
}
