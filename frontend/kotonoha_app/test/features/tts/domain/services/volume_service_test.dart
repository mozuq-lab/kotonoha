/// VolumeService ãƒ†ã‚¹ãƒˆ
///
/// TASK-0051: OSéŸ³é‡0ã®è­¦å‘Šè¡¨ç¤º
/// ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹: TC-051-001ã€œTC-051-014ï¼ˆæ­£å¸¸ç³»ãƒ»ç•°å¸¸ç³»ãƒ»å¢ƒç•Œå€¤ï¼‰
///
/// ãƒ†ã‚¹ãƒˆå¯¾è±¡: lib/features/tts/domain/services/volume_service.dart
///
/// ã€TDD Redãƒ•ã‚§ãƒ¼ã‚ºã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ãŒæœªå®Ÿè£…ã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹ã¯ãš
library;

import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';
import 'package:kotonoha_app/features/tts/domain/services/volume_service.dart';
import '../../../../mocks/mock_volume_controller.dart';

void main() {
  group('VolumeService', () {
    late MockVolumeController mockVolumeController;
    late VolumeService service;

    setUpAll(() {
      // Mocktailã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ã‚’ç™»éŒ²
      registerFallbackValue(0.0);
    });

    setUp(() {
      // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆãŒç‹¬ç«‹ã—ã¦å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã‹ã‚‰é–‹å§‹
      // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
      mockVolumeController = MockVolumeController();

      // ãƒ¢ãƒƒã‚¯ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨­å®š
      when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.5);
      when(() => mockVolumeController.getMute()).thenAnswer((_) async => false);

      service = VolumeService(volumeController: mockVolumeController);
    });

    // =========================================================================
    // 1. æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆåŸºæœ¬çš„ãªå‹•ä½œï¼‰
    // =========================================================================
    group('æ­£å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', () {
      /// TC-051-001: VolumeServiceãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: VolumeServiceãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      test('TC-051-001: VolumeServiceãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: VolumeServiceãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: VolumeServiceã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: åˆæœŸåŒ–ãŒæˆåŠŸã—ã€ã‚µãƒ¼ãƒ“ã‚¹ãŒä½¿ç”¨å¯èƒ½ãªçŠ¶æ…‹ã«ãªã‚‹
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.md ã«åŸºã¥ã

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ã‚µãƒ¼ãƒ“ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºèª
        // Then: ã€çµæœæ¤œè¨¼ã€‘: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(service, isNotNull); // ã€ç¢ºèªå†…å®¹ã€‘: ã‚µãƒ¼ãƒ“ã‚¹ãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
        expect(service.isInitialized, isTrue); // ã€ç¢ºèªå†…å®¹ã€‘: åˆæœŸåŒ–æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-002: éŸ³é‡50%ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: éŸ³é‡ãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      test('TC-051-002: éŸ³é‡50%ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: éŸ³é‡ãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: éŸ³é‡0.5ã®çŠ¶æ…‹ã§isVolumeZeroã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: isVolumeZero = false
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€Œå‡ºåŠ›å€¤ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: éŸ³é‡0.5ã‚’è¿”ã™ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.5);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’ç¢ºèª
        final result = await service.isVolumeZero();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, isFalse); // ã€ç¢ºèªå†…å®¹ã€‘: isVolumeZeroãŒfalseã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-003: éŸ³é‡0%ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: éŸ³é‡ãŒ0ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      test('TC-051-003: éŸ³é‡0%ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: éŸ³é‡ãŒ0ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: éŸ³é‡0.0ã®çŠ¶æ…‹ã§isVolumeZeroã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: isVolumeZero = true
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€Œå‡ºåŠ›å€¤ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: éŸ³é‡0.0ã‚’è¿”ã™ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.0);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’ç¢ºèª
        final result = await service.isVolumeZero();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: trueãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, isTrue); // ã€ç¢ºèªå†…å®¹ã€‘: isVolumeZeroãŒtrueã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-004: getCurrentVolumeã§ç¾åœ¨ã®éŸ³é‡ã‚’å–å¾—ã§ãã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: getCurrentVolumeãŒæ­£ã—ã„éŸ³é‡å€¤ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
      test('TC-051-004: getCurrentVolumeã§ç¾åœ¨ã®éŸ³é‡ã‚’å–å¾—ã§ãã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: getCurrentVolumeãŒæ­£ã—ã„éŸ³é‡å€¤ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: éŸ³é‡0.75ã®çŠ¶æ…‹ã§getCurrentVolumeã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: currentVolume = 0.75
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€Œå‡ºåŠ›å€¤ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: éŸ³é‡0.75ã‚’è¿”ã™ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.75);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: getCurrentVolumeã‚’å‘¼ã³å‡ºã™
        final result = await service.getCurrentVolume();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: 0.75ãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, 0.75); // ã€ç¢ºèªå†…å®¹ã€‘: éŸ³é‡0.75ãŒå–å¾—ã§ããŸã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });
    });

    // =========================================================================
    // 2. ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
    // =========================================================================
    group('ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', () {
      /// TC-051-009: éŸ³é‡å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã€ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: ERROR-2, NFR-301
      /// æ¤œè¨¼å†…å®¹: volume_controllerã®getVolume()ãŒå¤±æ•—ã—ãŸå ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      test('TC-051-009: éŸ³é‡å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã€ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: volume_controllerã®å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: getVolume()ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹å ´åˆã€ã‚µãƒ¼ãƒ“ã‚¹ãŒé©åˆ‡ã«å‡¦ç†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: VolumeServiceExceptionãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¿”ã•ã‚Œã‚‹
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€ŒERROR-2ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: getVolume()ãŒä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume())
            .thenThrow(Exception('éŸ³é‡å–å¾—ã«å¤±æ•—'));

        // When/Then: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œãƒ»çµæœæ¤œè¨¼ã€‘: ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(
          () => service.getCurrentVolume(),
          throwsA(isA<VolumeServiceException>()),
        ); // ã€ç¢ºèªå†…å®¹ã€‘: é©åˆ‡ãªä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-010: Webç’°å¢ƒã§ã¯éŸ³é‡å–å¾—ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹
      ///
      /// å„ªå…ˆåº¦: P1ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-2
      /// æ¤œè¨¼å†…å®¹: Webç’°å¢ƒã§ã®éŸ³é‡å–å¾—åˆ¶é™ã¸ã®å¯¾å¿œ
      test('TC-051-010: Webç’°å¢ƒã§ã¯éŸ³é‡å–å¾—ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: Webç’°å¢ƒã§ã®éŸ³é‡å–å¾—åˆ¶é™ã¸ã®å¯¾å¿œã‚’ç¢ºèª ğŸŸ¡
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: isSupported()ãŒfalseã‚’è¿”ã™å ´åˆã€isVolumeZeroãŒå¸¸ã«falseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: isVolumeZero = falseï¼ˆè­¦å‘Šæ©Ÿèƒ½ç„¡åŠ¹åŒ–ï¼‰
        // ğŸŸ¡ é»„ä¿¡å·: volume-warning-requirements.mdã€ŒEDGE-2ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: Webç’°å¢ƒã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        final webService = VolumeService(
          volumeController: mockVolumeController,
          isSupported: false,
        );

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’å‘¼ã³å‡ºã™
        final result = await webService.isVolumeZero();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, isFalse); // ã€ç¢ºèªå†…å®¹ã€‘: Webç’°å¢ƒã§ã¯å¸¸ã«falseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      });
    });

    // =========================================================================
    // 3. å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆæœ€å°å€¤ã€æœ€å¤§å€¤ï¼‰
    // =========================================================================
    group('å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹', () {
      /// TC-051-011: éŸ³é‡0.0ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: éŸ³é‡ã®æœ€å°å€¤ï¼ˆ0.0ï¼‰ã§ã®å‹•ä½œç¢ºèª
      test('TC-051-011: éŸ³é‡0.0ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: éŸ³é‡ã®æœ€å°å€¤ï¼ˆ0.0ï¼‰ã§ã®å‹•ä½œç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: éŸ³é‡ãŒå®Œå…¨ã«0ã®å ´åˆã€isVolumeZeroãŒtrueã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: isVolumeZero = true
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€Œå‡ºåŠ›å€¤ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: éŸ³é‡0.0ã‚’è¿”ã™ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.0);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’å‘¼ã³å‡ºã™
        final result = await service.isVolumeZero();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: trueãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, isTrue); // ã€ç¢ºèªå†…å®¹ã€‘: éŸ³é‡0.0ã§trueãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-012: éŸ³é‡0.01ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰
      ///
      /// å„ªå…ˆåº¦: P0ï¼ˆå¿…é ˆï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: éŸ³é‡ãŒ0ã‚’åƒ…ã‹ã«è¶…ãˆãŸå ´åˆã®å‹•ä½œç¢ºèª
      test('TC-051-012: éŸ³é‡0.01ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: éŸ³é‡ãŒ0ã‚’åƒ…ã‹ã«è¶…ãˆãŸå ´åˆã®å‹•ä½œç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: éŸ³é‡ãŒ0.01ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: isVolumeZero = false
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€Œå‡ºåŠ›å€¤ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: éŸ³é‡0.01ã‚’è¿”ã™ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.01);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’å‘¼ã³å‡ºã™
        final result = await service.isVolumeZero();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, isFalse); // ã€ç¢ºèªå†…å®¹ã€‘: éŸ³é‡0.01ã§falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-013: éŸ³é‡1.0ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰
      ///
      /// å„ªå…ˆåº¦: P1ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
      /// é–¢é€£è¦ä»¶: EDGE-202
      /// æ¤œè¨¼å†…å®¹: éŸ³é‡ã®æœ€å¤§å€¤ï¼ˆ1.0ï¼‰ã§ã®å‹•ä½œç¢ºèª
      test('TC-051-013: éŸ³é‡1.0ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ï¼ˆå¢ƒç•Œå€¤ï¼‰', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: éŸ³é‡ã®æœ€å¤§å€¤ï¼ˆ1.0ï¼‰ã§ã®å‹•ä½œç¢ºèª ğŸ”µ
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: éŸ³é‡ãŒæœ€å¤§ï¼ˆ1.0ï¼‰ã®å ´åˆã€isVolumeZeroãŒfalseã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèª
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: isVolumeZero = false
        // ğŸ”µ é’ä¿¡å·: volume-warning-requirements.mdã€Œå‡ºåŠ›å€¤ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: éŸ³é‡1.0ã‚’è¿”ã™ã‚ˆã†ã«è¨­å®š
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 1.0);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’å‘¼ã³å‡ºã™
        final result = await service.isVolumeZero();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(result, isFalse); // ã€ç¢ºèªå†…å®¹ã€‘: éŸ³é‡1.0ã§falseãŒè¿”ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª ğŸ”µ
      });

      /// TC-051-014: éŸ³é‡ãƒã‚§ãƒƒã‚¯ãŒ100msä»¥å†…ã«å®Œäº†ã™ã‚‹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰
      ///
      /// å„ªå…ˆåº¦: P1ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰
      /// é–¢é€£è¦ä»¶: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶
      /// æ¤œè¨¼å†…å®¹: éŸ³é‡ãƒã‚§ãƒƒã‚¯ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª
      test('TC-051-014: éŸ³é‡ãƒã‚§ãƒƒã‚¯ãŒ100msä»¥å†…ã«å®Œäº†ã™ã‚‹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼‰', () async {
        // ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: éŸ³é‡ãƒã‚§ãƒƒã‚¯ãŒ100msä»¥å†…ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
        // ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: isVolumeZero()ã®å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬
        // ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: 100msä»¥å†…ã«å®Œäº†
        // ğŸŸ¡ é»„ä¿¡å·: volume-warning-requirements.mdã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åŸºã¥ã

        // Given: ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ãƒ¢ãƒƒã‚¯ã¯å³åº§ã«å¿œç­”
        when(() => mockVolumeController.getVolume()).thenAnswer((_) async => 0.5);

        // When: ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: isVolumeZeroã‚’å‘¼ã³å‡ºã—ã€å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆæ¸¬
        final stopwatch = Stopwatch()..start();
        await service.isVolumeZero();
        stopwatch.stop();

        // Then: ã€çµæœæ¤œè¨¼ã€‘: 100msä»¥å†…ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        expect(
          stopwatch.elapsedMilliseconds,
          lessThan(100),
        ); // ã€ç¢ºèªå†…å®¹ã€‘: 100msä»¥å†…ã«å®Œäº†ã™ã‚‹ã“ã¨ã‚’ç¢ºèª ğŸŸ¡
      });
    });
  });
}
