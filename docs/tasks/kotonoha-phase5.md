# Phase 5: 統合・テスト・リリース準備

## 要件名

**kotonoha** - 文字盤コミュニケーション支援アプリ

## フェーズ概要

- **期間**: Week 17-20 (20営業日)
- **目標**: E2Eテスト、パフォーマンス最適化、モバイルビルド、リリース準備
- **成果物**: リリース可能なアプリ（iOS/Android/Web）
- **総タスク数**: 20タスク
- **総工数**: 160時間
- **信頼性レベル**: 🟡 黄信号（テスト戦略は要件定義書から推測、E2Eシナリオは具体的に記載なし）

## 🟡 信頼性レベルについて

このフェーズのタスクは、EARS要件定義書の非機能要件（NFR-001〜NFR-504）およびテスト戦略（NFR-501, NFR-502）に基づいていますが、具体的なE2Eシナリオやビルド設定の詳細は推測を含みます。パフォーマンス要件（NFR-001, NFR-002, NFR-003）は明確に記載されています。

## 週次計画

### Week 17: E2Eテスト・品質確認

- **目標**: 全機能のE2Eテスト、品質確認
- **成果物**: E2Eテストスイート、品質レポート

### Week 18: パフォーマンス最適化

- **目標**: パフォーマンス計測・最適化
- **成果物**: パフォーマンス要件達成（100ms応答、1秒TTS開始）

### Week 19: モバイルビルド・デプロイ設定

- **目標**: iOS/Androidビルド設定、CI/CD構築
- **成果物**: TestFlight/Google Play Console配布可能ビルド

### Week 20: ドキュメント整備・リリース準備

- **目標**: ユーザードキュメント、最終確認
- **成果物**: リリース準備完了

---

## 日次タスク

### Week 17: E2Eテスト・品質確認

#### Day 1: TASK-0081 - E2Eテスト環境構築

- [x] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: NFR-501, NFR-502
- **依存タスク**: すべてのPhase 4タスク

**実装詳細**:

1. integration_testパッケージ設定
2. E2Eテスト用のテストドライバー作成
3. モックサーバー設定（AI変換API用）
4. テストデータの準備（定型文、履歴サンプル）
5. CI環境でのE2Eテスト実行設定

**完了条件**:

- E2Eテスト環境が構築される
- integration_testが正常に実行できる
- モックサーバーが動作する
- CI環境でテストが実行できる

---

#### Day 2: TASK-0082 - 文字入力・読み上げE2Eテスト

- [x] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: REQ-001, REQ-002, REQ-401, REQ-402, NFR-001, NFR-003
- **依存タスク**: TASK-0081

**実装詳細**:

1. 文字盤タップ → 入力欄反映 → 読み上げフロー
2. 文字盤タップ応答100ms以内の確認（NFR-003）
3. TTS読み上げ開始1秒以内の確認（NFR-001）
4. 削除・全消去の動作確認
5. 入力文字数制限（1000文字）の確認

**完了条件**:

- 文字入力から読み上げまでのE2Eテストが成功
- パフォーマンス要件（100ms応答、1秒TTS開始）を満たす
- 削除・全消去が正常動作する
- 1000文字制限が機能する

**テスト要件**:

```dart
testWidgets('文字入力から読み上げまでのE2Eテスト', (tester) async {
  // 文字盤で「こんにちは」入力
  // 読み上げボタンタップ
  // TTS再生確認
});
```

---

#### Day 3: TASK-0083 - 定型文E2Eテスト ✅ **完了** (TDD開発完了 - 20テストケース全通過)

- [x] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: REQ-101, REQ-102, REQ-103, REQ-104, REQ-105, NFR-004
- **依存タスク**: TASK-0081

**実装詳細**:

1. 定型文一覧表示 → 選択 → 即座読み上げフロー
2. 定型文100件表示1秒以内の確認（NFR-004）
3. お気に入り優先表示の確認（REQ-105）
4. 定型文CRUD操作の確認
5. カテゴリ分類の確認

**完了条件**:

- 定型文選択から読み上げまでのE2Eテストが成功
- パフォーマンス要件（100件1秒以内）を満たす
- お気に入りが優先表示される
- CRUD操作が正常動作する

**テスト要件**:

```dart
testWidgets('定型文選択から読み上げまでのE2Eテスト', (tester) async {
  // 定型文一覧表示
  // 定型文タップ
  // 即座読み上げ確認
});
```

---

#### Day 4: TASK-0084 - 大ボタン・緊急ボタンE2Eテスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: REQ-201, REQ-202, REQ-204, REQ-301, REQ-302, REQ-303, REQ-304
- **依存タスク**: TASK-0081

**実装詳細**:

1. 「はい」「いいえ」「わからない」タップ → 即座読み上げ
2. 状態ボタンタップ → 即座読み上げ
3. 緊急ボタン → 確認ダイアログ → 緊急音・画面赤表示
4. 緊急ボタンの2段階確認（REQ-302）
5. リセットボタンで通常画面復帰

**完了条件**:

- 大ボタンタップで即座読み上げ
- 緊急ボタンの2段階確認が機能する
- 緊急音・画面赤表示が動作する
- リセットで通常画面に戻る

**テスト要件**:

```dart
testWidgets('緊急ボタン2段階確認E2Eテスト', (tester) async {
  // 緊急ボタン1回目タップ
  // 確認ダイアログ表示確認
  // 「はい」タップ
  // 緊急音・画面赤表示確認
});
```

---

#### Day 5: TASK-0085 - 履歴・お気に入りE2Eテスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: REQ-601, REQ-602, REQ-603, REQ-701, REQ-702, REQ-703
- **依存タスク**: TASK-0081

**実装詳細**:

1. 読み上げ → 履歴自動保存 → 履歴一覧表示
2. 履歴タップ → 再読み上げ
3. 履歴からお気に入り登録 → お気に入り一覧表示
4. 50件制限・自動削除の確認（REQ-602）
5. お気に入り並び順変更の確認（REQ-703）

**完了条件**:

- 履歴の自動保存・再読み上げが動作する
- 50件制限・自動削除が機能する
- お気に入り登録・並び順変更が動作する
- 履歴・お気に入りがローカル保存される

**テスト要件**:

```dart
testWidgets('履歴からお気に入り登録E2Eテスト', (tester) async {
  // 読み上げ実行
  // 履歴画面に遷移
  // お気に入り登録
  // お気に入り一覧で確認
});
```

---

### Week 18: パフォーマンス最適化

#### Day 6: TASK-0086 - AI変換E2Eテスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: REQ-901, REQ-902, REQ-903, REQ-904, NFR-002
- **依存タスク**: TASK-0081

**実装詳細**:

1. 入力 → AI変換 → 結果表示 → 採用/再生成/元の文
2. AI変換応答時間3秒以内の確認（NFR-002）
3. 3秒超過時のローディング表示確認（REQ-2006）
4. 丁寧さレベル3段階の動作確認
5. オフライン時のフォールバック確認

**完了条件**:

- AI変換フロー全体が動作する
- パフォーマンス要件（平均3秒以内）を満たす
- ローディング表示が適切に動作する
- オフライン時にフォールバックが機能する

**テスト要件**:

```dart
testWidgets('AI変換フローE2Eテスト', (tester) async {
  // 文字入力
  // AI変換ボタンタップ
  // 結果表示確認
  // 採用ボタンタップ
  // 入力欄に反映確認
});
```

---

#### Day 7: TASK-0087 - 設定・アクセシビリティE2Eテスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: REQ-801, REQ-802, REQ-803, REQ-2007, REQ-2008, REQ-5006
- **依存タスク**: TASK-0081

**実装詳細**:

1. フォントサイズ変更 → 全画面即時反映（REQ-2007）
2. テーマ変更 → 全画面即時反映（REQ-2008）
3. 高コントラストモードのコントラスト比確認（REQ-5006）
4. TTS速度・AI丁寧さレベル設定の確認
5. 設定の永続化確認

**完了条件**:

- 設定変更が即時に全画面に反映される
- 高コントラストモードで4.5:1以上のコントラスト比
- 設定がアプリ再起動後も保持される
- 各設定項目が正常動作する

**テスト要件**:

```dart
testWidgets('フォントサイズ変更即時反映E2Eテスト', (tester) async {
  // 設定画面に遷移
  // フォントサイズ変更
  // 文字盤画面で反映確認
});
```

---

#### Day 8: TASK-0088 - パフォーマンス計測・プロファイリング

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: NFR-001, NFR-002, NFR-003, NFR-004
- **依存タスク**: TASK-0082, TASK-0083

**実装詳細**:

1. Flutter DevToolsでのパフォーマンス計測
2. 文字盤タップ応答時間計測（目標: 100ms以内）
3. TTS読み上げ開始時間計測（目標: 1秒以内）
4. 定型文一覧表示時間計測（目標: 1秒以内）
5. AI変換応答時間計測（目標: 平均3秒以内）

**完了条件**:

- すべてのパフォーマンス要件を満たす
- パフォーマンス計測結果がドキュメント化される
- ボトルネックが特定・改善される
- 安定したパフォーマンスが確認される

**テスト要件**:

```dart
test('文字盤タップ応答時間が100ms以内', () async {
  final stopwatch = Stopwatch()..start();
  // タップイベント発火
  // 入力欄更新
  stopwatch.stop();
  expect(stopwatch.elapsedMilliseconds, lessThan(100));
});
```

---

#### Day 9: TASK-0089 - 文字盤UI最適化

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: NFR-003, REQ-5001
- **依存タスク**: TASK-0088

**実装詳細**:

1. 文字盤ウィジェットの再レンダリング最適化
2. constコンストラクタの活用
3. RepaintBoundaryの適切な配置
4. タップフィードバックアニメーションの最適化
5. メモリ使用量の確認・最適化

**完了条件**:

- 文字盤タップ応答が安定して100ms以内
- 不要な再レンダリングが排除される
- メモリリークがない
- スムーズなアニメーション

**テスト要件**:

```dart
testWidgets('文字盤タップ応答最適化確認', (tester) async {
  // 連続タップテスト
  // 応答時間計測
  // メモリ使用量確認
});
```

---

#### Day 10: TASK-0090 - TTS・ローカルストレージ最適化

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: NFR-001, NFR-004
- **依存タスク**: TASK-0088

**実装詳細**:

1. TTS初期化の最適化（遅延初期化）
2. TTS読み上げ開始時間の最適化
3. Hive読み込みの最適化（キャッシュ活用）
4. 定型文一覧の仮想スクロール実装
5. データベース操作の非同期最適化

**完了条件**:

- TTS読み上げ開始が安定して1秒以内
- 定型文100件表示が1秒以内
- Hive読み込みが高速化される
- データベース操作がUIをブロックしない

**テスト要件**:

```dart
test('TTS読み上げ開始時間が1秒以内', () async {
  final stopwatch = Stopwatch()..start();
  await ttsService.speak('こんにちは');
  stopwatch.stop();
  expect(stopwatch.elapsedMilliseconds, lessThan(1000));
});
```

---

### Week 19: モバイルビルド・デプロイ設定

#### Day 11: TASK-0091 - iOSビルド設定

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: NFR-401
- **依存タスク**: すべてのPhase 4タスク

**実装詳細**:

1. Xcode プロジェクト設定確認・調整
2. iOS 14.0以上の対応確認（NFR-401）
3. App Store Connect設定
4. 証明書・プロビジョニングプロファイル設定
5. TestFlight配布設定

**完了条件**:

- iOS向けビルドが成功する
- iOS 14.0以上で動作確認
- TestFlight経由でテスト配布可能
- App Store提出準備完了

---

#### Day 12: TASK-0092 - Androidビルド設定

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: NFR-401
- **依存タスク**: すべてのPhase 4タスク

**実装詳細**:

1. build.gradle設定確認・調整
2. Android 10以上の対応確認（NFR-401）
3. Google Play Console設定
4. 署名キー設定
5. 内部テスト配布設定

**完了条件**:

- Android向けビルドが成功する
- Android 10以上で動作確認
- Google Play内部テスト配布可能
- Google Play提出準備完了

---

#### Day 13: TASK-0093 - Webビルド設定

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: NFR-401
- **依存タスク**: すべてのPhase 4タスク

**実装詳細**:

1. Flutter Webビルド設定確認
2. Chrome/Safari/Edge対応確認（NFR-401）
3. PWA設定（manifest.json、service-worker）
4. Vercel/Netlifyデプロイ設定
5. 本番環境URL設定

**完了条件**:

- Web向けビルドが成功する
- 主要ブラウザ（Chrome、Safari、Edge）で動作確認
- PWAとしてインストール可能
- Vercel/Netlifyにデプロイ可能

---

#### Day 14: TASK-0094 - CI/CDパイプライン構築

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: NFR-501, NFR-502, NFR-503
- **依存タスク**: TASK-0091, TASK-0092, TASK-0093

**実装詳細**:

1. GitHub Actionsワークフロー作成
2. 自動テスト実行（Flutter test、pytest）
3. コードカバレッジ計測（目標: 80%以上）
4. Lintチェック（flutter_lints、Ruff + Black）
5. 自動ビルド・デプロイ（main/develop/feature）

**完了条件**:

- GitHub Actionsでテスト・ビルドが自動実行される
- コードカバレッジ80%以上を維持
- Lintチェックがすべてパスする
- mainブランチで自動デプロイが動作する

---

#### Day 15: TASK-0095 - 実機テスト（iOS/Android/タブレット）

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: NFR-401, NFR-402, NFR-403
- **依存タスク**: TASK-0091, TASK-0092

**実装詳細**:

1. iPhone/iPadでの動作確認
2. Android スマートフォン/タブレットでの動作確認
3. 9.7インチ以上タブレットでの最適表示確認（NFR-402）
4. 縦向き・横向き両対応確認（NFR-403）
5. TTS実機動作確認

**完了条件**:

- iOS/Android実機で正常動作する
- タブレットで最適な表示
- 縦向き・横向き両対応
- TTS実機で正常動作する

**テスト要件**:

```dart
// 実機テストチェックリスト
// - iPhone (iOS 14+)
// - iPad (9.7インチ以上)
// - Android スマートフォン (Android 10+)
// - Android タブレット
// - 縦向き/横向き切り替え
// - TTS読み上げ
```

---

### Week 20: ドキュメント整備・リリース準備

#### Day 16: TASK-0096 - カバレッジ確認・テスト補完

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: NFR-501, NFR-502
- **依存タスク**: すべてのE2Eテストタスク

**実装詳細**:

1. Flutter テストカバレッジ確認（目標: 80%以上）
2. バックエンドテストカバレッジ確認（目標: 90%以上）
3. カバレッジ不足箇所の特定
4. 追加テストケース作成
5. テストレポート生成

**完了条件**:

- Flutterカバレッジ80%以上
- バックエンドカバレッジ90%以上
- すべてのテストがパスする
- テストレポートが生成される

**テスト要件**:

```bash
# カバレッジ計測
flutter test --coverage
genhtml coverage/lcov.info -o coverage/html

# バックエンド
pytest --cov=app --cov-report=html
```

---

#### Day 17: TASK-0097 - セキュリティ・プライバシー最終確認

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **関連要件**: NFR-101, NFR-102, NFR-103, NFR-104, NFR-105
- **依存タスク**: すべての実装タスク

**実装詳細**:

1. ローカルストレージのデータ保存確認（NFR-101）
2. AI変換時のプライバシー通知確認（NFR-102）
3. データ削除機能の動作確認（NFR-103）
4. HTTPS通信の確認（NFR-104）
5. 環境変数の安全な管理確認（NFR-105）

**完了条件**:

- 会話内容が端末内にのみ保存される
- AI変換時のプライバシー説明が表示される
- 履歴・お気に入りが削除可能
- すべてのAPI通信がHTTPS
- 環境変数がハードコードされていない

**テスト要件**:

```dart
test('データがローカルにのみ保存される', () async {
  // NFR-101の確認
});

testWidgets('AI変換時にプライバシー通知表示', (tester) async {
  // NFR-102の確認
});
```

---

#### Day 18: TASK-0098 - ユーザードキュメント作成

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: NFR-205
- **依存タスク**: すべての実装タスク

**実装詳細**:

1. アプリ内ヘルプの最終確認
2. iOS「ガイド付きアクセス」設定ガイド（NFR-205）
3. Android「画面ピン留め」設定ガイド（NFR-205）
4. よくある質問（FAQ）作成
5. トラブルシューティングガイド作成

**完了条件**:

- アプリ内ヘルプが分かりやすい
- iOS/Androidのガイド付きアクセス設定方法が記載されている
- FAQが作成されている
- トラブルシューティングガイドが作成されている

---

#### Day 19: TASK-0099 - App Store/Google Play申請準備

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: なし（リリース準備）
- **依存タスク**: TASK-0091, TASK-0092

**実装詳細**:

1. App Storeメタデータ作成（説明文、スクリーンショット）
2. Google Playメタデータ作成（説明文、スクリーンショット）
3. プライバシーポリシーURL設定
4. サポートURL設定
5. アプリアイコン・スプラッシュ画面の最終確認

**完了条件**:

- App Store/Google Playのメタデータが準備完了
- スクリーンショットが各プラットフォーム要件を満たす
- プライバシーポリシーがアクセス可能
- サポート連絡先が設定されている

---

#### Day 20: TASK-0100 - リリース最終確認・チェックリスト

- [ ] **タスク完了**
- **推定工数**: 8時間
- **タスクタイプ**: DIRECT
- **要件名**: kotonoha
- **関連要件**: すべての要件
- **依存タスク**: すべてのPhase 5タスク

**実装詳細**:

1. 全機能の最終動作確認
2. パフォーマンス要件の最終確認
3. セキュリティ・プライバシー要件の最終確認
4. アクセシビリティ要件の最終確認
5. リリースチェックリストの完了確認

**完了条件**:

- すべての機能要件が満たされている
- すべての非機能要件が満たされている
- すべてのテストがパスする
- リリースチェックリストがすべて完了

**リリースチェックリスト**:

```
[ ] 基本機能（文字盤、定型文、TTS）が動作
[ ] 緊急ボタンが正常動作
[ ] AI変換が正常動作
[ ] 設定が正常動作
[ ] オフライン時も基本機能が動作
[ ] パフォーマンス要件達成
[ ] アクセシビリティ要件達成
[ ] テストカバレッジ80%以上
[ ] iOS/Android/Webビルド成功
[ ] App Store/Google Play申請準備完了
```

---

## フェーズ完了条件

- [ ] すべての20タスクが完了している
- [ ] E2Eテストがすべてパスする
- [ ] パフォーマンス要件を満たす
- [ ] テストカバレッジ80%以上
- [ ] iOS/Androidビルドが成功する
- [ ] CI/CDパイプラインが動作する
- [ ] ユーザードキュメントが完成している
- [ ] リリースチェックリストがすべて完了

## リリース後の運用・保守

- バグ報告対応フロー
- 定期的なアップデート計画
- ユーザーフィードバック収集

---

## 関連ドキュメント

- [要件定義書](../../spec/kotonoha-requirements.md)
- [アーキテクチャ設計](../../design/kotonoha/architecture.md)
- [Phase 4 タスク](./kotonoha-phase4.md)
- [タスク実装計画 - 全体概要](./kotonoha-overview.md)

---

## 更新履歴

- **2025-11-27**: Phase 5タスクファイル作成（tsumiki:kairo-tasks により自動生成）
