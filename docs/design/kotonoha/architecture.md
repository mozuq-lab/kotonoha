# 文字盤コミュニケーション支援アプリ（kotonoha） アーキテクチャ設計

## 🔵 信頼性レベル凡例

- 🔵 **青信号**: EARS要件定義書・設計文書を参考にした確実な設計
- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測による設計
- 🔴 **赤信号**: EARS要件定義書・設計文書にない推測による設計

## システム概要 🔵

kotonohaは、発話困難な方が「できるだけ少ない操作で、自分の言いたいことを、適切な丁寧さで、安全に伝えられる」ことを目的としたタブレット向けコミュニケーション支援アプリです。

**対象ユーザー**: 脳梗塞・ALS・筋疾患などで発話が難しいが、タブレットのタップ操作がある程度可能な方

**主な利用シーン**:
- 自宅での家族との会話
- 介護施設でのスタッフとのやり取り
- 病院・診察時の医師・看護師とのコミュニケーション

## アーキテクチャパターン 🔵

### パターン: オフラインファーストクライアント + オプションのクラウドAI連携

**選択理由**:
1. **オフライン対応必須** (REQ-1001): 文字盤入力・定型文・履歴・TTSはネットワーク不要で動作
2. **単一端末完結** (REQ-5004): データは端末内に保存し、クラウド同期は不要
3. **AI変換はオプション機能** (REQ-901, REQ-1002): オンライン時のみ利用可能
4. **高速レスポンス** (NFR-001, NFR-003): ローカルストレージとOS標準TTSで低遅延を実現

## コンポーネント構成

### フロントエンド（Flutter） 🔵

- **フレームワーク**: Flutter 3.38.1 + Dart 3.10+
- **対応プラットフォーム**: iOS / Android / Web
- **状態管理**: Riverpod 2.x
  - コンパイル時の安全性と非同期処理との親和性が高い
  - テスタビリティが高く、保守性に優れる
- **ルーティング**: go_router（宣言的ルーティング、ディープリンク対応）
- **ローカルストレージ**: shared_preferences（設定）、Hive（定型文・履歴・お気に入り）
- **HTTP通信**: dio + retrofit（AI変換API呼び出し）

**選択理由**:
- 1コードベースでiOS/Android/Web対応、開発効率が非常に高い
- ネイティブに近いパフォーマンス
- Material Design 3で現代的なUI/UX
- オフライン対応が容易

### バックエンド（FastAPI） 🟡

- **フレームワーク**: FastAPI 0.121+ (Python 3.10+)
- **ASGIサーバー**: Uvicorn
- **ORM**: SQLAlchemy 2.x (async対応)
- **マイグレーション**: Alembic 1.17+
- **認証・セキュリティ**: JWT (JSON Web Token)、OAuth2 + Bearer Token
- **バリデーション**: Pydantic 2.x

**役割**:
- AI変換APIのプロキシ・ロジック処理
- 将来的なクラウド連携機能の基盤
- 管理者機能（将来拡張）

**選択理由**:
- Python経験を活用できる
- 非同期対応で高速（平均応答時間3秒以内を目標、NFR-002）
- 自動APIドキュメント生成（Swagger UI）
- MVP段階では最小限のAPI実装、将来の拡張性を確保

### データベース（PostgreSQL） 🟡

- **DBMS**: PostgreSQL 15+
- **主な用途**:
  - AI変換履歴（オプション、将来的な学習・統計用）
  - 管理者用の分析データ（将来拡張）

**選択理由**:
- ユーザーデータは端末内ローカル保存（REQ-5003, NFR-101）
- バックエンドDBは将来的な拡張用として最小限の利用

### キャッシュ（Redis） 🔴

- **用途**: AI変換結果のキャッシュ（オプション、将来拡張）
- **MVP範囲**: 実装不要（後続フェーズで検討）

## データフロー概要

### 基本コミュニケーションフロー（オフライン動作） 🔵

```
[ユーザー]
  ↓ タップ
[文字盤UI] → [ローカル入力バッファ] → [TTS（OS標準）] → 🔊 読み上げ
  ↓
[ローカルストレージ（Hive）] ← 履歴保存
```

### AI変換フロー（オンライン時のみ） 🔵

```
[ユーザー入力]
  ↓
[Flutter App] → [FastAPI Backend] → [外部AI API（Claude/GPT等）]
  ↓                ↓                       ↓
[変換結果表示] ← [プロキシ処理] ←─────────[変換結果]
  ↓
[ユーザー確認] → 採用/却下/再生成
  ↓
[入力欄に反映] → [TTS読み上げ]
```

### 緊急呼び出しフロー 🔵

```
[緊急ボタンタップ]
  ↓
[確認ダイアログ] → ユーザー確認（2段階）
  ↓
[緊急音再生 + 画面全体赤表示]
```

## セキュリティ・プライバシー設計 🔵

### データ保存ポリシー

1. **ローカルストレージ優先** (NFR-101):
   - 定型文、履歴、お気に入り、設定はすべて端末内に保存
   - アプリ専用領域に保存、他アプリからアクセス不可

2. **AI変換時のプライバシー** (NFR-102):
   - AI変換機能使用時、入力テキストを外部APIに送信
   - 初回利用時に明示的に通知し、ユーザー同意を取得
   - プライバシーポリシー表示

3. **通信セキュリティ** (NFR-104):
   - すべてのAPI通信をHTTPS/TLS 1.2+で暗号化
   - JWT トークンによる認証（将来的なユーザー管理用）

4. **データ削除** (NFR-103):
   - 履歴・お気に入りをユーザーが任意に削除可能
   - アプリアンインストール時にすべてのデータを削除

## 非機能要件への対応

### パフォーマンス 🔵

- **TTS読み上げ**: 1秒以内に開始 (NFR-001)
  - OS標準TTS利用、ローカル処理で低遅延
- **文字盤タップ応答**: 100ms以内 (NFR-003)
  - Flutterのネイティブパフォーマンスで実現
- **AI変換**: 平均3秒以内 (NFR-002)
  - バックエンドでプロキシ処理、3秒超過時はローディング表示

### ユーザビリティ 🔵

- **タップ数制限**: 主要操作を3タップ以内で完了 (NFR-201)
  - 定型文即読み上げ: 1タップ
  - はい/いいえボタン: 1タップ
  - 文字入力→読み上げ: 文字入力 + 読み上げボタン
- **タップターゲットサイズ**: 44px × 44px以上 (REQ-5001)
  - 推奨: 60px × 60px（大ボタン、緊急ボタン）
- **誤操作防止**: 全消去・緊急ボタンは確認ダイアログ (REQ-5002)

### 信頼性 🔵

- **基本機能の継続性** (NFR-301):
  - AI変換エラー時も文字盤+読み上げは継続動作
  - ネットワークエラー時もオフライン機能が正常動作
- **データ永続化** (REQ-5003):
  - Hiveによるローカルデータベース、アプリクラッシュ時も保持
- **状態復元** (NFR-302):
  - バックグラウンド復帰時、前回の入力状態を復元

### アクセシビリティ 🔵

- **フォントサイズ**: 小/中/大の3段階 (REQ-801)
- **テーマ**: ライト/ダーク/高コントラストの3種類 (REQ-803)
- **高コントラストモード**: WCAG 2.1 AAレベル（4.5:1以上）(REQ-5006)
- **タップ主体の操作**: スワイプ等のジェスチャーに依存しない (REQ-5005)

## 技術的制約・前提条件

### プラットフォーム要件 🟡

- **iOS**: 14.0以上 (NFR-401)
- **Android**: 10以上 (NFR-401)
- **Web**: Chrome、Safari、Edge最新版 (NFR-401)
- **推奨デバイス**: 9.7インチ以上のタブレット (NFR-402)
- **画面方向**: 縦向き・横向き両対応 (NFR-403)

### 開発環境 🔵

- **Flutter**: 3.38.1
- **Dart**: 3.10+
- **Python**: 3.10+
- **FastAPI**: 0.121+
- **PostgreSQL**: 15+
- **Docker**: 最新安定版（開発環境）

## デプロイ戦略 🔵

### モバイルアプリ

- **iOS**: TestFlight（テスト配布） → App Store（本番）
- **Android**: Google Play Console Internal Testing → Google Play

### Webアプリ

- **ホスティング**: Vercel / Netlify
  - 無料枠から開始可能
  - 自動CDN配信、HTTPSデフォルト

### バックエンドAPI

- **推奨**: AWS ECS (Fargate) / Google Cloud Run / Azure Container Apps
- **代替案**: Heroku / Railway / Render（簡単デプロイ）

### データベース

- **マネージドサービス**: AWS RDS / Google Cloud SQL / Azure Database for PostgreSQL
- **接続**: SSL/TLS必須、接続プーリング設定

### 環境分離

- **開発環境**: ローカル（Docker Compose）
- **ステージング環境**: クラウド（本番と同じ構成）
- **本番環境**: クラウド

## スケーラビリティ戦略 🟡

### MVP段階

- 想定ユーザー数: 同時利用10人以下（NFR-005）
- 軽負荷環境で安定動作を優先

### 将来的な拡張

- 水平スケーリング: コンテナベースのバックエンド（ECS/Cloud Run）
- キャッシュ層: Redis導入でAI変換結果を再利用
- CDN: 静的アセット配信の高速化

## エラーハンドリング戦略 🔵

### クライアント側

1. **ネットワークエラー**:
   - 分かりやすいエラーメッセージ表示 (NFR-204)
   - 再試行オプション提供 (EDGE-001)
   - オフライン機能への自動フォールバック

2. **AI変換エラー**:
   - 元の入力文をそのまま使用可能 (EDGE-002)
   - エラーメッセージ表示

3. **TTS再生エラー**:
   - テキスト表示のみで継続 (EDGE-004)

4. **ストレージ容量不足**:
   - 警告表示、古い履歴削除提案 (EDGE-003)

### バックエンド側

1. **外部API連携エラー**:
   - タイムアウト設定（10秒）
   - リトライ処理（最大3回）
   - フォールバック処理

2. **データベースエラー**:
   - トランザクション管理
   - ロールバック処理
   - エラーログ記録

## 品質基準 🔵

### テストカバレッジ

- **全体**: 80%以上 (NFR-501)
- **ビジネスロジック・APIエンドポイント**: 90%以上 (NFR-502)

### コード品質

- **Flutter**: flutter_lints準拠 (NFR-503)
- **Python**: Ruff + Black準拠、型ヒント使用 (NFR-503)
- **API仕様**: OpenAPI (Swagger)形式で自動生成 (NFR-504)

### CI/CD

- **GitHub Actions**: 自動テスト・ビルド・デプロイ
  - Flutterテスト実行
  - Pythonテスト実行
  - コードカバレッジ測定
  - Lintチェック
  - 自動デプロイ（本番・ステージング）

## MVP範囲外（非スコープ）

以下の機能はMVPでは実装しない:

- クラウド同期・アカウント管理・複数端末間のデータ共有
- 視線入力・外部スイッチ・スキャン入力など、特殊インターフェースとの連携
- 長い会話履歴を用いた文脈理解・自動応答候補の提示
- 医療向けの高度な症状構造化・人体図UI・医療文書生成
- 詳細な統計・利用ログ・管理画面
- 多言語対応（翻訳・多言語TTS）
- 音声認識（音声入力）機能
- 画像・絵文字・スタンプ機能
- ビデオ通話連携機能
- 複数ユーザープロファイル管理
