# 文字盤コミュニケーション支援アプリ（kotonoha） 技術設計文書

## 📋 概要

このディレクトリには、文字盤コミュニケーション支援アプリ（kotonoha）の技術設計文書が含まれています。

**作成日**: 2025-11-19
**対象バージョン**: MVP (v1.0.0)
**関連要件定義書**: [../spec/kotonoha-requirements.md](../../spec/kotonoha-requirements.md)

## 🔵 信頼性レベルについて

各設計文書では、以下の信号で設計の根拠を示しています:

- 🔵 **青信号**: EARS要件定義書・設計文書を参考にした確実な設計
- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測による設計
- 🔴 **赤信号**: EARS要件定義書・設計文書にない推測による設計（将来的な拡張用）

## 📁 ファイル構成

### 1. [architecture.md](./architecture.md) - アーキテクチャ設計 🔵

システム全体のアーキテクチャとコンポーネント構成を定義しています。

**主な内容**:
- システム概要
- アーキテクチャパターン（オフラインファーストクライアント + オプションのクラウドAI連携）
- フロントエンド構成（Flutter + Riverpod）
- バックエンド構成（FastAPI + PostgreSQL）
- セキュリティ・プライバシー設計
- 非機能要件への対応
- MVP範囲外の機能

**重要な設計判断**:
- ✅ ユーザーデータは端末内ローカルストレージに保存（REQ-5004, NFR-101）
- ✅ AI変換はオプション機能、オフライン時は基本機能のみ（REQ-1001）
- ✅ OS標準TTSを使用し、低遅延で読み上げ（NFR-001）

### 2. [dataflow.md](./dataflow.md) - データフロー図 🔵

システム内のデータの流れと処理フローを可視化しています。

**主な内容**:
- システム全体のアーキテクチャフロー
- 基本コミュニケーションフロー（オフライン動作）
- AI変換フロー（オンライン時）
- 緊急呼び出しフロー
- 定型文管理フロー
- 履歴・お気に入り管理フロー
- ネットワーク接続状態管理
- エラーハンドリングフロー

**主要なフロー**:
- 📱 文字盤入力 → TTS読み上げ → 履歴保存（100ms以内の応答）
- 🤖 AI変換: 入力 → FastAPI → 外部AI API → 変換結果表示（3秒以内）
- 🚨 緊急呼び出し: 2段階確認 → 緊急音 + 画面赤表示

### 3. [interfaces.dart](./interfaces.dart) - Dart/Flutterインターフェース定義 🔵

Flutter アプリのデータモデルと型定義を記載しています。

**主な内容**:
- エンティティ定義（定型文、履歴、お気に入り、設定）
- 列挙型（カテゴリ、フォントサイズ、テーマ、TTS速度、丁寧さレベル等）
- APIリクエスト/レスポンス型
- UI状態定義
- 共通型・ユーティリティ
- 定型文初期データサンプル（50-100個）

**重要なエンティティ**:
- `PresetPhrase`: 定型文（カテゴリ・お気に入り機能付き）
- `History`: 履歴（最大50件、自動削除）
- `Favorite`: お気に入り（並び順カスタマイズ可能）
- `AppSettings`: アプリ設定（フォントサイズ、テーマ、TTS速度、AI丁寧さレベル）

### 4. [database-schema.sql](./database-schema.sql) - データベーススキーマ 🟡

PostgreSQLのデータベーススキーマを定義しています。

**主な内容**:
- AI変換ログテーブル（使用状況・学習データ収集用、ハッシュ化して保存）
- エラーログテーブル（デバッグ・監視用）
- 将来的な拡張用テーブル（MVP範囲外、コメントアウト）
- データ保持ポリシー（自動削除ルール）

**重要な注意点**:
- ⚠️ ユーザーデータは端末内ローカルストレージ（Hive）に保存（NFR-101）
- ⚠️ PostgreSQLはバックエンドAPIの内部処理用のみ
- ⚠️ AI変換テキストはプライバシー保護のためハッシュ化して保存（NFR-102）

### 5. [api-endpoints.md](./api-endpoints.md) - APIエンドポイント仕様 🔵

FastAPI バックエンドのAPIエンドポイント仕様を記載しています。

**主な内容**:
- ベースURL・共通仕様
- HTTPステータスコード・エラーコード
- AI変換エンドポイント（`POST /api/v1/ai/convert`）
- ヘルスチェックエンドポイント（`GET /api/v1/health`）
- レート制限（1分間に10リクエスト）
- セキュリティ設定（HTTPS/TLS、CORS）
- サンプルコード（Dart/Flutter、Python/FastAPI）

**主要なエンドポイント**:
- `POST /api/v1/ai/convert`: AI変換（平均3秒以内、NFR-002）
- `POST /api/v1/ai/regenerate`: AI変換再生成（ユーザーが「再生成」ボタンを押した場合）

## 🎯 設計の主要なポイント

### オフラインファースト設計 🔵

- **基本機能はすべてオフラインで動作** (REQ-1001)
  - 文字盤入力
  - 定型文選択・読み上げ
  - 履歴管理
  - お気に入り管理
  - OS標準TTS読み上げ
- **AI変換のみオンライン必須** (REQ-901, REQ-1002)
  - オフライン時は無効化・グレーアウト表示
  - オフライン時のフォールバック: 元の文をそのまま使用

### パフォーマンス重視 🔵

- **TTS読み上げ開始**: 1秒以内 (NFR-001)
  - OS標準TTS利用でローカル処理
- **文字盤タップ応答**: 100ms以内 (NFR-003)
  - Flutterのネイティブパフォーマンス
- **AI変換**: 平均3秒以内 (NFR-002)
  - 3秒超過時はローディング表示（REQ-2006）

### セキュリティ・プライバシー 🔵

- **ローカルストレージ優先** (NFR-101)
  - 定型文・履歴・お気に入り・設定はすべて端末内に保存
  - Hive（ローカルデータベース）+ shared_preferences（設定）
- **AI変換時のプライバシー通知** (NFR-102)
  - 初回利用時に明示的に通知
  - ユーザー同意を取得
- **通信暗号化** (NFR-104)
  - すべてのAPI通信をHTTPS/TLS 1.2+で暗号化

### アクセシビリティ対応 🔵

- **フォントサイズ**: 小/中/大の3段階 (REQ-801)
- **テーマ**: ライト/ダーク/高コントラストの3種類 (REQ-803)
- **タップターゲットサイズ**: 44px × 44px以上 (REQ-5001)
  - 推奨: 60px × 60px（大ボタン、緊急ボタン）
- **タップ主体の操作**: スワイプ等のジェスチャーに依存しない (REQ-5005)

## 📊 設計とEARS要件の対応表

| 設計要素 | 対応する要件 | 信頼性レベル |
|---------|------------|------------|
| オフライン対応 | REQ-1001, REQ-1002, REQ-1003 | 🔵 |
| AI変換機能 | REQ-901, REQ-902, REQ-903, REQ-904 | 🔵 |
| 定型文管理 | REQ-101〜107 | 🔵 |
| 履歴管理 | REQ-601〜605 | 🔵 |
| お気に入り管理 | REQ-701〜704 | 🔵 |
| 緊急ボタン | REQ-301〜304 | 🔵 |
| TTS読み上げ | REQ-401〜404 | 🔵 |
| 対面表示モード | REQ-501〜503 | 🔵 |
| アクセシビリティ | REQ-801〜804 | 🔵 |
| パフォーマンス | NFR-001〜005 | 🔵 |
| セキュリティ | NFR-101〜105 | 🔵 |
| ユーザビリティ | NFR-201〜205 | 🔵 |

## 🚀 次のステップ

この設計文書を基に、以下のステップで開発を進めてください:

1. **環境構築**: [../tech-stack.md](../tech-stack.md) のセットアップ手順に従って開発環境を構築
2. **タスク分割**: `/tsumiki:kairo-tasks` コマンドで実装タスクを分割
3. **TDD開発**: `/tsumiki:tdd-*` コマンドでテスト駆動開発
4. **実装**: 分割されたタスクを順番に実装

## 📝 更新履歴

- **2025-11-19**: 初回作成
  - アーキテクチャ設計
  - データフロー図
  - Dart/Flutterインターフェース定義
  - データベーススキーマ
  - APIエンドポイント仕様

## 🔗 関連ドキュメント

- [要件定義書](../../spec/kotonoha-requirements.md)
- [ユーザストーリー](../../spec/kotonoha-user-stories.md)
- [受け入れ基準](../../spec/kotonoha-acceptance-criteria.md)
- [技術スタック定義](../tech-stack.md)

## 📞 問い合わせ

設計に関する質問や変更提案がある場合は、GitHubのIssueまたはPull Requestを作成してください。
