# TASK-0022: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å®Ÿè£… - è¦ä»¶å®šç¾©æ›¸

## æ¦‚è¦

| é …ç›® | å†…å®¹ |
|------|------|
| ã‚¿ã‚¹ã‚¯ID | TASK-0022 |
| ã‚¿ã‚¹ã‚¯å | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å®Ÿè£… |
| ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ— | TDD |
| æ¨å®šå·¥æ•° | 8æ™‚é–“ |
| ä¾å­˜ã‚¿ã‚¹ã‚¯ | TASK-0021ï¼ˆFastAPIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ å†æ§‹ç¯‰ãƒ»è¨­å®šç®¡ç†å®Ÿè£…ï¼‰ |
| é–¢é€£è¦ä»¶ | NFR-002, NFR-304 |

## èƒŒæ™¯ã¨ç›®çš„

### èƒŒæ™¯
kotonohaã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ã€SQLAlchemy 2.x + asyncpgã‚’ä½¿ç”¨ã—ãŸéåŒæœŸPostgreSQLæ¥ç¶šãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼ˆTASK-0008, TASK-0009ã§åŸºæœ¬å®Ÿè£…æ¸ˆã¿ï¼‰ã€‚ç¾çŠ¶ã®`backend/app/db/session.py`ã«ã¯åŸºæœ¬çš„ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€æœ¬ç•ªé‹ç”¨ã«å‘ã‘ã¦ä»¥ä¸‹ã®å¼·åŒ–ãŒå¿…è¦ã§ã™ï¼š

1. **æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–**: `pool_recycle`è¨­å®šã®è¿½åŠ ã«ã‚ˆã‚‹é•·æ™‚é–“æ¥ç¶šã®å®‰å®šæ€§ç¢ºä¿
2. **ä¾å­˜æ€§æ³¨å…¥ã®å¼·åŒ–**: `app/api/deps.py`ã®å …ç‰¢åŒ–
3. **ãƒ†ã‚¹ãƒˆåŸºç›¤ã®æ•´å‚™**: ãƒ†ã‚¹ãƒˆç”¨conftest.pyã¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®å……å®Ÿ
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ä¸¦è¡Œæ¥ç¶šæ™‚ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹

### ç›®çš„
- NFR-002ï¼ˆAIå¤‰æ›å¿œç­”æ™‚é–“3ç§’ä»¥å†…ï¼‰ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šåŠ¹ç‡åŒ–
- NFR-304ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰ã®å®Ÿè£…
- å …ç‰¢ãªãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹ç¯‰ã«ã‚ˆã‚‹å“è³ªä¿è¨¼

## é–¢é€£è¦ä»¶ã®è©³ç´°

### NFR-002: AIå¤‰æ›ã®å¿œç­”æ™‚é–“ã‚’å¹³å‡3ç§’ä»¥å†… ğŸ”µ
- **å‡ºå…¸**: docs/spec/kotonoha-requirements.md (line 133)
- **é–¢é€£æ€§**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã®åŠ¹ç‡åŒ–ã«ã‚ˆã‚Šã€AIå¤‰æ›çµæœã®å±¥æ­´ä¿å­˜å‡¦ç†ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’æœ€å°åŒ–
- **å½±éŸ¿**: ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã®é©åˆ‡ãªè¨­å®šã«ã‚ˆã‚Šã€æ¥ç¶šç¢ºç«‹æ™‚é–“ã‚’çŸ­ç¸®

### NFR-304: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ğŸŸ¡
- **å‡ºå…¸**: docs/spec/kotonoha-requirements.md (line 159)
- **é–¢é€£æ€§**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«ãŠã‘ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- **å½±éŸ¿**: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¶­æŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

## ç¾çŠ¶åˆ†æ

### æ—¢å­˜å®Ÿè£…ã®ç¢ºèª

#### backend/app/db/session.pyï¼ˆç¾çŠ¶ï¼‰
```python
engine = create_async_engine(
    settings.DATABASE_URL,
    echo=False,
    pool_pre_ping=True,
    pool_size=10,
    max_overflow=10,
)
```

**èª²é¡Œ**:
- `pool_recycle`æœªè¨­å®š: é•·æ™‚é–“æ¥ç¶šã«ã‚ˆã‚‹ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ–­ãƒªã‚¹ã‚¯
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: `get_db()`é–¢æ•°ã§ã®commit/rollbackå‡¦ç†ãŒä¸ååˆ†

#### backend/app/api/deps.pyï¼ˆç¾çŠ¶ï¼‰
```python
async def get_db_session() -> AsyncGenerator[AsyncSession, None]:
    async for session in get_db():
        yield session
```

**èª²é¡Œ**:
- `get_db()`ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ã—ã¦å†—é•·
- ä¾å­˜æ€§æ³¨å…¥ã¨ã—ã¦ã®å½¹å‰²ãŒä¸æ˜ç¢º

#### backend/tests/conftest.pyï¼ˆç¾çŠ¶ï¼‰
- ãƒ†ã‚¹ãƒˆç”¨ã‚¨ãƒ³ã‚¸ãƒ³ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ»db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã¯å®Ÿè£…æ¸ˆã¿
- `test_client_with_db`ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã§FastAPIã®ä¾å­˜æ€§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ãŒå®Ÿè£…æ¸ˆã¿

## æ©Ÿèƒ½è¦ä»¶

### FR-001: æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šã®å¼·åŒ– ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| è¦ä»¶ID | FR-001 |
| å„ªå…ˆåº¦ | é«˜ |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å·ï¼ˆtech-stack.mdã€SQLAlchemyå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åŸºã¥ãï¼‰ |

**è¦ä»¶**:
- `pool_recycle`ã‚’3600ç§’ï¼ˆ1æ™‚é–“ï¼‰ã«è¨­å®šã—ã€é•·æ™‚é–“æ¥ç¶šã®è‡ªå‹•å†ä½œæˆã‚’å®Ÿç¾ã™ã‚‹
- `pool_timeout`ã‚’30ç§’ã«è¨­å®šã—ã€æ¥ç¶šå–å¾—æ™‚ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’æ˜ç¤ºã™ã‚‹
- æ—¢å­˜ã®`pool_size=10`ã€`max_overflow=10`ã¯ç¶­æŒã™ã‚‹ï¼ˆNFR-005: åŒæ™‚åˆ©ç”¨è€…10äººä»¥ä¸‹ã«å¯¾å¿œï¼‰

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- [ ] `pool_recycle=3600`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] `pool_timeout=30`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] 1æ™‚é–“ä»¥ä¸ŠçµŒéã—ãŸæ¥ç¶šãŒè‡ªå‹•çš„ã«å†ä½œæˆã•ã‚Œã‚‹
- [ ] æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®šãŒãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã‚‹ï¼ˆDEBUGæ™‚ï¼‰

### FR-002: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ– ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| è¦ä»¶ID | FR-002 |
| å„ªå…ˆåº¦ | é«˜ |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å·ï¼ˆNFR-304ã«åŸºã¥ãï¼‰ |

**è¦ä»¶**:
- `get_db()`é–¢æ•°ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®commit/rollbackã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡Œã„ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é©åˆ‡ã«ã‚¯ãƒ­ãƒ¼ã‚ºã™ã‚‹

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- [ ] æ­£å¸¸çµ‚äº†æ™‚ã«commitãŒå®Ÿè¡Œã•ã‚Œã‚‹
- [ ] ä¾‹å¤–ç™ºç”Ÿæ™‚ã«rollbackãŒå®Ÿè¡Œã•ã‚Œã‚‹
- [ ] ã™ã¹ã¦ã®ã‚±ãƒ¼ã‚¹ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å†throwã•ã‚Œã‚‹

### FR-003: ä¾å­˜æ€§æ³¨å…¥ã®çµ±åˆ ğŸŸ¡

| é …ç›® | å†…å®¹ |
|------|------|
| è¦ä»¶ID | FR-003 |
| å„ªå…ˆåº¦ | ä¸­ |
| ä¿¡é ¼æ€§ | ğŸŸ¡ é»„ä¿¡å·ï¼ˆFastAPIæ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ¨æ¸¬ï¼‰ |

**è¦ä»¶**:
- `app/api/deps.py`ã®`get_db_session()`ã‚’`get_db()`ã¨çµ±åˆã™ã‚‹ã‹ã€æ˜ç¢ºãªå½¹å‰²åˆ†æ‹…ã‚’å®šç¾©ã™ã‚‹
- FastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹æ¨™æº–çš„ãªä¾å­˜æ€§æ³¨å…¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºç«‹ã™ã‚‹

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- [ ] ä¾å­˜æ€§æ³¨å…¥é–¢æ•°ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä¸€è²«ã—ãŸä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç¢ºç«‹ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆdocstringï¼‰ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹

### FR-004: ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®å¼·åŒ– ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| è¦ä»¶ID | FR-004 |
| å„ªå…ˆåº¦ | é«˜ |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å·ï¼ˆNFR-501, NFR-502ã«åŸºã¥ãï¼‰ |

**è¦ä»¶**:
- æ—¢å­˜ã®conftest.pyã‚’ç¶­æŒã—ã¤ã¤ã€å¿…è¦ã«å¿œã˜ã¦å¼·åŒ–ã™ã‚‹
- ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ã‚’ä¿è¨¼ã™ã‚‹
- ä¸¦è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®æ¥ç¶šãƒ—ãƒ¼ãƒ«ç®¡ç†ã‚’é©åˆ‡ã«è¡Œã†

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- [ ] ãƒ†ã‚¹ãƒˆé–“ã§ãƒ‡ãƒ¼ã‚¿ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã‚‹
- [ ] ä¸¦è¡Œãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã‚‚æ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šãŒç’°å¢ƒå¤‰æ•°ã§åˆ¶å¾¡å¯èƒ½

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### TC-001: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-001 |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®åŸºæœ¬æ¥ç¶šãŒæˆåŠŸã™ã‚‹ã“ã¨
- `SELECT 1`ã‚¯ã‚¨ãƒªãŒæ­£å¸¸ã«å®Ÿè¡Œã§ãã‚‹ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@pytest.mark.asyncio
async def test_database_connection(db_session: AsyncSession):
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ"""
    result = await db_session.execute(text("SELECT 1"))
    assert result.scalar() == 1
```

### TC-002: æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-002 |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- `pool_recycle`ãŒ3600ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- `pool_size`ãŒ10ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- `max_overflow`ãŒ10ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- `pool_timeout`ãŒ30ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- `pool_pre_ping`ãŒTrueã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
def test_engine_pool_configuration():
    """ã‚¨ãƒ³ã‚¸ãƒ³ã®æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ"""
    from app.db.session import engine

    pool = engine.pool
    assert pool.size() == 10
    assert pool._max_overflow == 10
    assert pool._recycle == 3600
    assert pool._timeout == 30
```

### TC-003: ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆ ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-003 |
| ã‚«ãƒ†ã‚´ãƒª | çµ±åˆãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- 10å€‹ã®ä¸¦è¡Œã‚¯ã‚¨ãƒªãŒæ­£å¸¸ã«å®Ÿè¡Œã§ãã‚‹ã“ã¨
- æ¥ç¶šãƒ—ãƒ¼ãƒ«ãŒé©åˆ‡ã«ç®¡ç†ã•ã‚Œã‚‹ã“ã¨
- ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªãŒæ­£ã—ã„çµæœã‚’è¿”ã™ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@pytest.mark.asyncio
async def test_concurrent_connections():
    """ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆ"""
    import asyncio
    from app.db.session import async_session_maker

    async def execute_query(query_id: int) -> int:
        async with async_session_maker() as session:
            result = await session.execute(text("SELECT :id"), {"id": query_id})
            return result.scalar()

    tasks = [execute_query(i) for i in range(10)]
    results = await asyncio.gather(*tasks)

    assert len(results) == 10
    assert set(results) == set(range(10))
```

### TC-004: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-004 |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã“ã¨
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@pytest.mark.asyncio
async def test_session_rollback_on_error(db_session: AsyncSession):
    """ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ"""
    from app.models.ai_conversion_history import AIConversionHistory

    # ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã§ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹
    with pytest.raises(IntegrityError):
        record = AIConversionHistory(
            input_text=None,  # NOT NULLåˆ¶ç´„é•å
            converted_text="test",
            politeness_level="polite",
        )
        db_session.add(record)
        await db_session.flush()

    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¢ºèª
    await db_session.rollback()

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ä½¿ç”¨å¯èƒ½ãªã“ã¨ã‚’ç¢ºèª
    result = await db_session.execute(text("SELECT 1"))
    assert result.scalar() == 1
```

### TC-005: ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆ ğŸŸ¡

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-005 |
| ã‚«ãƒ†ã‚´ãƒª | çµ±åˆãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | ä¸­ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- FastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä¾å­˜æ€§æ³¨å…¥ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ãæä¾›ã•ã‚Œã‚‹ã“ã¨
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@pytest.mark.asyncio
async def test_dependency_injection(test_client_with_db):
    """ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆ"""
    from httpx import AsyncClient

    async with AsyncClient(app=test_client_with_db, base_url="http://test") as client:
        response = await client.get("/health")
        assert response.status_code == 200
        data = response.json()
        assert data["database"] == "connected"
```

### TC-006: æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ ğŸŸ¡

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-006 |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | ä¸­ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ãªä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã“ã¨
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé©åˆ‡ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@pytest.mark.asyncio
async def test_connection_error_handling():
    """æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ"""
    from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
    from sqlalchemy.exc import OperationalError

    # ç„¡åŠ¹ãªæ¥ç¶šURLã§ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
    invalid_engine = create_async_engine(
        "postgresql+asyncpg://invalid:invalid@localhost:5432/invalid_db",
        pool_pre_ping=True,
    )
    invalid_session_maker = async_sessionmaker(bind=invalid_engine, class_=AsyncSession)

    with pytest.raises(OperationalError):
        async with invalid_session_maker() as session:
            await session.execute(text("SELECT 1"))

    await invalid_engine.dispose()
```

### TC-007: pool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆ ğŸŸ¡

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-007 |
| ã‚«ãƒ†ã‚´ãƒª | çµ±åˆãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | ä½ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- `pool_pre_ping=True`ã«ã‚ˆã‚Šã€ç„¡åŠ¹ãªæ¥ç¶šãŒè‡ªå‹•çš„ã«å†æ¥ç¶šã•ã‚Œã‚‹ã“ã¨

**æ³¨æ„**: ã“ã®ãƒ†ã‚¹ãƒˆã¯æ¥ç¶šã‚’æ„å›³çš„ã«åˆ‡æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯å®Ÿè¡ŒãŒå›°é›£ãªå ´åˆãŒã‚ã‚‹

### TC-008: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆ ğŸ”µ

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-008 |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |

**ãƒ†ã‚¹ãƒˆå†…å®¹**:
- æ­£å¸¸çµ‚äº†æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã‚‹ã“ã¨
- ã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨

**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¾‹**:
```python
@pytest.mark.asyncio
async def test_session_commit(db_session: AsyncSession):
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆ"""
    from app.models.ai_conversion_history import AIConversionHistory, PolitenessLevel
    from uuid import uuid4

    record = AIConversionHistory(
        input_text="ãƒ†ã‚¹ãƒˆ",
        converted_text="ãƒ†ã‚¹ãƒˆã§ã™",
        politeness_level=PolitenessLevel.NORMAL,
        conversion_time_ms=100,
        user_session_id=uuid4(),
    )
    db_session.add(record)
    await db_session.commit()

    # ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    result = await db_session.execute(
        select(AIConversionHistory).where(AIConversionHistory.input_text == "ãƒ†ã‚¹ãƒˆ")
    )
    saved_record = result.scalar_one_or_none()
    assert saved_record is not None
    assert saved_record.converted_text == "ãƒ†ã‚¹ãƒˆã§ã™"
```

## å®Ÿè£…ä»•æ§˜

### æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šã®è©³ç´°

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | å€¤ | èª¬æ˜ |
|-----------|-----|------|
| `pool_size` | 10 | æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®åŸºæœ¬ã‚µã‚¤ã‚ºï¼ˆNFR-005å¯¾å¿œï¼‰ |
| `max_overflow` | 10 | ãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã‚’è¶…ãˆãŸè¿½åŠ æ¥ç¶šæ•° |
| `pool_recycle` | 3600 | æ¥ç¶šã®å†ä½œæˆé–“éš”ï¼ˆç§’ï¼‰ |
| `pool_timeout` | 30 | æ¥ç¶šå–å¾—ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰ |
| `pool_pre_ping` | True | æ¥ç¶šä½¿ç”¨å‰ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ |
| `echo` | False | SQLå‡ºåŠ›ï¼ˆDEBUGæ™‚ã®ã¿Trueï¼‰ |

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ãƒ•ãƒ­ãƒ¼

```
1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡
   â†“
2. get_db() ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿é–‹å§‹
   â†“
3. async_session_maker() ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
   â†“
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’yieldï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æä¾›ï¼‰
   â†“
5. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‡¦ç†å®Ÿè¡Œ
   â†“
6. [æ­£å¸¸çµ‚äº†] â†’ commit() â†’ close()
   [ä¾‹å¤–ç™ºç”Ÿ] â†’ rollback() â†’ close() â†’ ä¾‹å¤–å†throw
   â†“
7. ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¿”å´
```

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ deps.py           # ä¾å­˜æ€§æ³¨å…¥ï¼ˆå¼·åŒ–ï¼‰
â”‚   â””â”€â”€ db/
â”‚       â”œâ”€â”€ session.py        # ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆå¼·åŒ–ï¼‰
â”‚       â””â”€â”€ base.py           # ãƒ¢ãƒ‡ãƒ«é›†ç´„
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py           # ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ï¼ˆå¼·åŒ–ï¼‰
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ test_session.py   # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆæ–°è¦ï¼‰
```

## å®Œäº†æ¡ä»¶

### å¿…é ˆæ¡ä»¶
- [ ] `pool_recycle=3600`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] `pool_timeout=30`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] `get_db()`ã§commit/rollback/closeãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆTC-001ã€œTC-008ï¼‰ãŒæˆåŠŸã™ã‚‹
- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸90%ä»¥ä¸Šã‚’é”æˆ

### æ¨å¥¨æ¡ä»¶
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆdocstringï¼‰ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹
- [ ] ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] è¨­å®šå€¤ãŒç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½

## ãƒªã‚¹ã‚¯ã¨ç·©å’Œç­–

### ãƒªã‚¹ã‚¯1: æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æ¯æ¸‡
- **ãƒªã‚¹ã‚¯**: é«˜è² è·æ™‚ã«æ¥ç¶šãƒ—ãƒ¼ãƒ«ãŒæ¯æ¸‡ã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒç™ºç”Ÿã™ã‚‹
- **å½±éŸ¿**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é…å»¶ã¾ãŸã¯å¤±æ•—
- **ç·©å’Œç­–**: `pool_timeout`ã‚’è¨­å®šã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
- **ä¿¡é ¼æ€§**: ğŸŸ¡ é»„ä¿¡å·

### ãƒªã‚¹ã‚¯2: é•·æ™‚é–“æ¥ç¶šã®åˆ‡æ–­
- **ãƒªã‚¹ã‚¯**: PostgreSQLã®ã‚¢ã‚¤ãƒ‰ãƒ«æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚Šæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã‚‹
- **å½±éŸ¿**: æ¬¡å›ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- **ç·©å’Œç­–**: `pool_recycle`ã¨`pool_pre_ping`ã«ã‚ˆã‚Šè‡ªå‹•å†æ¥ç¶š
- **ä¿¡é ¼æ€§**: ğŸ”µ é’ä¿¡å·

### ãƒªã‚¹ã‚¯3: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆ†é›¢
- **ãƒªã‚¹ã‚¯**: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒæ··å…¥ã™ã‚‹
- **å½±éŸ¿**: ãƒ‡ãƒ¼ã‚¿æ±šæŸ“ã€æœ¬ç•ªéšœå®³
- **ç·©å’Œç­–**: `TEST_DATABASE_URL`ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æ˜ç¤ºçš„ãªåˆ†é›¢
- **ä¿¡é ¼æ€§**: ğŸ”µ é’ä¿¡å·

## å‚è€ƒè³‡æ–™

- [SQLAlchemy 2.x Async Documentation](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [FastAPI Dependency Injection](https://fastapi.tiangolo.com/tutorial/dependencies/)
- [pytest-asyncio Documentation](https://pytest-asyncio.readthedocs.io/)
- docs/spec/kotonoha-requirements.md
- docs/design/kotonoha/architecture.md
- docs/tasks/kotonoha-phase2.md

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ›´æ–°å†…å®¹ | æ›´æ–°è€… |
|------|-----------|---------|--------|
| 2025-11-22 | 1.0 | åˆç‰ˆä½œæˆ | Claude Code |
