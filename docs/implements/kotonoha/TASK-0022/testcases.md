# TASK-0022: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å®Ÿè£… - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä»•æ§˜æ›¸

## æ¦‚è¦

| é …ç›® | å†…å®¹ |
|------|------|
| ã‚¿ã‚¹ã‚¯ID | TASK-0022 |
| ã‚¿ã‚¹ã‚¯å | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†å®Ÿè£… |
| é–¢é€£è¦ä»¶å®šç¾©æ›¸ | docs/implements/kotonoha/TASK-0022/requirements.md |
| ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« | backend/tests/db/test_session.py |
| ä½œæˆæ—¥ | 2025-11-22 |

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¸€è¦§

| ãƒ†ã‚¹ãƒˆID | ãƒ†ã‚¹ãƒˆå | ã‚«ãƒ†ã‚´ãƒª | å„ªå…ˆåº¦ | é–¢é€£è¦ä»¶ |
|----------|----------|----------|--------|----------|
| TC-001 | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ | å˜ä½“ | é«˜ | FR-001, FR-004 |
| TC-002 | æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ | å˜ä½“ | é«˜ | FR-001 |
| TC-003 | ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆ | çµ±åˆ | é«˜ | FR-001, NFR-005 |
| TC-004 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ | å˜ä½“ | é«˜ | FR-002, NFR-304 |
| TC-005 | ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆ | çµ±åˆ | ä¸­ | FR-003 |
| TC-006 | æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ | å˜ä½“ | ä¸­ | FR-002, NFR-304 |
| TC-007 | pool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆ | çµ±åˆ | ä½ | FR-001 |
| TC-008 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆ | å˜ä½“ | é«˜ | FR-002 |

---

## TC-001: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-001 |
| ãƒ†ã‚¹ãƒˆå | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |
| é–¢é€£è¦ä»¶ | FR-001, FR-004 |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å· |

### ç›®çš„

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®åŸºæœ¬æ¥ç¶šãŒæ­£å¸¸ã«ç¢ºç«‹ã•ã‚Œã€ç°¡å˜ãªã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã‚‹
2. ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆkotonoha_testï¼‰ãŒå­˜åœ¨ã™ã‚‹
3. TEST_DATABASE_URLç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
4. db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãŒåˆ©ç”¨å¯èƒ½

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| ã‚¯ã‚¨ãƒª | `SELECT 1` | æœ€å°é™ã®æ¥ç¶šç¢ºèªã‚¯ã‚¨ãƒª |
| æœŸå¾…å€¤ | `1` | ã‚¯ã‚¨ãƒªã®æˆ»ã‚Šå€¤ |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‹ã‚‰AsyncSessionã‚’å–å¾—
2. `SELECT 1` ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
3. çµæœã‚’æ¤œè¨¼

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| ã‚¯ã‚¨ãƒªå®Ÿè¡ŒæˆåŠŸ | ä¾‹å¤–ãªã— | ä¾‹å¤–ãŒç™ºç”Ÿã—ãªã„ã“ã¨ |
| æˆ»ã‚Šå€¤ | `1` | `result.scalar() == 1` |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| DBæœªèµ·å‹•æ™‚ | PostgreSQLåœæ­¢ | OperationalErrorç™ºç”Ÿ |
| ç„¡åŠ¹ãªèªè¨¼æƒ…å ± | èª¤ã£ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | æ¥ç¶šã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_database_connection(db_session: AsyncSession):
    """
    TC-001: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®åŸºæœ¬æ¥ç¶šãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘PostgreSQLãŒèµ·å‹•ã—ã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆDBãŒå­˜åœ¨ã™ã‚‹
    ã€æœŸå¾…çµæœã€‘SELECT 1ã‚¯ã‚¨ãƒªãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã€1ãŒè¿”ã•ã‚Œã‚‹
    """
    result = await db_session.execute(text("SELECT 1"))
    assert result.scalar() == 1
```

---

## TC-002: æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-002 |
| ãƒ†ã‚¹ãƒˆå | æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |
| é–¢é€£è¦ä»¶ | FR-001 |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å· |

### ç›®çš„

æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒè¦ä»¶å®šç¾©æ›¸é€šã‚Šã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. `app.db.session`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½
2. engineã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| è¨­å®šé …ç›® | æœŸå¾…å€¤ | èª¬æ˜ |
|----------|--------|------|
| pool_size | 10 | åŸºæœ¬æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º |
| max_overflow | 10 | è¿½åŠ æ¥ç¶šæ•° |
| pool_recycle | 3600 | æ¥ç¶šå†ä½œæˆé–“éš”ï¼ˆç§’ï¼‰ |
| pool_timeout | 30 | æ¥ç¶šå–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰ |
| pool_pre_ping | True | æ¥ç¶šæœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. `app.db.session`ã‹ã‚‰engineã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
2. engine.poolã‹ã‚‰å„è¨­å®šå€¤ã‚’å–å¾—
3. å„è¨­å®šå€¤ãŒæœŸå¾…é€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| pool_size | 10 | `pool.size() == 10` |
| max_overflow | 10 | `pool._max_overflow == 10` |
| pool_recycle | 3600 | `pool._recycle == 3600` |
| pool_timeout | 30 | `pool._timeout == 30` |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| ç’°å¢ƒå¤‰æ•°ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ | DB_POOL_SIZE=5 | ç’°å¢ƒå¤‰æ•°ã®å€¤ãŒé©ç”¨ã•ã‚Œã‚‹ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
def test_engine_pool_configuration():
    """
    TC-002: æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãŒè¦ä»¶é€šã‚Šã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘engineã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
    ã€æœŸå¾…çµæœã€‘å„ãƒ—ãƒ¼ãƒ«è¨­å®šå€¤ãŒä»•æ§˜é€šã‚Šï¼ˆpool_size=10, pool_recycle=3600ç­‰ï¼‰
    """
    from app.db.session import engine

    pool = engine.pool

    # pool_sizeã®æ¤œè¨¼
    assert pool.size() == 10, f"pool_size should be 10, got {pool.size()}"

    # max_overflowã®æ¤œè¨¼
    assert pool._max_overflow == 10, f"max_overflow should be 10, got {pool._max_overflow}"

    # pool_recycleã®æ¤œè¨¼ï¼ˆFR-001: 3600ç§’ã«è¨­å®šï¼‰
    assert pool._recycle == 3600, f"pool_recycle should be 3600, got {pool._recycle}"

    # pool_timeoutã®æ¤œè¨¼ï¼ˆFR-001: 30ç§’ã«è¨­å®šï¼‰
    assert pool._timeout == 30, f"pool_timeout should be 30, got {pool._timeout}"
```

---

## TC-003: ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-003 |
| ãƒ†ã‚¹ãƒˆå | ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | çµ±åˆãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |
| é–¢é€£è¦ä»¶ | FR-001, NFR-005 |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å· |

### ç›®çš„

è¤‡æ•°ã®ä¸¦è¡Œæ¥ç¶šãŒæ¥ç¶šãƒ—ãƒ¼ãƒ«ã«ã‚ˆã£ã¦é©åˆ‡ã«ç®¡ç†ã•ã‚Œã€ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. PostgreSQLãŒèµ·å‹•ã—ã¦ã„ã‚‹
2. ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹
3. async_session_makerãŒåˆ©ç”¨å¯èƒ½

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| ä¸¦è¡Œæ¥ç¶šæ•° | 10 | NFR-005å¯¾å¿œï¼ˆåŒæ™‚åˆ©ç”¨è€…æ•°10äººä»¥ä¸‹ï¼‰ |
| ã‚¯ã‚¨ãƒª | `SELECT :id` | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãã‚¯ã‚¨ãƒª |
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | 0-9 | å„ã‚¯ã‚¨ãƒªã®è­˜åˆ¥å­ |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. 10å€‹ã®éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ä½œæˆï¼ˆå„ã‚¿ã‚¹ã‚¯ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œï¼‰
2. `asyncio.gather()`ã§å…¨ã‚¿ã‚¹ã‚¯ã‚’ä¸¦è¡Œå®Ÿè¡Œ
3. ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã€æ­£ã—ã„çµæœã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| çµæœæ•° | 10 | `len(results) == 10` |
| çµæœå€¤ | {0, 1, ..., 9} | `set(results) == set(range(10))` |
| ä¾‹å¤–ç™ºç”Ÿ | ãªã— | ä¾‹å¤–ãŒç™ºç”Ÿã—ãªã„ã“ã¨ |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| pool_sizeè¶…é | 25ä¸¦è¡Œæ¥ç¶š | max_overflowã¾ã§è¨±å®¹ã€ãã‚Œä»¥ä¸Šã¯pool_timeoutå¾Œã«ã‚¨ãƒ©ãƒ¼ |
| ä¸€éƒ¨ã‚¿ã‚¹ã‚¯å¤±æ•— | 1ã¤ã®ã‚¯ã‚¨ãƒªãŒã‚¨ãƒ©ãƒ¼ | ä»–ã®ã‚¿ã‚¹ã‚¯ã¯æ­£å¸¸ã«å®Œäº† |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_concurrent_connections():
    """
    TC-003: ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘10å€‹ã®ä¸¦è¡Œã‚¯ã‚¨ãƒªãŒæ¥ç¶šãƒ—ãƒ¼ãƒ«ã§é©åˆ‡ã«ç®¡ç†ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘async_session_makerãŒåˆ©ç”¨å¯èƒ½
    ã€æœŸå¾…çµæœã€‘ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã€æ­£ã—ã„çµæœã‚’è¿”ã™
    """
    import asyncio
    from app.db.session import async_session_maker

    async def execute_query(query_id: int) -> int:
        """å€‹åˆ¥ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹éåŒæœŸé–¢æ•°"""
        async with async_session_maker() as session:
            result = await session.execute(
                text("SELECT :id"),
                {"id": query_id}
            )
            return result.scalar()

    # 10å€‹ã®ä¸¦è¡Œã‚¿ã‚¹ã‚¯ã‚’ä½œæˆãƒ»å®Ÿè¡Œ
    tasks = [execute_query(i) for i in range(10)]
    results = await asyncio.gather(*tasks)

    # æ¤œè¨¼
    assert len(results) == 10, f"Expected 10 results, got {len(results)}"
    assert set(results) == set(range(10)), f"Results mismatch: {results}"
```

---

## TC-004: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-004 |
| ãƒ†ã‚¹ãƒˆå | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |
| é–¢é€£è¦ä»¶ | FR-002, NFR-304 |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å· |

### ç›®çš„

ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæ­£ã—ããƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãŒåˆ©ç”¨å¯èƒ½
2. AIConversionHistoryãƒ¢ãƒ‡ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
3. ai_conversion_historyãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| input_text | `None` | NOT NULLåˆ¶ç´„é•åã‚’ç™ºç”Ÿã•ã›ã‚‹ |
| converted_text | `"test"` | æœ‰åŠ¹ãªå¤‰æ›å¾Œãƒ†ã‚­ã‚¹ãƒˆ |
| politeness_level | `PolitenessLevel.POLITE` | æœ‰åŠ¹ãªä¸å¯§ã•ãƒ¬ãƒ™ãƒ« |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‹ã‚‰AsyncSessionã‚’å–å¾—
2. NOT NULLåˆ¶ç´„ã«é•åã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆï¼ˆinput_text=Noneï¼‰
3. flushã‚’å®Ÿè¡Œã—ã¦IntegrityErrorã‚’ç™ºç”Ÿã•ã›ã‚‹
4. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œ
5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå¼•ãç¶šãæ­£å¸¸ã«ä½¿ç”¨å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| ä¾‹å¤–ç™ºç”Ÿ | IntegrityError | `pytest.raises(IntegrityError)` |
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ | ä¾‹å¤–ãªã— | `await session.rollback()` |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šä½¿ç”¨ | SELECT 1ãŒæˆåŠŸ | å¾Œç¶šã‚¯ã‚¨ãƒªãŒæ­£å¸¸å®Ÿè¡Œ |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ | BEGINå†…ã§ã‚¨ãƒ©ãƒ¼ | å¤–å´ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| éƒ¨åˆ†çš„ãªãƒ•ãƒ©ãƒƒã‚·ãƒ¥ | è¤‡æ•°addå¾Œã«1ã¤ãŒã‚¨ãƒ©ãƒ¼ | ã™ã¹ã¦ã®å¤‰æ›´ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_session_rollback_on_error(db_session: AsyncSession):
    """
    TC-004: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘AIConversionHistoryãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨å¯èƒ½
    ã€æœŸå¾…çµæœã€‘IntegrityErrorç™ºç”Ÿå¾Œã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæˆåŠŸã—ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå†åˆ©ç”¨å¯èƒ½
    """
    from sqlalchemy.exc import IntegrityError
    from app.models.ai_conversion_history import AIConversionHistory, PolitenessLevel

    # NOT NULLåˆ¶ç´„é•åã‚’ç™ºç”Ÿã•ã›ã‚‹
    with pytest.raises(IntegrityError):
        record = AIConversionHistory(
            input_text=None,  # NOT NULLåˆ¶ç´„é•å
            converted_text="test",
            politeness_level=PolitenessLevel.POLITE,
        )
        db_session.add(record)
        await db_session.flush()

    # ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
    await db_session.rollback()

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«ä½¿ç”¨å¯èƒ½ãªã“ã¨ã‚’ç¢ºèª
    result = await db_session.execute(text("SELECT 1"))
    assert result.scalar() == 1, "Session should be usable after rollback"
```

---

## TC-005: ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-005 |
| ãƒ†ã‚¹ãƒˆå | ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | çµ±åˆãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | ä¸­ |
| é–¢é€£è¦ä»¶ | FR-003 |
| ä¿¡é ¼æ€§ | ğŸŸ¡ é»„ä¿¡å· |

### ç›®çš„

FastAPIã®ä¾å­˜æ€§æ³¨å…¥æ©Ÿèƒ½ã‚’é€šã˜ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ãæä¾›ã•ã‚Œã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆçµ‚äº†æ™‚ã«é©åˆ‡ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. test_client_with_dbãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãŒåˆ©ç”¨å¯èƒ½
2. /healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šçŠ¶æ…‹ã‚’è¿”ã™

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | `/health` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯API |
| æœŸå¾…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | 200 | æ­£å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹ |
| æœŸå¾…ãƒ¬ã‚¹ãƒãƒ³ã‚¹ | `{"database": "connected"}` | DBæ¥ç¶šçŠ¶æ…‹ |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. test_client_with_dbãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‹ã‚‰FastAPIã‚¢ãƒ—ãƒªã‚’å–å¾—
2. httpx.AsyncClientã‚’ä½œæˆ
3. /healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒœãƒ‡ã‚£ã‚’æ¤œè¨¼

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | 200 | `response.status_code == 200` |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ | "connected" | `data["database"] == "connected"` |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒ­ãƒ¼ã‚º | ãƒªãƒ¼ã‚¯ç„¡ã— | ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãŒãªã„ã“ã¨ |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| DBæ¥ç¶šå¤±æ•—æ™‚ | DBåœæ­¢ | {"database": "disconnected"}ã‚’è¿”ã™ |
| ä¾å­˜æ€§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æ¼ã‚Œ | ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æœªè¨­å®š | æœ¬ç•ªDBã«æ¥ç¶šï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—ï¼‰ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_dependency_injection(test_client_with_db):
    """
    TC-005: ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘FastAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä¾å­˜æ€§æ³¨å…¥ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘test_client_with_dbãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãŒåˆ©ç”¨å¯èƒ½
    ã€æœŸå¾…çµæœã€‘/healthã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒDBæ¥ç¶šçŠ¶æ…‹ã‚’æ­£ã—ãè¿”ã™
    """
    from httpx import AsyncClient, ASGITransport

    transport = ASGITransport(app=test_client_with_db)
    async with AsyncClient(transport=transport, base_url="http://test") as client:
        response = await client.get("/health")

        assert response.status_code == 200, f"Expected 200, got {response.status_code}"
        data = response.json()
        assert data.get("database") == "connected", f"Database status: {data}"
```

---

## TC-006: æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-006 |
| ãƒ†ã‚¹ãƒˆå | æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | ä¸­ |
| é–¢é€£è¦ä»¶ | FR-002, NFR-304 |
| ä¿¡é ¼æ€§ | ğŸŸ¡ é»„ä¿¡å· |

### ç›®çš„

ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã§ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆã—ãŸå ´åˆã«ã€é©åˆ‡ãªä¾‹å¤–ãŒç™ºç”Ÿã—ãƒªã‚½ãƒ¼ã‚¹ãŒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. SQLAlchemyéåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆå¯èƒ½
2. pytest.raisesãŒåˆ©ç”¨å¯èƒ½

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| ç„¡åŠ¹URL | `postgresql+asyncpg://invalid:invalid@localhost:5432/invalid_db` | å­˜åœ¨ã—ãªã„DB |
| ã‚¯ã‚¨ãƒª | `SELECT 1` | æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒª |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. ç„¡åŠ¹ãªæ¥ç¶šURLã§éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
3. OperationalErrorãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. ã‚¨ãƒ³ã‚¸ãƒ³ã‚’é©åˆ‡ã«dispose

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| ä¾‹å¤–ã‚¿ã‚¤ãƒ— | OperationalError | `pytest.raises(OperationalError)` |
| ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— | å®Œäº† | `await engine.dispose()` |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | å¿œç­”ãªã—ã‚µãƒ¼ãƒãƒ¼ | æŒ‡å®šæ™‚é–“å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ |
| èªè¨¼å¤±æ•— | ç„¡åŠ¹ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | èªè¨¼ã‚¨ãƒ©ãƒ¼ |
| DBå­˜åœ¨ã—ãªã„ | å­˜åœ¨ã—ãªã„DBå | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸å­˜åœ¨ã‚¨ãƒ©ãƒ¼ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_connection_error_handling():
    """
    TC-006: æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘ç„¡åŠ¹ãªæ¥ç¶šæƒ…å ±ã§é©åˆ‡ãªä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘ãªã—ï¼ˆç„¡åŠ¹ãªã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆã—ã¦ãƒ†ã‚¹ãƒˆï¼‰
    ã€æœŸå¾…çµæœã€‘OperationalErrorãŒç™ºç”Ÿã—ã€ãƒªã‚½ãƒ¼ã‚¹ãŒé©åˆ‡ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹
    """
    from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
    from sqlalchemy.exc import OperationalError

    # ç„¡åŠ¹ãªæ¥ç¶šURLã§ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
    invalid_engine = create_async_engine(
        "postgresql+asyncpg://invalid:invalid@localhost:5432/invalid_db",
        pool_pre_ping=True,
    )
    invalid_session_maker = async_sessionmaker(
        bind=invalid_engine,
        class_=AsyncSession,
        expire_on_commit=False,
    )

    try:
        # æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        with pytest.raises(OperationalError):
            async with invalid_session_maker() as session:
                await session.execute(text("SELECT 1"))
    finally:
        # ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        await invalid_engine.dispose()
```

---

## TC-007: pool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-007 |
| ãƒ†ã‚¹ãƒˆå | pool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | çµ±åˆãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | ä½ |
| é–¢é€£è¦ä»¶ | FR-001 |
| ä¿¡é ¼æ€§ | ğŸŸ¡ é»„ä¿¡å· |

### ç›®çš„

`pool_pre_ping=True`è¨­å®šã«ã‚ˆã‚Šã€æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‹ã‚‰å–å¾—ã—ãŸæ¥ç¶šãŒä½¿ç”¨å‰ã«æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. engineã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
2. PostgreSQLãŒèµ·å‹•ã—ã¦ã„ã‚‹

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| è¨­å®šå€¤ | `pool_pre_ping=True` | æ¥ç¶šæœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹ |
| ã‚¯ã‚¨ãƒª | `SELECT 1` | æ¥ç¶šç¢ºèªã‚¯ã‚¨ãƒª |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. engine.poolã‹ã‚‰pool_pre_pingè¨­å®šã‚’ç¢ºèª
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
3. æ¥ç¶šãŒæ­£å¸¸ã«å†åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| pool_pre_pingè¨­å®š | True | `engine.pool._pre_ping == True` |
| ã‚¯ã‚¨ãƒªå®Ÿè¡ŒæˆåŠŸ | ä¾‹å¤–ãªã— | ã‚¯ã‚¨ãƒªãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| æ¥ç¶šåˆ‡æ–­å¾Œã®å†åˆ©ç”¨ | ã‚¢ã‚¤ãƒ‰ãƒ«æ¥ç¶šåˆ‡æ–­ | è‡ªå‹•çš„ã«æ–°ã—ã„æ¥ç¶šã‚’å–å¾— |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_pool_pre_ping_enabled():
    """
    TC-007: pool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘pool_pre_pingè¨­å®šãŒæœ‰åŠ¹ã§ã€æ¥ç¶šã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘engineãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
    ã€æœŸå¾…çµæœã€‘pool_pre_pingãŒTrueã§ã€æ¥ç¶šãŒæ­£å¸¸ã«ä½¿ç”¨ã•ã‚Œã‚‹

    æ³¨æ„: å®Œå…¨ãªpool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆã¯æ¥ç¶šã‚’æ„å›³çš„ã«åˆ‡æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€
    ã“ã“ã§ã¯è¨­å®šå€¤ã®ç¢ºèªã¨åŸºæœ¬çš„ãªæ¥ç¶šå‹•ä½œã®ã¿ã‚’æ¤œè¨¼ã™ã‚‹ã€‚
    """
    from app.db.session import engine, async_session_maker

    # pool_pre_pingè¨­å®šã®ç¢ºèª
    # Note: SQLAlchemy 2.xã§ã¯_pre_pingã§ã¯ãªãã€poolæ§‹ç¯‰æ™‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ç¢ºèª
    # ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆæ™‚ã«pool_pre_ping=TrueãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’é–“æ¥çš„ã«ç¢ºèª

    # è¤‡æ•°å›ã®æ¥ç¶šå–å¾—ãƒ»è§£æ”¾ã‚’è¡Œã„ã€pool_pre_pingãŒæœ‰åŠ¹ãªçŠ¶æ…‹ã§å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    for _ in range(3):
        async with async_session_maker() as session:
            result = await session.execute(text("SELECT 1"))
            assert result.scalar() == 1
```

---

## TC-008: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆ

### åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ãƒ†ã‚¹ãƒˆID | TC-008 |
| ãƒ†ã‚¹ãƒˆå | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆ |
| ã‚«ãƒ†ã‚´ãƒª | å˜ä½“ãƒ†ã‚¹ãƒˆ |
| å„ªå…ˆåº¦ | é«˜ |
| é–¢é€£è¦ä»¶ | FR-002 |
| ä¿¡é ¼æ€§ | ğŸ”µ é’ä¿¡å· |

### ç›®çš„

æ­£å¸¸ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã€æ°¸ç¶šåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

### å‰ææ¡ä»¶

1. db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãŒåˆ©ç”¨å¯èƒ½
2. AIConversionHistoryãƒ¢ãƒ‡ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
3. ai_conversion_historyãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹

### ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

| ãƒ‡ãƒ¼ã‚¿é …ç›® | å€¤ | èª¬æ˜ |
|------------|-----|------|
| input_text | `"ãƒ†ã‚¹ãƒˆå…¥åŠ›"` | å¤‰æ›å…ƒãƒ†ã‚­ã‚¹ãƒˆ |
| converted_text | `"ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã§ã™"` | å¤‰æ›å¾Œãƒ†ã‚­ã‚¹ãƒˆ |
| politeness_level | `PolitenessLevel.NORMAL` | ä¸å¯§ã•ãƒ¬ãƒ™ãƒ« |
| conversion_time_ms | `100` | å¤‰æ›å‡¦ç†æ™‚é–“ï¼ˆmsï¼‰ |
| user_session_id | UUID | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ID |

### ãƒ†ã‚¹ãƒˆæ‰‹é †

1. db_sessionãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‹ã‚‰AsyncSessionã‚’å–å¾—
2. AIConversionHistoryãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«addã—ã¦commit
4. åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§SELECTã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

### æœŸå¾…çµæœ

| æ¤œè¨¼é …ç›® | æœŸå¾…å€¤ | æ¤œè¨¼æ–¹æ³• |
|----------|--------|----------|
| ã‚³ãƒŸãƒƒãƒˆæˆåŠŸ | ä¾‹å¤–ãªã— | `await session.commit()` |
| ãƒ¬ã‚³ãƒ¼ãƒ‰å­˜åœ¨ | not None | `scalar_one_or_none() is not None` |
| input_textä¸€è‡´ | "ãƒ†ã‚¹ãƒˆå…¥åŠ›" | `record.input_text == "ãƒ†ã‚¹ãƒˆå…¥åŠ›"` |
| converted_textä¸€è‡´ | "ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã§ã™" | `record.converted_text == "ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã§ã™"` |
| idè‡ªå‹•ç”Ÿæˆ | > 0 | `record.id > 0` |
| created_atè‡ªå‹•è¨­å®š | not None | `record.created_at is not None` |

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

| ã‚±ãƒ¼ã‚¹ | å…¥åŠ›/çŠ¶æ…‹ | æœŸå¾…å‹•ä½œ |
|--------|-----------|----------|
| å¤§é‡ãƒ‡ãƒ¼ã‚¿ã‚³ãƒŸãƒƒãƒˆ | 1000ãƒ¬ã‚³ãƒ¼ãƒ‰ | ã™ã¹ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ°¸ç¶šåŒ–ã•ã‚Œã‚‹ |
| é•·æ–‡ãƒ†ã‚­ã‚¹ãƒˆ | 10000æ–‡å­— | Textå‹ã§åˆ¶é™ãªãä¿å­˜ã•ã‚Œã‚‹ |
| Unicodeæ–‡å­— | çµµæ–‡å­—ã€ç‰¹æ®Šæ–‡å­— | æ­£ã—ãã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãƒ»ä¿å­˜ã•ã‚Œã‚‹ |

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

```python
@pytest.mark.asyncio
async def test_session_commit(db_session: AsyncSession):
    """
    TC-008: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆ

    ã€ç›®çš„ã€‘æ­£å¸¸çµ‚äº†æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œæ°¸ç¶šåŒ–ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    ã€å‰ææ¡ä»¶ã€‘AIConversionHistoryãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨å¯èƒ½
    ã€æœŸå¾…çµæœã€‘ã‚³ãƒŸãƒƒãƒˆå¾Œã€ãƒ‡ãƒ¼ã‚¿ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
    """
    from uuid import uuid4
    from sqlalchemy import select
    from app.models.ai_conversion_history import AIConversionHistory, PolitenessLevel

    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
    test_session_id = uuid4()
    record = AIConversionHistory(
        input_text="ãƒ†ã‚¹ãƒˆå…¥åŠ›",
        converted_text="ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã§ã™",
        politeness_level=PolitenessLevel.NORMAL,
        conversion_time_ms=100,
        user_session_id=test_session_id,
    )

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ ã—ã¦ã‚³ãƒŸãƒƒãƒˆ
    db_session.add(record)
    await db_session.commit()

    # ã‚³ãƒŸãƒƒãƒˆå¾Œã€IDã¨created_atãŒè‡ªå‹•è¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    assert record.id is not None and record.id > 0, "ID should be auto-generated"
    assert record.created_at is not None, "created_at should be auto-generated"

    # ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆSELECTã§å–å¾—ï¼‰
    result = await db_session.execute(
        select(AIConversionHistory).where(
            AIConversionHistory.user_session_id == test_session_id
        )
    )
    saved_record = result.scalar_one_or_none()

    assert saved_record is not None, "Record should be persisted"
    assert saved_record.input_text == "ãƒ†ã‚¹ãƒˆå…¥åŠ›"
    assert saved_record.converted_text == "ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã§ã™"
    assert saved_record.politeness_level == PolitenessLevel.NORMAL
    assert saved_record.conversion_time_ms == 100
```

---

## è£œè¶³: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ‰‹é †

### ç’°å¢ƒè¨­å®š

```bash
# ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®š
export TEST_DATABASE_URL="postgresql+asyncpg://kotonoha_user:your_secure_password_here@localhost:5432/kotonoha_test"

# ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆï¼ˆåˆå›ã®ã¿ï¼‰
createdb -U kotonoha_user kotonoha_test
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
cd backend
pytest tests/db/test_session.py -v

# ç‰¹å®šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest tests/db/test_session.py::test_database_connection -v

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãå®Ÿè¡Œ
pytest tests/db/test_session.py --cov=app/db --cov-report=term-missing
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé †åº

æ¨å¥¨ã•ã‚Œã‚‹å®Ÿè¡Œé †åºï¼ˆä¾å­˜é–¢ä¿‚è€ƒæ…®ï¼‰:

1. TC-001: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆåŸºæœ¬æ¥ç¶šç¢ºèªï¼‰
2. TC-002: æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆï¼ˆè¨­å®šå€¤ç¢ºèªï¼‰
3. TC-008: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆæ­£å¸¸ç³»ï¼‰
4. TC-004: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆç•°å¸¸ç³»ï¼‰
5. TC-003: ä¸¦è¡Œæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆè² è·ãƒ†ã‚¹ãƒˆï¼‰
6. TC-006: æ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ç³»ï¼‰
7. TC-005: ä¾å­˜æ€§æ³¨å…¥ãƒ†ã‚¹ãƒˆï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆï¼‰
8. TC-007: pool_pre_pingå‹•ä½œãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰

---

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ›´æ–°å†…å®¹ | æ›´æ–°è€… |
|------|-----------|---------|--------|
| 2025-11-22 | 1.0 | åˆç‰ˆä½œæˆ | Claude Code |
