# TDD要件定義書: 五十音文字盤UI

## タスク情報

- **タスクID**: TASK-0037
- **機能名**: 五十音文字盤UI実装
- **作成日**: 2025-11-22
- **信頼性レベル**: 🔵 青信号（EARS要件定義書・インターフェース定義に明確に記載）

---

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

### 🔵 機能説明

五十音配列の文字盤UIを表示し、ユーザーがタップした文字を入力バッファに追加する機能。発話困難な方が「できるだけ少ない操作で」文字入力できることを目的とする。

### 🔵 解決する問題

- 発話が困難な方が、タブレットのタップ操作で文字を入力し、コミュニケーションを行える
- 従来のキーボードよりも視認性・操作性に優れた五十音配列を提供

### 🔵 想定されるユーザー

- 脳梗塞・ALS・筋疾患などで発話が難しいが、タブレットのタップ操作がある程度可能な方
- 介護スタッフや家族と会話したい高齢者

### 🔵 システム内での位置づけ

- メイン画面（HomeScreen）の中核コンポーネント
- 入力バッファ管理（TASK-0038）と連携し、文字入力機能を実現
- テーマ実装（TASK-0016）に依存し、フォントサイズ・配色に追従

### 参照したEARS要件

- **REQ-001**: システムは五十音配列の文字盤UIを表示しなければならない 🔵
- **REQ-002**: システムは文字盤の文字をタップすると入力欄に文字を追加しなければならない 🔵
- **REQ-5001**: タップターゲットのサイズを44px × 44px以上としなければならない 🟡
- **NFR-003**: 文字盤タップから入力欄への文字反映までの遅延を100ms以内 🟡
- **NFR-202**: ボタン・タップ領域を視認性が高く押しやすいサイズ（推奨60px × 60px以上）🟡

### 参照した設計文書

- `docs/design/kotonoha/dataflow.md`: 文字盤入力処理フロー
- `docs/design/kotonoha/interfaces.dart`: InputScreenState
- `frontend/kotonoha_app/lib/core/constants/app_sizes.dart`: サイズ定数

---

## 2. 入力・出力の仕様（EARS機能要件・型定義ベース）

### 🔵 入力パラメータ

#### 文字盤ウィジェット

| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| onCharacterTap | `Function(String)` | Yes | 文字タップ時のコールバック |
| fontSize | `FontSize` | No | フォントサイズ設定（デフォルト: medium） |
| isEnabled | `bool` | No | 有効/無効状態（デフォルト: true） |

### 🔵 出力値

- タップされた文字（String）をコールバック経由で返却
- 視覚的フィードバック（タップアニメーション）をUIに反映

### 🔵 データフロー

```
ユーザータップ
    ↓
文字盤ウィジェット（CharacterBoardWidget）
    ↓
onCharacterTap コールバック
    ↓
入力バッファProvider（TASK-0038で実装）
    ↓
UI更新（入力欄に文字表示）
```

### 🔵 表示する文字一覧

#### 基本五十音（あ〜ん）: 46文字

```
あ い う え お
か き く け こ
さ し す せ そ
た ち つ て と
な に ぬ ね の
は ひ ふ へ ほ
ま み む め も
や　 ゆ　 よ
ら り る れ ろ
わ を ん
```

#### 濁音: 20文字

```
が ぎ ぐ げ ご
ざ じ ず ぜ ぞ
だ ぢ づ で ど
ば び ぶ べ ぼ
```

#### 半濁音: 5文字

```
ぱ ぴ ぷ ぺ ぽ
```

#### 拗音（小文字）: 9文字

```
ゃ ゅ ょ
ぁ ぃ ぅ ぇ ぉ
っ
```

#### 句読点・記号: 5文字

```
ー 、 。 ？ ！
```

**合計: 約85文字**

### 参照したEARS要件

- **REQ-001**: 五十音配列の文字盤UI表示
- **REQ-002**: タップで入力欄に文字追加
- **EDGE-101**: 1000文字制限

### 参照した設計文書

- `docs/design/kotonoha/interfaces.dart`: InputScreenState定義
- `docs/design/kotonoha/dataflow.md`: 文字盤入力処理シーケンス図

---

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### 🔵 パフォーマンス要件

| 項目 | 要件 | 根拠 |
|------|------|------|
| タップ応答時間 | 100ms以内 | NFR-003 |
| UI描画 | 60fps維持 | Flutter標準 |
| メモリ使用量 | 最小限 | constウィジェット活用 |

### 🔵 アクセシビリティ要件

| 項目 | 要件 | 根拠 |
|------|------|------|
| タップターゲット最小サイズ | 44px × 44px以上 | REQ-5001, WCAG 2.1 |
| 推奨タップターゲットサイズ | 60px × 60px以上 | NFR-202 |
| フォントサイズ追従 | 設定に連動 | REQ-802 |
| 高コントラスト対応 | WCAG 2.1 AA（4.5:1以上） | REQ-5006 |
| Semanticsウィジェット | 必須 | アクセシビリティ標準 |

### 🔵 レスポンシブ要件

| 項目 | 要件 | 根拠 |
|------|------|------|
| 縦向き対応 | 必須 | NFR-403 |
| 横向き対応 | 必須 | NFR-403 |
| タブレット（9.7インチ以上） | 主要対象 | NFR-402 |
| スマートフォン | 基本動作保証 | NFR-402 |

### 🔵 コード品質要件

| 項目 | 要件 | 根拠 |
|------|------|------|
| Null Safety | 有効必須 | tech-stack.md |
| constコンストラクタ | 可能な限り使用 | CLAUDE.md |
| keyパラメータ | 全ウィジェットに設定 | CLAUDE.md |
| flutter_lints | 準拠 | NFR-503 |

### 参照したEARS要件

- **REQ-5001**: タップターゲットサイズ44px × 44px以上
- **REQ-802**: フォントサイズ設定に追従
- **NFR-003**: 100ms以内の応答
- **NFR-202**: 推奨60px × 60px以上
- **NFR-402**: 9.7インチ以上のタブレット対象
- **NFR-403**: 縦・横画面両対応

### 参照した設計文書

- `docs/tech-stack.md`: 品質基準
- `frontend/kotonoha_app/lib/core/constants/app_sizes.dart`: サイズ定数

---

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 🔵 基本的な使用パターン

#### UC-001: 基本的な文字入力

```
1. ユーザーがホーム画面を表示
2. 五十音文字盤が表示される
3. 「あ」をタップ
4. 入力欄に「あ」が追加される（100ms以内）
5. 視覚的フィードバック（タップアニメーション）が表示される
```

#### UC-002: 連続入力

```
1. 「こ」→「ん」→「に」→「ち」→「は」を順番にタップ
2. 入力欄に「こんにちは」が表示される
3. 各タップで視覚的フィードバックが表示される
```

#### UC-003: 濁音・半濁音入力

```
1. 濁音タブ/セクションに切り替え（または同画面内）
2. 「が」をタップ
3. 入力欄に「が」が追加される
```

#### UC-004: 拗音入力

```
1. 小文字タブ/セクションに切り替え（または同画面内）
2. 「ょ」をタップ
3. 入力欄に「ょ」が追加される
```

### 🔵 エッジケース

#### EDGE-001: 画面回転

```
1. 縦向きで文字盤を表示
2. 端末を横向きに回転
3. 文字盤が再レイアウトされ、適切に表示される
4. タップ機能が正常に動作する
```

#### EDGE-002: フォントサイズ変更

```
1. 設定画面でフォントサイズを「大」に変更
2. 文字盤画面に戻る
3. 文字盤の文字サイズが「大」設定に追従している
```

#### EDGE-003: テーマ変更

```
1. 設定画面でテーマを「ダークモード」に変更
2. 文字盤画面に戻る
3. 文字盤の配色がダークモードに追従している
```

#### EDGE-004: 高速連続タップ

```
1. 「あ」を高速で5回タップ
2. 入力欄に「あああああ」が正しく追加される
3. デバウンス処理で連打による誤動作を防止
```

### 🔴 エラーケース

#### ERR-001: 入力上限到達（TASK-0038で実装予定）

```
1. 入力欄が1000文字に達している
2. 文字盤をタップ
3. 「文字数上限に達しました」という警告が表示される
4. 文字は追加されない
```

### 参照したEARS要件

- **REQ-001**: 五十音文字盤表示
- **REQ-002**: タップで文字追加
- **EDGE-101**: 1000文字制限
- **NFR-403**: 縦・横画面両対応

### 参照した設計文書

- `docs/design/kotonoha/dataflow.md`: 文字盤入力処理シーケンス図

---

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー

- US-001: 発話困難な利用者が、五十音文字盤で伝えたい内容を入力できる

### 参照した機能要件

- **REQ-001**: 五十音配列の文字盤UI表示 🔵
- **REQ-002**: タップで入力欄に文字追加 🔵
- **REQ-802**: フォントサイズ設定に追従 🔵

### 参照した非機能要件

- **NFR-003**: 100ms以内の応答時間 🟡
- **NFR-202**: 推奨60px × 60px以上のタップ領域 🟡
- **NFR-402**: 9.7インチ以上のタブレット対象 🟡
- **NFR-403**: 縦・横画面両対応 🟡

### 参照したEdgeケース

- **EDGE-101**: 1000文字制限（TASK-0038と連携）

### 参照した受け入れ基準

- 五十音すべての文字（あ〜ん、濁音、半濁音、拗音）が表示される
- タップから文字反映まで100ms以内
- 画面回転でも適切に表示される
- フォントサイズ設定に追従する
- アクセシビリティ対応（Semanticsウィジェット使用）

### 参照した設計文書

| ドキュメント | 該当セクション |
|-------------|---------------|
| architecture.md | フロントエンド構成 |
| dataflow.md | 文字盤入力処理フロー |
| interfaces.dart | InputScreenState |
| app_sizes.dart | characterBoardButtonSize定数 |

---

## 6. 実装アーキテクチャ

### 🔵 ウィジェット構成

```
HomeScreen
└── CharacterBoardWidget (新規作成)
    ├── CharacterCategoryTabs (基本/濁音/半濁音/小文字)
    └── CharacterGrid
        └── CharacterButton (各文字ボタン)
```

### 🔵 ファイル配置

```
lib/features/character_board/
├── presentation/
│   ├── home_screen.dart (既存、更新)
│   └── widgets/
│       ├── character_board_widget.dart (新規)
│       ├── character_grid.dart (新規)
│       └── character_button.dart (新規)
└── domain/
    └── character_data.dart (新規: 文字データ定義)
```

### 🟡 状態管理（TASK-0038との連携）

- 本タスクでは文字盤UIのみ実装
- 入力バッファ管理は TASK-0038 で実装予定
- 本タスクでは `onCharacterTap` コールバックで文字を返却するのみ

---

## 品質判定

```
✅ 高品質:
- 要件の曖昧さ: なし（REQ-001, REQ-002で明確に定義）
- 入出力定義: 完全（文字タップ → コールバック → バッファ追加）
- 制約条件: 明確（100ms応答、44px以上、60px推奨）
- 実装可能性: 確実（Flutter標準機能で実現可能）
```

---

**次のお勧めステップ**: `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。
