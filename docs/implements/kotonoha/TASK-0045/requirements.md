# TASK-0045: 緊急ボタンUI実装 - 要件定義書

## 概要

緊急時に介護者や周囲の人を呼び出すための緊急ボタンウィジェットを実装する。目立つデザイン（赤色等）で、すべての画面に常時表示し、誤タップ防止の配置・デザインを実現する。既存のEmergencyButton（TASK-0017）を拡張し、確認ダイアログ連携、テーマ対応、アクセシビリティ対応を追加する。

**タスクタイプ**: TDD
**推定工数**: 8時間

## 関連要件

### 直接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-301 | システムは緊急呼び鈴ボタンをすべての画面で表示しなければならない | 🔵 |
| REQ-302 | システムは緊急ボタンを2段階確認（1回目タップ→確認ダイアログ→2回目確認タップ）で動作させなければならない | 🔵 |
| REQ-5002 | システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない | 🔵 |
| NFR-202 | システムはボタン・タップ領域を視認性が高く押しやすいサイズ（推奨60px × 60px以上）で設計しなければならない | 🟡 |

### 間接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-303 | システムは緊急ボタン押下時に周囲の人が気づきやすい音を発生させなければならない | 🔵 |
| REQ-304 | システムは緊急ボタン押下時に画面全体を目立つ色（赤など）で表示しなければならない | 🟡 |
| REQ-2004 | ユーザーが緊急ボタンを1回タップした場合、システムは「緊急呼び出しを実行しますか?」という確認ダイアログを表示しなければならない | 🔵 |
| REQ-2005 | 緊急呼び出しの確認ダイアログで「はい」をタップした場合、システムは緊急音を発生させ、画面を緊急表示に切り替えなければならない | 🔵 |
| REQ-5001 | システムはタップターゲット（ボタン・キー）のサイズを44px × 44px以上としなければならない | 🟡 |
| REQ-5006 | システムは高コントラストモードでWCAG 2.1 AAレベルのコントラスト比（4.5:1以上）を確保しなければならない | 🟡 |
| REQ-803 | システムは「ライトモード」「ダークモード」「高コントラストモード」の3つのテーマを提供しなければならない | 🔵 |
| EDGE-203 | マナーモード有効時に緊急ボタンが押された場合、システムはマナーモードを一時的に解除して緊急音を鳴らす、または明確な警告を表示しなければならない | 🟡 |

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### FR-001: 目立つデザイン（赤色）
- **要件**: システムは緊急ボタンを赤色（#D32F2F / AppColors.emergency）を基調とした目立つデザインで表示しなければならない
- **根拠**: REQ-301、緊急性の視覚的表現
- **信頼性**: 🔵 青信号

#### FR-002: 円形ボタン形状
- **要件**: システムは緊急ボタンを円形（CircleBorder）で表示しなければならない
- **根拠**: 既存実装（TASK-0017）との一貫性、視認性
- **信頼性**: 🔵 青信号

#### FR-003: 推奨サイズ60px以上
- **要件**: システムは緊急ボタンのサイズを推奨60px以上、最小44px以上としなければならない
- **根拠**: REQ-5001、NFR-202
- **信頼性**: 🔵 青信号

#### FR-004: アイコン表示
- **要件**: システムは緊急ボタンに`notifications_active`アイコンを白色で表示しなければならない
- **根拠**: 既存実装（TASK-0017）との一貫性、緊急性の視覚的表現
- **信頼性**: 🔵 青信号

#### FR-005: 視認性の高い配置
- **要件**: システムは緊急ボタンを画面の固定位置（右下または右上）に常時表示し、他のUI要素と重ならない位置に配置しなければならない
- **根拠**: REQ-301、NFR-203、誤タップ防止
- **信頼性**: 🟡 黄信号

#### FR-006: 他のボタンとの距離確保
- **要件**: システムは緊急ボタンと他の操作ボタンとの間に16px以上の間隔を設け、誤タップを防止しなければならない
- **根拠**: REQ-5002、NFR-202
- **信頼性**: 🟡 黄信号

#### FR-007: Semanticsラベル設定
- **要件**: システムは緊急ボタンに「緊急呼び出しボタン」のSemanticsラベルを設定しなければならない
- **根拠**: アクセシビリティ、スクリーンリーダー対応
- **信頼性**: 🔵 青信号

#### FR-008: エレベーション（影）
- **要件**: システムは緊急ボタンにエレベーション（影）を付与し、他のUI要素から浮き出るデザインとしなければならない
- **根拠**: 視認性向上、REQ-301
- **信頼性**: 🟡 黄信号

### 条件付き要件（WHEN/IF-THEN）

#### FR-101: タップ時の確認ダイアログ表示
- **条件**: ユーザーが緊急ボタンをタップした場合
- **動作**: システムは「緊急呼び出しを実行しますか?」という確認ダイアログを表示しなければならない
- **根拠**: REQ-302、REQ-2004、REQ-5002
- **信頼性**: 🔵 青信号

#### FR-102: 視覚的フィードバック
- **条件**: ユーザーが緊急ボタンをタップした場合
- **動作**: システムはタップ時に視覚的フィードバック（リップルエフェクト、色変化等）を提供しなければならない
- **根拠**: UX標準、アクセシビリティ
- **信頼性**: 🟡 黄信号

#### FR-103: テーマ変更時の配色維持
- **条件**: ユーザーがテーマ（ライト/ダーク/高コントラスト）を変更した場合
- **動作**: システムは緊急ボタンの赤色基調を維持しつつ、テーマに応じたコントラスト調整を行わなければならない
- **根拠**: REQ-803、REQ-5006
- **信頼性**: 🔵 青信号

#### FR-104: 確認ダイアログでの「はい」タップ
- **条件**: 確認ダイアログで「はい」をタップした場合
- **動作**: システムはonEmergencyConfirmedコールバックを呼び出さなければならない（緊急音発生・画面変更は後続タスクで実装）
- **根拠**: REQ-2005、REQ-303、REQ-304
- **信頼性**: 🔵 青信号

#### FR-105: 確認ダイアログでの「いいえ」/キャンセルタップ
- **条件**: 確認ダイアログで「いいえ」またはキャンセルをタップした場合
- **動作**: システムはダイアログを閉じ、通常状態に戻らなければならない
- **根拠**: REQ-302、誤操作防止
- **信頼性**: 🔵 青信号

#### FR-106: 画面回転時のレイアウト維持
- **条件**: デバイスが縦向き/横向きに回転した場合
- **動作**: システムは緊急ボタンの位置と視認性を維持した状態でレイアウトを調整しなければならない
- **根拠**: NFR-403
- **信頼性**: 🟡 黄信号

### 制約要件（MUST）

#### FR-201: 最小タップターゲット保証
- **要件**: 緊急ボタンのタップ領域は、いかなる場合も44px × 44px未満にしてはならない
- **根拠**: REQ-5001、WCAG 2.1 AA
- **信頼性**: 🔵 青信号

#### FR-202: 高コントラストモードでのコントラスト比
- **要件**: 高コントラストモードにおいて、緊急ボタンのアイコン/ラベルと背景のコントラスト比は4.5:1以上でなければならない
- **根拠**: REQ-5006、WCAG 2.1 AA
- **信頼性**: 🔵 青信号

#### FR-203: タップ操作のみでの完結
- **要件**: 緊急ボタンの操作はタップのみで完結し、スワイプやロングプレスを必須としてはならない
- **根拠**: REQ-5005
- **信頼性**: 🔵 青信号

#### FR-204: 確認ステップの必須化
- **要件**: 緊急ボタンの発動には必ず2段階確認（ボタンタップ→確認ダイアログ→確認タップ）を必須としなければならない
- **根拠**: REQ-302、REQ-5002
- **信頼性**: 🔵 青信号

### オプション要件（MAY）

#### FR-301: 振動フィードバック
- **要件**: システムは緊急ボタンタップ時に軽い振動フィードバックを提供してもよい
- **根拠**: アクセシビリティ向上、UX向上
- **信頼性**: 🟡 黄信号

#### FR-302: アニメーション効果
- **要件**: システムは緊急ボタンに軽いパルスアニメーション（脈動効果）を追加してもよい
- **根拠**: 視認性向上
- **信頼性**: 🔴 赤信号

## 非機能要件

### パフォーマンス

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-P001 | タップからの視覚フィードバックは100ms以内 | NFR-003 | 🟡 |
| NFR-P002 | 確認ダイアログの表示は300ms以内 | UX標準 | 🟡 |
| NFR-P003 | 緊急ボタンの初回レンダリングは100ms以内 | UX標準 | 🟡 |

### ユーザビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-U001 | ボタンは一目で「緊急」と認識できるデザイン | REQ-301、REQ-303 | 🔵 |
| NFR-U002 | 他の操作ボタンから十分に離れた位置に配置 | REQ-5002、誤タップ防止 | 🔵 |
| NFR-U003 | 確認ダイアログの文言は明確で理解しやすい日本語 | NFR-204 | 🟡 |
| NFR-U004 | 確認ダイアログの「はい」「いいえ」ボタンは大きく押しやすい | NFR-202 | 🟡 |

### アクセシビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-A001 | Semanticsラベルで「緊急呼び出しボタン」と読み上げ可能 | WCAG、スクリーンリーダー対応 | 🔵 |
| NFR-A002 | 色だけでなくアイコンで緊急性を表現 | 色覚多様性対応 | 🔵 |
| NFR-A003 | 確認ダイアログにも適切なSemanticsを設定 | アクセシビリティ | 🟡 |
| NFR-A004 | 高コントラストモードでも視認性を確保 | REQ-5006 | 🔵 |

## エッジケース・境界値

### エッジケース

#### EDGE-001: 連続タップ
- **状況**: ユーザーが緊急ボタンを短時間に連続タップした場合
- **期待動作**: システムは最初のタップで確認ダイアログを表示し、ダイアログ表示中は後続タップを無視する
- **信頼性**: 🟡 黄信号

#### EDGE-002: ダイアログ表示中の画面回転
- **状況**: 確認ダイアログ表示中にデバイスが回転した場合
- **期待動作**: システムはダイアログを維持し、レイアウトを適切に調整する
- **信頼性**: 🟡 黄信号

#### EDGE-003: ダイアログ表示中のアプリバックグラウンド化
- **状況**: 確認ダイアログ表示中にアプリがバックグラウンドに移動した場合
- **期待動作**: システムはフォアグラウンド復帰時にダイアログを再表示する、または閉じて通常状態に戻る
- **信頼性**: 🟡 黄信号

#### EDGE-004: 超小画面での表示
- **状況**: 画面幅が狭い端末（スマートフォン等）で表示した場合
- **期待動作**: システムはボタンサイズを最小44pxまで縮小するが、それ以下にはしない
- **信頼性**: 🟡 黄信号

#### EDGE-005: 確認ダイアログ表示中の他タップ
- **状況**: 確認ダイアログ表示中にダイアログ外をタップした場合
- **期待動作**: システムはダイアログを閉じ、通常状態に戻る（誤タップ防止のため即座に閉じる）
- **信頼性**: 🟡 黄信号

### 境界値

| 項目 | 最小値 | 推奨値 | 最大値 |
|------|--------|--------|--------|
| ボタンサイズ | 44px | 60px | 80px |
| エレベーション | 2 | 4 | 8 |
| 他ボタンとの間隔 | 16px | 24px | 制限なし |
| アイコンサイズ | 24px | 28px | 32px |
| 確認ダイアログの「はい」ボタン幅 | 100px | 120px | 画面幅の40% |
| 確認ダイアログの「いいえ」ボタン幅 | 100px | 120px | 画面幅の40% |

## 受け入れ基準

### 機能テスト

- [ ] AC-001: 緊急ボタンが円形で赤色（#D32F2F）で表示される
- [ ] AC-002: 緊急ボタンのサイズが60px × 60px（デフォルト）である
- [ ] AC-003: `notifications_active`アイコンが白色で表示される
- [ ] AC-004: タップ時に視覚的フィードバック（リップル）が表示される
- [ ] AC-005: タップ時に確認ダイアログが表示される
- [ ] AC-006: 確認ダイアログに「緊急呼び出しを実行しますか?」のメッセージが表示される
- [ ] AC-007: 確認ダイアログに「はい」「いいえ」ボタンが表示される
- [ ] AC-008: 「はい」タップでonEmergencyConfirmedコールバックが呼び出される
- [ ] AC-009: 「いいえ」タップでダイアログが閉じる
- [ ] AC-010: ダイアログ外タップでダイアログが閉じる
- [ ] AC-011: ボタンにエレベーション（影）が適用されている

### アクセシビリティテスト

- [ ] AC-012: Semanticsラベルに「緊急呼び出しボタン」が設定されている
- [ ] AC-013: 高コントラストモードでコントラスト比4.5:1以上を確保している
- [ ] AC-014: 確認ダイアログのボタンサイズが44px以上である

### テーマ対応テスト

- [ ] AC-015: ライトモードで適切な配色で表示される
- [ ] AC-016: ダークモードで適切な配色で表示される
- [ ] AC-017: 高コントラストモードで適切な配色で表示される

### エッジケーステスト

- [ ] AC-018: 連続タップ時に複数のダイアログが表示されない
- [ ] AC-019: 画面回転時にボタンの視認性が維持される
- [ ] AC-020: カスタムサイズ（例: 80px）が適用される
- [ ] AC-021: 最小サイズ（44px）が保証される

### 配置テスト

- [ ] AC-022: ボタンが他のUI要素と重ならない位置に配置できる
- [ ] AC-023: Positionedウィジェット等で固定位置に配置できる

## 技術仕様

### 使用コンポーネント（既存）

- `EmergencyButton` ウィジェット（TASK-0017で実装済み、拡張対象）
- `AppColors.emergency` 色定数（既存、`core/constants/app_colors.dart`）
- `AppSizes` 定数（既存、`core/constants/app_sizes.dart`）

### 新規作成・拡張ウィジェット

| ウィジェット名 | 説明 |
|----------------|------|
| `EmergencyButtonWithConfirmation` | 確認ダイアログ付き緊急ボタン（EmergencyButtonを拡張） |
| `EmergencyConfirmationDialog` | 緊急呼び出し確認ダイアログ |

### インターフェース設計

```dart
/// 緊急ボタンウィジェット（確認ダイアログ付き）
///
/// REQ-301: 全画面で常時表示
/// REQ-302: 2段階確認
/// REQ-5002: 誤操作防止
class EmergencyButtonWithConfirmation extends StatelessWidget {
  /// 緊急呼び出し確認後のコールバック
  final VoidCallback onEmergencyConfirmed;

  /// ボタンサイズ（デフォルト: 60px）
  final double size;

  /// 確認ダイアログをカスタマイズするためのビルダー（オプション）
  final Widget Function(BuildContext context, VoidCallback onConfirm, VoidCallback onCancel)? dialogBuilder;

  const EmergencyButtonWithConfirmation({
    super.key,
    required this.onEmergencyConfirmed,
    this.size = 60.0,
    this.dialogBuilder,
  });
}

/// 緊急呼び出し確認ダイアログ
///
/// REQ-2004: 確認ダイアログ表示
/// REQ-2005: 確認後の動作
class EmergencyConfirmationDialog extends StatelessWidget {
  /// 「はい」ボタンタップ時のコールバック
  final VoidCallback onConfirm;

  /// 「いいえ」ボタンタップ時のコールバック
  final VoidCallback onCancel;

  const EmergencyConfirmationDialog({
    super.key,
    required this.onConfirm,
    required this.onCancel,
  });
}

/// 緊急状態の列挙型（interfaces.dartから参照）
/// REQ-301, REQ-302, REQ-303, REQ-304
enum EmergencyState {
  /// 通常状態
  normal,
  /// 確認ダイアログ表示中
  confirmationDialog,
  /// 緊急音再生中・画面赤表示中
  alertActive,
}
```

### 配置・レイアウト

```
+--------------------------------------------------+
|  [  はい  ]   [  いいえ  ]   [ わからない ]       |  <- QuickResponseButtons
+--------------------------------------------------+
|  [ 痛い ]  [ トイレ ]  [ 暑い ]   [ 寒い ]        |  <- StatusButtons
|  [  水  ]  [ 眠い  ]  [ 助けて ] [ 待って ]       |
+--------------------------------------------------+
|                                                  |
|              （文字盤エリア）                      |
|                                                  |
|                                            [SOS] |  <- EmergencyButton（右下固定）
+--------------------------------------------------+

※ または右上に配置

+--------------------------------------------------+
|                                            [SOS] |  <- EmergencyButton（右上固定）
|  [  はい  ]   [  いいえ  ]   [ わからない ]       |
+--------------------------------------------------+
...
```

### 確認ダイアログデザイン

```
+------------------------------------------+
|                                          |
|         緊急呼び出し                      |
|                                          |
|   緊急呼び出しを実行しますか?             |
|                                          |
|   周囲に緊急音が鳴り、画面が              |
|   赤くなります。                          |
|                                          |
|   +----------+      +----------+         |
|   |   はい   |      |  いいえ  |         |
|   +----------+      +----------+         |
|                                          |
+------------------------------------------+
```

### カラースキーム

| 状態 | ライトモード | ダークモード | 高コントラスト |
|------|--------------|--------------|----------------|
| 通常 | 赤（#D32F2F） | 赤（#EF5350） | 赤（#FF0000）白アイコン |
| タップ時 | 濃い赤（#B71C1C） | 濃い赤（#C62828） | 濃い赤（#CC0000） |
| 確認ダイアログ背景 | 白 | グレー | 白 |
| 「はい」ボタン | 赤（#D32F2F） | 赤（#EF5350） | 赤（#FF0000） |
| 「いいえ」ボタン | グレー（#757575） | グレー（#BDBDBD） | 黒（#000000）白文字 |

## 依存関係

### 依存するタスク（完了済み）

- TASK-0017: 共通UIコンポーネント実装（EmergencyButtonの基本実装） ✅
- TASK-0016: テーマ実装（ライト・ダーク・高コントラスト） ✅
- TASK-0043: 「はい」「いいえ」「わからない」大ボタン実装 ✅
- TASK-0044: 状態ボタン実装 ✅

### 後続タスクへの影響

- TASK-0046: 緊急呼び出しダイアログ・確認フロー - EmergencyButtonWithConfirmationのダイアログ機能を利用
- TASK-0047: 緊急音再生・画面表示 - onEmergencyConfirmedコールバックで緊急状態へ遷移
- TASK-0048: OS標準TTS連携 - 緊急メッセージ読み上げ機能

## 設計上の考慮事項

### TASK-0017との関係

TASK-0017で実装されたEmergencyButtonを以下のように拡張:

1. **基本EmergencyButton**: 単純なボタン（onPressedコールバック）→ そのまま維持
2. **EmergencyButtonWithConfirmation**: 確認ダイアログ付き（2段階確認）→ 新規追加

両方のウィジェットを提供し、用途に応じて選択可能とする。

### 誤タップ防止の設計

1. **2段階確認**: ボタンタップ→確認ダイアログ→確認タップ
2. **配置**: 他のボタンから離れた位置（右下/右上の角）
3. **間隔**: 他のUI要素との間に16px以上の余白
4. **ダイアログ外タップ**: キャンセルとして扱う（即座に閉じる）

### アクセシビリティ対応

1. **Semanticsラベル**: 「緊急呼び出しボタン」
2. **色以外の識別**: アイコン（notifications_active）による識別
3. **高コントラスト**: 白アイコン on 赤背景（コントラスト比確保）
4. **タップターゲット**: 最小44px、推奨60px

### テーマ対応

緊急ボタンは赤色を基調とし、テーマによって大きく変更しない。ただし:
- ダークモード: やや明るい赤（#EF5350）で視認性確保
- 高コントラストモード: 純粋な赤（#FF0000）と白アイコンで最大コントラスト

## 備考

- 信頼性レベル凡例:
  - 🔵 **青信号**: 要件定義書に明確に記載された要件
  - 🟡 **黄信号**: 要件定義書から妥当に推測される要件
  - 🔴 **赤信号**: 要件定義書にない推測による要件

- 本タスクではUIウィジェットの実装に焦点を当て、緊急音再生・画面全体の赤表示は後続タスク（TASK-0047）で実装する
- EmergencyStateの状態管理はRiverpodプロバイダーで管理（後続タスクで詳細設計）

---

**ドキュメント作成日**: 2025-11-24
**タスクID**: TASK-0045
**関連要件**: REQ-301, REQ-302, REQ-5002, NFR-202
