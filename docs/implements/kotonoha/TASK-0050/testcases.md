# TTS読み上げ中断機能 - テストケース一覧

## タスク情報

- **タスクID**: TASK-0050
- **タスク名**: TTS読み上げ中断機能
- **関連要件**: REQ-403, REQ-3003
- **テストフレームワーク**: flutter_test + mocktail
- **作成日**: 2025-11-26

## テストケースサマリー

| カテゴリ | テストケース数 |
|----------|---------------|
| 正常系（UI表示） | 5 |
| 正常系（状態管理） | 4 |
| 異常系 | 3 |
| 境界値 | 2 |
| 統合テスト | 3 |
| **合計** | **17** |

---

## 1. 正常系テストケース（UI表示）

### TC-050-001: アイドル状態で「読み上げ」ボタンが表示される

- **テスト名**: アイドル状態で「読み上げ」ボタンが表示される
  - **何をテストするか**: TTSがidle状態の時、読み上げボタンが表示されること
  - **期待される動作**: 「読み上げ」ラベルのボタンがレンダリングされる
- **入力値**: TTSState.idle
  - **入力データの意味**: アプリ起動直後の初期状態
- **期待される結果**: 「読み上げ」ボタンが表示される
  - **期待結果の理由**: REQ-402「読み上げボタンを明確に表示」
- **テストの目的**: ボタンの初期表示確認
  - **確認ポイント**: ボタンラベルが「読み上げ」であること
- 🔵 青信号: REQ-402、REQ-3003に基づく

### TC-050-002: 読み上げ中は「停止」ボタンに切り替わる

- **テスト名**: 読み上げ中は「停止」ボタンに切り替わる
  - **何をテストするか**: TTSがspeaking状態の時、停止ボタンが表示されること
  - **期待される動作**: ボタンラベルが「停止」に変わる
- **入力値**: TTSState.speaking
  - **入力データの意味**: 読み上げ中の状態
- **期待される結果**: 「停止」ボタンが表示される
  - **期待結果の理由**: REQ-3003「読み上げ実行中状態では停止ボタンとして表示」
- **テストの目的**: 状態に応じたボタン切り替え確認
  - **確認ポイント**: ボタンラベルが「停止」であること、アイコンが変わること
- 🔵 青信号: REQ-3003に基づく

### TC-050-003: 読み上げ完了後は「読み上げ」ボタンに戻る

- **テスト名**: 読み上げ完了後は「読み上げ」ボタンに戻る
  - **何をテストするか**: 読み上げ完了後にボタンが元の状態に戻ること
  - **期待される動作**: 状態がidle/completedに遷移するとボタンが「読み上げ」に戻る
- **入力値**: speaking → completed → idle
  - **入力データの意味**: 読み上げ完了後の状態遷移
- **期待される結果**: 「読み上げ」ボタンに戻る
  - **期待結果の理由**: 通常の状態遷移フロー
- **テストの目的**: 状態遷移後のUI復帰確認
  - **確認ポイント**: 完了後に再び読み上げ可能な状態になること
- 🔵 青信号: tts_state.dart状態遷移定義に基づく

### TC-050-004: ボタンサイズが44px×44px以上である

- **テスト名**: ボタンサイズが44px×44px以上である
  - **何をテストするか**: アクセシビリティ要件を満たすボタンサイズ
  - **期待される動作**: ボタンのタップ領域が最低44pxを確保
- **入力値**: ウィジェットレンダリング
  - **入力データの意味**: UI構築時のサイズ検証
- **期待される結果**: width >= 44, height >= 44
  - **期待結果の理由**: REQ-5001「タップターゲット44px×44px以上」
- **テストの目的**: アクセシビリティ要件の確認
  - **確認ポイント**: 高齢者や運動機能に制限のあるユーザーが操作しやすいこと
- 🟡 黄信号: REQ-5001から推測

### TC-050-005: ボタンに適切なSemantics（アクセシビリティラベル）が設定されている

- **テスト名**: ボタンにSemanticsが設定されている
  - **何をテストするか**: スクリーンリーダー対応の確認
  - **期待される動作**: Semanticsウィジェットにlabelが設定されている
- **入力値**: ウィジェットツリー検査
  - **入力データの意味**: アクセシビリティツリーの確認
- **期待される結果**: 「読み上げ」または「停止」のラベルが設定されている
  - **期待結果の理由**: アクセシビリティ対応
- **テストの目的**: スクリーンリーダー対応確認
  - **確認ポイント**: 状態に応じた適切なラベルが設定されていること
- 🟡 黄信号: tech-stack.md「Semanticsウィジェット使用」に基づく

---

## 2. 正常系テストケース（状態管理）

### TC-050-006: 読み上げボタンタップでTTS読み上げが開始される

- **テスト名**: 読み上げボタンタップでTTS読み上げが開始される
  - **何をテストするか**: ボタンタップがTTSNotifier.speak()を呼び出すこと
  - **期待される動作**: speak()が呼ばれ、状態がspeakingに遷移
- **入力値**: ボタンタップ + テキスト「こんにちは」
  - **入力データの意味**: ユーザーが読み上げボタンをタップした場合
- **期待される結果**: TTSState.speakingに遷移
  - **期待結果の理由**: REQ-401「入力欄のテキストをTTSで読み上げる」
- **テストの目的**: ボタンとTTSの連携確認
  - **確認ポイント**: UIアクションがビジネスロジックに正しく伝達されること
- 🔵 青信号: REQ-401に基づく

### TC-050-007: 停止ボタンタップでTTS読み上げが中断される

- **テスト名**: 停止ボタンタップでTTS読み上げが中断される
  - **何をテストするか**: 停止ボタンタップがTTSNotifier.stop()を呼び出すこと
  - **期待される動作**: stop()が呼ばれ、状態がstoppedに遷移
- **入力値**: 読み上げ中状態 + 停止ボタンタップ
  - **入力データの意味**: ユーザーが読み上げを中断したい場合
- **期待される結果**: TTSState.stoppedに遷移
  - **期待結果の理由**: REQ-403「読み上げ中の停止・中断機能」
- **テストの目的**: 中断機能の動作確認
  - **確認ポイント**: 読み上げが即座に停止すること
- 🔵 青信号: REQ-403に基づく

### TC-050-008: 停止後にidleに自動遷移する

- **テスト名**: 停止後にidleに自動遷移する
  - **何をテストするか**: stopped状態からidle状態への自動遷移
  - **期待される動作**: stopped後、短時間でidleに戻る
- **入力値**: TTSState.stopped
  - **入力データの意味**: 停止直後の状態
- **期待される結果**: TTSState.idleに自動遷移
  - **期待結果の理由**: tts_state.dart状態遷移定義
- **テストの目的**: 状態遷移の正常動作確認
  - **確認ポイント**: 次の読み上げが可能な状態に戻ること
- 🔵 青信号: tts_state.dart状態遷移定義に基づく

### TC-050-009: 状態変更がRiverpodで正しく監視される

- **テスト名**: 状態変更がRiverpodで正しく監視される
  - **何をテストするか**: 状態変更がConsumerWidgetに通知されること
  - **期待される動作**: container.listen()で状態変更がキャプチャできる
- **入力値**: speak() → stop()の一連の操作
  - **入力データの意味**: 状態遷移のシナリオ
- **期待される結果**: idle → speaking → stopped の順で通知
  - **期待結果の理由**: Riverpodの状態管理パターン
- **テストの目的**: 状態管理とUI更新の連携確認
  - **確認ポイント**: UIが状態変更に追従すること
- 🔵 青信号: 既存テストパターン（TC-048-022）に基づく

---

## 3. 異常系テストケース

### TC-050-010: アイドル状態で停止ボタンをタップしてもエラーにならない

- **テスト名**: アイドル状態で停止ボタンをタップしてもエラーにならない
  - **エラーケースの概要**: idle状態でstop()が呼ばれた場合
  - **エラー処理の重要性**: 冪等性の確保
- **入力値**: TTSState.idle + stop()呼び出し
  - **不正な理由**: 読み上げ中でないのに停止を要求
  - **実際の発生シナリオ**: UIの遅延で状態とボタンがずれた場合
- **期待される結果**: エラーなし、状態はidleのまま（またはstopped→idleに遷移）
  - **エラーメッセージの内容**: エラーメッセージは表示されない
  - **システムの安全性**: アプリはクラッシュしない
- **テストの目的**: 冪等性の確認
  - **品質保証の観点**: 予期しない操作に対する堅牢性
- 🟡 黄信号: 防御的プログラミングの原則に基づく

### TC-050-011: 連続した停止ボタンタップが安全に処理される

- **テスト名**: 連続した停止ボタンタップが安全に処理される
  - **エラーケースの概要**: 停止ボタンを連打した場合
  - **エラー処理の重要性**: UIの安全性確保
- **入力値**: 停止ボタン連続タップ（2回以上）
  - **不正な理由**: 通常は1回で十分な操作を複数回実行
  - **実際の発生シナリオ**: ユーザーが反応を確認できず連打した場合
- **期待される結果**: 1回目で停止、2回目以降は無視
  - **エラーメッセージの内容**: エラーメッセージは表示されない
  - **システムの安全性**: アプリの状態が破綻しない
- **テストの目的**: 連打耐性の確認
  - **品質保証の観点**: ユーザビリティと安全性の両立
- 🟡 黄信号: 既存テストパターン（TC-048-028）に基づく

### TC-050-012: TTS停止エラー時も基本機能が継続動作する

- **テスト名**: TTS停止エラー時も基本機能が継続動作する
  - **エラーケースの概要**: stop()呼び出し時にエラーが発生した場合
  - **エラー処理の重要性**: NFR-301「重大なエラーでも基本機能は継続」
- **入力値**: stop()が例外をスローする設定
  - **不正な理由**: OSレベルのTTSエラー
  - **実際の発生シナリオ**: システムリソース不足など
- **期待される結果**: エラー状態になるが、アプリはクラッシュしない
  - **エラーメッセージの内容**: 適切なエラーメッセージが設定される
  - **システムの安全性**: 文字盤入力などの基本機能は継続動作
- **テストの目的**: エラー耐性の確認
  - **品質保証の観点**: NFR-301準拠
- 🔵 青信号: NFR-301に基づく

---

## 4. 境界値テストケース

### TC-050-013: 読み上げ開始直後（100ms以内）の停止が正常に処理される

- **テスト名**: 読み上げ開始直後の停止が正常に処理される
  - **境界値の意味**: 状態遷移の境界（speaking直後のstop）
  - **境界値での動作保証**: 状態遷移の競合がないこと
- **入力値**: speak() → 即時stop()
  - **境界値選択の根拠**: 最短の読み上げ時間
  - **実際の使用場面**: 誤タップで読み上げを開始した場合の即座キャンセル
- **期待される結果**: 停止が正常に処理され、idle状態に戻る
  - **境界での正確性**: speak→stopの順序が保証される
  - **一貫した動作**: 通常の停止と同じ動作
- **テストの目的**: 境界条件での動作確認
  - **堅牢性の確認**: 高速な状態遷移でも安定動作
- 🟡 黄信号: 防御的プログラミングの原則に基づく

### TC-050-014: 長いテキスト（1000文字）の読み上げ中の停止

- **テスト名**: 長いテキストの読み上げ中の停止
  - **境界値の意味**: 入力バッファ最大値での停止
  - **境界値での動作保証**: 長時間の読み上げでも停止が効くこと
- **入力値**: 1000文字のテキスト + 途中で停止
  - **境界値選択の根拠**: 入力バッファの最大文字数（EDGE-101）
  - **実際の使用場面**: 長文の読み上げを途中でキャンセル
- **期待される結果**: 読み上げが即座に停止する
  - **境界での正確性**: テキスト長に関わらず停止が効く
  - **一貫した動作**: 短いテキストと同じ動作
- **テストの目的**: 最大データでの動作確認
  - **堅牢性の確認**: 極端な条件下でも安定動作
- 🔵 青信号: EDGE-101（1000文字制限）に基づく

---

## 5. 統合テストケース

### TC-050-015: 読み上げ→停止→再読み上げの一連のフロー

- **テスト名**: 読み上げ→停止→再読み上げの一連のフロー
  - **何をテストするか**: 一連の操作フローが正常に動作すること
  - **期待される動作**: 停止後に再度読み上げが可能
- **入力値**: speak("A") → stop() → speak("B")
  - **入力データの意味**: 読み上げを中断して別のテキストを読み上げるシナリオ
- **期待される結果**: 両方のspeak()が正常に実行される
  - **期待結果の理由**: 基本的なユースケースの確認
- **テストの目的**: E2Eフロー確認
  - **確認ポイント**: 状態遷移が正しく行われること
- 🔵 青信号: requirements.md「パターン1」に基づく

### TC-050-016: UIボタンタップからTTS停止までの統合フロー

- **テスト名**: UIボタンタップからTTS停止までの統合フロー
  - **何をテストするか**: ウィジェットテストでボタン→Provider→TTSServiceの連携
  - **期待される動作**: ボタンタップでTTSが実際に停止する
- **入力値**: WidgetTester.tap(停止ボタン)
  - **入力データの意味**: ユーザー操作のシミュレーション
- **期待される結果**: TTSService.stop()が呼ばれる
  - **期待結果の理由**: UI→ロジックの連携確認
- **テストの目的**: 統合動作確認
  - **確認ポイント**: 各レイヤーが正しく連携すること
- 🔵 青信号: 既存統合テストパターンに基づく

### TC-050-017: 状態変更に応じたボタン表示更新の統合確認

- **テスト名**: 状態変更に応じたボタン表示更新の統合確認
  - **何をテストするか**: 状態変更→UI更新のリアクティブな連携
  - **期待される動作**: TTSStateの変更がボタン表示に即座に反映
- **入力値**: Provider状態の変更
  - **入力データの意味**: 状態変更イベント
- **期待される結果**: ボタンラベルが自動的に切り替わる
  - **期待結果の理由**: Riverpodのリアクティブ更新
- **テストの目的**: リアクティブUI更新確認
  - **確認ポイント**: 状態変更がUIに100ms以内に反映されること
- 🔵 青信号: NFR-003（100ms以内応答）に基づく

---

## 開発言語・フレームワーク

- **プログラミング言語**: Dart 3.10+
  - **言語選択の理由**: Flutter公式言語、Null Safety対応
  - **テストに適した機能**: async/await、型推論、アノテーション
- **テストフレームワーク**: flutter_test + mocktail
  - **フレームワーク選択の理由**: Flutter公式テストフレームワーク、モック生成が容易
  - **テスト実行環境**: `flutter test` コマンドで実行
- 🔵 青信号: tech-stack.md「flutter_test、mocktail」に基づく

---

## テストファイル構成

| ファイル | テストケース |
|----------|-------------|
| `test/features/tts/presentation/widgets/tts_button_test.dart` | TC-050-001〜TC-050-009 |
| `test/integration/tts_stop_integration_test.dart` | TC-050-010〜TC-050-017 |

---

## 品質判定

### 品質基準チェック

| 項目 | 状態 | 備考 |
|------|------|------|
| テストケース分類 | ✅ | 正常系・異常系・境界値が網羅 |
| 期待値定義 | ✅ | 各テストケースの期待値が明確 |
| 技術選択 | ✅ | Dart + flutter_test + mocktailで確定 |
| 実装可能性 | ✅ | 既存テストパターンを活用可能 |

### 判定結果

✅ **高品質**: 次のステップに進めます

---

**次のお勧めステップ**: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
