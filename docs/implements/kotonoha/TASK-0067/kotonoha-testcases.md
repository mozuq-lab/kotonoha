# TASK-0067: AI変換APIクライアント テストケース一覧

## 信頼性レベル: 🔵 青信号

EARS要件定義書、API仕様、およびインターフェース定義に基づいてテストケースを設計。

---

## 開発言語・フレームワーク

- **プログラミング言語**: Dart 🔵
  - **言語選択の理由**: Flutterアプリ開発の標準言語
  - **テストに適した機能**: async/await、型安全性、mockable design
- **テストフレームワーク**: flutter_test + mockito 🔵
  - **フレームワーク選択の理由**: Flutter標準、Dioのモッキングに適している
  - **テスト実行環境**: `flutter test`

---

## 1. 正常系テストケース

### TC-067-001: AI変換が正常に実行される（politeレベル）

- **テスト名**: AI変換リクエストが正常に処理され、変換結果が返される
  - **何をテストするか**: `/api/v1/ai/convert` エンドポイントへの正常なリクエストと応答
  - **期待される動作**: 入力テキストが丁寧な表現に変換される
- **入力値**:
  - `inputText`: "水 ぬるく"
  - `politenessLevel`: `PolitenessLevel.polite`
  - **入力データの意味**: 典型的な短い入力テキストで、丁寧モードでの変換
- **期待される結果**:
  - `convertedText`: "お水をぬるめでお願いします"（例）
  - `originalText`: "水 ぬるく"
  - `politenessLevel`: polite
  - `processingTimeMs`: 正の整数
  - **期待結果の理由**: バックエンドAPIのレスポンス形式に準拠
- **テストの目的**: REQ-901（短い入力を丁寧な文章に変換）の検証
  - **確認ポイント**: レスポンスフィールドが全て正しく設定されること
- 🔵 青信号（API仕様に明確に定義）

---

### TC-067-002: AI変換が正常に実行される（casualレベル）

- **テスト名**: カジュアルレベルでのAI変換が正常に処理される
  - **何をテストするか**: casualレベルでの変換が適切に動作すること
  - **期待される動作**: 入力テキストがカジュアルな表現に変換される
- **入力値**:
  - `inputText`: "ありがとう"
  - `politenessLevel`: `PolitenessLevel.casual`
  - **入力データの意味**: REQ-903の3段階丁寧さレベルのうちcasualをテスト
- **期待される結果**:
  - `convertedText`: 変換後テキスト
  - `politenessLevel`: casual
  - **期待結果の理由**: 丁寧さレベルが正しく適用されていることを確認
- **テストの目的**: REQ-903（丁寧さレベル3段階）の検証
  - **確認ポイント**: casualレベルが正しく適用されること
- 🔵 青信号

---

### TC-067-003: AI変換が正常に実行される（normalレベル）

- **テスト名**: 標準レベルでのAI変換が正常に処理される
  - **何をテストするか**: normalレベルでの変換が適切に動作すること
  - **期待される動作**: 入力テキストが普通の丁寧さで変換される
- **入力値**:
  - `inputText`: "痛い 腰"
  - `politenessLevel`: `PolitenessLevel.normal`
  - **入力データの意味**: REQ-903の3段階丁寧さレベルのうちnormalをテスト
- **期待される結果**:
  - `convertedText`: 変換後テキスト
  - `politenessLevel`: normal
  - **期待結果の理由**: 丁寧さレベルが正しく適用されていることを確認
- **テストの目的**: REQ-903（丁寧さレベル3段階）の検証
  - **確認ポイント**: normalレベルが正しく適用されること
- 🔵 青信号

---

### TC-067-004: AI再変換が正常に実行される

- **テスト名**: regenerateメソッドが正常に動作し、前回と異なる結果が返される
  - **何をテストするか**: `/api/v1/ai/regenerate` エンドポイントへの正常なリクエストと応答
  - **期待される動作**: 前回の結果と異なる新しい変換結果が生成される
- **入力値**:
  - `inputText`: "水 ぬるく"
  - `politenessLevel`: `PolitenessLevel.polite`
  - `previousResult`: "お水をぬるめでお願いします"
  - **入力データの意味**: REQ-904の再生成機能をテスト
- **期待される結果**:
  - `convertedText`: 前回と異なる変換結果（例: "お水をぬるめにしてください"）
  - `originalText`: "水 ぬるく"
  - **期待結果の理由**: 再生成は異なる表現を返すべき
- **テストの目的**: REQ-904（再生成機能）の検証
  - **確認ポイント**: previousResultが正しくAPIに送信されること
- 🔵 青信号

---

### TC-067-005: レスポンスのJSONパースが正しく行われる

- **テスト名**: AIConversionResponseのfromJsonが正しくパースする
  - **何をテストするか**: JSONレスポンスからモデルオブジェクトへの変換
  - **期待される動作**: 全フィールドが正しく設定される
- **入力値**:
  ```json
  {
    "converted_text": "ありがとうございます",
    "original_text": "ありがとう",
    "politeness_level": "polite",
    "processing_time_ms": 1500
  }
  ```
  - **入力データの意味**: バックエンドAPIの典型的なレスポンス形式
- **期待される結果**:
  - 各フィールドが正しくDartオブジェクトに変換される
  - **期待結果の理由**: snake_case → camelCaseの変換が正しいこと
- **テストの目的**: データモデルの正確性検証
  - **確認ポイント**: snake_case/camelCase変換、型変換
- 🔵 青信号

---

## 2. 異常系テストケース

### TC-067-006: 接続タイムアウト時にAI_API_TIMEOUTエラーがスローされる

- **テスト名**: 10秒のタイムアウト超過時に適切な例外がスローされる
  - **エラーケースの概要**: サーバー応答が遅延し接続タイムアウトが発生
  - **エラー処理の重要性**: EDGE-001（タイムアウト時のエラーメッセージ）
- **入力値**:
  - 任意の有効なリクエスト
  - モック: DioExceptionType.connectionTimeout
  - **不正な理由**: タイムアウト発生のシミュレーション
  - **実際の発生シナリオ**: サーバー過負荷、ネットワーク遅延
- **期待される結果**:
  - `AIConversionException`がスローされる
  - `code`: "AI_API_TIMEOUT"
  - `message`: タイムアウトを示すメッセージ
  - **エラーメッセージの内容**: ユーザーが理解できる日本語メッセージ
  - **システムの安全性**: アプリがクラッシュしない
- **テストの目的**: NFR-002タイムアウト処理の検証
  - **品質保証の観点**: ユーザー体験を損なわないエラーハンドリング
- 🔵 青信号

---

### TC-067-007: 受信タイムアウト時にAI_API_TIMEOUTエラーがスローされる

- **テスト名**: レスポンス受信中にタイムアウトした場合の処理
  - **エラーケースの概要**: 接続後のレスポンス待機中にタイムアウト
  - **エラー処理の重要性**: 部分的なレスポンスでの不整合防止
- **入力値**:
  - モック: DioExceptionType.receiveTimeout
  - **実際の発生シナリオ**: AI処理に時間がかかりすぎる
- **期待される結果**:
  - `AIConversionException`（code: "AI_API_TIMEOUT"）
  - **システムの安全性**: 部分データが破棄される
- **テストの目的**: タイムアウト処理の網羅性確認
- 🔵 青信号

---

### TC-067-008: ネットワーク接続エラー時にNETWORK_ERRORがスローされる

- **テスト名**: インターネット接続不可時の処理
  - **エラーケースの概要**: デバイスがオフラインまたはサーバー到達不可
  - **エラー処理の重要性**: REQ-1002（オフライン時の表示）
- **入力値**:
  - モック: DioExceptionType.connectionError
  - **実際の発生シナリオ**: Wi-Fi切断、機内モード
- **期待される結果**:
  - `AIConversionException`（code: "NETWORK_ERROR"）
  - `message`: ネットワーク接続確認を促すメッセージ
- **テストの目的**: オフライン時のエラーハンドリング検証
- 🔵 青信号

---

### TC-067-009: サーバーエラー（500）時にAI_API_ERRORがスローされる

- **テスト名**: バックエンドが500エラーを返した場合の処理
  - **エラーケースの概要**: 外部AI APIでエラーが発生
  - **エラー処理の重要性**: EDGE-002（フォールバック処理）
- **入力値**:
  - モック: HTTP 500、レスポンスボディにエラー情報
  - **実際の発生シナリオ**: Claude API障害
- **期待される結果**:
  - `AIConversionException`（code: "AI_API_ERROR"）
- **テストの目的**: サーバーエラー時のフォールバック検証
- 🔵 青信号

---

### TC-067-010: レート制限超過時にRATE_LIMIT_EXCEEDEDがスローされる

- **テスト名**: HTTP 429レスポンス時の処理
  - **エラーケースの概要**: 短時間に多数のリクエストを送信
  - **エラー処理の重要性**: レート制限の適切な通知
- **入力値**:
  - モック: HTTP 429、Retry-Afterヘッダー
  - **実際の発生シナリオ**: 1分間に10回以上のリクエスト
- **期待される結果**:
  - `AIConversionException`（code: "RATE_LIMIT_EXCEEDED"）
  - `message`: 再試行までの待機時間を含む
- **テストの目的**: レート制限エラーの適切な処理
- 🔵 青信号

---

### TC-067-011: バリデーションエラー（400）時にVALIDATION_ERRORがスローされる

- **テスト名**: 入力値が不正な場合のエラー処理
  - **エラーケースの概要**: バックエンドでバリデーション失敗
  - **エラー処理の重要性**: ユーザーへの適切なフィードバック
- **入力値**:
  - モック: HTTP 400、code: "VALIDATION_ERROR"
  - **実際の発生シナリオ**: 文字数制限違反など
- **期待される結果**:
  - `AIConversionException`（code: "VALIDATION_ERROR"）
- **テストの目的**: クライアント側エラーハンドリング検証
- 🟡 黄信号（API仕様から推測）

---

### TC-067-012: 不正なJSONレスポンス時にエラーがスローされる

- **テスト名**: レスポンスがJSONとしてパースできない場合
  - **エラーケースの概要**: サーバーが不正な形式のレスポンスを返す
  - **エラー処理の重要性**: アプリのクラッシュ防止
- **入力値**:
  - モック: 不正なJSONボディ
  - **実際の発生シナリオ**: サーバーの予期しないエラー
- **期待される結果**:
  - `AIConversionException`（code: "INTERNAL_ERROR" または類似）
- **テストの目的**: 堅牢なエラーハンドリング検証
- 🟡 黄信号

---

## 3. 境界値テストケース

### TC-067-013: 最小文字数（2文字）の入力が正常に処理される

- **テスト名**: 2文字入力でのAI変換が成功する
  - **境界値の意味**: 入力最小文字数2文字の境界
  - **境界値での動作保証**: 最小文字数でも正常に変換される
- **入力値**:
  - `inputText`: "水水"（2文字）
  - **境界値選択の根拠**: バックエンドAPI仕様の最小値
  - **実際の使用場面**: 極端に短い入力
- **期待される結果**:
  - 正常に変換結果が返される
  - **境界での正確性**: 2文字でも変換処理が実行される
- **テストの目的**: 入力文字数下限の検証
- 🔵 青信号

---

### TC-067-014: 最大文字数（500文字）の入力が正常に処理される

- **テスト名**: 500文字入力でのAI変換が成功する
  - **境界値の意味**: 入力最大文字数500文字の境界
  - **境界値での動作保証**: 最大文字数でも正常に変換される
- **入力値**:
  - `inputText`: 500文字の文字列
  - **境界値選択の根拠**: バックエンドAPI仕様の最大値
  - **実際の使用場面**: 長文入力
- **期待される結果**:
  - 正常に変換結果が返される
- **テストの目的**: 入力文字数上限の検証
- 🔵 青信号

---

### TC-067-015: リクエストモデルのtoJsonが正しくシリアライズされる

- **テスト名**: AIConversionRequestのtoJsonがAPI仕様に準拠
  - **境界値の意味**: JSONシリアライズの正確性
  - **境界値での動作保証**: 全フィールドが正しくシリアライズされる
- **入力値**:
  - `inputText`: "テスト"
  - `politenessLevel`: PolitenessLevel.normal
- **期待される結果**:
  ```json
  {
    "input_text": "テスト",
    "politeness_level": "normal"
  }
  ```
  - **一貫した動作**: camelCase → snake_case変換が正しい
- **テストの目的**: リクエスト形式の検証
- 🔵 青信号

---

### TC-067-016: 再変換リクエストのtoJsonが正しくシリアライズされる

- **テスト名**: AIRegenerateRequestのtoJsonがAPI仕様に準拠
  - **境界値の意味**: 再変換リクエストのシリアライズ正確性
- **入力値**:
  - `inputText`: "テスト"
  - `politenessLevel`: PolitenessLevel.polite
  - `previousResult`: "前回の結果"
- **期待される結果**:
  ```json
  {
    "input_text": "テスト",
    "politeness_level": "polite",
    "previous_result": "前回の結果"
  }
  ```
- **テストの目的**: 再変換リクエスト形式の検証
- 🔵 青信号

---

## 4. 単体テストケース（モデル・例外）

### TC-067-017: PolitenessLevel enumが正しく動作する

- **テスト名**: PolitenessLevelの値とname変換が正しい
  - **何をテストするか**: enumの定義とJSON変換
- **入力値**: PolitenessLevel.casual, normal, polite
- **期待される結果**:
  - casual.name == "casual"
  - normal.name == "normal"
  - polite.name == "polite"
- **テストの目的**: enum定義の正確性検証
- 🔵 青信号

---

### TC-067-018: AIConversionExceptionが正しく動作する

- **テスト名**: 例外クラスが適切なプロパティを持つ
  - **何をテストするか**: 例外クラスの構造とtoString
- **入力値**:
  - `code`: "AI_API_ERROR"
  - `message`: "エラーが発生しました"
- **期待される結果**:
  - code, messageプロパティにアクセス可能
  - toStringが適切な形式を返す
- **テストの目的**: 例外クラスの基本動作検証
- 🔵 青信号

---

### TC-067-019: Dioのタイムアウト設定が正しく適用される

- **テスト名**: connectTimeout/receiveTimeoutが10秒に設定される
  - **何をテストするか**: Dio BaseOptionsの設定
- **入力値**: AIConversionApiClientの初期化
- **期待される結果**:
  - connectTimeout: 10秒
  - receiveTimeout: 10秒
- **テストの目的**: NFR-002タイムアウト設定の検証
- 🔵 青信号

---

### TC-067-020: HTTPヘッダーが正しく設定される

- **テスト名**: Content-TypeとAcceptヘッダーがJSON形式で設定される
  - **何をテストするか**: リクエストヘッダーの設定
- **入力値**: AIConversionApiClientからのリクエスト
- **期待される結果**:
  - Content-Type: application/json
  - Accept: application/json
- **テストの目的**: API仕様準拠の検証
- 🔵 青信号

---

## テストケース一覧表

| テストID | カテゴリ | テスト名 | 信頼性 |
|---------|---------|---------|-------|
| TC-067-001 | 正常系 | AI変換（polite） | 🔵 |
| TC-067-002 | 正常系 | AI変換（casual） | 🔵 |
| TC-067-003 | 正常系 | AI変換（normal） | 🔵 |
| TC-067-004 | 正常系 | AI再変換 | 🔵 |
| TC-067-005 | 正常系 | JSONパース | 🔵 |
| TC-067-006 | 異常系 | 接続タイムアウト | 🔵 |
| TC-067-007 | 異常系 | 受信タイムアウト | 🔵 |
| TC-067-008 | 異常系 | ネットワークエラー | 🔵 |
| TC-067-009 | 異常系 | サーバーエラー（500） | 🔵 |
| TC-067-010 | 異常系 | レート制限超過 | 🔵 |
| TC-067-011 | 異常系 | バリデーションエラー | 🟡 |
| TC-067-012 | 異常系 | 不正JSONレスポンス | 🟡 |
| TC-067-013 | 境界値 | 最小文字数（2文字） | 🔵 |
| TC-067-014 | 境界値 | 最大文字数（500文字） | 🔵 |
| TC-067-015 | 単体 | リクエストtoJson | 🔵 |
| TC-067-016 | 単体 | 再変換リクエストtoJson | 🔵 |
| TC-067-017 | 単体 | PolitenessLevel enum | 🔵 |
| TC-067-018 | 単体 | AIConversionException | 🔵 |
| TC-067-019 | 単体 | タイムアウト設定 | 🔵 |
| TC-067-020 | 単体 | HTTPヘッダー設定 | 🔵 |

---

## 品質判定

### ✅ 高品質

- **テストケース分類**: 正常系5件、異常系7件、境界値4件、単体4件で網羅
- **期待値定義**: 全テストケースで期待値が明確
- **技術選択**: Dart + flutter_test + mockito（導入済み）
- **実装可能性**: 全テストケースが現在の技術スタックで実現可能

---

## 次のステップ

次のお勧めステップ: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
