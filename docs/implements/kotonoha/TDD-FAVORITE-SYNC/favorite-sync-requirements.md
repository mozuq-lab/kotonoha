# 定型文お気に入りとお気に入り画面の連動機能 - 要件定義書

## 基本情報

- **タスクID**: TDD-FAVORITE-SYNC
- **機能名**: 定型文お気に入りとお気に入り画面の連動
- **作成日**: 2024-12-04
- **信頼性レベル**: 🔵 青信号（EARS要件定義書ベース）

---

## 1. 機能の概要

### 1.1 何をする機能か 🔵

定型文画面で「お気に入り」ボタンを押した際に、その定型文が「お気に入り画面」にも表示されるよう、2つのお気に入り機能を連動させる。

**現状の問題**:
- 定型文画面でお気に入りにすると、定型文画面内で上部に優先表示される（`PresetPhrase.isFavorite`フラグ）
- しかし、お気に入り画面（`FavoriteProvider`）には表示されない
- REQ-701「定型文または履歴をお気に入りとして登録」の「定型文」部分が実装されていない

### 1.2 どのような問題を解決するか 🔵

- **ユーザーの混乱**: 「お気に入り」操作の結果が一貫しておらず、定型文をお気に入りにしてもお気に入り画面で確認できない
- **要件との乖離**: REQ-701が求める「定型文をお気に入りとして登録」機能が部分的にしか実装されていない

### 1.3 想定されるユーザー 🔵

- 発話困難な方（脳梗塞・ALS・筋疾患など）
- タブレットのタップ操作がある程度可能な方

### 1.4 システム内での位置づけ 🔵

```
┌─────────────────────────────────────────────────────────────┐
│ PresetPhraseScreen（定型文画面）                              │
│   └─ toggleFavorite() → PresetPhraseNotifier.toggleFavorite()│
│                              │                               │
│                              ▼ 【新規追加】                   │
│                        FavoriteNotifier.addFavorite()        │
│                        または deleteFavorite()               │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│ FavoritesScreen（お気に入り画面）                            │
│   └─ favoriteProvider → FavoriteState.favorites             │
│       └─ 定型文のお気に入りも表示される 【新規機能】          │
└─────────────────────────────────────────────────────────────┘
```

### 1.5 参照したEARS要件

- **REQ-701**: システムは定型文または履歴をお気に入りとして登録する機能を提供しなければならない 🔵
- **REQ-702**: システムはお気に入りをリスト上部に優先表示しなければならない 🔵
- **REQ-703**: システムはお気に入りの並び順を変更できる機能を提供しなければならない 🔵
- **REQ-704**: システムはお気に入り削除時に確認ダイアログを表示しなければならない 🔵
- **REQ-105**: システムはお気に入り定型文を一覧上部に優先表示しなければならない 🔵

---

## 2. 入力・出力の仕様

### 2.1 入力パラメータ 🔵

#### toggleFavorite（定型文画面での操作）

| パラメータ | 型 | 説明 | 制約 |
|-----------|-----|------|------|
| phraseId | String | 定型文のUUID | 必須、既存の定型文ID |

#### 連動処理（PresetPhraseNotifier → FavoriteNotifier）

| パラメータ | 型 | 説明 | 制約 |
|-----------|-----|------|------|
| content | String | 定型文の内容 | 必須、1-500文字 |
| sourceType | String? | 元データの種類 | 'preset_phrase' |
| sourceId | String? | 元データのID | PresetPhrase.id |

### 2.2 出力値 🔵

#### お気に入り追加時

| 出力 | 型 | 説明 |
|------|-----|------|
| Favorite | Favorite | 新規作成されたお気に入りエンティティ |

#### お気に入り解除時

| 出力 | 型 | 説明 |
|------|-----|------|
| void | - | 対象のFavoriteが削除される |

### 2.3 データフロー 🔵

```
[ユーザー]
    │
    ▼ タップ
[定型文画面 - お気に入りボタン]
    │
    ▼ toggleFavorite(phraseId)
[PresetPhraseNotifier]
    │
    ├─► PresetPhrase.isFavorite = true/false を更新
    │
    └─► 【新規】FavoriteNotifier への連動
           │
           ├─ isFavorite=true の場合:
           │    └─► addFavorite(content, sourceType: 'preset_phrase', sourceId)
           │
           └─ isFavorite=false の場合:
                └─► deleteFavoriteBySourceId(sourceId)
```

### 2.4 参照した設計文書

- **interfaces.dart**: Favorite, PresetPhrase インターフェース
- **dataflow.md**: 定型文管理フロー、履歴・お気に入り管理フロー

---

## 3. 制約条件

### 3.1 パフォーマンス要件 🔵

| 項目 | 要件 | 根拠 |
|------|------|------|
| お気に入り切り替え応答時間 | 100ms以内 | NFR-003（文字盤タップ応答と同等） |
| お気に入り一覧表示 | 1秒以内 | NFR-004（定型文一覧表示と同等） |

### 3.2 データ整合性要件 🔵

| 項目 | 要件 | 根拠 |
|------|------|------|
| 重複登録防止 | 同じ定型文を複数回お気に入りに追加しない | データ整合性 |
| 連動削除 | 定型文のお気に入り解除時、対応するFavoriteも削除 | UX一貫性 |
| 孤立データ防止 | 定型文削除時、対応するFavoriteも削除 | データ整合性 |

### 3.3 アーキテクチャ制約 🔵

| 項目 | 要件 | 根拠 |
|------|------|------|
| 状態管理 | Riverpod StateNotifier パターンを使用 | tech-stack.md |
| データ永続化 | Hive を使用（ローカルストレージ） | tech-stack.md |
| 非同期処理 | async/await パターン | Dart標準 |

### 3.4 参照したEARS要件

- **NFR-003**: 文字盤タップから入力欄への文字反映までの遅延を100ms以内
- **NFR-004**: 定型文一覧の表示を1秒以内に完了
- **REQ-5003**: アプリが強制終了しても定型文・設定・履歴を失わない永続化機構

---

## 4. 想定される使用例

### 4.1 基本的な使用パターン 🔵

#### パターン1: 定型文をお気に入りに追加

1. ユーザーが定型文画面を開く
2. 「おはようございます」の定型文のお気に入りボタン（星アイコン）をタップ
3. 星アイコンが塗りつぶされ、定型文が上部に移動
4. **【新規】** お気に入り画面にも「おはようございます」が表示される

#### パターン2: 定型文のお気に入りを解除

1. ユーザーが定型文画面でお気に入り済みの定型文のボタンをタップ
2. 星アイコンが空になり、定型文が通常位置に戻る
3. **【新規】** お気に入り画面から「おはようございます」が削除される

#### パターン3: お気に入り画面から直接削除

1. ユーザーがお気に入り画面を開く
2. 定型文由来のお気に入りを削除
3. **【新規】** 対応する定型文のisFavoriteフラグもfalseになる

### 4.2 エッジケース 🟡

#### EDGE-SYNC-001: 既存の重複データ

- **状況**: 同じcontentの定型文とお気に入りが既に存在
- **対応**: contentで重複チェックし、既存のFavoriteがあれば追加しない

#### EDGE-SYNC-002: 定型文削除時の連動

- **状況**: お気に入り済みの定型文を削除
- **対応**: 対応するFavoriteも自動削除

#### EDGE-SYNC-003: オフライン時の操作

- **状況**: オフライン環境でお気に入り操作
- **対応**: ローカルストレージのみで完結するため、正常動作

### 4.3 エラーケース 🟡

#### ERROR-SYNC-001: ストレージ書き込み失敗

- **状況**: Hiveへの書き込みが失敗
- **対応**: エラーログを記録し、UIに「保存に失敗しました」を表示

### 4.4 参照したEARS要件

- **EDGE-104**: お気に入りが0件の状態でお気に入り画面にアクセスした場合
- **REQ-1001**: 文字盤入力・定型文・履歴・TTSをオフライン環境で利用可能

---

## 5. EARS要件・設計文書との対応関係

### 5.1 参照したユーザストーリー

- **ストーリー4.2**: よく使う文章をお気に入りに登録する 🔵

### 5.2 参照した機能要件

| 要件ID | 内容 | 本機能との関連 |
|--------|------|---------------|
| REQ-701 | 定型文または履歴をお気に入りとして登録 | **主要要件** - 定型文→お気に入り連動 |
| REQ-702 | お気に入りをリスト上部に優先表示 | お気に入り画面での表示 |
| REQ-703 | お気に入りの並び順を変更できる | 既存機能を維持 |
| REQ-704 | お気に入り削除時に確認ダイアログ | 既存機能を維持 |
| REQ-105 | お気に入り定型文を一覧上部に優先表示 | 定型文画面での表示（既存） |

### 5.3 参照した非機能要件

| 要件ID | 内容 | 本機能との関連 |
|--------|------|---------------|
| NFR-003 | 100ms以内の応答 | お気に入り切り替えの応答時間 |
| NFR-004 | 1秒以内の一覧表示 | お気に入り画面の表示速度 |
| REQ-5003 | データ永続化 | Hiveでの保存 |

### 5.4 参照したEdgeケース

| 要件ID | 内容 | 本機能との関連 |
|--------|------|---------------|
| EDGE-104 | お気に入り0件時の表示 | 空状態の処理 |

### 5.5 参照した設計文書

| 文書 | セクション | 内容 |
|------|-----------|------|
| dataflow.md | 定型文管理フロー | toggleFavoriteの処理フロー |
| dataflow.md | 履歴・お気に入り管理フロー | お気に入り追加の処理 |
| interfaces.dart | Favorite | お気に入りエンティティ定義 |
| interfaces.dart | PresetPhrase | 定型文エンティティ定義 |

---

## 6. 実装方針

### 6.1 変更対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `lib/features/preset_phrase/providers/preset_phrase_notifier.dart` | toggleFavoriteにFavoriteNotifier連動を追加 |
| `lib/features/favorite/providers/favorite_provider.dart` | sourceId対応、deleteFavoriteBySourceIdメソッド追加 |
| `lib/features/favorite/domain/models/favorite.dart` | sourceType, sourceIdフィールド追加（任意） |

### 6.2 新規追加メソッド

```dart
// FavoriteNotifier
Future<void> addFavoriteFromPresetPhrase(String content, String sourceId);
Future<void> deleteFavoriteBySourceId(String sourceId);

// PresetPhraseNotifier (既存メソッド修正)
Future<void> toggleFavorite(String id); // FavoriteNotifier連動を追加
```

---

## 7. 品質判定

### ✅ 高品質

| 項目 | 状態 | 備考 |
|------|------|------|
| 要件の曖昧さ | なし | REQ-701に明確に記載 |
| 入出力定義 | 完全 | パラメータ・戻り値を明確化 |
| 制約条件 | 明確 | パフォーマンス・整合性要件を定義 |
| 実装可能性 | 確実 | 既存コードベースの拡張で実現可能 |

---

## 8. 次のステップ

次のお勧めステップ: `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。
