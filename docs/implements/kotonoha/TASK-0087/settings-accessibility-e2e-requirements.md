# TASK-0087: 設定・アクセシビリティE2Eテスト - 要件定義書

## タスク情報

- **タスクID**: TASK-0087
- **タスクタイプ**: TDD (E2Eテスト)
- **推定工数**: 8時間
- **作成日**: 2025-11-30

## 概要

設定画面およびアクセシビリティ機能のE2Eテストを実装する。フォントサイズ変更、テーマ切り替え、高コントラストモードのWCAG 2.1 AA準拠、TTS速度・AI丁寧さレベル設定の即時反映と永続化を検証する。発話困難な方が自分に合った設定でアプリを快適に利用できることを保証する。

## 1. 機能の概要

### 🔵 青信号 - 要件定義書ベース

- **何をする機能か**: ユーザーがアプリの表示・音声・AI設定をカスタマイズし、変更が即座に反映される機能
- **どのような問題を解決するか**: 視覚・聴覚・認知面での個人差に対応し、各ユーザーに最適な使用環境を提供
- **想定されるユーザー**: 発話が困難でタブレット操作が可能な方（視力低下、高コントラスト必要、TTS速度調整が必要な方を含む）
- **システム内での位置づけ**: フロントエンド設定画面とローカルストレージ（Hive）による設定永続化

### 参照した要件

- **ユーザストーリー**: US-008（表示カスタマイズ）, US-009（高コントラストモード）
- **機能要件**: REQ-801, REQ-802, REQ-803, REQ-404, REQ-903
- **条件付き要件**: REQ-2007, REQ-2008
- **非機能要件**: REQ-5006, REQ-804

## 2. 入力・出力の仕様

### 🔵 青信号 - インターフェース定義ベース

### 入力パラメータ（設定値）

| パラメータ | 型 | 制約 | 説明 |
|-----------|---|------|------|
| fontSize | FontSize (enum) | small/medium/large | フォントサイズ設定 |
| themeMode | ThemeMode (enum) | light/dark/highContrast | テーマ設定 |
| ttsSpeed | TtsSpeed (enum) | slow/normal/fast | TTS読み上げ速度 |
| politenessLevel | PolitenessLevel (enum) | casual/normal/polite | AI変換丁寧さレベル |

### 出力（画面反映）

| 反映項目 | 対象 | 説明 |
|---------|------|------|
| フォントサイズ | 文字盤、定型文一覧、ボタンラベル、入力欄 | 全画面のテキストサイズ変更 |
| テーマカラー | 全画面の背景色、文字色、ボタン色 | 配色変更 |
| TTS速度 | 読み上げ機能 | 読み上げ速度変更 |
| 丁寧さレベル | AI変換機能 | デフォルトの丁寧さレベル |

### データフロー

1. ユーザーが設定画面で設定値を選択
2. 選択と同時に設定がHiveに保存
3. 設定変更がProviderを通じて全画面に通知
4. 各画面のUIが即座に更新
5. アプリ再起動後も設定が復元

### 参照した設計文書

- **型定義**: interfaces.dart の AppSettings, FontSize, ThemeMode
- **ストレージ**: Hive settings_box

## 3. 制約条件

### 🔵 青信号 - 要件定義書ベース

### アクセシビリティ要件

| 要件ID | 制約 | 目標値 |
|--------|------|--------|
| REQ-5006 | 高コントラストモード | WCAG 2.1 AAレベル（コントラスト比4.5:1以上） |
| REQ-804 | タップターゲットサイズ | 最小44px × 44px、推奨60px × 60px |

### 即時反映要件

| 要件ID | 制約 |
|--------|------|
| REQ-2007 | フォントサイズ変更は即座に全画面に反映 |
| REQ-2008 | テーマ変更は即座に全画面に反映 |

### 永続化要件

- 設定はHiveに保存し、アプリ再起動後も保持
- 設定変更時に自動保存（手動保存ボタン不要）

### 参照した要件

- **アクセシビリティ**: REQ-5006, REQ-804
- **即時反映**: REQ-2007, REQ-2008
- **永続化**: NFR-101

## 4. 想定される使用例

### 🔵 青信号 - 要件定義書ベース

### 正常系フロー

#### TC-E2E-087-001: フォントサイズ変更 → 全画面即時反映

1. ユーザーが設定画面を開く
2. フォントサイズを「大」に変更
3. 文字盤画面に戻る
4. 文字盤のフォントサイズが大きくなっている

#### TC-E2E-087-002: テーマ変更 → 全画面即時反映

1. ユーザーが設定画面を開く
2. テーマを「ダークモード」に変更
3. 背景が暗くなり、文字色が明るくなる
4. ホーム画面に戻ってもダークモードが維持される

#### TC-E2E-087-003: 高コントラストモード → WCAG 2.1 AA準拠

1. ユーザーが設定画面を開く
2. テーマを「高コントラスト」に変更
3. コントラスト比が4.5:1以上になる
4. テキストが明瞭に視認できる

#### TC-E2E-087-004: TTS速度変更 → 読み上げ速度反映

1. ユーザーが設定画面を開く
2. TTS速度を「遅い」に変更
3. 読み上げをテスト
4. 読み上げ速度が遅くなっている

#### TC-E2E-087-005: AI丁寧さレベル変更 → デフォルト設定反映

1. ユーザーが設定画面を開く
2. AI丁寧さレベルを「丁寧」に変更
3. AI変換を実行
4. デフォルトで「丁寧」レベルが選択される

### 🟡 黄信号 - 要件からの推測

### 永続化確認

#### TC-E2E-087-006: 設定のアプリ再起動後復元

1. 設定を変更する（フォントサイズ、テーマ等）
2. アプリを終了・再起動
3. 設定が保持されている

### 参照したEdgeケース

- **EDGE-201**: バックグラウンド復帰時の状態復元

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー

- US-008: 表示カスタマイズ（フォントサイズ変更）
- US-009: 高コントラストモード利用

### 参照した機能要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| REQ-801 | フォントサイズ選択 | 小/中/大の3段階選択 |
| REQ-802 | フォントサイズ追従 | 文字盤・定型文・ボタンラベルがサイズに追従 |
| REQ-803 | テーマ選択 | ライト/ダーク/高コントラストの3種類 |
| REQ-404 | TTS速度設定 | 遅い/普通/速いの3段階 |
| REQ-903 | AI丁寧さレベル | カジュアル/普通/丁寧の3段階 |

### 参照した条件付き要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| REQ-2007 | フォントサイズ即時反映 | 変更時に即座に全テキスト要素に反映 |
| REQ-2008 | テーマ即時反映 | 変更時に即座に全画面の配色に反映 |

### 参照した非機能要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| REQ-5006 | 高コントラスト準拠 | WCAG 2.1 AAレベル（4.5:1以上） |
| REQ-804 | タップターゲットサイズ | 最小44px × 44px |
| NFR-101 | ローカルストレージ | 設定の端末内保存・永続化 |

### 参照した設計文書

- **型定義**: interfaces.dart の AppSettings, FontSize, ThemeMode, TtsSpeed, PolitenessLevel
- **実装画面**: settings_screen.dart, font_size_setting.dart, theme_setting.dart
- **Provider**: settings_provider.dart

## 受け入れ基準

### AC-001: フォントサイズ設定

- [ ] フォントサイズを小/中/大の3段階から選択できる
- [ ] 変更が即座に全画面（文字盤、定型文、ボタン）に反映される
- [ ] 設定がアプリ再起動後も保持される

### AC-002: テーマ設定

- [ ] ライト/ダーク/高コントラストの3種類を選択できる
- [ ] 変更が即座に全画面の配色に反映される
- [ ] 設定がアプリ再起動後も保持される

### AC-003: 高コントラストモード

- [ ] 高コントラストモードでコントラスト比4.5:1以上を満たす
- [ ] テキストが明瞭に視認できる
- [ ] ボタン・アイコンが識別しやすい

### AC-004: TTS速度設定

- [ ] TTS速度を遅い/普通/速いの3段階から選択できる
- [ ] 変更が読み上げに反映される
- [ ] 設定がアプリ再起動後も保持される

### AC-005: AI丁寧さレベル設定

- [ ] AI丁寧さレベルをカジュアル/普通/丁寧の3段階から選択できる
- [ ] 変更がAI変換のデフォルトレベルに反映される
- [ ] 設定がアプリ再起動後も保持される

### AC-006: 設定画面UI

- [ ] 設定画面にアクセスできる
- [ ] 各設定項目がセクション分けされている
- [ ] タップターゲットサイズが44px × 44px以上

## 品質判定

✅ **高品質**:
- 要件の曖昧さ: なし（REQ-801〜803, REQ-2007, REQ-2008, REQ-5006に明確に記載）
- 入出力定義: 完全（設定値と画面反映が明確）
- 制約条件: 明確（即時反映、永続化、WCAG準拠）
- 実装可能性: 確実（既存設定実装をベースに検証可能）

## 信頼性レベル

🔵 青信号 - EARS要件定義書（REQ-801〜803, REQ-2007, REQ-2008, REQ-5006）に基づく明確な要件定義

---

次のお勧めステップ: テストケース一覧ドキュメントを作成します。
