# TASK-0018: ユーティリティ関数実装 TDD要件定義書

## タスク概要

- **タスクID**: TASK-0018
- **タスク名**: ユーティリティ関数実装（Logger、バリデーション、エラーハンドリング）
- **タスクタイプ**: TDD
- **推定工数**: 8時間
- **依存タスク**: TASK-0017

## 関連要件

### 主要関連要件
- **NFR-204**: システムはエラーメッセージを分かりやすい日本語で表示し、復旧方法を示さなければならない
- **NFR-301**: システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない

### 関連するEdgeケース・境界値要件
- **EDGE-001**: ネットワークタイムアウト時、システムはユーザーに分かりやすいエラーメッセージを表示し、再試行オプションを提供しなければならない
- **EDGE-002**: AI変換APIエラー時、システムは元の入力文をそのまま使用可能にするフォールバック処理を実行しなければならない
- **EDGE-101**: 入力欄の文字数が1000文字を超えた場合、システムは警告を表示し、1000文字で入力を制限しなければならない
- **EDGE-102**: 定型文の文字数が500文字を超えた場合、システムは警告を表示し、500文字で入力を制限しなければならない
- **EDGE-105**: AI変換の入力が2文字未満の場合、システムは変換を実行せず、「もう少し長く入力してください」というメッセージを表示してもよい

---

## 機能要件

### 1. Loggerユーティリティ機能

#### FR-LOGGER-001: デバッグログ出力
- **概要**: デバッグレベルのログを出力する機能
- **詳細**: 開発時のデバッグ情報を出力できなければならない
- **信頼性**: 🟡 黄信号（ログ出力は一般的な開発プラクティスに基づく推測）

#### FR-LOGGER-002: 情報ログ出力
- **概要**: 情報レベルのログを出力する機能
- **詳細**: アプリケーションの正常な動作状況を記録できなければならない
- **信頼性**: 🟡 黄信号

#### FR-LOGGER-003: 警告ログ出力
- **概要**: 警告レベルのログを出力する機能
- **詳細**: 潜在的な問題や注意が必要な状況を記録できなければならない
- **信頼性**: 🟡 黄信号

#### FR-LOGGER-004: エラーログ出力
- **概要**: エラーレベルのログを出力する機能（例外情報、スタックトレース含む）
- **詳細**: エラー発生時に、エラーメッセージ、例外オブジェクト、スタックトレースを記録できなければならない
- **信頼性**: 🔵 青信号（NFR-301に基づく）

#### FR-LOGGER-005: 環境別ログレベル制御
- **概要**: 開発環境と本番環境でログレベルを制御する機能
- **詳細**: 本番環境ではデバッグログを出力しないように制御できなければならない
- **信頼性**: 🟡 黄信号

---

### 2. バリデーションユーティリティ機能

#### FR-VALID-001: 入力テキストバリデーション（最大文字数）
- **概要**: 入力テキストが最大1000文字以内であることを検証する機能
- **詳細**:
  - 入力テキストが1000文字以内の場合、エラーなし（null）を返す
  - 入力テキストが1000文字を超える場合、日本語のエラーメッセージを返す
  - 空文字・nullの場合はエラーなし（空入力は許可）
- **信頼性**: 🔵 青信号（EDGE-101に基づく）

#### FR-VALID-002: 定型文バリデーション（最大文字数・必須チェック）
- **概要**: 定型文テキストが最大500文字以内であり、空でないことを検証する機能
- **詳細**:
  - 定型文が500文字以内かつ空でない場合、エラーなし（null）を返す
  - 定型文が空の場合、「定型文を入力してください」エラーメッセージを返す
  - 定型文が500文字を超える場合、「定型文は500文字以内にしてください」エラーメッセージを返す
- **信頼性**: 🔵 青信号（EDGE-102に基づく）

#### FR-VALID-003: AI変換可能判定（最小文字数）
- **概要**: AI変換が実行可能かどうかを判定する機能
- **詳細**:
  - 入力テキストが2文字以上の場合、true（変換可能）を返す
  - 入力テキストが2文字未満の場合、false（変換不可）を返す
- **信頼性**: 🔴 赤信号（EDGE-105に基づく推測）

#### FR-VALID-004: 入力テキストサニタイズ
- **概要**: 入力テキストから前後の空白を除去する機能
- **詳細**: 入力テキストの前後の空白（半角・全角スペース、タブ、改行）を除去する
- **信頼性**: 🟡 黄信号（一般的な入力処理に基づく）

---

### 3. エラーハンドリングユーティリティ機能

#### FR-ERROR-001: ネットワークエラーメッセージ生成
- **概要**: ネットワークエラー発生時の日本語メッセージを生成する機能
- **詳細**:
  - ネットワークエラーの場合、「ネットワークエラーが発生しました。インターネット接続を確認してください。」を返す
  - 再試行可能であることを示す情報も提供する
- **信頼性**: 🔵 青信号（NFR-204、EDGE-001に基づく）

#### FR-ERROR-002: タイムアウトエラーメッセージ生成
- **概要**: タイムアウトエラー発生時の日本語メッセージを生成する機能
- **詳細**: タイムアウトエラーの場合、「通信がタイムアウトしました。しばらく待ってからもう一度お試しください。」を返す
- **信頼性**: 🔵 青信号（NFR-204、EDGE-001に基づく）

#### FR-ERROR-003: AI変換エラーメッセージ生成
- **概要**: AI変換APIエラー発生時の日本語メッセージを生成する機能
- **詳細**: AI変換エラーの場合、「変換に失敗しました。元の文をそのまま使用できます。」を返す
- **信頼性**: 🔵 青信号（NFR-204、EDGE-002に基づく）

#### FR-ERROR-004: 汎用エラーメッセージ生成
- **概要**: 予期しないエラー発生時の日本語メッセージを生成する機能
- **詳細**: 予期しないエラーの場合、「予期しないエラーが発生しました。アプリを再起動してください。」を返す
- **信頼性**: 🔵 青信号（NFR-204に基づく）

#### FR-ERROR-005: カスタム例外クラス定義
- **概要**: アプリケーション固有の例外クラスを定義する機能
- **詳細**:
  - `NetworkException`: ネットワーク関連エラー用
  - `TimeoutException`: タイムアウトエラー用
  - `AiConversionException`: AI変換エラー用
  - `ValidationException`: バリデーションエラー用
- **信頼性**: 🟡 黄信号（エラーハンドリングのベストプラクティスに基づく）

#### FR-ERROR-006: エラーログ記録連携
- **概要**: エラーハンドリング時にLoggerと連携してエラーログを記録する機能
- **詳細**: エラーハンドリング時に自動的にエラーログを出力し、スタックトレースも記録する
- **信頼性**: 🔵 青信号（NFR-301に基づく）

#### FR-ERROR-007: ユーザーフレンドリーなエラー表示
- **概要**: エラーをユーザーフレンドリーな形式で表示する機能
- **詳細**: エラー発生時にSnackBarなどでユーザーに通知し、必要に応じて対処方法を提示する
- **信頼性**: 🔵 青信号（NFR-204に基づく）

---

## 非機能要件

### NFR-UTIL-001: 日本語エラーメッセージ
- **概要**: すべてのエラーメッセージは分かりやすい日本語で表示する
- **詳細**: 技術的な専門用語を避け、一般ユーザーが理解できる平易な表現を使用する
- **計測方法**: エラーメッセージの可読性レビュー
- **目標値**: すべてのエラーメッセージが日本語で、対処方法を含む
- **信頼性**: 🔵 青信号（NFR-204に基づく）

### NFR-UTIL-002: エラー発生時の基本機能継続性
- **概要**: エラーが発生しても基本機能を継続利用可能にする
- **詳細**: 例外をキャッチして適切に処理し、アプリケーションがクラッシュしないようにする
- **計測方法**: 意図的にエラーを発生させた際のアプリ動作確認
- **目標値**: エラー発生後も文字盤入力・読み上げが継続動作
- **信頼性**: 🔵 青信号（NFR-301に基づく）

### NFR-UTIL-003: ログ出力パフォーマンス
- **概要**: ログ出力がアプリケーションのパフォーマンスに影響を与えない
- **詳細**: ログ出力処理が同期的にブロックしないよう、軽量な実装とする
- **計測方法**: ログ出力前後の処理時間計測
- **目標値**: ログ出力が1ms未満で完了
- **信頼性**: 🟡 黄信号

### NFR-UTIL-004: テストカバレッジ
- **概要**: ユーティリティ関数のテストカバレッジを高く維持する
- **詳細**: ユーティリティ関数は他の機能から広く使用されるため、高いテストカバレッジを確保する
- **計測方法**: flutter testのカバレッジレポート
- **目標値**: 90%以上のテストカバレッジ
- **信頼性**: 🔵 青信号（NFR-502に基づく）

---

## 受け入れ基準

### AC-LOGGER: Loggerユーティリティ

#### AC-LOGGER-001: デバッグログ出力テスト
**Given（前提条件）**:
- AppLoggerクラスがインポートされている

**When（実行条件）**:
- `AppLogger.debug('テストメッセージ')` を呼び出す

**Then（期待結果）**:
- デバッグレベルのログが出力される
- ログにメッセージ「テストメッセージ」が含まれる

---

#### AC-LOGGER-002: エラーログ出力テスト（例外情報付き）
**Given（前提条件）**:
- AppLoggerクラスがインポートされている
- 例外オブジェクトが存在する

**When（実行条件）**:
- `AppLogger.error('エラー発生', error, stackTrace)` を呼び出す

**Then（期待結果）**:
- エラーレベルのログが出力される
- ログにエラーメッセージ、例外情報、スタックトレースが含まれる

---

### AC-VALID: バリデーションユーティリティ

#### AC-VALID-001: 入力テキスト正常値テスト
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 入力テキストが「こんにちは」（5文字）

**When（実行条件）**:
- `Validators.validateInputText('こんにちは')` を呼び出す

**Then（期待結果）**:
- 戻り値がnull（エラーなし）

---

#### AC-VALID-002: 入力テキスト上限超過テスト
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 入力テキストが1001文字以上

**When（実行条件）**:
- `Validators.validateInputText(longText)` を呼び出す（longTextは1001文字）

**Then（期待結果）**:
- 戻り値に「1000文字以内」を含むエラーメッセージが返される

---

#### AC-VALID-003: 入力テキスト空文字テスト
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 入力テキストが空文字またはnull

**When（実行条件）**:
- `Validators.validateInputText('')` を呼び出す
- `Validators.validateInputText(null)` を呼び出す

**Then（期待結果）**:
- 戻り値がnull（空入力は許可）

---

#### AC-VALID-004: 定型文正常値テスト
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 定型文テキストが「ありがとうございます」（10文字）

**When（実行条件）**:
- `Validators.validatePresetPhrase('ありがとうございます')` を呼び出す

**Then（期待結果）**:
- 戻り値がnull（エラーなし）

---

#### AC-VALID-005: 定型文空文字テスト
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 定型文テキストが空文字またはnull

**When（実行条件）**:
- `Validators.validatePresetPhrase('')` を呼び出す
- `Validators.validatePresetPhrase(null)` を呼び出す

**Then（期待結果）**:
- 戻り値に「定型文を入力してください」エラーメッセージが返される

---

#### AC-VALID-006: 定型文上限超過テスト
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 定型文テキストが501文字以上

**When（実行条件）**:
- `Validators.validatePresetPhrase(longText)` を呼び出す（longTextは501文字）

**Then（期待結果）**:
- 戻り値に「500文字以内」を含むエラーメッセージが返される

---

#### AC-VALID-007: AI変換可能判定テスト（変換可能）
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 入力テキストが「ああ」（2文字）

**When（実行条件）**:
- `Validators.canConvertWithAi('ああ')` を呼び出す

**Then（期待結果）**:
- 戻り値がtrue（変換可能）

---

#### AC-VALID-008: AI変換可能判定テスト（変換不可）
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 入力テキストが「あ」（1文字）

**When（実行条件）**:
- `Validators.canConvertWithAi('あ')` を呼び出す

**Then（期待結果）**:
- 戻り値がfalse（変換不可）

---

#### AC-VALID-009: 境界値テスト（入力テキスト1000文字）
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 入力テキストがちょうど1000文字

**When（実行条件）**:
- `Validators.validateInputText(text1000)` を呼び出す（text1000は1000文字）

**Then（期待結果）**:
- 戻り値がnull（エラーなし、1000文字はOK）

---

#### AC-VALID-010: 境界値テスト（定型文500文字）
**Given（前提条件）**:
- Validatorsクラスがインポートされている
- 定型文テキストがちょうど500文字

**When（実行条件）**:
- `Validators.validatePresetPhrase(text500)` を呼び出す（text500は500文字）

**Then（期待結果）**:
- 戻り値がnull（エラーなし、500文字はOK）

---

### AC-ERROR: エラーハンドリングユーティリティ

#### AC-ERROR-001: ネットワークエラーメッセージ生成テスト
**Given（前提条件）**:
- ErrorHandlerクラスがインポートされている
- NetworkException例外が発生した

**When（実行条件）**:
- `ErrorHandler.getErrorMessage(NetworkException('接続エラー'))` を呼び出す

**Then（期待結果）**:
- 戻り値に「ネットワークエラー」「インターネット接続を確認」を含む日本語メッセージが返される

---

#### AC-ERROR-002: タイムアウトエラーメッセージ生成テスト
**Given（前提条件）**:
- ErrorHandlerクラスがインポートされている
- TimeoutException例外が発生した

**When（実行条件）**:
- `ErrorHandler.getErrorMessage(TimeoutException('タイムアウト'))` を呼び出す

**Then（期待結果）**:
- 戻り値に「タイムアウト」「もう一度お試しください」を含む日本語メッセージが返される

---

#### AC-ERROR-003: AI変換エラーメッセージ生成テスト
**Given（前提条件）**:
- ErrorHandlerクラスがインポートされている
- AiConversionException例外が発生した

**When（実行条件）**:
- `ErrorHandler.getErrorMessage(AiConversionException('変換失敗'))` を呼び出す

**Then（期待結果）**:
- 戻り値に「変換に失敗しました」「元の文」を含む日本語メッセージが返される

---

#### AC-ERROR-004: 汎用エラーメッセージ生成テスト
**Given（前提条件）**:
- ErrorHandlerクラスがインポートされている
- 予期しない例外（Exception）が発生した

**When（実行条件）**:
- `ErrorHandler.getErrorMessage(Exception('未知のエラー'))` を呼び出す

**Then（期待結果）**:
- 戻り値に「予期しないエラー」を含む日本語メッセージが返される

---

#### AC-ERROR-005: エラーハンドリング時のログ記録テスト
**Given（前提条件）**:
- ErrorHandlerクラスとAppLoggerクラスがインポートされている
- エラーが発生した

**When（実行条件）**:
- `ErrorHandler.handleError(context, error, stackTrace)` を呼び出す

**Then（期待結果）**:
- AppLoggerにエラーログが記録される
- ログにエラー内容とスタックトレースが含まれる

---

## テストケースサマリー

### Loggerユーティリティ（5件）
| ID | テストケース | 優先度 |
|----|-------------|--------|
| TC-LOG-001 | デバッグログ出力 | Medium |
| TC-LOG-002 | 情報ログ出力 | Medium |
| TC-LOG-003 | 警告ログ出力 | Medium |
| TC-LOG-004 | エラーログ出力（例外情報付き） | High |
| TC-LOG-005 | 本番環境でのデバッグログ抑制 | Low |

### バリデーションユーティリティ（12件）
| ID | テストケース | 優先度 |
|----|-------------|--------|
| TC-VAL-001 | 入力テキスト正常値（短い文字列） | High |
| TC-VAL-002 | 入力テキスト正常値（ちょうど1000文字） | High |
| TC-VAL-003 | 入力テキスト上限超過（1001文字以上） | High |
| TC-VAL-004 | 入力テキスト空文字 | High |
| TC-VAL-005 | 入力テキストnull | High |
| TC-VAL-006 | 定型文正常値 | High |
| TC-VAL-007 | 定型文正常値（ちょうど500文字） | High |
| TC-VAL-008 | 定型文上限超過（501文字以上） | High |
| TC-VAL-009 | 定型文空文字 | High |
| TC-VAL-010 | 定型文null | High |
| TC-VAL-011 | AI変換可能判定（2文字以上） | High |
| TC-VAL-012 | AI変換可能判定（2文字未満） | High |

### エラーハンドリングユーティリティ（8件）
| ID | テストケース | 優先度 |
|----|-------------|--------|
| TC-ERR-001 | ネットワークエラーメッセージ生成 | High |
| TC-ERR-002 | タイムアウトエラーメッセージ生成 | High |
| TC-ERR-003 | AI変換エラーメッセージ生成 | High |
| TC-ERR-004 | 汎用エラーメッセージ生成 | High |
| TC-ERR-005 | ValidationExceptionメッセージ生成 | Medium |
| TC-ERR-006 | エラーハンドリング時のログ記録 | High |
| TC-ERR-007 | SnackBar表示テスト | Medium |
| TC-ERR-008 | エラー発生時のアプリ継続動作 | High |

---

## 実装ファイル構成

```
frontend/kotonoha_app/
├── lib/
│   └── core/
│       └── utils/
│           ├── logger.dart           # Loggerユーティリティ
│           ├── validators.dart       # バリデーションユーティリティ
│           ├── error_handler.dart    # エラーハンドリングユーティリティ
│           └── exceptions.dart       # カスタム例外クラス
└── test/
    └── core/
        └── utils/
            ├── logger_test.dart      # Loggerテスト
            ├── validators_test.dart  # バリデーションテスト
            └── error_handler_test.dart # エラーハンドリングテスト
```

---

## 信頼性レベルサマリー

| レベル | 件数 | 説明 |
|--------|------|------|
| 🔵 青信号 | 13件 | 要件定義書に明確に記載された要件に基づく |
| 🟡 黄信号 | 8件 | 要件定義書から妥当に推測される要件 |
| 🔴 赤信号 | 1件 | 要件定義書にない推測による要件 |

---

## 更新履歴

- **2025-11-22**: TDD要件定義書作成（tdd-requirements.md）
