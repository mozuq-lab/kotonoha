# TASK-0090: TTSãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ– - é–‹ç™ºãƒ¡ãƒ¢

## æ¦‚è¦

**ã‚¿ã‚¹ã‚¯ID**: TASK-0090
**ã‚¿ã‚¹ã‚¯å**: TTSãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–
**ç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚º**: å®Œäº†
**æœ€çµ‚æ›´æ–°**: 2025-12-01

## ç›®çš„

1. **TTSæœ€é©åŒ–**: èª­ã¿ä¸Šã’é–‹å§‹æ™‚é–“ã‚’1ç§’ä»¥å†…ã«æŠ‘åˆ¶ï¼ˆNFR-001ï¼‰
2. **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–**: å®šå‹æ–‡ã®èª­ã¿è¾¼ã¿æ™‚é–“ã‚’10msä»¥å†…ã«æŠ‘åˆ¶ï¼ˆNFR-004ï¼‰

## å®Ÿè£…å†…å®¹

### TDD Greenãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ2025-12-01ï¼‰

#### 1. TTSæœ€é©åŒ–ï¼ˆtts_provider.dartï¼‰

**å®Ÿè£…å†…å®¹**:
- TTSNotifierã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã« `Future.microtask(() => _service.initialize())` ã‚’è¿½åŠ ï¼ˆ99è¡Œç›®ï¼‰
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§TTSåˆæœŸåŒ–ã‚’é–‹å§‹
- æœ€åˆã®speak()å‘¼ã³å‡ºã—æ™‚ã®é…å»¶ã‚’å‰Šæ¸›

**ã‚³ãƒ¼ãƒ‰ä¾‹**:
```dart
TTSNotifier({TTSService? service}) : super(TTSServiceState.initial()) {
  _service = service ??
      TTSService(
        tts: FlutterTts(),
        onStateChanged: _onServiceStateChanged,
      );
  // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§TTSåˆæœŸåŒ–ã‚’é–‹å§‹ï¼ˆTASK-0090: TTSæœ€é©åŒ–ï¼‰
  // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å®Œäº†å¾Œã«éåŒæœŸã§åˆæœŸåŒ–ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€
  // æœ€åˆã®speak()å‘¼ã³å‡ºã—æ™‚ã®é…å»¶ã‚’å‰Šæ¸›
  Future.microtask(() => _service.initialize());
}
```

#### 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–ï¼ˆpreset_phrase_repository.dartï¼‰

**å®Ÿè£…å†…å®¹**:
- `_cache` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆ18è¡Œç›®ï¼‰
- `invalidateCache()` ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ï¼ˆ86-88è¡Œç›®ï¼‰
- `loadAll()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨å‹ã«å¤‰æ›´ï¼ˆ30-39è¡Œç›®ï¼‰
- `save()`, `delete()`, `saveAll()` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥è‡ªå‹•ç„¡åŠ¹åŒ–ï¼ˆ48, 59, 70è¡Œç›®ï¼‰

**ã‚³ãƒ¼ãƒ‰ä¾‹**:
```dart
/// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
List<PresetPhrase>? _cache;

/// å…¨å®šå‹æ–‡ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ï¼‰
Future<List<PresetPhrase>> loadAll() async {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™ï¼ˆé«˜é€Ÿï¼‰
  if (_cache != null) {
    return _cache!;
  }
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‘ã‚Œã°Hiveã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹
  _cache = _box.values.toList();
  return _cache!;
}

/// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
void invalidateCache() {
  _cache = null;
}
```

### TDD Refactorãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ2025-12-01ï¼‰

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

**è©•ä¾¡çµæœ**: ğŸŸ¢ é‡å¤§ãªè„†å¼±æ€§ãªã—

- å…¥åŠ›å€¤æ¤œè¨¼: âœ… é©åˆ‡
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: âœ… é©åˆ‡
- ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†: âœ… é©åˆ‡
- ãƒ‡ãƒ¼ã‚¿æ¼æ´©ãƒªã‚¹ã‚¯: âœ… å•é¡Œãªã—

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼

**è©•ä¾¡çµæœ**: ğŸŸ¢ é‡å¤§ãªæ€§èƒ½èª²é¡Œãªã—

**TTSæœ€é©åŒ–**:
- åˆæœŸåŒ–ã®æœ€é©åŒ–: O(1) - éåŒæœŸã§å®Ÿè¡Œã€ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãªã—
- çŠ¶æ…‹å¤‰æ›´ã®å¿œç­”æ€§: O(1)

**ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœ€é©åŒ–**:
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚: O(1)
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚: O(n) - n=å®šå‹æ–‡ã®æ•°ï¼ˆæœ€å¤§100ä»¶ç¨‹åº¦ï¼‰

#### ã‚³ãƒ¼ãƒ‰å“è³ªè©•ä¾¡

**è©•ä¾¡çµæœ**: âœ… é«˜å“è³ª - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¸è¦

- æ—¥æœ¬èªã‚³ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿ
- é©åˆ‡ãªå‘½åè¦å‰‡
- DRYåŸå‰‡éµå®ˆ
- é©åˆ‡ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
- è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³æº–æ‹ 
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…æ¸ˆã¿

#### ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿæ–½å†…å®¹

**çµè«–**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¸è¦

Greenãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«é«˜å“è³ªã®ãŸã‚ã€å¤‰æ›´ãªã—ã€‚

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

**TTS Provider ãƒ†ã‚¹ãƒˆ**: âœ… å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ10ä»¶ï¼‰
**Preset Phrase Repository ãƒ†ã‚¹ãƒˆ**: âœ… å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ13ä»¶ï¼‰

## æŠ€è¡“çš„ãªèª²é¡Œã¨è§£æ±ºç­–

### èª²é¡Œ1: TTSåˆæœŸåŒ–é…å»¶

**å•é¡Œ**: åˆå›ã®speak()å‘¼ã³å‡ºã—æ™‚ã«åˆæœŸåŒ–å‡¦ç†ãŒåŒæœŸçš„ã«å®Ÿè¡Œã•ã‚Œã€1ç§’ã®é…å»¶ãŒç™ºç”Ÿ

**è§£æ±ºç­–**: ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆæœŸåŒ–ã‚’é–‹å§‹
- `Future.microtask(() => _service.initialize())` ã‚’ä½¿ç”¨
- éåŒæœŸã§åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã€æœ€åˆã®speak()å‘¼ã³å‡ºã—æ™‚ã®é…å»¶ã‚’å‰Šæ¸›

### èª²é¡Œ2: å®šå‹æ–‡ã®é »ç¹ãªèª­ã¿è¾¼ã¿

**å•é¡Œ**: UIå†æç”»ã®ãŸã³ã«Hiveã‹ã‚‰èª­ã¿è¾¼ã¿ãŒç™ºç”Ÿã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹

**è§£æ±ºç­–**: ãƒ¡ãƒ¢ãƒªå†…ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…
- `_cache` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- 2å›ç›®ä»¥é™ã®`loadAll()`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¿”ã™ï¼ˆ10msä»¥å†…ï¼‰
- `save()`, `delete()`, `saveAll()` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è‡ªå‹•ç„¡åŠ¹åŒ–

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:
- `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/tts/providers/tts_provider.dart`
- `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/preset_phrase/data/preset_phrase_repository.dart`

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:
- `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/test/features/tts/providers/tts_provider_test.dart`
- `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/test/features/preset_phrase/data/preset_phrase_repository_test.dart`

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
- `/Volumes/external/dev/kotonoha/docs/implements/kotonoha/TASK-0090/optimization-refactor-phase.md`

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

æ¬¡ã®ãŠå‹§ã‚ã‚¹ãƒ†ãƒƒãƒ—: `/tsumiki:tdd-verify-complete` ã§å®Œå…¨æ€§æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## æœ€çµ‚ã‚³ãƒ¼ãƒ‰å“è³ªè©•ä¾¡

### âœ… é«˜å“è³ª

- **ãƒ†ã‚¹ãƒˆçµæœ**: å…¨ã¦ç¶™ç¶šæˆåŠŸï¼ˆ23ä»¶ï¼‰
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: é‡å¤§ãªè„†å¼±æ€§ãªã—
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: é‡å¤§ãªæ€§èƒ½èª²é¡Œãªã—
- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿å“è³ª**: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ä¸è¦ï¼ˆæ—¢ã«é«˜å“è³ªï¼‰
- **ã‚³ãƒ¼ãƒ‰å“è³ª**: é©åˆ‡ãªãƒ¬ãƒ™ãƒ«
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: å®Œæˆ
