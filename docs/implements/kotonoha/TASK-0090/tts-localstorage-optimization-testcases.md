# TASK-0090: TTS・ローカルストレージ最適化 - テストケース定義書

## 概要

### 機能名
TTS・ローカルストレージ最適化（Performance Optimization for TTS and Local Storage）

### 作成日
2025-12-01

### 開発言語・テストフレームワーク
- **プログラミング言語**: Dart 3.10+
  - **言語選択の理由**: Flutter標準言語、既存コードベースとの一貫性
  - **テストに適した機能**: async/await、mockライブラリ対応
- **テストフレームワーク**: flutter_test + mocktail
  - **フレームワーク選択の理由**: Flutter公式、既存テストパターンとの整合性
  - **テスト実行環境**: ローカル（`flutter test`）、CI/CD（GitHub Actions）
- 🔵 青信号: tech-stack.md、既存テストパターンに基づく

---

## テストケース一覧

### 1. TTS最適化 - 正常系テストケース

#### TC-090-001: TTS事前初期化が起動時にバックグラウンドで実行される
- **テスト名**: TTS事前初期化のバックグラウンド実行確認
  - **何をテストするか**: TTSNotifier生成時にバックグラウンドで初期化が開始されることを確認
  - **期待される動作**: TTSNotifierのコンストラクタ実行後、即座にinitialize()が非同期で呼び出される
- **入力値**: なし（TTSNotifierの生成のみ）
  - **入力データの意味**: アプリ起動シナリオを再現
- **期待される結果**: initialize()が1回呼び出される
  - **期待結果の理由**: NFR-001（読み上げ開始1秒以内）を達成するため、事前初期化が必要
- **テストの目的**: 遅延初期化の実装確認
  - **確認ポイント**: Future.microtask()でのバックグラウンド初期化
- 🔵 青信号: NFR-001、要件定義書の実装方針に基づく

#### TC-090-002: 事前初期化後の読み上げ開始時間が1秒以内
- **テスト名**: TTS読み上げ開始時間の計測（事前初期化済み）
  - **何をテストするか**: 初期化済みの状態でspeak()を呼び出した際の開始時間
  - **期待される動作**: speak()呼び出しから読み上げ開始まで1秒以内
- **入力値**: text = "こんにちは"（通常のテキスト）
  - **入力データの意味**: 一般的な読み上げテキスト
- **期待される結果**: 読み上げ開始まで1000ms以内
  - **期待結果の理由**: NFR-001パフォーマンス要件
- **テストの目的**: パフォーマンス要件の達成確認
  - **確認ポイント**: Stopwatchによる時間計測
- 🔵 青信号: NFR-001に明確に記載

#### TC-090-003: 初期化前でも読み上げが1秒以内に開始される
- **テスト名**: TTS自動初期化込みの読み上げ開始時間計測
  - **何をテストするか**: 未初期化状態からspeak()を呼び出した際のトータル時間
  - **期待される動作**: 自動初期化を含めても1秒以内に読み上げ開始
- **入力値**: text = "テスト"（短いテキスト）
  - **入力データの意味**: 最小限のテキストでの計測
- **期待される結果**: 読み上げ開始まで1000ms以内
  - **期待結果の理由**: ユーザー体験として許容される遅延
- **テストの目的**: ワーストケースでのパフォーマンス確認
  - **確認ポイント**: 自動初期化のオーバーヘッド
- 🟡 黄信号: NFR-001から推測、実際のOS依存性あり

#### TC-090-004: 連続読み上げで2回目以降は即座に開始される
- **テスト名**: 連続読み上げのパフォーマンス確認
  - **何をテストするか**: 2回目以降のspeak()呼び出し時の開始時間
  - **期待される動作**: 初期化済みのため即座に読み上げ開始
- **入力値**: text1 = "最初", text2 = "次"
  - **入力データの意味**: 連続使用シナリオ
- **期待される結果**: 2回目は100ms以内に開始
  - **期待結果の理由**: 初期化済みのため追加オーバーヘッドなし
- **テストの目的**: キャッシュ効果の確認
  - **確認ポイント**: 初期化の再実行がないこと
- 🟡 黄信号: パフォーマンス最適化の期待値

---

### 2. ローカルストレージ最適化 - 正常系テストケース

#### TC-090-005: 定型文100件の読み込みが1秒以内に完了する
- **テスト名**: 定型文100件読み込みパフォーマンス計測
  - **何をテストするか**: loadAll()の実行時間
  - **期待される動作**: 100件の定型文を1秒以内に読み込む
- **入力値**: 100件の定型文データ
  - **入力データの意味**: NFR-004の目標件数
- **期待される結果**: loadAll()が1000ms以内に完了
  - **期待結果の理由**: NFR-004パフォーマンス要件
- **テストの目的**: ストレージ読み込みパフォーマンス確認
  - **確認ポイント**: Hive読み込み時間
- 🔵 青信号: NFR-004に明確に記載

#### TC-090-006: キャッシュ有効時は2回目の読み込みが高速化される
- **テスト名**: キャッシュによる読み込み高速化確認
  - **何をテストするか**: 2回目のloadAll()呼び出し時の速度向上
  - **期待される動作**: メモリキャッシュから即座に返す
- **入力値**: 100件の定型文データ（2回loadAll()を呼び出す）
  - **入力データの意味**: キャッシュ効果の検証
- **期待される結果**: 2回目は10ms以内に完了
  - **期待結果の理由**: ディスクI/Oなしでメモリから読み出し
- **テストの目的**: キャッシュ実装の効果確認
  - **確認ポイント**: キャッシュヒット時の高速化
- 🟡 黄信号: 最適化実装の期待値

#### TC-090-007: キャッシュ無効化後は最新データが読み込まれる
- **テスト名**: キャッシュ無効化と最新データ取得
  - **何をテストするか**: invalidateCache()後のloadAll()で最新データが取得されること
  - **期待される動作**: キャッシュをクリアし、Hiveから再読み込み
- **入力値**: 初期データ → 更新 → invalidateCache() → loadAll()
  - **入力データの意味**: データ更新後のキャッシュ整合性
- **期待される結果**: 更新後のデータが取得される
  - **期待結果の理由**: キャッシュ無効化後は再読み込みが必要
- **テストの目的**: キャッシュ整合性の確認
  - **確認ポイント**: invalidateCache()の動作
- 🔵 青信号: キャッシュ実装の基本動作

#### TC-090-008: 保存操作時にキャッシュが自動無効化される
- **テスト名**: 保存時のキャッシュ自動無効化確認
  - **何をテストするか**: save()呼び出し後にキャッシュが無効化されること
  - **期待される動作**: save()後のloadAll()で最新データが取得される
- **入力値**: 初期データ → loadAll() → save(新データ) → loadAll()
  - **入力データの意味**: 保存操作後のキャッシュ整合性
- **期待される結果**: 2回目のloadAll()で新データが取得される
  - **期待結果の理由**: データ変更時はキャッシュを無効化する必要がある
- **テストの目的**: 自動キャッシュ無効化の確認
  - **確認ポイント**: CRUD操作後のキャッシュ状態
- 🔵 青信号: データ整合性要件

---

### 3. 異常系テストケース

#### TC-090-009: TTS初期化失敗時も読み上げが安全に失敗する
- **テスト名**: TTS初期化失敗時のエラーハンドリング
  - **エラーケースの概要**: TTSエンジンの初期化が失敗した場合
  - **エラー処理の重要性**: アプリクラッシュを防ぎ、基本機能を継続
- **入力値**: モックでsetLanguage()がExceptionをスロー
  - **不正な理由**: OS制限やハードウェア問題
  - **実際の発生シナリオ**: 古いOS、TTSエンジン未インストール
- **期待される結果**: state=error、errorMessageが設定される
  - **エラーメッセージの内容**: "TTS初期化に失敗しました"
  - **システムの安全性**: アプリは継続動作
- **テストの目的**: NFR-301（基本機能継続）の確認
  - **品質保証の観点**: 障害耐性
- 🔵 青信号: NFR-301、既存テスト（TC-048-011）のパターン

#### TC-090-010: Hive読み込みエラー時の安全な処理
- **テスト名**: Hive読み込みエラー時のフォールバック
  - **エラーケースの概要**: Hiveからのデータ読み込みが失敗した場合
  - **エラー処理の重要性**: データ損失を防ぎ、空リストで継続
- **入力値**: 破損したHive Box（モックで例外をスロー）
  - **不正な理由**: ストレージ破損、権限エラー
  - **実際の発生シナリオ**: ディスク容量不足、ファイル破損
- **期待される結果**: 空リストが返される、エラーログが出力される
  - **エラーメッセージの内容**: "定型文の読み込みに失敗しました"
  - **システムの安全性**: 既存データを保護、UIは正常表示
- **テストの目的**: EDGE-003、NFR-304の確認
  - **品質保証の観点**: データ保護
- 🟡 黄信号: NFR-304から推測

#### TC-090-011: 初期化未完了時のspeak()呼び出しは待機後に実行
- **テスト名**: 初期化中のspeak()呼び出し処理
  - **エラーケースの概要**: 初期化処理中にspeak()が呼ばれた場合
  - **エラー処理の重要性**: 競合状態を防ぎ、正常に読み上げ開始
- **入力値**: 初期化開始直後にspeak()を呼び出す
  - **不正な理由**: タイミング競合
  - **実際の発生シナリオ**: アプリ起動直後の読み上げ要求
- **期待される結果**: 初期化完了を待ってから読み上げ開始
  - **エラーメッセージの内容**: なし（正常処理）
  - **システムの安全性**: 競合状態を回避
- **テストの目的**: 競合状態の防止確認
  - **品質保証の観点**: 堅牢性
- 🟡 黄信号: 実装上の考慮事項

---

### 4. 境界値テストケース

#### TC-090-012: 定型文0件でのloadAll()パフォーマンス
- **テスト名**: 空データでの読み込みパフォーマンス
  - **境界値の意味**: データ最小値（0件）
  - **境界値での動作保証**: 空でもエラーなく高速に返す
- **入力値**: 0件の定型文データ
  - **境界値選択の根拠**: EDGE-104（空の一覧表示）
  - **実際の使用場面**: 初回起動、全削除後
- **期待される結果**: 空リストが10ms以内に返される
  - **境界での正確性**: null参照エラーなし
  - **一貫した動作**: 空リスト型で返す
- **テストの目的**: 最小値でのパフォーマンス確認
  - **堅牢性の確認**: エッジケース対応
- 🔵 青信号: EDGE-104対応

#### TC-090-013: 定型文500件でのloadAll()パフォーマンス
- **テスト名**: 大量データでの読み込みパフォーマンス
  - **境界値の意味**: データ上限値（想定最大500件）
  - **境界値での動作保証**: 大量データでも1秒以内
- **入力値**: 500件の定型文データ
  - **境界値選択の根拠**: 要件定義書の想定最大値
  - **実際の使用場面**: ヘビーユーザー、長期利用
- **期待される結果**: 500件が1秒以内に読み込まれる
  - **境界での正確性**: 全件正確に読み込み
  - **一貫した動作**: パフォーマンス維持
- **テストの目的**: スケーラビリティの確認
  - **堅牢性の確認**: 大量データ対応
- 🟡 黄信号: 要件定義書から推測、NFR-004の拡張

#### TC-090-014: 1文字テキストの読み上げ開始時間
- **テスト名**: 最小テキストでの読み上げ開始時間
  - **境界値の意味**: テキスト最小値（1文字）
  - **境界値での動作保証**: 1文字でも正常に処理
- **入力値**: text = "あ"（1文字）
  - **境界値選択の根拠**: 既存テスト（TC-048-015）
  - **実際の使用場面**: 短い応答
- **期待される結果**: 1秒以内に読み上げ開始
  - **境界での正確性**: 短いテキストでも遅延なし
  - **一貫した動作**: 通常テキストと同等のパフォーマンス
- **テストの目的**: 最小値でのパフォーマンス確認
  - **堅牢性の確認**: 短いテキスト対応
- 🔵 青信号: 既存テストパターン

#### TC-090-015: 1000文字テキストの読み上げ開始時間
- **テスト名**: 最大テキストでの読み上げ開始時間
  - **境界値の意味**: テキスト最大値（1000文字）
  - **境界値での動作保証**: 長文でも1秒以内に開始
- **入力値**: text = "あ" * 1000（1000文字）
  - **境界値選択の根拠**: EDGE-101（入力欄の文字数制限）
  - **実際の使用場面**: 長文メッセージ
- **期待される結果**: 1秒以内に読み上げ開始
  - **境界での正確性**: 全文が正確に読み上げられる
  - **一貫した動作**: 短いテキストと同等の開始時間
- **テストの目的**: 最大値でのパフォーマンス確認
  - **堅牢性の確認**: 長文対応
- 🔵 青信号: EDGE-101対応

---

## テスト実装ファイル構成

```
frontend/kotonoha_app/test/
├── features/
│   ├── tts/
│   │   ├── domain/services/
│   │   │   └── tts_service_optimization_test.dart  # TC-090-001〜004, 009, 011, 014, 015
│   │   └── providers/
│   │       └── tts_provider_optimization_test.dart # TC-090-001（Provider層）
│   └── preset_phrase/
│       └── data/
│           └── preset_phrase_repository_cache_test.dart  # TC-090-005〜008, 010, 012, 013
└── integration/
    └── performance_optimization_test.dart  # 統合パフォーマンステスト
```

---

## 品質判定

### ✅ 高品質

| 項目 | 状況 |
|------|------|
| テストケース分類 | 正常系4件、異常系3件、境界値4件 - 全カテゴリ網羅 |
| 期待値定義 | パフォーマンス目標値（1秒、100ms等）が明確 |
| 技術選択 | flutter_test + mocktail確定、既存パターン踏襲 |
| 実装可能性 | 既存テストパターン（TC-048, TC-055）をベースに実装可能 |

---

## 次のステップ

次のお勧めステップ: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。

---

## 更新履歴

- **2025-12-01**: 初版作成（TDDテストケース洗い出しフェーズ）
