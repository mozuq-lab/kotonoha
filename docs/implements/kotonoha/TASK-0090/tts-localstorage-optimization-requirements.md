# TASK-0090: TTS・ローカルストレージ最適化 - 要件定義書

## 概要

### 機能名
TTS・ローカルストレージ最適化（Performance Optimization for TTS and Local Storage）

### 作成日
2025-12-01

### 関連タスク
- TASK-0090
- 依存: TASK-0088 (パフォーマンス計測・プロファイリング) ✅ 完了

---

## 1. 機能の概要

### 🔵 何をする機能か
TTS（Text-to-Speech）読み上げ開始時間とローカルストレージ（Hive）読み込み時間を最適化し、パフォーマンス要件を安定して満たすことを目的とした最適化機能。

**参照したEARS要件**: NFR-001, NFR-004, REQ-5003

### 🔵 どのような問題を解決するか
1. **TTS読み上げ開始遅延**: 初回読み上げ時にTTSエンジンの初期化が同期的に実行され、遅延が発生する可能性がある
2. **定型文一覧表示遅延**: 大量の定型文（100件以上）を一覧表示する際にUIブロックが発生する可能性がある
3. **Hive読み込み遅延**: 起動時のHive初期化・データ読み込みがメインスレッドをブロックする可能性がある

### 🔵 想定されるユーザー
- 脳梗塞・ALS・筋疾患などで発話が困難な方
- 素早いコミュニケーションが必要な場面（医師への緊急連絡、家族との会話等）

### 🔵 システム内での位置づけ
- **レイヤー**: アプリケーション基盤層（TTSサービス、ローカルストレージ）
- **依存関係**:
  - TTSService（既存実装: TASK-0048）
  - HiveInit（既存実装: TASK-0054）
  - PresetPhraseRepository（既存実装: TASK-0055）
  - PresetPhraseScreen（既存実装: TASK-0083）

---

## 2. 入力・出力の仕様

### 🔵 TTS最適化

#### 入力パラメータ
| パラメータ名 | 型 | 制約 | 説明 |
|-------------|-----|------|------|
| text | String | 1-1000文字 | 読み上げるテキスト |
| speed | TTSSpeed | slow/normal/fast | 読み上げ速度 |

#### 出力値
| 出力名 | 型 | 説明 |
|--------|-----|------|
| state | TTSState | idle/speaking/stopped/completed/error |
| speakStartTime | Duration | 読み上げ開始までの時間（計測用） |

#### パフォーマンス要件
- **NFR-001**: TTS読み上げ開始までの時間を**1秒以内**

### 🔵 ローカルストレージ最適化

#### 入力パラメータ
| パラメータ名 | 型 | 制約 | 説明 |
|-------------|-----|------|------|
| - | - | - | Hive Boxのオープン・データ読み込み |

#### 出力値
| 出力名 | 型 | 説明 |
|--------|-----|------|
| phrases | List<PresetPhrase> | 定型文リスト（最大500件程度想定） |
| loadTime | Duration | 読み込み時間（計測用） |

#### パフォーマンス要件
- **NFR-004**: 定型文一覧の表示（100件程度）を**1秒以内**に完了

---

## 3. 制約条件

### 🔵 パフォーマンス要件
| 要件ID | 内容 | 目標値 |
|--------|------|--------|
| NFR-001 | TTS読み上げ開始時間 | 1秒以内 |
| NFR-003 | 文字盤タップ応答 | 100ms以内 |
| NFR-004 | 定型文100件表示 | 1秒以内 |

### 🔵 アーキテクチャ制約
- **Riverpod**: 状態管理はRiverpodを使用（StateNotifierProvider）
- **Hive**: ローカルストレージはHiveを使用
- **flutter_tts**: TTSエンジンはflutter_ttsを使用（OS標準TTS）

### 🔵 互換性要件
- **NFR-401**: iOS 14.0以上、Android 10以上で動作
- **NFR-403**: 縦向き・横向き両方の画面方向で正常動作

### 🟡 技術的制約
- TTSエンジンの初期化はOSに依存するため、完全な制御は不可能
- Hiveの読み込み速度はストレージ性能に依存

---

## 4. 想定される使用例

### 🔵 基本的な使用パターン

#### パターン1: 初回起動時のTTS読み上げ
1. アプリ起動
2. 文字盤で「こんにちは」と入力
3. 読み上げボタンをタップ
4. **1秒以内**にTTS読み上げが開始される

#### パターン2: 定型文一覧表示
1. 定型文タブを選択
2. **1秒以内**に100件の定型文が一覧表示される
3. スクロールしても描画遅延なし

#### パターン3: 連続読み上げ
1. 定型文を選択して読み上げ
2. 読み上げ完了前に別の定型文を選択
3. 前の読み上げが停止し、新しい読み上げが即座に開始

### 🟡 エッジケース

#### EDGE-TTS-001: 初回起動時のTTS遅延
- **状況**: アプリ初回起動時、TTSエンジンが未初期化
- **期待動作**: バックグラウンドで事前初期化し、読み上げ要求時は即座に開始
- **最適化手法**: 遅延初期化（Lazy Initialization）

#### EDGE-STORAGE-001: 大量データ読み込み
- **状況**: 定型文が500件以上存在
- **期待動作**: UIをブロックせず、非同期でデータを読み込む
- **最適化手法**: 仮想スクロール、ページネーション

#### EDGE-STORAGE-002: Hive初期化遅延
- **状況**: 起動時のHive初期化が遅い
- **期待動作**: 起動画面表示中にバックグラウンドで初期化
- **最適化手法**: 非同期初期化

---

## 5. EARS要件・設計文書との対応関係

### 参照した機能要件
- **REQ-401**: システムは入力欄のテキストをOS標準TTSで読み上げる機能を提供しなければならない
- **REQ-5003**: システムはアプリが強制終了しても定型文・設定・履歴を失わない永続化機構を実装しなければならない

### 参照した非機能要件
- **NFR-001**: システムはTTS読み上げ開始までの時間を1秒以内としなければならない 🔵
- **NFR-003**: システムは文字盤タップから入力欄への文字反映までの遅延を100ms以内としなければならない 🔵
- **NFR-004**: システムは定型文一覧の表示（100件程度）を1秒以内に完了しなければならない 🔵
- **NFR-301**: システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない 🔵

### 参照した設計文書
- **アーキテクチャ**: docs/design/kotonoha/architecture.md（オフラインファースト設計）
- **型定義**: docs/design/kotonoha/interfaces.dart（TTSService、PresetPhrase）
- **技術スタック**: docs/tech-stack.md（Flutter + Riverpod + Hive）

---

## 6. 実装方針

### 🔵 TTS最適化実装

#### 6.1 遅延初期化（Lazy Initialization）
現在のTTSServiceは初回speak()呼び出し時に初期化を行っている。これを改善し、アプリ起動時にバックグラウンドで事前初期化を行う。

```dart
// 改善前: speak()呼び出し時に初期化
Future<void> speak(String text) async {
  if (!_isInitialized) {
    await initialize(); // 遅延発生
  }
  await tts.speak(text);
}

// 改善後: アプリ起動時にバックグラウンドで事前初期化
class TTSNotifier extends StateNotifier<TTSServiceState> {
  TTSNotifier() : super(TTSServiceState.initial()) {
    // バックグラウンドで事前初期化
    Future.microtask(() => _service.initialize());
  }
}
```

#### 6.2 TTS読み上げ開始時間計測
パフォーマンス監視のために読み上げ開始時間を計測するメソッドを追加。

### 🔵 ローカルストレージ最適化実装

#### 6.3 Hive読み込みキャッシュ
Hive Boxから読み込んだデータをメモリキャッシュに保持し、再読み込みを回避。

```dart
class PresetPhraseRepository {
  List<PresetPhrase>? _cache;

  Future<List<PresetPhrase>> loadAll() async {
    if (_cache != null) return _cache!;
    _cache = _box.values.toList();
    return _cache!;
  }

  void invalidateCache() => _cache = null;
}
```

#### 6.4 定型文一覧の仮想スクロール
ListView.builderを使用した仮想スクロール実装（既存実装の確認・最適化）。

#### 6.5 データベース操作の非同期最適化
Hive操作がUIスレッドをブロックしないよう、Isolateまたはcompute()を使用。

---

## 7. 品質判定

### ✅ 高品質

| 項目 | 状況 |
|------|------|
| 要件の曖昧さ | なし - NFR-001, NFR-004が明確に定義 |
| 入出力定義 | 完全 - パラメータ、戻り値、計測値が明確 |
| 制約条件 | 明確 - パフォーマンス目標値が数値で定義 |
| 実装可能性 | 確実 - 既存実装ベースでの最適化 |

---

## 8. 次のステップ

次のお勧めステップ: `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。

---

## 更新履歴

- **2025-12-01**: 初版作成（TDD要件定義フェーズ）
