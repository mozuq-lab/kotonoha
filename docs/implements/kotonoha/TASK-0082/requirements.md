# TASK-0082 文字入力・読み上げE2Eテスト TDD要件定義書

## 概要

- **タスクID**: TASK-0082
- **タスク名**: 文字入力・読み上げE2Eテスト
- **タスクタイプ**: TDD
- **作成日時**: 2025-11-29
- **関連要件**: REQ-001, REQ-002, REQ-401, REQ-402, NFR-001, NFR-003
- **依存タスク**: TASK-0081 (E2Eテスト環境構築) - 完了済み

## タスクの目的

このタスクは、kotonohaアプリの最も基本的かつ重要なユーザーフロー「文字盤タップ → 入力欄反映 → 読み上げ」のエンドツーエンド（E2E）テストを実装し、以下を保証することを目的とします。

1. **機能正常性**: 文字入力と読み上げ機能が正しく動作すること
2. **パフォーマンス**: NFR-001（TTS開始1秒以内）、NFR-003（タップ応答100ms以内）を満たすこと
3. **ユーザビリティ**: 削除・全消去機能が正しく動作すること
4. **信頼性**: 境界値（1文字、1000文字）や異常系でも安定動作すること

---

## 機能要件の詳細

### 1. 文字盤入力機能 (REQ-001, REQ-002)

#### REQ-001: 五十音配列の文字盤UI表示
- **要件内容**: システムは五十音配列の文字盤UIを表示しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-1、ユーザヒアリングで明確）
- **受け入れ基準**:
  - 五十音（あ行〜わ行）がボタンとして表示される
  - 濁音・半濁音・小文字の入力手段が提供される
  - 各ボタンのサイズが最小44px × 44px以上（REQ-5001）
  - 推奨サイズは60px × 60px以上（NFR-202）
- **E2Eテストでの確認ポイント**:
  - 文字盤UIが画面上に表示されること
  - すべての文字ボタンがタップ可能であること

#### REQ-002: 文字タップで入力欄に文字追加
- **要件内容**: システムは文字盤の文字をタップすると入力欄に文字を追加しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-1で明確）
- **受け入れ基準**:
  - 文字ボタンをタップすると、入力欄の末尾に文字が追加される
  - 連続タップで複数文字が順番通りに追加される
  - タップから入力欄反映までの遅延が100ms以内（NFR-003）
- **E2Eテストでの確認ポイント**:
  - 「こんにちは」を順番にタップして正しく入力されること
  - 連続タップで文字が抜けないこと

### 2. 削除機能 (REQ-003, REQ-004)

#### REQ-003: 削除ボタンで最後の1文字削除
- **要件内容**: システムは削除ボタンで最後の1文字を削除する機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-1で明確）
- **受け入れ基準**:
  - 削除ボタンタップで入力欄の最後の1文字のみが削除される
  - 入力欄が空の場合、削除ボタンを押しても安全に処理される（エラーにならない）
- **E2Eテストでの確認ポイント**:
  - 「あいう」入力後、削除で「あい」になること
  - 空の状態で削除ボタンを押してもエラーにならないこと

#### REQ-004: 全消去ボタンで全文字削除
- **要件内容**: システムは全消去ボタンで入力欄のすべての文字を削除する機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-1で明確）
- **受け入れ基準**:
  - 全消去ボタンタップで確認ダイアログが表示される（REQ-2001）
  - 確認ダイアログで「はい」を選択すると、入力欄が空になる
  - 確認ダイアログで「いいえ」を選択すると、入力欄の内容が保持される（REQ-5002）
- **E2Eテストでの確認ポイント**:
  - 確認ダイアログが表示されること
  - 「はい」選択で全削除されること
  - 「いいえ」選択で内容が保持されること

### 3. 音声読み上げ機能 (REQ-401, REQ-402, REQ-403)

#### REQ-401: OS標準TTSで読み上げ
- **要件内容**: システムは入力欄のテキストをOS標準TTSで読み上げる機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-2-1、ユーザヒアリングで明確）
- **受け入れ基準**:
  - 読み上げボタンタップで入力欄のテキストが読み上げられる
  - OS標準TTS（flutter_tts）を使用
  - 読み上げ開始までの時間が1秒以内（NFR-001）
- **E2Eテストでの確認ポイント**:
  - 読み上げボタンタップでTTSが開始されること
  - 読み上げ開始が1秒以内であること

#### REQ-402: 読み上げボタンの明確な表示
- **要件内容**: システムは読み上げボタンを明確に表示しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-2-1で明確）
- **受け入れ基準**:
  - 読み上げボタンが視認しやすい位置に配置される
  - ボタンサイズが最小44px × 44px以上（REQ-5001）
- **E2Eテストでの確認ポイント**:
  - 読み上げボタンが画面上に表示されること

#### REQ-403: 読み上げ中の停止・中断機能
- **要件内容**: システムは読み上げ中の停止・中断機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-2-1で明確）
- **受け入れ基準**:
  - 読み上げ中は読み上げボタンが「停止」ボタンとして表示される（REQ-3003）
  - 停止ボタンタップで読み上げが中断される
- **E2Eテストでの確認ポイント**:
  - 読み上げ中に停止ボタンが表示されること
  - 停止ボタンタップで読み上げが停止すること

---

## 非機能要件の詳細

### 1. パフォーマンス要件

#### NFR-001: TTS読み上げ開始1秒以内
- **要件内容**: システムはTTS読み上げ開始までの時間を1秒以内としなければならない
- **信頼性レベル**: 🟡 黄信号（mvp-requirements-original.md 6-2から具体化）
- **受け入れ基準**:
  - 読み上げボタンタップからTTS再生開始までが1秒（1000ms）以内
  - OS標準TTSを使用することで低遅延を実現
- **E2Eテストでの計測方法**:
  - Stopwatchを使用してタップからTTS開始までの時間を計測
  - 複数回計測して平均値が1秒以内であることを確認

#### NFR-003: 文字盤タップ応答100ms以内
- **要件内容**: システムは文字盤タップから入力欄への文字反映までの遅延を100ms以内としなければならない
- **信頼性レベル**: 🟡 黄信号（mvp-requirements-original.md 6-2から推測）
- **受け入れ基準**:
  - 文字ボタンタップから入力欄のテキスト更新完了までが100ms以内
  - ネイティブFlutterウィジェットを使用することで高速応答を実現
- **E2Eテストでの計測方法**:
  - Stopwatchを使用してタップから画面更新までの時間を計測
  - 連続10回タップでもすべて100ms以内であることを確認

### 2. ユーザビリティ要件

#### NFR-202: ボタンを視認性高く押しやすいサイズで設計
- **要件内容**: システムはボタン・タップ領域を視認性が高く押しやすいサイズ（推奨60px × 60px以上）で設計しなければならない
- **信頼性レベル**: 🟡 黄信号（mvp-requirements-original.md 6-1から具体化）
- **受け入れ基準**:
  - 文字盤ボタン、読み上げボタン、削除ボタンが60px × 60px以上
  - 最小サイズでも44px × 44px以上（REQ-5001）
- **E2Eテストでの確認ポイント**:
  - ボタンがタップしやすいサイズで表示されること

#### REQ-5002: 誤操作防止の仕組み
- **要件内容**: システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 6-1で明確）
- **受け入れ基準**:
  - 全消去ボタンタップ時に確認ダイアログが表示される
  - ダイアログで「いいえ」を選択すると操作がキャンセルされる
- **E2Eテストでの確認ポイント**:
  - 確認ダイアログが正しく動作すること

### 3. 信頼性要件

#### NFR-301: 重大エラーでも基本機能を継続利用可能
- **要件内容**: システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 6-4で明確）
- **受け入れ基準**:
  - TTS再生エラーが発生しても、文字入力は継続できる
  - 空の入力欄で読み上げボタンを押してもエラーにならない
- **E2Eテストでの確認ポイント**:
  - 異常系テストでアプリがクラッシュしないこと

---

## 境界値・エッジケースの詳細

### EDGE-101: 入力欄の文字数制限（1000文字）
- **要件内容**: 入力欄の文字数が1000文字を超えた場合、システムは警告を表示し、1000文字で入力を制限しなければならない
- **信頼性レベル**: 🟡 黄信号（推測）
- **受け入れ基準**:
  - 1000文字までは正常に入力できる
  - 1001文字目以降は入力されない
  - 制限に達した際に警告が表示される
- **E2Eテストでの確認ポイント**:
  - 1000文字入力後、さらにタップしても追加されないこと
  - 警告メッセージが表示されること

### 空入力欄での読み上げ試行
- **エラーケース**: 入力欄が空の状態で読み上げボタンをタップ
- **信頼性レベル**: 🟡 黄信号（妥当な推測）
- **期待される動作**:
  - エラーにならない
  - 読み上げが実行されない、または「入力してください」といった視覚的フィードバック
- **E2Eテストでの確認ポイント**:
  - アプリがクラッシュしないこと
  - 安全に処理されること

### 削除ボタン連打での境界確認
- **エッジケース**: 入力欄が空になった後も削除ボタンをタップ
- **信頼性レベル**: 🟡 黄信号（防御的プログラミングから推測）
- **期待される動作**:
  - エラーにならない
  - 空の状態が保持される
- **E2Eテストでの確認ポイント**:
  - アプリがクラッシュしないこと
  - 安全に無視されること

---

## テスト対象範囲

### 含まれる機能（スコープ内）

1. **文字盤入力機能**:
   - 五十音の文字ボタン表示
   - 文字タップで入力欄に追加
   - 連続タップでの複数文字入力

2. **削除機能**:
   - 削除ボタンで1文字削除
   - 全消去ボタンで全削除（確認ダイアログ付き）

3. **読み上げ機能**:
   - 読み上げボタンで入力欄テキストを読み上げ
   - 読み上げ中の停止ボタン

4. **パフォーマンス**:
   - 文字盤タップ応答100ms以内
   - TTS読み上げ開始1秒以内

5. **境界値・異常系**:
   - 1文字入力
   - 1000文字入力
   - 1001文字目の制限
   - 空入力欄での操作
   - 削除ボタン連打

### 含まれない機能（スコープ外）

1. **定型文機能**: 別タスク（TASK-0083以降）でテスト
2. **大ボタン機能**: 別タスクでテスト
3. **履歴詳細機能**: 統合テストでは履歴保存を確認するが、履歴画面の詳細操作は別タスク
4. **AI変換機能**: 別タスクでテスト
5. **設定機能（フォントサイズ、テーマ、読み上げ速度）**: 別タスクでテスト
6. **対面表示機能**: 別タスクでテスト

---

## 受け入れ基準

### 機能正常性

- [ ] TC-E2E-082-001: 文字盤で「こんにちは」を入力できる ✅
- [ ] TC-E2E-082-002: 入力後に読み上げボタンをタップしてTTSが開始される ✅
- [ ] TC-E2E-082-003: 連続した文字入力が正しく処理される ✅
- [ ] TC-E2E-082-004: 削除ボタンで最後の1文字が削除される ✅
- [ ] TC-E2E-082-005: 全消去ボタンで全文字が削除される ✅
- [ ] TC-E2E-082-006: 読み上げ中に停止ボタンで停止できる ✅

### 異常系・エラーハンドリング

- [ ] TC-E2E-082-007: 空の入力欄で読み上げボタンをタップしても安全に処理される ✅
- [ ] TC-E2E-082-008: 全消去確認ダイアログでキャンセルすると内容が保持される ✅

### 境界値

- [ ] TC-E2E-082-009: 1文字だけ入力して読み上げができる ✅
- [ ] TC-E2E-082-010: 1000文字の入力と読み上げができる ✅
- [ ] TC-E2E-082-011: 1001文字目の入力が制限される ✅
- [ ] TC-E2E-082-012: 削除ボタン連打で空になった後も安全に処理される ✅

### パフォーマンス

- [ ] TC-E2E-082-013: 文字盤タップ応答が100ms以内 ✅
- [ ] TC-E2E-082-014: TTS読み上げ開始が1秒以内 ✅
- [ ] TC-E2E-082-015: 連続10回タップの応答が安定（すべて100ms以内） ✅

### 統合テスト

- [ ] TC-E2E-082-016: 文字入力→読み上げ→履歴保存の一連フローが正常動作 ✅
- [ ] TC-E2E-082-017: 複数回の入力→読み上げサイクルが安定動作 ✅

---

## 技術的実装方針

### テストフレームワーク

- **使用パッケージ**: `integration_test`（Flutter公式E2Eテストフレームワーク）
- **テスト実行環境**: Chrome（Web）、iOS/Androidエミュレータ/実機
- **選択理由**: Flutter公式で推奨、ウィジェットテストの拡張としてE2Eテストが可能

### パフォーマンス計測

- **計測方法**: Dartの`Stopwatch`クラスを使用
- **計測ポイント**:
  - タップイベント発火から入力欄更新完了までの時間
  - 読み上げボタンタップからTTS再生開始までの時間
- **合格基準**:
  - 文字盤タップ応答: 100ms以内
  - TTS読み上げ開始: 1秒（1000ms）以内

### ヘルパー関数の活用

TASK-0081で実装済みのヘルパー関数を活用:

- `pumpApp(tester)`: アプリを初期化してホーム画面を表示
- `typeOnCharacterBoard(tester, text)`: 文字盤で文字列を入力
- `tapCharacterOnBoard(tester, char)`: 文字盤で1文字をタップ
- `measurePerformance(name, maxMilliseconds, action)`: パフォーマンス計測

---

## テストケース一覧

詳細なテストケースは別ファイル参照:
- **ファイル**: `character-input-tts-testcases.md`
- **テストケース総数**: 17件
  - 正常系: 6件
  - 異常系: 2件
  - 境界値: 4件
  - パフォーマンス: 3件
  - 統合テスト: 2件

---

## 品質基準

### コードカバレッジ

- **目標カバレッジ**: 80%以上（NFR-501）
- **対象範囲**:
  - 文字盤入力ロジック
  - 削除・全消去ロジック
  - TTS制御ロジック
  - 入力文字数制限ロジック

### テスト成功基準

- [ ] すべてのテストケース（17件）がGREENで成功
- [ ] パフォーマンステストがすべて基準値以内
- [ ] 異常系テストでアプリがクラッシュしない
- [ ] コードカバレッジが80%以上

---

## 信頼性レベル内訳

### 🔵 青信号（確実な要件）: 10件

- REQ-001: 五十音配列の文字盤UI表示
- REQ-002: 文字タップで入力欄に文字追加
- REQ-003: 削除ボタンで最後の1文字削除
- REQ-004: 全消去ボタンで全文字削除
- REQ-401: OS標準TTSで読み上げ
- REQ-402: 読み上げボタンの明確な表示
- REQ-403: 読み上げ中の停止・中断機能
- REQ-5002: 誤操作防止の仕組み
- NFR-001: TTS読み上げ開始1秒以内
- NFR-003: 文字盤タップ応答100ms以内

### 🟡 黄信号（妥当な推測）: 7件

- 連続した文字入力の処理
- 1文字入力での読み上げ
- 1000文字制限（EDGE-101）
- 1001文字目の制限動作
- 削除ボタン連打の境界確認
- 空入力欄での読み上げ試行
- 連続10回タップの応答安定性

### 🔴 赤信号（推測）: 0件

---

## 開発フロー

### TDDサイクル

1. **RED（失敗テスト作成）**:
   - `/tsumiki:tdd-red`コマンドで実行
   - 17個のテストケースを実装
   - すべてのテストが失敗することを確認

2. **GREEN（テストを通す実装）**:
   - `/tsumiki:tdd-green`コマンドで実行
   - 文字盤入力、削除、読み上げ機能を実装
   - すべてのテストが成功することを確認

3. **REFACTOR（リファクタリング）**:
   - `/tsumiki:tdd-refactor`コマンドで実行
   - コード品質の向上
   - パフォーマンス最適化

4. **VERIFY（完了検証）**:
   - `/tsumiki:tdd-verify-complete`コマンドで実行
   - すべてのテストが成功
   - カバレッジが80%以上
   - パフォーマンス要件を満たす

---

## 次のステップ

このTDD要件定義書の確認後、次のステップに進んでください:

1. `/tsumiki:tdd-red` - REDフェーズ（失敗するテストを作成）
2. `/tsumiki:tdd-green` - GREENフェーズ（テストを通す実装）
3. `/tsumiki:tdd-refactor` - REFACTORフェーズ（リファクタリング）
4. `/tsumiki:tdd-verify-complete` - VERIFY（完了検証）

---

## 関連ドキュメント

- **要件定義書**: `docs/spec/kotonoha-requirements.md`
- **テストケース一覧**: `docs/implements/kotonoha/TASK-0082/character-input-tts-testcases.md`
- **E2Eテスト環境構築**: TASK-0081の実装記録
- **技術スタック**: `docs/tech-stack.md`

---

## 更新履歴

- **2025-11-29**: TDD要件定義書作成
  - 機能要件の詳細化（REQ-001, REQ-002, REQ-401, REQ-402, REQ-403）
  - 非機能要件の詳細化（NFR-001, NFR-003）
  - 境界値・エッジケースの明確化（EDGE-101）
  - テスト対象範囲の定義
  - 受け入れ基準の設定（17件のテストケース）
  - 信頼性レベル内訳の整理（🔵10件、🟡7件、🔴0件）
