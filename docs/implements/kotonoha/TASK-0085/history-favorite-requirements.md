# 履歴・お気に入りE2Eテスト 要件定義書

## TASK-0085: 履歴・お気に入りE2Eテスト

**作成日**: 2025-11-29
**関連要件**: REQ-601, REQ-602, REQ-603, REQ-701, REQ-702, REQ-703
**依存タスク**: TASK-0081 (E2Eテスト環境構築)

---

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

### 1.1 履歴機能 🔵
- **何をする機能**: 読み上げまたは表示した文章を自動的に履歴として保存し、後から再利用できる機能
- **解決する問題**: 同じ内容を繰り返し入力する手間を省き、効率的なコミュニケーションを支援
- **想定ユーザー**: 発話困難な方（脳梗塞・ALS・筋疾患など）
- **システム内の位置づけ**: ローカルストレージ（Hive）に保存、オフライン動作対応

### 1.2 お気に入り機能 🔵
- **何をする機能**: 定型文または履歴からよく使うフレーズをお気に入り登録し、優先的にアクセスできる機能
- **解決する問題**: 頻繁に使用するフレーズへの素早いアクセスを提供
- **想定ユーザー**: 発話困難な方（脳梗塞・ALS・筋疾患など）
- **システム内の位置づけ**: ローカルストレージ（Hive）に保存、並び順のカスタマイズ可能

### 参照したEARS要件
- REQ-601: 履歴の自動保存
- REQ-602: 履歴の50件制限と自動削除
- REQ-603: 履歴からの再読み上げ
- REQ-701: お気に入り登録機能
- REQ-702: お気に入りの優先表示
- REQ-703: お気に入りの並び順変更

### 参照した設計文書
- architecture.md: オフラインファースト設計、ローカルストレージ優先
- dataflow.md: 履歴・お気に入り管理フロー
- interfaces.dart: History, Favorite, HistoryType エンティティ

---

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

### 2.1 履歴機能 🔵

#### 入力
| パラメータ | 型 | 制約 | 説明 |
|-----------|-----|------|------|
| content | String | 1-1000文字 | 読み上げ・表示したテキスト |
| type | HistoryType | enum: manualInput, preset, aiConverted, quickButton | 履歴の種類 |

#### 出力
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | String (UUID) | 一意識別子 |
| content | String | テキスト内容 |
| createdAt | DateTime | 作成日時 |
| type | HistoryType | 履歴の種類 |

#### データフロー
```
読み上げ実行 → 履歴自動保存 → 50件超過チェック → 古い履歴自動削除
```

### 2.2 お気に入り機能 🔵

#### 入力
| パラメータ | 型 | 制約 | 説明 |
|-----------|-----|------|------|
| content | String | 1-1000文字 | お気に入り登録するテキスト |
| displayOrder | int | >= 0 | 並び順 |

#### 出力
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | String (UUID) | 一意識別子 |
| content | String | テキスト内容 |
| createdAt | DateTime | 登録日時 |
| displayOrder | int | 並び順 |

#### データフロー
```
履歴項目長押し → コンテキストメニュー → お気に入り追加 → displayOrder自動設定
```

### 参照したEARS要件
- REQ-601, REQ-602, REQ-603 (履歴)
- REQ-701, REQ-702, REQ-703 (お気に入り)

### 参照した設計文書
- interfaces.dart: History class (lines 106-156), Favorite class (lines 158-211)

---

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### 3.1 パフォーマンス要件 🔵
| 要件ID | 内容 | 基準 |
|--------|------|------|
| NFR-001 | TTS読み上げ開始時間 | 1秒以内 |
| NFR-004 | 定型文一覧表示（100件程度） | 1秒以内 |
| - | 履歴一覧表示（50件） | 1秒以内（推定） |

### 3.2 データ制約 🔵
| 制約 | 内容 |
|------|------|
| 履歴件数上限 | 50件（REQ-602） |
| 自動削除 | 51件目追加時、最古の履歴を自動削除 |
| 重複チェック | お気に入り登録時、同一内容は追加不可 |
| ローカル保存 | すべてのデータは端末内に保存（NFR-101） |

### 3.3 UI制約 🔵
| 制約 | 内容 |
|------|------|
| タップターゲット | 44px × 44px以上（REQ-5001） |
| 確認ダイアログ | 削除操作時は必須（REQ-2002, REQ-704） |
| barrierDismissible | false（誤操作防止） |

### 参照したEARS要件
- NFR-001, NFR-004 (パフォーマンス)
- NFR-101 (プライバシー・ローカル保存)
- REQ-5001 (タップターゲット)
- REQ-2002, REQ-704 (確認ダイアログ)

### 参照した設計文書
- architecture.md: パフォーマンス要件、ユーザビリティ要件

---

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 4.1 基本的な使用パターン 🔵

#### E2E-HIST-001: 読み上げ → 履歴自動保存 → 履歴一覧表示
1. メイン画面で文字入力
2. 読み上げボタンをタップ
3. TTS読み上げ実行
4. 履歴画面に遷移
5. 履歴一覧に保存されたテキストが表示される

#### E2E-HIST-002: 履歴タップ → 再読み上げ
1. 履歴画面を開く
2. 履歴項目をタップ
3. TTS再読み上げが実行される

#### E2E-HIST-003: 履歴からお気に入り登録 → お気に入り一覧表示
1. 履歴画面を開く
2. 履歴項目を長押し
3. コンテキストメニューから「お気に入りに追加」を選択
4. お気に入り画面に遷移
5. 登録されたテキストが表示される

#### E2E-FAV-001: お気に入り並び順変更
1. お気に入り画面を開く
2. 編集ボタンをタップ
3. ドラッグ&ドロップで並び順を変更
4. 完了ボタンをタップ
5. 新しい並び順が保存される

### 4.2 エッジケース 🔵

#### E2E-HIST-004: 50件制限・自動削除の確認
1. 50件の履歴を追加
2. 51件目を追加
3. 最古の履歴が自動削除される
4. 履歴件数が50件のまま

#### E2E-HIST-005: 履歴0件の状態
1. 履歴がない状態で履歴画面を開く
2. 「履歴がありません」メッセージが表示される
（EDGE-103）

#### E2E-FAV-002: お気に入り0件の状態
1. お気に入りがない状態でお気に入り画面を開く
2. 「お気に入りがありません」メッセージが表示される
（EDGE-104）

#### E2E-FAV-003: お気に入り重複登録の防止
1. 同じ内容を2回お気に入り登録しようとする
2. 重複エラーメッセージが表示される
3. 2件目は登録されない

### 4.3 異常系 🟡

#### E2E-HIST-006: 履歴削除確認ダイアログ
1. 履歴項目の削除ボタンをタップ
2. 確認ダイアログが表示される
3. 「キャンセル」で削除中止
4. 「削除」で削除実行

#### E2E-HIST-007: 履歴全削除確認ダイアログ
1. 全削除ボタンをタップ
2. 確認ダイアログが表示される
3. 「はい」で全削除実行
4. 履歴が0件になる

#### E2E-FAV-004: お気に入り削除確認ダイアログ
1. お気に入り項目の削除ボタンをタップ
2. 確認ダイアログが表示される
（REQ-704: 確認ダイアログ必須）

### 参照したEARS要件
- REQ-601, REQ-602, REQ-603 (履歴基本操作)
- REQ-701, REQ-702, REQ-703 (お気に入り基本操作)
- EDGE-103, EDGE-104 (空状態)
- REQ-704 (削除確認ダイアログ)

### 参照した設計文書
- dataflow.md: 履歴・お気に入り管理フロー

---

## 5. EARS要件・設計文書との対応関係

### 5.1 参照したユーザストーリー
- US-006: 履歴から再読み上げしたい
- US-007: お気に入りを管理したい

### 5.2 参照した機能要件
| 要件ID | 内容 | E2Eテストカバレッジ |
|--------|------|---------------------|
| REQ-601 | 履歴の自動保存 | E2E-HIST-001 |
| REQ-602 | 50件制限・自動削除 | E2E-HIST-004 |
| REQ-603 | 履歴からの再読み上げ | E2E-HIST-002 |
| REQ-701 | お気に入り登録 | E2E-HIST-003 |
| REQ-702 | お気に入り優先表示 | E2E-FAV-001 |
| REQ-703 | お気に入り並び順変更 | E2E-FAV-001 |
| REQ-704 | お気に入り削除確認 | E2E-FAV-004 |

### 5.3 参照した非機能要件
- NFR-001: TTS読み上げ1秒以内
- NFR-004: 一覧表示1秒以内
- NFR-101: ローカル保存

### 5.4 参照したEdgeケース
- EDGE-103: 履歴0件
- EDGE-104: お気に入り0件

### 5.5 参照した設計文書
- **アーキテクチャ**: architecture.md - オフラインファースト設計
- **データフロー**: dataflow.md - 履歴・お気に入り管理フロー
- **型定義**: interfaces.dart - History, Favorite エンティティ

---

## 6. 実装済み機能の確認

### 6.1 履歴機能（実装済み）
- `history_screen.dart`: 履歴一覧表示、個別削除、全削除、再読み上げ
- `history_provider.dart`: 履歴のCRUD操作
- `history_item_card.dart`: 履歴項目UI

### 6.2 お気に入り機能（実装済み）
- `favorites_screen.dart`: お気に入り一覧表示、並び替え、削除
- `favorite_provider.dart`: お気に入りのCRUD操作、並び替え
- `favorite_item_card.dart`: お気に入り項目UI

### 6.3 E2Eテストヘルパー（利用可能）
- `test_helpers.dart`: pumpApp(), tapButton(), waitForText() など

---

## 7. 品質判定

### 判定結果: ✅ 高品質

| 基準 | 状況 |
|------|------|
| 要件の曖昧さ | なし - EARS要件から明確に定義 |
| 入出力定義 | 完全 - interfaces.dartで型定義済み |
| 制約条件 | 明確 - パフォーマンス・データ・UI制約を定義 |
| 実装可能性 | 確実 - 既存実装があり、E2Eテスト可能 |

---

## 8. 次のステップ

次のお勧めステップ: `/tdd-testcases` でテストケースの洗い出しを行います。
