# TDD要件定義書 - TASK-0041: 定型文CRUD機能実装

## タスク情報

| 項目 | 内容 |
|------|------|
| **タスクID** | TASK-0041 |
| **タスク名** | 定型文CRUD機能実装 |
| **タスクタイプ** | TDD |
| **フェーズ** | Phase 3 - Week 9, Day 5 |
| **推定工数** | 8時間 |
| **関連要件** | REQ-104, EDGE-102 |
| **依存タスク** | TASK-0040 (定型文一覧UI実装) |

---

## 1. 機能の概要

### 1.1 機能説明 🔵

定型文CRUD（Create/Read/Update/Delete）機能は、ユーザーが定型文を追加・編集・削除・お気に入り切り替えできる機能を提供する。

- **目的**: 発話困難なユーザーが自分専用の定型文を管理し、よく使うフレーズをカスタマイズできるようにする
- **ユーザーストーリー**: 「利用者として、自分がよく使うフレーズを定型文として追加・編集・削除したい。また、特によく使うものをお気に入りに登録して優先表示したい」
- **システム内位置づけ**: 定型文一覧画面からアクセス可能なCRUD操作機能

### 1.2 参照EARS要件 🔵

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-104 | システムは定型文の追加・編集・削除機能を提供しなければならない | 🔵 |
| EDGE-102 | 定型文の文字数が500文字を超えた場合、システムは警告を表示し、500文字で入力を制限しなければならない | 🟡 |
| REQ-105 | システムはお気に入り定型文を一覧上部に優先表示しなければならない | 🔵 |
| REQ-5002 | システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない | 🔵 |
| NFR-201 | システムは主要な操作（文字入力、定型文選択、読み上げ）を3タップ以内で完了できなければならない | 🟡 |

---

## 2. 入力・出力の仕様

### 2.1 入力パラメータ 🔵

#### 2.1.1 定型文追加（Create）

| パラメータ | 型 | 制約 | 説明 |
|------------|------|------|------|
| content | `String` | 1〜500文字 | 定型文の内容 |
| category | `String` | 'daily', 'health', 'other' | カテゴリ |
| isFavorite | `bool` | デフォルト: false | お気に入りフラグ |

#### 2.1.2 定型文編集（Update）

| パラメータ | 型 | 制約 | 説明 |
|------------|------|------|------|
| id | `String` | 必須 | 編集対象の定型文ID |
| content | `String?` | 1〜500文字 | 更新後の定型文内容 |
| category | `String?` | 'daily', 'health', 'other' | 更新後のカテゴリ |
| isFavorite | `bool?` | - | 更新後のお気に入りフラグ |

#### 2.1.3 定型文削除（Delete）

| パラメータ | 型 | 制約 | 説明 |
|------------|------|------|------|
| id | `String` | 必須 | 削除対象の定型文ID |

### 2.2 出力（UI/動作） 🔵

| 操作 | 出力・動作 |
|------|------------|
| 追加成功 | 定型文一覧に新規項目が追加される、成功メッセージ表示 |
| 編集成功 | 定型文一覧の該当項目が更新される、成功メッセージ表示 |
| 削除成功 | 定型文一覧から該当項目が削除される、成功メッセージ表示 |
| お気に入り切替 | お気に入りフラグが反転、一覧表示位置が即座に更新される |
| 500文字超過 | 警告メッセージ表示、入力制限 |
| 空入力 | エラーメッセージ表示、送信不可 |

### 2.3 データフロー 🔵

```
[ユーザー操作（追加/編集/削除/お気に入り切替）]
        ↓
[バリデーション（500文字制限、空チェック）]
        ↓
[PresetPhraseProvider (Riverpod StateNotifier)]
        ↓
[ローカルストレージ(Hive) - PresetPhrase Box]
        ↓
[UI更新（定型文一覧リフレッシュ）]
```

---

## 3. 機能要件（EARS記法）

### 3.1 通常要件（SHALL） 🔵

| ID | 要件（EARS記法） | 信頼性 |
|----|------------------|--------|
| CRUD-001 | システムは定型文追加ダイアログを提供しなければならない | 🔵 |
| CRUD-002 | システムは定型文追加時に内容とカテゴリを入力できるフォームを表示しなければならない | 🔵 |
| CRUD-003 | システムは追加された定型文にUUID形式の一意識別子を自動付与しなければならない | 🔵 |
| CRUD-004 | システムは定型文編集ダイアログを提供しなければならない | 🔵 |
| CRUD-005 | システムは定型文編集時に現在の内容とカテゴリを初期表示しなければならない | 🔵 |
| CRUD-006 | システムは定型文削除機能を提供しなければならない | 🔵 |
| CRUD-007 | システムは定型文のお気に入りフラグを切り替える機能を提供しなければならない | 🔵 |
| CRUD-008 | システムは定型文追加・編集時にcreatedAt/updatedAtタイムスタンプを自動設定しなければならない | 🔵 |

### 3.2 条件付き要件（WHEN/IF-THEN） 🔵

| ID | 要件（EARS記法） | 信頼性 |
|----|------------------|--------|
| CRUD-101 | ユーザーが定型文を削除しようとした場合、システムは確認ダイアログを表示しなければならない | 🔵 |
| CRUD-102 | ユーザーが確認ダイアログで「削除」を選択した場合、システムは定型文を削除しなければならない | 🔵 |
| CRUD-103 | ユーザーが確認ダイアログで「キャンセル」を選択した場合、システムは削除を中止しなければならない | 🔵 |
| CRUD-104 | ユーザーが500文字を超える内容を入力した場合、システムは警告を表示し入力を制限しなければならない | 🟡 |
| CRUD-105 | ユーザーが空の内容で保存しようとした場合、システムはエラーメッセージを表示し保存を拒否しなければならない | 🟡 |
| CRUD-106 | ユーザーがお気に入りアイコンをタップした場合、システムはお気に入りフラグを即座に切り替えなければならない | 🔵 |

### 3.3 制約要件（MUST） 🔵

| ID | 要件（EARS記法） | 信頼性 |
|----|------------------|--------|
| CRUD-201 | システムは定型文の最大文字数を500文字に制限しなければならない | 🟡 |
| CRUD-202 | システムは定型文の最小文字数を1文字としなければならない | 🟡 |
| CRUD-203 | システムはタップターゲット（ボタン・アイコン）を44px × 44px以上としなければならない | 🔵 |
| CRUD-204 | システムは削除操作に確認ダイアログを設けなければならない | 🔵 |
| CRUD-205 | システムは定型文データをローカルストレージ（Hive）に永続化しなければならない | 🔵 |

---

## 4. 非機能要件 🟡

### 4.1 パフォーマンス

| 制約 | 値 | 根拠 |
|------|-----|------|
| 追加・編集・削除レスポンス | 500ms以内 | NFR-003から推測 |
| お気に入り切替 | 即座（100ms以内） | ユーザビリティ要件 |
| 一覧更新 | 操作完了後即座に反映 | NFR-201 |

### 4.2 ユーザビリティ

| 制約 | 値 | 根拠 |
|------|-----|------|
| 追加操作 | 3タップ以内 | NFR-201 |
| 編集操作 | 3タップ以内 | NFR-201 |
| 削除操作 | 2タップ（タップ+確認） | REQ-5002 |
| フォントサイズ | 小/中/大の3段階対応 | REQ-802 |
| テーマ | ライト/ダーク/高コントラスト対応 | REQ-803 |

### 4.3 アクセシビリティ

| 制約 | 値 | 根拠 |
|------|-----|------|
| タップターゲット | 44px × 44px 以上 | REQ-5001 |
| 推奨タップターゲット | 60px以上 | NFR-202 |
| 入力フィールド | 十分な余白と視認性 | NFR-202 |
| エラーメッセージ | 分かりやすい日本語 | NFR-204 |

---

## 5. エッジケース・境界値 🟡

### 5.1 文字数境界

| ケース | 入力 | 期待動作 | 信頼性 |
|--------|------|----------|--------|
| EDGE-001 | 0文字（空） | エラー表示、保存不可 | 🟡 |
| EDGE-002 | 1文字 | 正常保存 | 🟡 |
| EDGE-003 | 500文字 | 正常保存 | 🟡 |
| EDGE-004 | 501文字 | 警告表示、500文字で制限 | 🟡 |
| EDGE-005 | 空白のみ | エラー表示、保存不可 | 🟡 |

### 5.2 特殊文字

| ケース | 入力 | 期待動作 | 信頼性 |
|--------|------|----------|--------|
| EDGE-006 | 絵文字を含む | 正常保存 | 🟡 |
| EDGE-007 | 改行を含む | 正常保存（改行は保持） | 🟡 |
| EDGE-008 | 全角・半角混在 | 正常保存 | 🟡 |

### 5.3 操作エラー

| ケース | 状況 | 期待動作 | 信頼性 |
|--------|------|----------|--------|
| EDGE-009 | 存在しないIDで編集 | エラーハンドリング、ログ出力 | 🟡 |
| EDGE-010 | 存在しないIDで削除 | エラーハンドリング、ログ出力 | 🟡 |
| EDGE-011 | 同時編集（複数画面） | 最新データで上書き | 🔴 |

### 5.4 ダイアログ操作

| ケース | 状況 | 期待動作 | 信頼性 |
|--------|------|----------|--------|
| EDGE-012 | ダイアログ外タップ | ダイアログを閉じる（削除確認以外） | 🟡 |
| EDGE-013 | 削除確認ダイアログ外タップ | 閉じない（誤操作防止） | 🔵 |
| EDGE-014 | 編集中にキャンセル | 変更破棄、元の状態維持 | 🟡 |

---

## 6. 想定される使用例

### 6.1 正常系 🔵

#### UC-001: 定型文追加
1. ユーザーが「+」ボタンをタップ
2. 追加ダイアログが表示される
3. ユーザーが内容を入力（例: 「ありがとうございます」）
4. ユーザーがカテゴリを選択（例: 「日常」）
5. ユーザーが「保存」ボタンをタップ
6. 定型文が一覧に追加される
7. 成功メッセージが表示される

#### UC-002: 定型文編集
1. ユーザーが定型文の編集アイコンをタップ
2. 編集ダイアログが現在の内容で表示される
3. ユーザーが内容を変更
4. ユーザーが「保存」ボタンをタップ
5. 定型文が更新される
6. 成功メッセージが表示される

#### UC-003: 定型文削除
1. ユーザーが定型文の削除アイコンをタップ
2. 確認ダイアログが表示される（「この定型文を削除しますか？」）
3. ユーザーが「削除」ボタンをタップ
4. 定型文が削除される
5. 一覧から消える

#### UC-004: お気に入り切り替え
1. ユーザーが定型文のお気に入りアイコンをタップ
2. お気に入りフラグが切り替わる
3. 一覧の表示位置が即座に更新される（お気に入りは上部へ）

### 6.2 異常系 🟡

#### UC-005: 空入力での保存試行
1. ユーザーが追加ダイアログを開く
2. 内容を空のまま「保存」をタップ
3. エラーメッセージ「定型文を入力してください」が表示される
4. ダイアログは閉じない

#### UC-006: 500文字超過
1. ユーザーが追加ダイアログを開く
2. 500文字を超える内容を入力しようとする
3. 500文字で入力が制限される
4. 文字数カウンター「500/500」が赤く表示される

#### UC-007: 削除キャンセル
1. ユーザーが削除アイコンをタップ
2. 確認ダイアログが表示される
3. ユーザーが「キャンセル」をタップ
4. ダイアログが閉じる
5. 定型文は削除されない

---

## 7. 受け入れ基準

### 7.1 機能要件の受け入れ基準 🔵

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-001 | 定型文追加ダイアログが表示される | ウィジェットテスト |
| AC-002 | 定型文を追加でき、一覧に反映される | ウィジェットテスト |
| AC-003 | 定型文編集ダイアログが現在の内容で表示される | ウィジェットテスト |
| AC-004 | 定型文を編集でき、変更が保存される | ウィジェットテスト |
| AC-005 | 定型文削除時に確認ダイアログが表示される | ウィジェットテスト |
| AC-006 | 確認後に定型文が削除される | ウィジェットテスト |
| AC-007 | お気に入りアイコンタップでフラグが切り替わる | ウィジェットテスト |
| AC-008 | お気に入り切り替え後、一覧表示位置が更新される | ウィジェットテスト |

### 7.2 バリデーションの受け入れ基準 🟡

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-009 | 空入力で保存しようとするとエラーが表示される | ユニットテスト |
| AC-010 | 500文字を超える入力が制限される | ユニットテスト |
| AC-011 | 1〜500文字の入力は正常に保存される | ユニットテスト |
| AC-012 | 空白のみの入力でエラーが表示される | ユニットテスト |

### 7.3 非機能要件の受け入れ基準 🟡

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-013 | 追加・編集・削除が500ms以内に完了する | パフォーマンステスト |
| AC-014 | タップターゲットが44px以上である | ウィジェットテスト |
| AC-015 | テーマ切り替えでダイアログ表示が適切に変わる | UIテスト |
| AC-016 | フォントサイズ設定がダイアログに反映される | UIテスト |

---

## 8. 技術設計

### 8.1 実装ファイル構成 🟡

```dart
lib/features/preset_phrase/
├── presentation/
│   ├── widgets/
│   │   ├── phrase_add_dialog.dart       // 定型文追加ダイアログ
│   │   ├── phrase_edit_dialog.dart      // 定型文編集ダイアログ
│   │   ├── phrase_delete_dialog.dart    // 削除確認ダイアログ
│   │   └── widgets.dart                 // バレルファイル（更新）
│   └── ...
├── providers/
│   └── preset_phrase_provider.dart      // 定型文状態管理（新規作成）
├── domain/
│   └── preset_phrase_validator.dart     // バリデーションロジック
└── data/
    └── preset_phrase_repository.dart    // データ操作（Hive連携）
```

### 8.2 依存関係 🔵

| 依存 | 用途 |
|------|------|
| PresetPhrase モデル | データ構造（既存） |
| Hive | ローカルストレージ |
| flutter_riverpod | 状態管理 |
| uuid | 一意識別子生成 |
| TASK-0040 | 定型文一覧UI（完了済み） |

### 8.3 既存モデル参照 🔵

```dart
// lib/shared/models/preset_phrase.dart (既存)
@HiveType(typeId: 1)
class PresetPhrase extends HiveObject {
  final String id;
  final String content;
  final String category;  // 'daily', 'health', 'other'
  final bool isFavorite;
  final int displayOrder;
  final DateTime createdAt;
  final DateTime updatedAt;

  PresetPhrase copyWith({...});
}
```

### 8.4 Provider設計 🟡

```dart
// preset_phrase_provider.dart
@riverpod
class PresetPhraseNotifier extends _$PresetPhraseNotifier {
  @override
  List<PresetPhrase> build() => [];

  Future<void> addPhrase(String content, String category);
  Future<void> updatePhrase(String id, {String? content, String? category, bool? isFavorite});
  Future<void> deletePhrase(String id);
  Future<void> toggleFavorite(String id);
}
```

---

## 9. EARS要件・設計文書との対応関係

### 9.1 参照要件一覧

| 種別 | 要件ID |
|------|--------|
| 機能要件 | REQ-104, REQ-105 |
| エッジケース | EDGE-102 |
| 制約要件 | REQ-5001, REQ-5002, REQ-5003 |
| 非機能要件 | NFR-201, NFR-202, NFR-204 |
| アクセシビリティ | REQ-801, REQ-802, REQ-803 |

### 9.2 参照設計文書

| 文書 | 該当セクション |
|------|----------------|
| interfaces.dart | PresetPhrase, PresetCategory |
| dataflow.md | 定型文管理フロー |
| architecture.md | Presentation Layer - Widgets, State Management |
| kotonoha-phase3.md | TASK-0041 定義 |

---

## 10. 品質判定

### 判定結果: 高品質

| 項目 | 状態 | 備考 |
|------|------|------|
| 要件の曖昧さ | なし | REQ-104が明確に定義 |
| 入出力定義 | 完全 | CRUD操作すべて定義済み |
| 制約条件 | 明確 | 500文字制限、確認ダイアログ |
| 実装可能性 | 確実 | 既存モデル・UIを活用 |
| エッジケース | 網羅的 | 境界値、特殊文字、操作エラー対応 |

---

## 11. 次のステップ

次のお勧めステップ: `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。

---

## 更新履歴

- **2025-11-23**: TDD要件定義書初版作成（TASK-0041）
