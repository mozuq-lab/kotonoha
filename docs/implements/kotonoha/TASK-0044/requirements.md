# TASK-0044: 状態ボタン（「痛い」「トイレ」等8-12個）実装 - 要件定義書

## 概要

ユーザーが自身の状態や要求を即座に伝えられるよう、「痛い」「トイレ」「暑い」「寒い」等の状態ボタンを8-12個表示する機能を実装する。TASK-0043で実装した「はい」「いいえ」「わからない」大ボタンの下に配置し、タップ時に即座に読み上げを行う。

**タスクタイプ**: TDD
**推定工数**: 8時間

## 関連要件

### 直接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-202 | システムは状態を表すボタン（「痛い」「トイレ」「暑い」「寒い」など）を画面上部に表示しなければならない | 🔵 |
| REQ-203 | システムは状態ボタンを8-12個の固定文言として提供しなければならない | 🔵 |
| REQ-204 | システムは大ボタンおよび状態ボタンのタップ時に即座に読み上げを実行しなければならない | 🟡 |

### 間接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-5001 | システムはタップターゲット（ボタン・キー）のサイズを44px × 44px以上としなければならない | 🟡 |
| REQ-5005 | システムはタップ主体の操作で完結し、スワイプ等のジェスチャーへの依存を避けなければならない | 🔵 |
| NFR-001 | システムはTTS読み上げ開始までの時間を1秒以内としなければならない | 🟡 |
| NFR-202 | システムはボタン・タップ領域を視認性が高く押しやすいサイズ（推奨60px × 60px以上）で設計しなければならない | 🟡 |
| REQ-803 | システムは「ライトモード」「ダークモード」「高コントラストモード」の3つのテーマを提供しなければならない | 🔵 |
| REQ-801 | システムはフォントサイズを「小」「中」「大」の3段階から選択できなければならない | 🔵 |
| REQ-802 | システムは文字盤・定型文一覧・ボタンラベルのフォントサイズをフォントサイズ設定に追従させなければならない | 🔵 |

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### FR-001: 状態ボタンの種類
- **要件**: システムは以下の状態ボタンを提供しなければならない
  1. 痛い
  2. トイレ
  3. 暑い
  4. 寒い
  5. 水
  6. 眠い
  7. 助けて
  8. 待って
  9. もう一度（任意）
  10. ありがとう（任意）
  11. ごめんなさい（任意）
  12. 大丈夫（任意）
- **根拠**: REQ-202, REQ-203
- **信頼性**: 🔵 青信号（8個は必須、12個まで拡張可能）

#### FR-002: ボタン数の範囲
- **要件**: システムは8個以上12個以下の状態ボタンを表示しなければならない
- **根拠**: REQ-203
- **信頼性**: 🔵 青信号

#### FR-003: 画面上部への配置
- **要件**: システムは状態ボタンを「はい」「いいえ」「わからない」大ボタン（QuickResponseButtons）の下に配置しなければならない
- **根拠**: REQ-202、TASK-0043との整合性
- **信頼性**: 🔵 青信号

#### FR-004: タップターゲットサイズの保証
- **要件**: システムは各状態ボタンのサイズを最小44px × 44px以上としなければならない
- **根拠**: REQ-5001
- **信頼性**: 🔵 青信号

#### FR-005: 視認性の高いラベル表示
- **要件**: システムは各ボタンに状態を表すラベルを明確に表示しなければならない
- **根拠**: REQ-202、アクセシビリティ要件
- **信頼性**: 🔵 青信号

#### FR-006: フォントサイズ設定への追従
- **要件**: システムは状態ボタンのラベルフォントサイズをフォントサイズ設定（小/中/大）に追従させなければならない
- **根拠**: REQ-802
- **信頼性**: 🔵 青信号

#### FR-007: グリッドレイアウト
- **要件**: システムは状態ボタンをグリッド形式（横4列）で配置しなければならない
- **根拠**: NFR-203（主要機能を1画面でアクセス可能）、視認性
- **信頼性**: 🟡 黄信号

#### FR-008: ボタン間の適切な間隔
- **要件**: システムは状態ボタン間に4px以上の間隔を設けなければならない
- **根拠**: 誤タップ防止、NFR-202
- **信頼性**: 🟡 黄信号

### 条件付き要件（WHEN/IF-THEN）

#### FR-101: タップ時の即座読み上げ
- **条件**: ユーザーが状態ボタンをタップした場合
- **動作**: システムは即座に（1秒以内に）ボタンのラベルテキストをTTSで読み上げなければならない
- **根拠**: REQ-204、NFR-001
- **信頼性**: 🔵 青信号

#### FR-102: 視覚的フィードバック
- **条件**: ユーザーが状態ボタンをタップした場合
- **動作**: システムはタップ時に視覚的フィードバック（色変化、リップルエフェクト等）を提供しなければならない
- **根拠**: UX標準、アクセシビリティ
- **信頼性**: 🟡 黄信号

#### FR-103: テーマ変更時の配色追従
- **条件**: ユーザーがテーマ（ライト/ダーク/高コントラスト）を変更した場合
- **動作**: システムは状態ボタンの配色を即座に変更後のテーマに追従させなければならない
- **根拠**: REQ-803、REQ-2008
- **信頼性**: 🔵 青信号

#### FR-104: 画面回転時のレイアウト維持
- **条件**: デバイスが縦向き/横向きに回転した場合
- **動作**: システムは状態ボタンの視認性とタップ可能性を維持した状態でレイアウトを調整しなければならない
- **根拠**: NFR-403
- **信頼性**: 🟡 黄信号

### 制約要件（MUST）

#### FR-201: 最小タップターゲット保証
- **要件**: 状態ボタンのタップ領域は、いかなる場合も44px × 44px未満にしてはならない
- **根拠**: REQ-5001、WCAG 2.1 AA
- **信頼性**: 🔵 青信号

#### FR-202: 高コントラストモードでのコントラスト比
- **要件**: 高コントラストモードにおいて、状態ボタンのラベルと背景のコントラスト比は4.5:1以上でなければならない
- **根拠**: REQ-5006、WCAG 2.1 AA
- **信頼性**: 🔵 青信号

#### FR-203: タップ操作のみでの完結
- **要件**: 状態ボタンの操作はタップのみで完結し、スワイプやロングプレスを必須としてはならない
- **根拠**: REQ-5005
- **信頼性**: 🔵 青信号

### オプション要件（MAY）

#### FR-301: カスタマイズ可能な設計（将来拡張用）
- **要件**: システムは状態ボタンの文言を将来的にカスタマイズ可能な設計としてもよい
- **根拠**: タスク説明「カスタマイズ可能な設計（将来拡張用）」
- **信頼性**: 🟡 黄信号

#### FR-302: カテゴリ別色分け
- **要件**: システムは状態ボタンをカテゴリ（体調、要求、感情等）別に色分けしてもよい
- **根拠**: 視認性向上、UX向上
- **信頼性**: 🟡 黄信号

## 非機能要件

### パフォーマンス

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-P001 | タップから読み上げ開始まで1秒以内 | NFR-001 | 🔵 |
| NFR-P002 | タップからの視覚フィードバックは100ms以内 | NFR-003 | 🟡 |
| NFR-P003 | 状態ボタン全体の初回レンダリングは500ms以内 | UX標準 | 🟡 |

### ユーザビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-U001 | ボタン配置は一目で理解できる設計 | NFR-203 | 🟡 |
| NFR-U002 | 緊急性の高いボタン（「痛い」「助けて」等）は目立つ位置に配置 | UX標準、アクセシビリティ | 🟡 |
| NFR-U003 | カテゴリごとに視覚的な区別が可能（色や配置） | アクセシビリティ | 🟡 |

### アクセシビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-A001 | 色覚多様性に配慮し、色だけでなくラベルテキストで識別可能 | WCAG | 🔵 |
| NFR-A002 | ボタン間隔は誤タップを防ぐ十分な余白を確保（4px以上） | NFR-202 | 🟡 |
| NFR-A003 | 各ボタンにSemanticsラベルを設定 | Flutter標準 | 🔵 |

## エッジケース・境界値

### エッジケース

#### EDGE-001: TTS読み上げ中のボタン再タップ
- **状況**: ユーザーがTTS読み上げ中に別の状態ボタンをタップした場合
- **期待動作**: システムは現在の読み上げを中断し、新しいボタンのラベルを読み上げる
- **信頼性**: 🟡 黄信号

#### EDGE-002: 音量ゼロ状態でのタップ
- **状況**: デバイス音量がゼロ（ミュート）の状態で状態ボタンをタップした場合
- **期待動作**: システムは視覚的フィードバックを提供し、可能であれば音量警告を表示する
- **根拠**: EDGE-202
- **信頼性**: 🟡 黄信号

#### EDGE-003: TTSサービス未初期化/エラー時
- **状況**: TTSサービスが利用不可または初期化未完了の状態でタップした場合
- **期待動作**: システムは視覚的フィードバックのみ提供し、エラー時はエラーメッセージを表示する
- **信頼性**: 🟡 黄信号

#### EDGE-004: 連続タップ
- **状況**: ユーザーが同じボタンを短時間に連続タップした場合
- **期待動作**: システムは最初のタップのみを処理し、読み上げ完了まで後続タップを無視する（デバウンス）
- **信頼性**: 🟡 黄信号

#### EDGE-005: 超小画面での表示
- **状況**: 画面幅が狭い端末（スマートフォン等）で表示した場合
- **期待動作**: システムはボタンサイズを最小44pxまで縮小するが、それ以下にはしない。必要に応じて行数を増やす
- **信頼性**: 🟡 黄信号

#### EDGE-006: 大画面での表示
- **状況**: 大画面タブレット（12インチ以上）で表示した場合
- **期待動作**: システムはボタンサイズを適切に拡大し、過度に大きくならないよう制限する
- **信頼性**: 🟡 黄信号

### 境界値

| 項目 | 最小値 | 推奨値 | 最大値 |
|------|--------|--------|--------|
| ボタン数 | 8個 | 10個 | 12個 |
| ボタン高さ | 44px | 48px | 制限なし |
| ボタン幅 | 44px | 可変（画面幅に応じて均等分割） | 制限なし |
| ボタン間隔 | 4px | 8px | 12px |
| フォントサイズ（小） | 12px | 14px | - |
| フォントサイズ（中） | 16px | 18px | - |
| フォントサイズ（大） | 20px | 22px | - |
| グリッド列数（縦向き） | 4列 | 4列 | 4列 |
| グリッド列数（横向き） | 6列 | 6列 | 8列 |

## 受け入れ基準

### 機能テスト

- [ ] AC-001: 8個以上12個以下の状態ボタンが表示される
- [ ] AC-002: 必須の8個のボタン（痛い、トイレ、暑い、寒い、水、眠い、助けて、待って）が表示される
- [ ] AC-003: ボタンが「はい」「いいえ」「わからない」ボタンの下に配置されている
- [ ] AC-004: 各ボタンのサイズが44px × 44px以上である
- [ ] AC-005: ボタン間に4px以上の間隔がある
- [ ] AC-006: 各ボタンのラベルが正しく表示されている
- [ ] AC-007: 各ボタンタップで対応するテキストが読み上げられる
- [ ] AC-008: タップから読み上げ開始まで1秒以内である
- [ ] AC-009: ボタンがグリッド形式（横4列）で配置されている

### テーマ対応テスト

- [ ] AC-010: ライトモードで適切な配色で表示される
- [ ] AC-011: ダークモードで適切な配色で表示される
- [ ] AC-012: 高コントラストモードで4.5:1以上のコントラスト比を確保している

### フォントサイズ対応テスト

- [ ] AC-013: フォントサイズ「小」でラベルが適切なサイズで表示される
- [ ] AC-014: フォントサイズ「中」でラベルが適切なサイズで表示される
- [ ] AC-015: フォントサイズ「大」でラベルが適切なサイズで表示される

### エッジケーステスト

- [ ] AC-016: 連続タップ時にデバウンスが機能する
- [ ] AC-017: 画面回転時にレイアウトが崩れない
- [ ] AC-018: 縦向き・横向きの両方で最小タップターゲットが確保されている
- [ ] AC-019: 狭い画面幅（320px）でもボタンが44px以上を維持する

### アクセシビリティテスト

- [ ] AC-020: 各ボタンにSemanticsラベルが設定されている
- [ ] AC-021: 色だけでなくラベルテキストで状態を識別可能

## 技術仕様

### 使用コンポーネント

- `QuickResponseButton` ウィジェット（TASK-0043で実装済み、再利用または拡張）
- `DebounceMixin`（TASK-0043で実装済み、再利用）
- `AppSizes` 定数（既存、`core/constants/app_sizes.dart`）
- `AppColors` 定数（既存、`core/constants/app_colors.dart`）

### 新規作成ウィジェット

| ウィジェット名 | 説明 |
|----------------|------|
| `StatusButtons` | 状態ボタン8-12個をグリッド形式で表示するコンテナウィジェット |
| `StatusButton` | 個々の状態ボタン（QuickResponseButtonを拡張または再利用） |

### データ構造

```dart
/// 状態ボタンの種類
enum StatusButtonType {
  pain,      // 痛い
  toilet,    // トイレ
  hot,       // 暑い
  cold,      // 寒い
  water,     // 水
  sleepy,    // 眠い
  help,      // 助けて
  wait,      // 待って
  // 以下オプション（8-12個）
  again,     // もう一度
  thanks,    // ありがとう
  sorry,     // ごめんなさい
  okay,      // 大丈夫
}

/// 状態ボタンのラベル定義
const statusButtonLabels = {
  StatusButtonType.pain: '痛い',
  StatusButtonType.toilet: 'トイレ',
  StatusButtonType.hot: '暑い',
  StatusButtonType.cold: '寒い',
  StatusButtonType.water: '水',
  StatusButtonType.sleepy: '眠い',
  StatusButtonType.help: '助けて',
  StatusButtonType.wait: '待って',
  StatusButtonType.again: 'もう一度',
  StatusButtonType.thanks: 'ありがとう',
  StatusButtonType.sorry: 'ごめんなさい',
  StatusButtonType.okay: '大丈夫',
};

/// 状態ボタンのカテゴリ分類（将来拡張用）
enum StatusButtonCategory {
  physical,  // 身体状態（痛い、眠い、暑い、寒い）
  request,   // 要求（トイレ、水、助けて、待って）
  emotion,   // 感情・コミュニケーション（ありがとう、ごめんなさい、大丈夫、もう一度）
}
```

### 配置・レイアウト

```
+--------------------------------------------------+
|  [  はい  ]   [  いいえ  ]   [ わからない ]       |  <- QuickResponseButtons (TASK-0043)
+--------------------------------------------------+
|  [ 痛い ]  [ トイレ ]  [ 暑い ]   [ 寒い ]        |  <- StatusButtons Row 1
|  [  水  ]  [ 眠い  ]  [ 助けて ] [ 待って ]       |  <- StatusButtons Row 2
|  [もう一度] [ありがとう] [ごめん] [ 大丈夫 ]      |  <- StatusButtons Row 3 (Optional)
+--------------------------------------------------+
|                                                  |
|              （文字盤エリア）                      |
|                                                  |
+--------------------------------------------------+
```

### カラースキーム（案）

| カテゴリ | ライトモード | ダークモード | 高コントラスト |
|----------|--------------|--------------|----------------|
| 身体状態 | オレンジ系（#FFA726） | オレンジ系（#FB8C00） | 黒字白背景 |
| 要求 | 青系（#42A5F5） | 青系（#1E88E5） | 黒字白背景 |
| 感情 | 緑系（#66BB6A） | 緑系（#43A047） | 黒字白背景 |

## 依存関係

### 依存するタスク（完了済み）

- TASK-0043: 「はい」「いいえ」「わからない」大ボタン実装 ✅
  - QuickResponseButton ウィジェット
  - DebounceMixin
  - TTS読み上げ連携パターン
- TASK-0037: 五十音文字盤UI実装 ✅
- TASK-0016: テーマ実装（ライト・ダーク・高コントラスト） ✅
- TASK-0017: 共通UIコンポーネント実装 ✅

### 後続タスクへの影響

- TASK-0045: 緊急ボタンUI実装 - StatusButtonsの配置を考慮
- TASK-0048: OS標準TTS連携 - 状態ボタンでのTTS呼び出しパターンを参考にする

## 設計上の考慮事項

### TASK-0043との関係

TASK-0043で実装された以下のコンポーネント/パターンを再利用または拡張する:

1. **QuickResponseButton**: 状態ボタンのベースとして利用可能
2. **DebounceMixin**: 連続タップ防止に再利用
3. **テーマ対応パターン**: 3テーマ対応の配色設計
4. **フォントサイズ追従パターン**: 設定に応じたサイズ変更
5. **TTSコールバックパターン**: onTTSSpeak の設計

### 状態ボタンの選定理由

以下の観点から8-12個の状態ボタンを選定:

1. **身体状態**: 痛み、体温調節（暑い/寒い）、眠気は即座に伝える必要がある
2. **基本的要求**: トイレ、水は日常的に最も頻度が高い
3. **緊急性**: 「助けて」は緊急ボタンとは別に、軽度の支援要求に使用
4. **コミュニケーション円滑化**: 「待って」「もう一度」は対話の制御に必須
5. **感謝・謝罪**: 社会的コミュニケーションの基本

### 将来拡張性

- StatusButtonType をenumで定義し、将来的なカスタマイズに対応
- カテゴリ分類を導入し、ユーザー設定による表示/非表示切り替えの基盤を準備
- ボタン数を8-12個の範囲で柔軟に設定可能な設計

## 備考

- 信頼性レベル凡例:
  - 🔵 **青信号**: 要件定義書に明確に記載された要件
  - 🟡 **黄信号**: 要件定義書から妥当に推測される要件
  - 🔴 **赤信号**: 要件定義書にない推測による要件

---

**ドキュメント作成日**: 2025-11-23
**タスクID**: TASK-0044
**関連要件**: REQ-202, REQ-203, REQ-204
