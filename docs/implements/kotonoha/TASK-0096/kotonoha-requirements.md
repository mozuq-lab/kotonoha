# TASK-0096: カバレッジ確認・テスト補完 - TDD要件定義書

## 1. タスク概要

### 1.1 タスク情報

- **タスクID**: TASK-0096
- **タスク名**: カバレッジ確認・テスト補完
- **タスクタイプ**: TDD
- **要件名**: kotonoha
- **フェーズ**: Phase 5 (Week 20 - Day 16)
- **推定工数**: 8時間
- **依存タスク**: すべてのE2Eテストタスク (TASK-0081 〜 TASK-0095)

### 1.2 目的

全フロントエンド（Flutter）およびバックエンド（FastAPI）コードのテストカバレッジを計測し、プロジェクトの品質基準（NFR-501、NFR-502）を満たすため、カバレッジ不足箇所を特定して追加テストケースを作成する。

### 1.3 背景・動機

- プロジェクトの品質基準として、コードカバレッジ80%以上（全体）、ビジネスロジック・APIエンドポイント90%以上を目標としている
- Phase 5までに実装されたすべての機能に対して、テストの充実度を検証し、リリース前の品質保証を確実にする必要がある
- カバレッジ不足箇所は、潜在的なバグやエッジケースの見落としを示す可能性がある

## 2. 関連要件（EARS記法ベース）

### 2.1 非機能要件

#### NFR-501: 全体コードカバレッジ 🔵
- **要件**: システムはコードカバレッジ80%以上のテストを維持しなければならない
- **出典**: `docs/spec/kotonoha-requirements.md`, `docs/tech-stack.md`
- **検証方法**: Flutter: `flutter test --coverage`、Backend: `pytest --cov=app`

#### NFR-502: ビジネスロジック・APIカバレッジ 🔵
- **要件**: システムは重要なビジネスロジック・APIエンドポイントで90%以上のテストカバレッジを維持しなければならない
- **出典**: `docs/spec/kotonoha-requirements.md`, `docs/tech-stack.md`
- **検証方法**: 重点モジュール・エンドポイントの個別カバレッジ計測

#### NFR-503: コード品質基準 🔵
- **要件**: システムはFlutter lints、Ruff + Black準拠のコード品質を維持しなければならない
- **出典**: `docs/spec/kotonoha-requirements.md`, `docs/tech-stack.md`
- **検証方法**: Lintチェックがすべてパス

### 2.2 保守性要件

- **REQ-5003**: システムはアプリが強制終了しても定型文・設定・履歴を失わない永続化機構を実装しなければならない 🔵
- **NFR-301**: システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない 🔵
- **NFR-302**: システムはアプリクラッシュからの復旧時に、最後の入力状態を復元しなければならない 🟡

## 3. 機能要件（EARS記法）

### 3.1 通常要件（SHALL）

#### カバレッジ計測機能

- **REQ-CV-001**: システムはFrontend（Flutter）のテストカバレッジを計測しなければならない 🔵
  - **計測対象**: `frontend/kotonoha_app/lib/` 配下のすべてのDartファイル
  - **ツール**: `flutter test --coverage`、`lcov`

- **REQ-CV-002**: システムはBackend（FastAPI）のテストカバレッジを計測しなければならない 🔵
  - **計測対象**: `backend/app/` 配下のすべてのPythonファイル
  - **ツール**: `pytest --cov=app --cov-report=html`

- **REQ-CV-003**: システムはカバレッジレポートをHTML形式で生成しなければならない 🔵
  - **Frontend**: `frontend/kotonoha_app/coverage/html/index.html`
  - **Backend**: `backend/htmlcov/index.html`

#### カバレッジ不足箇所の特定

- **REQ-CV-101**: システムはカバレッジ80%未満のファイル・モジュールを一覧化しなければならない 🔵
  - **基準**: Line Coverage < 80%

- **REQ-CV-102**: システムはビジネスロジック・APIエンドポイントのカバレッジが90%未満の箇所を特定しなければならない 🔵
  - **Frontend重点モジュール**:
    - `lib/features/text_input/` - 文字盤入力ロジック
    - `lib/features/preset_text/` - 定型文管理ロジック
    - `lib/features/tts/` - TTS読み上げロジック
    - `lib/features/history/` - 履歴管理ロジック
    - `lib/features/ai_convert/` - AI変換ロジック
    - `lib/core/storage/` - ローカルストレージ（Hive）
  - **Backend重点モジュール**:
    - `app/api/v1/endpoints/ai.py` - AI変換APIエンドポイント
    - `app/services/ai_service.py` - AI変換ビジネスロジック
    - `app/core/security.py` - セキュリティ・認証ロジック
    - `app/core/config.py` - 設定管理

- **REQ-CV-103**: システムは未テストの関数・メソッドを特定しなければならない 🔵
  - **基準**: Function Coverage = 0%

- **REQ-CV-104**: システムは未テストのブランチ（条件分岐）を特定しなければならない 🔵
  - **基準**: Branch Coverage < 100%（特にエラーハンドリング分岐）

#### 追加テストケース作成

- **REQ-CV-201**: システムはカバレッジ不足箇所に対して追加のユニットテストを作成しなければならない 🔵
  - **対象**: 単体関数・メソッド、ユーティリティクラス

- **REQ-CV-202**: システムはエッジケース・異常系のテストケースを追加しなければならない 🔵
  - **対象**: エラーハンドリング、境界値、null/空値処理

- **REQ-CV-203**: システムは未テストのWidgetに対してWidget Testを追加しなければならない 🔵
  - **対象**: UI部品、カスタムWidget

- **REQ-CV-204**: システはRiverpod Provider・Notifierに対するテストを補完しなければならない 🔵
  - **対象**: 状態管理ロジック、非同期処理

#### テストレポート生成

- **REQ-CV-301**: システムはカバレッジレポートを可視化しなければならない 🔵
  - **形式**: HTML、Markdown
  - **内容**: 全体カバレッジ率、モジュール別カバレッジ、不足箇所リスト

- **REQ-CV-302**: システムはテスト実行結果サマリーを生成しなければならない 🔵
  - **内容**: 総テスト数、成功/失敗数、実行時間、カバレッジ達成状況

- **REQ-CV-303**: システムはカバレッジ改善前後の比較レポートを作成しなければならない 🔵
  - **内容**: Before/After カバレッジ率、追加テスト数、改善箇所

### 3.2 条件付き要件（WHEN/IF-THEN）

- **REQ-CV-401**: カバレッジが80%未満の場合、システムはテスト追加が必要な箇所を優先順位付けしなければならない 🟡
  - **優先順位**:
    1. ビジネスロジック（90%以上必須）
    2. APIエンドポイント（90%以上必須）
    3. エラーハンドリング・異常系
    4. UI部品・Widget

- **REQ-CV-402**: ビジネスロジック・APIエンドポイントのカバレッジが90%未満の場合、システムは警告を表示しなければならない 🟡

- **REQ-CV-403**: テスト実行に失敗した場合、システムはエラー詳細とスタックトレースをログに記録しなければならない 🔵

- **REQ-CV-404**: カバレッジ計測コマンドがエラーとなった場合、システムは原因を特定し、実行手順を修正しなければならない 🟡

### 3.3 制約要件（MUST）

- **REQ-CV-501**: システムは既存のテストを破壊せずに追加テストを作成しなければならない 🔵
  - **検証**: すべてのテストが成功する

- **REQ-CV-502**: システムはテストコードもLint基準を満たさなければならない 🔵
  - **Frontend**: flutter_lints
  - **Backend**: Ruff + Black

- **REQ-CV-503**: システムはテスト実行時間を合理的な範囲（Frontend: 5分以内、Backend: 3分以内）に保たなければならない 🟡

- **REQ-CV-504**: システムはカバレッジ計測結果をCI/CDパイプラインで可視化しなければならない 🔵
  - **ツール**: GitHub Actions、Codecov/Coveralls等

## 4. 非機能要件

### 4.1 パフォーマンス要件

- **NFR-CV-001**: テスト実行時間は合理的な範囲内（Frontend: 5分以内、Backend: 3分以内）でなければならない 🟡
- **NFR-CV-002**: カバレッジレポート生成時間は1分以内でなければならない 🟡

### 4.2 保守性要件

- **NFR-CV-101**: テストコードは読みやすく、保守しやすい構造でなければならない 🔵
- **NFR-CV-102**: テストコードはDRY原則（Don't Repeat Yourself）に従い、共通処理を適切に抽出しなければならない 🔵
- **NFR-CV-103**: テストデータ・モックは再利用可能な形で定義しなければならない 🔵

### 4.3 信頼性要件

- **NFR-CV-201**: テストはCI環境でも同じ結果が得られなければならない（環境依存排除）🔵
- **NFR-CV-202**: テストは実行順序に依存してはならない（独立性）🔵
- **NFR-CV-203**: テストは外部サービス（実APIなど）に依存してはならない（モック使用）🔵

## 5. Edgeケース・境界値・異常系

### 5.1 エラー処理

- **EDGE-CV-001**: カバレッジ計測コマンドがエラー終了した場合、システムはエラー詳細を表示し、実行手順を再確認しなければならない 🟡
- **EDGE-CV-002**: テスト実行中にタイムアウトが発生した場合、システムは該当テストを特定し、修正しなければならない 🟡
- **EDGE-CV-003**: カバレッジレポート生成に失敗した場合、システムは原因を特定し、ツールの再インストールを試みなければならない 🟡

### 5.2 境界値

- **EDGE-CV-101**: カバレッジが正確に80%の場合、システムは基準達成と判定しなければならない 🟡
- **EDGE-CV-102**: カバレッジが79.9%の場合、システムは基準未達と判定しなければならない 🟡
- **EDGE-CV-103**: テスト数が0件のモジュールの場合、システムは「未テスト」と分類しなければならない 🟡

### 5.3 異常系・特殊ケース

- **EDGE-CV-201**: 既存テストが失敗している状態でカバレッジ計測を実行した場合、システムはまずテスト修正を促さなければならない 🟡
- **EDGE-CV-202**: 生成されたコード（build_runner等）がカバレッジに含まれる場合、システムは除外設定を行わなければならない 🔵
- **EDGE-CV-203**: カバレッジレポートのファイルサイズが大きすぎる場合（>100MB）、システムは圧縮または分割を検討しなければならない 🔴

## 6. 実装スコープ

### 6.1 含まれるもの（In Scope）

- Frontend（Flutter）のテストカバレッジ計測・レポート生成
- Backend（FastAPI）のテストカバレッジ計測・レポート生成
- カバレッジ不足箇所（80%未満）の特定・一覧化
- ビジネスロジック・APIエンドポイント（90%未満）の特定・一覧化
- 追加ユニットテスト・Widget Testの作成
- エッジケース・異常系テストの作成
- テストレポート生成（HTML、Markdown）
- カバレッジ改善前後の比較レポート
- CI/CDパイプラインへのカバレッジ可視化統合

### 6.2 含まれないもの（Out of Scope）

- E2Eテストの追加（TASK-0082〜TASK-0087で実施済み）
- パフォーマンステストの追加（TASK-0088〜TASK-0090で実施済み）
- 実機テストの追加（TASK-0095で実施済み）
- コードのリファクタリング（テスト追加に伴う軽微な修正は除く）
- 新機能の追加
- ドキュメント作成（テストレポート除く）

## 7. 受け入れ基準（Acceptance Criteria）

### 7.1 必須条件

1. **カバレッジ基準達成**
   - [ ] Frontend（Flutter）全体カバレッジ ≥ 80%
   - [ ] Backend（FastAPI）全体カバレッジ ≥ 90%（APIエンドポイント中心のため）
   - [ ] Frontend ビジネスロジック（重点モジュール）カバレッジ ≥ 90%
   - [ ] Backend APIエンドポイント カバレッジ ≥ 90%

2. **テスト成功**
   - [ ] すべてのFrontendテストがパスする（`flutter test`）
   - [ ] すべてのBackendテストがパスする（`pytest`）
   - [ ] CI環境でもすべてのテストがパスする

3. **レポート生成**
   - [ ] Frontend カバレッジレポート（HTML）が生成される
   - [ ] Backend カバレッジレポート（HTML）が生成される
   - [ ] カバレッジサマリー（Markdown）が生成される
   - [ ] カバレッジ改善前後の比較レポートが作成される

4. **品質基準**
   - [ ] 追加テストコードがLint基準を満たす
   - [ ] テストコードが適切にコメント・命名されている
   - [ ] テストコードが保守しやすい構造になっている

### 7.2 推奨条件

- [ ] カバレッジがCI/CDパイプライン（GitHub Actions）で可視化される
- [ ] カバレッジバッジが README.md に追加される
- [ ] テスト実行時間が合理的な範囲内（Frontend: 5分以内、Backend: 3分以内）
- [ ] 未テストのエッジケース・異常系が網羅される

## 8. 技術的制約・前提条件

### 8.1 技術スタック

- **Frontend**: Flutter 3.38.1、Riverpod 2.x、Hive、flutter_test、integration_test
- **Backend**: FastAPI 0.121、SQLAlchemy 2.x、pytest、pytest-cov、pytest-asyncio
- **カバレッジツール**:
  - Frontend: `flutter test --coverage`、`lcov`、`genhtml`
  - Backend: `pytest-cov`、`coverage.py`

### 8.2 前提条件

- Phase 5のすべてのE2Eテストタスク（TASK-0081〜TASK-0095）が完了している
- 既存のユニットテスト・Widget Test・E2Eテストがすべてパスしている
- CI/CDパイプライン（GitHub Actions）が構築されている（TASK-0094）

### 8.3 制約

- テストコード追加によるアプリケーションコードの大幅な変更は避ける（テスト容易性のための軽微なリファクタリングは可）
- 既存のテストを破壊しない
- テスト実行時間は合理的な範囲内に保つ
- カバレッジ計測は開発環境・CI環境で再現可能でなければならない

## 9. 参考資料

### 9.1 プロジェクト内ドキュメント

- **要件定義書**: `docs/spec/kotonoha-requirements.md` (NFR-501, NFR-502)
- **技術スタック**: `docs/tech-stack.md`
- **Phase 5 タスク**: `docs/tasks/kotonoha-phase5.md` (TASK-0096)
- **アーキテクチャ設計**: `docs/design/kotonoha/architecture.md`

### 9.2 外部参考資料

- Flutter Testing Documentation: https://docs.flutter.dev/testing
- Flutter Test Coverage: https://docs.flutter.dev/testing/overview#code-coverage
- pytest-cov Documentation: https://pytest-cov.readthedocs.io/
- LCOV Tutorial: http://ltp.sourceforge.net/coverage/lcov.php

## 10. 実装計画

### 10.1 実施順序（推奨）

1. **カバレッジ計測・レポート生成** (2時間)
   - Frontend: `flutter test --coverage` 実行、HTML レポート生成
   - Backend: `pytest --cov=app --cov-report=html` 実行
   - カバレッジ結果の確認・記録

2. **カバレッジ不足箇所の特定・分析** (1時間)
   - カバレッジ80%未満のファイル一覧化
   - ビジネスロジック・API（90%未満）の特定
   - 未テスト関数・ブランチのリストアップ
   - 優先順位付け

3. **Frontend 追加テスト作成** (2時間)
   - 重点モジュールのユニットテスト追加
   - Widget Test の追加
   - Riverpod Provider/Notifier テスト追加
   - エッジケース・異常系テスト追加

4. **Backend 追加テスト作成** (1.5時間)
   - APIエンドポイントのテスト追加
   - ビジネスロジックのユニットテスト追加
   - エラーハンドリング・異常系テスト追加

5. **再計測・検証** (1時間)
   - カバレッジ再計測
   - 80%/90% 基準達成確認
   - すべてのテストがパスすることを確認

6. **レポート作成・CI統合** (0.5時間)
   - カバレッジサマリー（Markdown）作成
   - 改善前後比較レポート作成
   - CI/CDパイプラインでカバレッジ可視化

### 10.2 成果物

- `frontend/kotonoha_app/coverage/lcov.info` - Frontendカバレッジデータ
- `frontend/kotonoha_app/coverage/html/index.html` - FrontendカバレッジHTML レポート
- `backend/htmlcov/index.html` - BackendカバレッジHTMLレポート
- `docs/implements/kotonoha/TASK-0096/coverage-report.md` - カバレッジサマリーレポート
- `docs/implements/kotonoha/TASK-0096/coverage-improvement.md` - 改善前後比較レポート
- 追加テストコード（Frontend: `test/`、Backend: `tests/`）

## 11. テスト戦略

### 11.1 TDDサイクル（このタスクでは逆順）

通常のTDDサイクルとは異なり、このタスクでは既存実装に対してテストを追加するため、以下の順序で実施：

1. **カバレッジ計測（Red相当）** - 未テスト箇所を特定
2. **テスト作成（Green相当）** - 追加テストを作成し、カバレッジを向上
3. **検証・リファクタ（Refactor相当）** - テストコードの品質向上、カバレッジ基準達成確認

### 11.2 重点テスト領域

#### Frontend（Flutter）

1. **ビジネスロジック（90%以上必須）**
   - `lib/features/text_input/providers/` - 文字入力状態管理
   - `lib/features/preset_text/providers/` - 定型文状態管理
   - `lib/features/tts/providers/` - TTS状態管理
   - `lib/features/history/providers/` - 履歴状態管理
   - `lib/features/ai_convert/providers/` - AI変換状態管理
   - `lib/core/storage/` - Hiveローカルストレージ

2. **Widget（80%以上）**
   - カスタムWidget
   - 条件分岐を含むUI部品

3. **ユーティリティ・ヘルパー（80%以上）**
   - `lib/core/utils/`
   - `lib/core/helpers/`

#### Backend（FastAPI）

1. **APIエンドポイント（90%以上必須）**
   - `app/api/v1/endpoints/ai.py`
   - `app/api/v1/endpoints/health.py`

2. **ビジネスロジック（90%以上必須）**
   - `app/services/ai_service.py`
   - `app/core/security.py`

3. **設定・ユーティリティ（80%以上）**
   - `app/core/config.py`
   - `app/utils/`

### 11.3 テストタイプ別優先度

| テストタイプ | 優先度 | カバレッジ目標 |
|---|---|---|
| ユニットテスト（ビジネスロジック） | 最高 | 90%以上 |
| APIエンドポイントテスト | 最高 | 90%以上 |
| Widget Test | 高 | 80%以上 |
| Riverpod Provider Test | 高 | 90%以上 |
| エラーハンドリング・異常系 | 高 | 80%以上 |
| ユーティリティ・ヘルパー | 中 | 80%以上 |

## 12. 品質基準

### 12.1 コードカバレッジ基準

| 対象 | Line Coverage | Function Coverage | Branch Coverage |
|---|---|---|---|
| Frontend全体 | ≥ 80% | ≥ 75% | ≥ 70% |
| Frontend ビジネスロジック | ≥ 90% | ≥ 85% | ≥ 80% |
| Backend全体 | ≥ 90% | ≥ 85% | ≥ 80% |
| Backend APIエンドポイント | ≥ 90% | ≥ 90% | ≥ 85% |

### 12.2 テスト品質基準

- テストコードはLint基準を満たす（flutter_lints、Ruff + Black）
- テストケース名は明確で、何をテストしているかが分かる
- テストコードは保守しやすい構造（共通処理の適切な抽出）
- テストデータ・モックは再利用可能
- テストは独立性・冪等性を持つ（実行順序・回数に依存しない）

### 12.3 CI/CD統合

- GitHub ActionsでカバレッジをCI実行時に自動計測
- カバレッジが基準を下回る場合、CIが失敗する
- PR作成時にカバレッジレポートをコメント投稿
- カバレッジバッジをREADME.mdに表示

## 13. リスク・課題

### 13.1 リスク

| リスク | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| カバレッジ80%達成困難 | 高 | 中 | 優先順位付けし、重点領域から着手 |
| 既存テストが失敗している | 高 | 低 | まず既存テスト修正を優先 |
| テスト作成に時間がかかる | 中 | 中 | 8時間で完了しない場合は翌日継続 |
| カバレッジツールのエラー | 中 | 低 | ツール再インストール、設定確認 |

### 13.2 課題

- 生成されたコード（`*.g.dart`等）がカバレッジに含まれる可能性 → 除外設定が必要
- 一部のコードがテストしにくい構造の可能性 → 軽微なリファクタリングで対応
- CI環境でのカバレッジ計測が遅い可能性 → 並列実行、キャッシュ活用

## 14. 完了定義（Definition of Done）

- [ ] Frontend全体カバレッジ ≥ 80%達成
- [ ] Backend全体カバレッジ ≥ 90%達成
- [ ] Frontend ビジネスロジックカバレッジ ≥ 90%達成
- [ ] Backend APIエンドポイントカバレッジ ≥ 90%達成
- [ ] すべてのテストがパスする（Frontend、Backend、CI環境）
- [ ] カバレッジレポート（HTML、Markdown）が生成される
- [ ] 改善前後比較レポートが作成される
- [ ] 追加テストコードがLint基準を満たす
- [ ] CI/CDパイプラインでカバレッジが可視化される
- [ ] タスク実施内容がドキュメント化される

---

## 信頼性レベル

このTDD要件定義書の信頼性レベル: **🔵 青信号**

- NFR-501、NFR-502は要件定義書（`docs/spec/kotonoha-requirements.md`）に明確に記載されている
- テストカバレッジ基準（80%/90%）は技術スタック（`docs/tech-stack.md`）で定義されている
- テストツール（flutter test、pytest-cov）は実際に使用されているツール
- カバレッジ計測・レポート生成のコマンドは標準的な手法

一部の実装詳細（CI統合方法、優先順位付け等）は推測を含むが、合理的な範囲内。

---

## 更新履歴

- **2025-12-02**: TASK-0096 TDD要件定義書 初版作成
