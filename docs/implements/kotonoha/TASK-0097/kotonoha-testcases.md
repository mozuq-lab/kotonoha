# TASK-0097: セキュリティ・プライバシー最終確認 - テストケース定義書

## 概要

**タスクID**: TASK-0097
**生成日**: 2025-12-03
**テストケース総数**: 35件
**信頼性レベル**: 🔵 青信号（NFR-101〜NFR-105に基づく）

## テストケース一覧

### グループ1: NFR-101 ローカルストレージ保存 (8件)

| ID | テストケース | 優先度 | 根拠 |
|----|--------------|--------|------|
| TC-101-001 | 定型文がHive Boxに保存される | P0 | NFR-101 |
| TC-101-002 | 履歴がHive Boxに保存される | P0 | NFR-101 |
| TC-101-003 | お気に入りがHive Boxに保存される | P0 | NFR-101 |
| TC-101-004 | 設定がshared_preferencesに保存される | P0 | NFR-101 |
| TC-101-005 | データ保存時にネットワーク呼び出しが発生しない | P1 | NFR-101 |
| TC-101-006 | アプリ再起動後もローカルデータが保持される | P0 | NFR-101, REQ-5003 |
| TC-101-007 | Hive Boxがアプリ専用領域に作成される | P1 | NFR-101 |
| TC-101-008 | 入力バッファがローカルで管理される | P1 | NFR-101 |

### グループ2: NFR-102 AI変換プライバシー通知 (9件)

| ID | テストケース | 優先度 | 根拠 |
|----|--------------|--------|------|
| TC-102-001 | 初回AI変換時にプライバシー同意ダイアログが表示される | P0 | NFR-102 |
| TC-102-002 | プライバシー同意前はAI変換が実行されない | P0 | NFR-102 |
| TC-102-003 | プライバシー同意後はAI変換が実行される | P0 | NFR-102 |
| TC-102-004 | 同意状態がshared_preferencesに永続化される | P0 | NFR-102 |
| TC-102-005 | 2回目以降のAI変換時はダイアログが表示されない | P1 | NFR-102 |
| TC-102-006 | プライバシーポリシーへのリンクが表示される | P1 | NFR-102 |
| TC-102-007 | 同意ダイアログに「会話内容を外部に送信」説明が含まれる | P1 | NFR-102 |
| TC-102-008 | 同意をキャンセルした場合AI変換が実行されない | P0 | NFR-102 |
| TC-102-009 | 設定画面から同意状態をリセットできる | P2 | NFR-102 |

### グループ3: NFR-103 データ削除機能 (8件)

| ID | テストケース | 優先度 | 根拠 |
|----|--------------|--------|------|
| TC-103-001 | 履歴を個別削除できる | P0 | NFR-103, REQ-604 |
| TC-103-002 | 履歴を全削除できる | P0 | NFR-103, REQ-604 |
| TC-103-003 | お気に入りを個別削除できる（確認ダイアログ後） | P0 | NFR-103, REQ-704 |
| TC-103-004 | お気に入りを全削除できる | P0 | NFR-103 |
| TC-103-005 | 定型文を削除できる（確認ダイアログ後） | P0 | NFR-103, REQ-104 |
| TC-103-006 | 削除確認ダイアログで「いいえ」を選択するとキャンセルされる | P1 | NFR-103 |
| TC-103-007 | 削除後にデータが永続的に削除される | P1 | NFR-103 |
| TC-103-008 | 存在しないIDの削除でエラーが発生しない | P2 | EDGE-065-002 |

### グループ4: NFR-104 HTTPS通信 (5件)

| ID | テストケース | 優先度 | 根拠 |
|----|--------------|--------|------|
| TC-104-001 | 本番環境のAPIベースURLがhttps://で始まる | P0 | NFR-104 |
| TC-104-002 | API通信がHTTPSで暗号化される | P0 | NFR-104 |
| TC-104-003 | CORSが正しく設定される | P1 | NFR-104 |
| TC-104-004 | 本番環境でHTTP URLは拒否される | P1 | NFR-104 |
| TC-104-005 | TLS 1.2以上が使用される | P1 | NFR-104 |

### グループ5: NFR-105 環境変数管理 (5件)

| ID | テストケース | 優先度 | 根拠 |
|----|--------------|--------|------|
| TC-105-001 | APIキーがソースコードにハードコードされていない | P0 | NFR-105 |
| TC-105-002 | SECRET_KEYが環境変数から読み込まれる | P0 | NFR-105 |
| TC-105-003 | データベース接続情報が環境変数から読み込まれる | P0 | NFR-105 |
| TC-105-004 | .envファイルが.gitignoreに含まれる | P0 | NFR-105 |
| TC-105-005 | フロントエンドのAPIベースURLが環境変数から取得される | P0 | NFR-105 |

## 詳細テスト仕様

### TC-101-001: 定型文がHive Boxに保存される

**前提条件**:
- Hiveが初期化されている
- presetPhrasesボックスが開かれている

**テスト手順**:
1. PresetPhraseRepositoryを作成
2. 新しいPresetPhraseを保存
3. Hive Boxに保存されたことを確認

**期待結果**:
- PresetPhraseがHive Boxに存在する
- ネットワーク呼び出しが発生しない

**テストコード位置**: `frontend/kotonoha_app/test/features/security/local_storage_test.dart`

---

### TC-102-001: 初回AI変換時にプライバシー同意ダイアログが表示される

**前提条件**:
- アプリが初期状態（同意フラグなし）
- ネットワーク接続あり

**テスト手順**:
1. AI変換画面を表示
2. AI変換ボタンをタップ
3. プライバシー同意ダイアログが表示されることを確認

**期待結果**:
- 同意ダイアログが表示される
- ダイアログに「会話内容を外部に送信」説明が含まれる
- 「同意する」「同意しない」ボタンが表示される

**テストコード位置**: `frontend/kotonoha_app/test/features/security/privacy_consent_test.dart`

---

### TC-103-001: 履歴を個別削除できる

**前提条件**:
- 履歴が1件以上存在する

**テスト手順**:
1. HistoryRepositoryを作成
2. 履歴を保存
3. delete(id)を呼び出し
4. 履歴が削除されたことを確認

**期待結果**:
- 指定したIDの履歴が削除される
- 他の履歴は影響を受けない

**テストコード位置**: `frontend/kotonoha_app/test/features/security/data_deletion_test.dart`

---

### TC-104-001: 本番環境のAPIベースURLがhttps://で始まる

**前提条件**:
- 本番環境設定が適用されている

**テスト手順**:
1. 本番環境用のAPI_BASE_URLを取得
2. https://で始まることを確認

**期待結果**:
- URLがhttps://で始まる

**テストコード位置**: `frontend/kotonoha_app/test/features/security/https_test.dart`

---

### TC-105-001: APIキーがソースコードにハードコードされていない

**前提条件**:
- ソースコードが存在する

**テスト手順**:
1. lib/ディレクトリ内の全Dartファイルを検索
2. APIキーパターン（sk-ant-, sk-）を検索
3. ハードコードが存在しないことを確認

**期待結果**:
- ハードコードされたAPIキーが見つからない

**テストコード位置**: `frontend/kotonoha_app/test/features/security/env_variables_test.dart`

## テスト実行計画

### Phase 1: ユニットテスト
- TC-101-001〜TC-101-008: ローカルストレージテスト
- TC-103-001〜TC-103-008: データ削除テスト
- TC-105-001〜TC-105-005: 環境変数テスト

### Phase 2: ウィジェットテスト
- TC-102-001〜TC-102-009: プライバシー同意UIテスト

### Phase 3: 統合テスト
- TC-104-001〜TC-104-005: HTTPS通信テスト

## テストカバレッジ目標

- **行カバレッジ**: 80%以上
- **ブランチカバレッジ**: 80%以上
- **重要ロジック**: 90%以上

## 更新履歴

- **2025-12-03**: テストケース定義書作成
