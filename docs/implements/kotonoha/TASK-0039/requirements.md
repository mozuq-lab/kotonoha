# TDD要件定義・機能仕様 - TASK-0039: 削除ボタン・全消去ボタン実装

## タスク情報

- **タスクID**: TASK-0039
- **タスク名**: 削除ボタン・全消去ボタン実装
- **タスクタイプ**: TDD
- **推定工数**: 8時間
- **フェーズ**: Phase 3 - Week 9, Day 3
- **依存タスク**: TASK-0038 (文字入力バッファ管理 - 完了済み)

## 関連文書

- **EARS要件定義書**: [docs/spec/kotonoha-requirements.md](../../../spec/kotonoha-requirements.md)
- **アーキテクチャ設計**: [docs/design/kotonoha/architecture.md](../../../design/kotonoha/architecture.md)
- **インターフェース定義**: [docs/design/kotonoha/interfaces.dart](../../../design/kotonoha/interfaces.dart)
- **Phase 3タスク**: [docs/tasks/kotonoha-phase3.md](../../../tasks/kotonoha-phase3.md)
- **TASK-0038要件定義**: [docs/implements/kotonoha/TASK-0038/requirements.md](../TASK-0038/requirements.md)

---

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

### 機能概要 🔵

この機能は、文字入力バッファの内容を操作するための削除ボタンと全消去ボタンのUIを実装します。削除ボタンは最後の1文字を削除し、全消去ボタンは確認ダイアログを表示した上でバッファ全体をクリアします。

### 何をする機能か

- **削除ボタン**: 入力バッファの最後の1文字を削除する
- **全消去ボタン**: 入力バッファのすべての文字を削除する
- **確認ダイアログ**: 全消去時に誤操作を防止するための確認を表示する
- **アクセシビリティ対応**: タップしやすいサイズ（最小44px、推奨60px以上）でボタンを配置

### どのような問題を解決するか

**文字削除操作の必要性 🔵**:
- REQ-003: ユーザーが入力を間違えた場合に、最後の1文字を削除できる必要がある
- REQ-004: ユーザーが入力をやり直したい場合に、全ての文字を一度に削除できる必要がある

**誤操作防止の必要性 🔵**:
- REQ-2001: 全消去は不可逆な操作であるため、確認ダイアログで意図を確認する必要がある
- REQ-5002: 重要な操作には誤操作防止の仕組みを設ける必要がある

### 想定されるユーザー

- 発話が困難で、タブレットの文字盤を使ってコミュニケーションするユーザー
- 手の動きが不安定で、誤タップの可能性があるユーザー
- 介護スタッフや家族（支援者）

### システム内での位置づけ

**アーキテクチャ上の位置 🔵**:
- **Presentation層**: 削除ボタン・全消去ボタンウィジェット
- **TASK-0038（InputBufferNotifier）との連携**: `deleteLastCharacter()`、`clear()`メソッドを呼び出す
- **TASK-0037（五十音文字盤UI）との連携**: 文字盤と同じ画面に配置
- **共通ウィジェット（LargeButton）の活用**: アクセシビリティ要件を満たすボタンコンポーネント

### 参照したEARS要件

- **REQ-003**: システムは削除ボタンで最後の1文字を削除する機能を提供しなければならない 🔵
- **REQ-004**: システムは全消去ボタンで入力欄のすべての文字を削除する機能を提供しなければならない 🔵
- **REQ-2001**: ユーザーが全消去ボタンをタップした場合、システムは確認ダイアログを表示しなければならない 🟡
- **REQ-5002**: システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない 🔵

### 参照した設計文書

- **architecture.md**: フロントエンド（Flutter）セクション - Riverpod 2.x状態管理
- **interfaces.dart**: `InputScreenState`クラス（469-515行目）

---

## 2. 入力・出力の仕様（EARS機能要件・TypeScript型定義ベース）

### 削除ボタンウィジェット 🔵

#### DeleteButton

```dart
class DeleteButton extends StatelessWidget {
  /// ボタンタップ時のコールバック
  final VoidCallback? onPressed;

  /// ボタンの有効/無効状態
  final bool enabled;

  const DeleteButton({
    Key? key,
    this.onPressed,
    this.enabled = true,
  }) : super(key: key);
}
```

**入力パラメータ**:
- `onPressed`: ボタンタップ時に実行されるコールバック（nullの場合は無効状態）
- `enabled`: ボタンの有効/無効状態（入力バッファが空の場合はfalse）

**出力/動作**:
- タップ時に`onPressed`コールバックを実行
- 無効状態の場合はタップを無視（視覚的にもグレーアウト表示）

### 全消去ボタンウィジェット 🔵

#### ClearAllButton

```dart
class ClearAllButton extends StatelessWidget {
  /// ボタンタップ時のコールバック（確認後に実行される）
  final VoidCallback? onConfirmed;

  /// ボタンの有効/無効状態
  final bool enabled;

  const ClearAllButton({
    Key? key,
    this.onConfirmed,
    this.enabled = true,
  }) : super(key: key);
}
```

**入力パラメータ**:
- `onConfirmed`: 確認ダイアログで「はい」をタップした後に実行されるコールバック
- `enabled`: ボタンの有効/無効状態（入力バッファが空の場合はfalse）

**出力/動作**:
- タップ時に確認ダイアログを表示
- ダイアログで「はい」を選択した場合のみ`onConfirmed`コールバックを実行
- ダイアログで「いいえ」を選択した場合はキャンセル（何もしない）

### 確認ダイアログ 🟡

#### ClearConfirmationDialog

```dart
class ClearConfirmationDialog extends StatelessWidget {
  /// 確認時のコールバック
  final VoidCallback onConfirmed;

  /// キャンセル時のコールバック
  final VoidCallback onCancelled;

  const ClearConfirmationDialog({
    Key? key,
    required this.onConfirmed,
    required this.onCancelled,
  }) : super(key: key);
}
```

**表示内容**:
- タイトル: 「確認」
- メッセージ: 「入力内容をすべて消去しますか？」
- 「はい」ボタン: `onConfirmed`を実行しダイアログを閉じる
- 「いいえ」ボタン: `onCancelled`を実行しダイアログを閉じる

### データフロー 🔵

```
[削除ボタン (DeleteButton)]
  ↓ onPressed()
[InputBufferNotifier.deleteLastCharacter()]
  ↓ state更新
[UI再描画（入力欄表示更新）]

[全消去ボタン (ClearAllButton)]
  ↓ タップ
[確認ダイアログ (ClearConfirmationDialog)]
  ↓ 「はい」選択
[onConfirmed() → InputBufferNotifier.clear()]
  ↓ state更新
[UI再描画（入力欄表示更新）]
```

### 参照したEARS要件

- **REQ-003**: 削除ボタンで最後の1文字削除 🔵
- **REQ-004**: 全消去ボタンで全削除 🔵
- **REQ-2001**: 全消去時の確認ダイアログ 🟡

### 参照した設計文書

- **interfaces.dart**: 469-515行目（`InputScreenState`クラス）

---

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### アクセシビリティ要件 🔵

#### ボタンサイズ
- **REQ-5001**: タップターゲットのサイズは44px x 44px以上
- **NFR-202**: 推奨サイズは60px x 60px以上
- **実装**: 既存の`LargeButton`ウィジェットを活用、または同等のサイズを確保

#### 視認性
- **REQ-803**: ライト/ダーク/高コントラストモードに対応
- **REQ-5006**: 高コントラストモードでWCAG 2.1 AAレベル（4.5:1以上）
- **実装**: テーマプロバイダーを使用し、テーマに応じた色を適用

### パフォーマンス要件 🔵

#### 応答速度
- **NFR-003**: ボタンタップから状態変更までの遅延を100ms以内
- **実装**: TASK-0038で実装済みの`InputBufferNotifier`の同期的な状態更新を活用

### 操作性要件 🔵

#### タップ主体の操作
- **REQ-5005**: タップ主体の操作で完結し、スワイプ等のジェスチャーへの依存を避ける
- **実装**: ボタンはタップのみで動作、長押しやスワイプは不要

#### 誤操作防止
- **REQ-5002**: 重要な操作（全消去）に誤操作防止の仕組みを設ける
- **実装**: 全消去時に確認ダイアログを表示

### UIレイアウト要件 🟡

#### ボタン配置
- 削除ボタンと全消去ボタンは文字盤の近くに配置
- 十分な間隔を確保し、隣接ボタンとの誤タップを防止
- **推奨**: 削除ボタンと全消去ボタンの間に最低8pxの間隔

#### 視覚的区別
- 削除ボタン: 通常のアクションボタン色（secondary color推奨）
- 全消去ボタン: 警告色（赤系、destructive action）で視覚的に区別
- 無効状態: グレーアウト表示

### 参照したEARS要件

- **NFR-003**: ボタンタップ応答100ms以内 🔵
- **NFR-202**: タップ領域60px x 60px以上推奨 🟡
- **REQ-5001**: タップターゲット44px x 44px以上 🟡
- **REQ-5002**: 誤操作防止の仕組み 🔵
- **REQ-5005**: タップ主体の操作 🔵

### 参照した設計文書

- **architecture.md**: フロントエンド（Flutter）セクション

---

## 4. 想定される使用例（EARSエッジケース・データフローベース）

### 基本的な使用パターン 🔵

#### パターン1: 1文字削除
**REQ-003の通常動作**:
```dart
// 現在の入力: 'こんにちは'
// ユーザーが削除ボタンをタップ

// 1. DeleteButtonがonPressedコールバックを発火
// 2. InputBufferNotifier.deleteLastCharacter()が呼び出される
// 3. バッファが'こんにち'に更新される
// 4. UIが再描画される

expect(container.read(inputBufferProvider), 'こんにち');
```

#### パターン2: 全消去（確認ダイアログ「はい」）
**REQ-004, REQ-2001の通常動作**:
```dart
// 現在の入力: 'おはようございます'
// ユーザーが全消去ボタンをタップ

// 1. ClearAllButtonが確認ダイアログを表示
// 2. ダイアログに「入力内容をすべて消去しますか？」と表示
// 3. ユーザーが「はい」をタップ
// 4. onConfirmedコールバックが発火
// 5. InputBufferNotifier.clear()が呼び出される
// 6. バッファが''に更新される
// 7. UIが再描画される

expect(container.read(inputBufferProvider), '');
```

#### パターン3: 全消去（確認ダイアログ「いいえ」）
**REQ-2001のキャンセル動作**:
```dart
// 現在の入力: 'おはようございます'
// ユーザーが全消去ボタンをタップ

// 1. ClearAllButtonが確認ダイアログを表示
// 2. ダイアログに「入力内容をすべて消去しますか？」と表示
// 3. ユーザーが「いいえ」をタップ
// 4. ダイアログが閉じる
// 5. バッファは変更されない

expect(container.read(inputBufferProvider), 'おはようございます');
```

### エッジケース 🟡

#### EDGE-1: 空バッファでの削除ボタン
```dart
// 現在の入力: ''（空）
// ユーザーが削除ボタンをタップ

// 期待される動作:
// - 削除ボタンは無効状態（enabled: false）で表示
// - タップしても何も起こらない
// - TASK-0038のInputBufferNotifier.deleteLastCharacter()は空バッファでも安全

expect(container.read(inputBufferProvider), '');
```

#### EDGE-2: 空バッファでの全消去ボタン
```dart
// 現在の入力: ''（空）
// ユーザーが全消去ボタンをタップ

// 期待される動作:
// - 全消去ボタンは無効状態（enabled: false）で表示
// - タップしても確認ダイアログは表示されない

expect(container.read(inputBufferProvider), '');
```

#### EDGE-3: 連続削除
```dart
// 現在の入力: 'あいう'
// ユーザーが削除ボタンを3回連続タップ

// 期待される動作:
// 1回目: 'あい'
// 2回目: 'あ'
// 3回目: ''
// 4回目以降: 何も起こらない（ボタンが無効化）

expect(container.read(inputBufferProvider), '');
```

#### EDGE-4: 確認ダイアログ表示中のバックグラウンド遷移 🔴
```dart
// 確認ダイアログが表示されている状態でアプリがバックグラウンドに移行

// 期待される動作:
// - フォアグラウンド復帰時、ダイアログの状態を維持
// - または、ダイアログを自動的に閉じ、入力状態を保持
```

### エラーケース 🟡

#### エラー1: 削除ボタン連打
```dart
// ユーザーが高速で削除ボタンを連打

// 期待される動作:
// - 各タップが順次処理される
// - UIが追従して更新される
// - パフォーマンス劣化が発生しない（100ms以内応答）
```

### 参照したEARS要件

- **REQ-003**: 削除ボタンで最後の1文字削除 🔵
- **REQ-004**: 全消去ボタンで全削除 🔵
- **REQ-2001**: 全消去時の確認ダイアログ 🟡

### 参照した設計文書

- **TASK-0038/requirements.md**: InputBufferNotifierの仕様

---

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー 🔵

- **ストーリー名**: 「文字入力機能」
- **As a**: 発話が困難なユーザー
- **I want to**: 入力した文字を削除・修正したい
- **So that**: 入力を間違えても簡単にやり直せる

### 参照した機能要件 🔵

| 要件ID | 要件内容 | 信頼性レベル |
|--------|----------|--------------|
| REQ-003 | システムは削除ボタンで最後の1文字を削除する機能を提供しなければならない | 🔵 |
| REQ-004 | システムは全消去ボタンで入力欄のすべての文字を削除する機能を提供しなければならない | 🔵 |
| REQ-2001 | ユーザーが全消去ボタンをタップした場合、システムは確認ダイアログを表示しなければならない | 🟡 |
| REQ-5002 | システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない | 🔵 |

### 参照した非機能要件 🟡

| 要件ID | 要件内容 | 信頼性レベル |
|--------|----------|--------------|
| NFR-003 | ボタンタップから状態変更まで100ms以内 | 🔵 |
| NFR-202 | タップ領域は60px x 60px以上推奨 | 🟡 |
| REQ-5001 | タップターゲットは44px x 44px以上 | 🟡 |
| REQ-5005 | タップ主体の操作で完結 | 🔵 |

### 参照した設計文書 🔵

#### アーキテクチャ
- **architecture.md**: フロントエンド（Flutter）- Riverpod 2.x状態管理設計

#### 型定義
- **interfaces.dart**: 469-515行目（`InputScreenState`クラス）

---

## 6. 実装範囲の定義

### 実装対象 🔵

#### 本タスクで実装する機能

1. **DeleteButton ウィジェット**:
   - 削除ボタンのUI
   - タップ時のコールバック発火
   - 有効/無効状態の表示切り替え
   - アクセシビリティ対応（サイズ、色）

2. **ClearAllButton ウィジェット**:
   - 全消去ボタンのUI
   - タップ時の確認ダイアログ表示
   - 確認後のコールバック発火
   - 有効/無効状態の表示切り替え
   - 警告色での視覚的区別

3. **ClearConfirmationDialog ウィジェット**:
   - 確認ダイアログのUI
   - 「入力内容をすべて消去しますか？」メッセージ
   - 「はい」「いいえ」ボタン
   - アクセシビリティ対応

4. **HomeScreenへの統合**:
   - 削除ボタン・全消去ボタンのレイアウト配置
   - InputBufferNotifierとの連携
   - 入力バッファ状態に応じたボタン有効/無効制御

5. **テスト実装**:
   - DeleteButtonウィジェットテスト
   - ClearAllButtonウィジェットテスト
   - ClearConfirmationDialogウィジェットテスト
   - 統合テスト（InputBufferNotifierとの連携）

### 実装範囲外（後続タスクで実装） 🟡

#### 後続タスクで実装
- 削除ボタン・全消去ボタンのカスタマイズ設定
- ハプティックフィードバック（触覚フィードバック）
- 音声フィードバック（クリック音等）

---

## 7. 受け入れ基準

### 機能要件の受け入れ基準 🔵

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-001 | 削除ボタンをタップすると最後の1文字が削除される | ウィジェットテスト |
| AC-002 | 全消去ボタンをタップすると確認ダイアログが表示される | ウィジェットテスト |
| AC-003 | 確認ダイアログで「はい」を選択するとバッファがクリアされる | ウィジェットテスト |
| AC-004 | 確認ダイアログで「いいえ」を選択するとキャンセルされる | ウィジェットテスト |
| AC-005 | 入力バッファが空の場合、削除ボタンが無効化される | ウィジェットテスト |
| AC-006 | 入力バッファが空の場合、全消去ボタンが無効化される | ウィジェットテスト |

### 非機能要件の受け入れ基準 🔵

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-007 | ボタンタップから状態変更まで100ms以内 | パフォーマンステスト |
| AC-008 | ボタンのタップターゲットが44px x 44px以上 | 視覚検査/テスト |
| AC-009 | ボタンがライト/ダーク/高コントラストモードで適切に表示される | 視覚検査/テスト |
| AC-010 | 全消去ボタンが警告色で視覚的に区別される | 視覚検査 |

### エッジケースの受け入れ基準 🟡

| ID | 基準 | 検証方法 |
|----|------|----------|
| AC-011 | 空バッファで削除ボタンをタップしてもエラーにならない | ウィジェットテスト |
| AC-012 | 連続削除で正しく文字が削除される | ウィジェットテスト |
| AC-013 | 確認ダイアログ外タップでダイアログが閉じない（モーダル） | ウィジェットテスト |

---

## 8. 品質判定基準

### 高品質の条件

#### 要件の明確さ
- [x] 削除ボタンの動作が明確（最後の1文字削除）
- [x] 全消去ボタンの動作が明確（確認ダイアログ→全削除）
- [x] 確認ダイアログの内容が明確（メッセージ、ボタン）
- [x] 有効/無効状態の条件が明確（空バッファで無効化）

#### 入出力定義の完全性
- [x] 各ウィジェットのパラメータが明確
- [x] コールバックの実行タイミングが明確
- [x] データフローが明確

#### 制約条件の明確さ
- [x] ボタンサイズ要件: 44px以上、60px推奨
- [x] パフォーマンス要件: 100ms以内
- [x] 誤操作防止要件: 確認ダイアログ

#### 実装可能性
- [x] TASK-0038のInputBufferNotifierを活用
- [x] 既存のLargeButtonパターンを参考にできる
- [x] Flutterの標準ダイアログを活用できる

### 改善が必要な点

#### ダイアログのキャンセル動作 🟡
- ダイアログ外タップ時の動作は実装時に決定
- バリアdismissible: falseで外部タップを無効化推奨

#### 視覚的フィードバック 🔴
- タップ時のリップルエフェクトの詳細は実装時に決定
- 無効状態の視覚的表現の詳細は実装時に決定

---

## 9. 次のステップ

### 推奨コマンド
次は `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。

### テストケースで確認すべき項目

1. **DeleteButton 正常系テスト**:
   - 削除ボタンの表示
   - タップ時のコールバック発火
   - 有効/無効状態の切り替え

2. **ClearAllButton 正常系テスト**:
   - 全消去ボタンの表示
   - タップ時の確認ダイアログ表示
   - 「はい」選択時のコールバック発火
   - 「いいえ」選択時のキャンセル

3. **ClearConfirmationDialog テスト**:
   - ダイアログの表示内容
   - 「はい」ボタンの動作
   - 「いいえ」ボタンの動作
   - モーダル性（外部タップで閉じない）

4. **統合テスト**:
   - InputBufferNotifierとの連携
   - 入力バッファ状態に応じたボタン制御
   - 連続操作の動作確認

5. **アクセシビリティテスト**:
   - ボタンサイズの検証
   - テーマ対応の確認

---

## 更新履歴

- **2025-11-22**: TDD要件定義書作成
  - EARS要件定義書（REQ-003, REQ-004, REQ-2001, REQ-5002）を参照
  - architecture.md、interfaces.dartから設計情報を抽出
  - TASK-0038の実装（InputBufferNotifier）を前提条件として反映
  - 信頼性レベル（🔵🟡🔴）を各セクションに明記
