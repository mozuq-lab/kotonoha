# TASK-0063: 履歴再読み上げ・削除機能 - 要件定義書

## 概要

TASK-0063では、ユーザーが保存された履歴を再利用できる機能を実装します。具体的には、履歴のタップによる即座の再読み上げ、個別削除機能、全削除機能を提供します。これにより、ユーザーは過去に使用した文章を効率的に再利用できるようになります。

**対象機能**: 履歴再読み上げ、履歴個別削除、履歴全削除

**関連要件**:
- REQ-603: システムは履歴一覧からワンタップで再読み上げ・再表示できる機能を提供しなければならない
- REQ-604: システムは履歴の個別削除および全削除機能を提供しなければならない
- NFR-001: システムはTTS読み上げ開始までの時間を1秒以内としなければならない
- NFR-204: システムはエラーメッセージを分かりやすい日本語で表示し、復旧方法を示さなければならない

**依存タスク**:
- TASK-0061: 履歴一覧UI実装（完了）
- TASK-0062: 履歴Hiveモデル・リポジトリ実装（完了）
- TASK-0048: OS標準TTS連携（完了）

**信頼性レベル凡例**:
- 🔵 **青信号**: EARS要件定義書・設計文書・既存実装を参考にした確実な要件
- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測による要件
- 🔴 **赤信号**: EARS要件定義書・設計文書にない推測による要件

---

## 機能要件（FR: Functional Requirements）

### 履歴再読み上げ機能

#### FR-063-001: 履歴タップによる再読み上げ 🔵
**WHEN** ユーザーが履歴リスト内の履歴項目をタップした場合、**THEN** システムは即座にその履歴の内容をTTS（Text-to-Speech）で読み上げなければならない。

**設計根拠**:
- REQ-603に基づく「ワンタップで再読み上げ」機能
- 過去の会話内容を素早く再利用するための中核機能
- タップ操作のみで完結（アクセシビリティ要件REQ-5005準拠）

**実装詳細**:
- 履歴項目ウィジェット（HistoryListItem）にonTapコールバック設定
- タップ時にTTSProviderのspeak()メソッドを呼び出し
- TTS読み上げ開始まで1秒以内（NFR-001準拠）

**UI/UX考慮点**:
- タップ可能領域は44px × 44px以上（REQ-5001準拠）
- タップ時の視覚的フィードバック（リップル効果等）
- 読み上げ中の視覚的インジケーター表示

---

#### FR-063-002: 読み上げ中の状態表示 🔵
**WHEN** 履歴の再読み上げが実行中である場合、**THEN** システムは読み上げ中であることを視覚的に明示しなければならない。

**設計根拠**:
- REQ-3003「読み上げが実行中の状態にある場合、システムは読み上げボタンを「停止」ボタンとして表示しなければならない」
- ユーザーへの操作フィードバック提供（ユーザビリティ向上）
- 複数操作の競合防止（読み上げ中に別の履歴をタップした場合の挙動明確化）

**実装詳細**:
- TTSProviderの状態（TTSState）を監視
- 読み上げ中は該当履歴項目をハイライト表示
- 読み上げ停止ボタンの表示（グローバルまたは履歴項目内）

---

#### FR-063-003: 読み上げ中の再タップによる中断 🟡
**WHEN** 読み上げ中にユーザーが別の履歴項目をタップした場合、**THEN** システムは現在の読み上げを停止し、新しい履歴の読み上げを開始しなければならない。

**設計根拠**:
- TTSService実装のEDGE-2対応「読み上げ中に新しいテキストを読み上げる場合」
- ユーザーの意図を優先（最新のタップが有効）
- 自然な操作フロー（前の読み上げを手動停止せずに済む）

**実装詳細**:
- TTSService.speak()内で自動的に前の読み上げを停止
- 既存のTTSService実装で対応済み（再確認必要）
- UIは新しい履歴項目をハイライト

---

### 履歴削除機能

#### FR-063-004: 履歴長押しによるメニュー表示 🟡
**WHEN** ユーザーが履歴項目を長押しした場合、**THEN** システムはコンテキストメニュー（削除、お気に入り追加）を表示しなければならない。

**設計根拠**:
- タスクファイルの実装詳細「履歴長押しでメニュー表示（削除、お気に入り追加）」
- モバイルUIの一般的なUXパターン
- 誤操作防止（長押しは意図的な操作）

**実装詳細**:
- HistoryListItemにonLongPressコールバック設定
- showModalBottomSheet または showMenuによるメニュー表示
- メニュー項目: 「削除」「お気に入りに追加」（Phase 4以降）

**UI/UX考慮点**:
- 長押し時間: 500ms〜800ms程度（標準的な長押し判定時間）
- 長押し時の触覚フィードバック（HapticFeedback.mediumImpact）
- メニュー表示位置: 履歴項目の近くまたは画面下部

---

#### FR-063-005: 個別削除機能と確認ダイアログ 🔵
**WHEN** ユーザーが履歴項目のメニューから「削除」を選択した場合、**THEN** システムは確認ダイアログを表示し、「はい」を選択した場合のみ削除を実行しなければならない。

**設計根拠**:
- REQ-604「システムは履歴の個別削除および全削除機能を提供しなければならない」
- REQ-5002「システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない」
- タスクファイルの完了条件「個別削除時に確認ダイアログが表示される」

**実装詳細**:
- showDialogによる確認ダイアログ表示
- ダイアログ内容:
  - タイトル: 「履歴を削除しますか?」
  - 本文: 削除対象の履歴内容の一部（最大50文字程度）
  - ボタン: 「キャンセル」「削除」
- 「削除」選択時にHistoryRepository.delete()を呼び出し
- 削除後にリストを自動更新（Riverpod Providerの状態更新）

**UI/UX考慮点**:
- 削除ボタンは赤色など警告色で表示
- ダイアログはモーダル（背景タップで閉じない）
- 削除後にスナックバー等で「削除しました」通知（オプション）

---

#### FR-063-006: 全削除機能と確認ダイアログ 🔵
**WHEN** ユーザーが履歴画面の「全削除」ボタンをタップした場合、**THEN** システムは確認ダイアログを表示し、「はい」を選択した場合のみ全削除を実行しなければならない。

**設計根拠**:
- REQ-604「システムは履歴の個別削除および全削除機能を提供しなければならない」
- REQ-5002（誤操作防止の仕組み）
- タスクファイルの完了条件「全削除時に確認ダイアログが表示される」

**実装詳細**:
- 履歴画面のAppBarまたはメニューに「全削除」ボタン配置
- showDialogによる確認ダイアログ表示
- ダイアログ内容:
  - タイトル: 「すべての履歴を削除しますか?」
  - 本文: 「この操作は取り消せません。XX件の履歴が削除されます。」
  - ボタン: 「キャンセル」「すべて削除」
- 「すべて削除」選択時にHistoryRepository.deleteAll()を呼び出し
- 削除後にリストを自動更新（空のリスト表示、「履歴がありません」メッセージ）

**UI/UX考慮点**:
- 全削除ボタンは目立たない場所に配置（誤タップ防止）
- ボタンアイコン: delete_sweep_outlinedなど
- 削除後にスナックバー等で「全削除しました」通知（オプション）

---

#### FR-063-007: 削除後のリスト自動更新 🔵
**WHEN** 履歴の個別削除または全削除が完了した場合、**THEN** システムは即座に履歴リストを更新し、最新の状態を表示しなければならない。

**設計根拠**:
- タスクファイルの実装詳細「削除後のリスト自動更新」
- ユーザーへの即時フィードバック提供
- データ整合性の維持（削除されたはずの履歴が画面に残らない）

**実装詳細**:
- RiverpodのStateProviderまたはStateNotifierProviderを使用
- HistoryRepository操作後、Providerの状態を更新
- UIは自動的に再構築され、最新の履歴リストを表示
- 削除後に履歴が0件になった場合、EDGE-103「履歴がありません」メッセージを表示

---

### エッジケース・境界値対応

#### FR-063-008: 空文字列の読み上げ防止 🔵
**WHEN** 履歴の内容が空文字列の場合、**THEN** システムは読み上げを実行せず、何も行わないものとする。

**設計根拠**:
- TTSService実装のEDGE-3対応「空文字列の読み上げ試行」
- データ整合性エラー防止（通常は履歴に空文字列は保存されないが、防御的実装）

**実装詳細**:
- TTSService.speak()内で空文字列チェック済み
- HistoryRepository保存時にバリデーション（空文字列を拒否）で二重防止

---

#### FR-063-009: 読み上げエラー時の処理 🔵
**WHEN** 履歴の読み上げ中にTTSエラーが発生した場合、**THEN** システムはエラーメッセージを表示し、アプリは継続動作しなければならない。

**設計根拠**:
- EDGE-004「TTS音声再生エラー時、システムはテキスト表示のみで継続し、エラー通知を表示しなければならない」
- NFR-301「システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない」
- NFR-204「システムはエラーメッセージを分かりやすい日本語で表示し、復旧方法を示さなければならない」

**実装詳細**:
- TTSServiceのエラーハンドリング機能を活用（state=error、errorMessage設定）
- UIでTTSState.errorを検知し、スナックバーまたはダイアログでエラー表示
- エラーメッセージ例: 「読み上げに失敗しました。音声設定を確認してください。」
- エラー後もアプリは継続動作（他の履歴の再生、削除操作は可能）

---

#### FR-063-010: 存在しない履歴IDの削除試行 🟡
**WHEN** 存在しない履歴IDを削除しようとした場合、**THEN** システムはエラーを発生させず、何も行わないものとする。

**設計根拠**:
- HistoryRepository実装のEDGE-006「存在しないIDでも例外を投げない」
- 並行操作の安全性（複数箇所で同時削除されても問題なし）

**実装詳細**:
- HistoryRepository.delete()は既に対応済み（Hive.delete()は存在しないキーでも例外なし）
- UIは削除失敗を通知しない（ユーザーにとって削除済みと同じ結果）

---

## 受け入れ基準（AC: Acceptance Criteria）

### AC-063-001: 履歴タップで即座に読み上げ 🔵
**GIVEN** 履歴リストに1件以上の履歴が存在する状態で、
**WHEN** ユーザーが履歴項目をタップすると、
**THEN** 以下の条件を満たす:
- タップから1秒以内に読み上げが開始される（NFR-001）
- タップした履歴の内容（content）が正確に読み上げられる
- 読み上げ中は視覚的インジケーター（ハイライト等）が表示される

**テスト方法**:
- ウィジェットテスト: HistoryListItemのonTapコールバックが呼ばれることを確認
- インテグレーションテスト: タップ後にTTSProvider.speak()が呼ばれることを検証
- 手動テスト: 実機で読み上げ開始時間を計測（1秒以内を確認）

---

### AC-063-002: 読み上げ中に別の履歴をタップすると切り替わる 🟡
**GIVEN** ある履歴の読み上げが実行中の状態で、
**WHEN** ユーザーが別の履歴項目をタップすると、
**THEN** 以下の条件を満たす:
- 前の読み上げが即座に停止される
- 新しい履歴の読み上げが開始される
- 新しい履歴項目がハイライト表示される

**テスト方法**:
- ウィジェットテスト: 連続タップ時のTTSService.speak()呼び出しを検証
- ユニットテスト: TTSService.speak()内の停止ロジックをテスト

---

### AC-063-003: 履歴長押しでメニュー表示 🟡
**GIVEN** 履歴リストに1件以上の履歴が存在する状態で、
**WHEN** ユーザーが履歴項目を長押しすると、
**THEN** 以下の条件を満たす:
- コンテキストメニューが表示される
- メニューに「削除」オプションが含まれる
- （オプション）メニューに「お気に入りに追加」オプションが含まれる（Phase 4以降）

**テスト方法**:
- ウィジェットテスト: onLongPressコールバックが呼ばれることを確認
- ウィジェットテスト: メニュー表示後に「削除」ボタンが見つかることを確認

---

### AC-063-004: 個別削除時に確認ダイアログ表示 🔵
**GIVEN** 履歴項目のメニューから「削除」を選択した状態で、
**WHEN** 確認ダイアログが表示されると、
**THEN** 以下の条件を満たす:
- ダイアログに「履歴を削除しますか?」というタイトルが表示される
- ダイアログに削除対象の履歴内容が表示される
- 「キャンセル」ボタンと「削除」ボタンが表示される
- 「キャンセル」選択時は履歴が削除されない
- 「削除」選択時は履歴が削除され、リストから消える

**テスト方法**:
- ウィジェットテスト: ダイアログの表示内容を検証
- インテグレーションテスト: 削除フロー全体をテスト（メニュー→ダイアログ→削除→リスト更新）

---

### AC-063-005: 全削除時に確認ダイアログ表示 🔵
**GIVEN** 履歴リストに複数件の履歴が存在する状態で、
**WHEN** ユーザーが「全削除」ボタンをタップすると、
**THEN** 以下の条件を満たす:
- 確認ダイアログが表示される
- ダイアログに「すべての履歴を削除しますか?」というタイトルが表示される
- ダイアログに削除件数が表示される（例: 「XX件の履歴が削除されます」）
- 「キャンセル」ボタンと「すべて削除」ボタンが表示される
- 「キャンセル」選択時は履歴が削除されない
- 「すべて削除」選択時は全履歴が削除され、「履歴がありません」メッセージが表示される

**テスト方法**:
- ウィジェットテスト: ダイアログの表示内容を検証
- インテグレーションテスト: 全削除フロー全体をテスト（ボタン→ダイアログ→全削除→空リスト表示）
- ユニットテスト: HistoryRepository.deleteAll()のテスト

---

### AC-063-006: 削除後にリストが自動更新される 🔵
**GIVEN** 履歴リストに5件の履歴が存在する状態で、
**WHEN** ユーザーが1件の履歴を削除すると、
**THEN** 以下の条件を満たす:
- 削除後のリストに4件の履歴が表示される
- 削除した履歴は表示されない
- リストの順序は変わらない（最新順を維持）

**テスト方法**:
- インテグレーションテスト: 削除前後のリスト件数を検証
- ウィジェットテスト: Provider状態更新後の再構築を確認

---

### AC-063-007: 読み上げエラー時にエラーメッセージ表示 🔵
**GIVEN** TTSエンジンがエラー状態にある（モック）状態で、
**WHEN** ユーザーが履歴項目をタップすると、
**THEN** 以下の条件を満たす:
- エラーメッセージが表示される（例: 「読み上げに失敗しました」）
- アプリは継続動作する（クラッシュしない）
- 他の履歴項目のタップ、削除操作は可能

**テスト方法**:
- ユニットテスト: TTSService.speak()エラー時の状態確認
- ウィジェットテスト: TTSState.error時のエラーUI表示確認

---

## 非機能要件（NFR: Non-Functional Requirements）

### NFR-063-001: パフォーマンス - 読み上げ開始時間 🔵
システムは履歴タップから読み上げ開始までの時間を1秒以内としなければならない。

**根拠**: NFR-001「システムはTTS読み上げ開始までの時間を1秒以内としなければならない」

**計測方法**:
- 手動テスト: 実機でストップウォッチ計測
- パフォーマンステスト: タップイベントからTTS開始までの時間をログ記録

**許容範囲**: 1000ms以内（目標: 500ms以内）

---

### NFR-063-002: ユーザビリティ - タップ領域サイズ 🔵
履歴項目のタップ可能領域は最小44px × 44px、推奨60px × 60px以上とする。

**根拠**: REQ-5001「システムはタップターゲット（ボタン・キー）のサイズを44px × 44px以上としなければならない」

**検証方法**:
- ウィジェットテスト: HistoryListItemのサイズを測定
- 手動テスト: 実機でタップしやすさを確認

---

### NFR-063-003: 信頼性 - エラー耐性 🔵
読み上げエラー、削除エラーが発生しても、アプリは継続動作し、ユーザーに適切なエラーメッセージを表示する。

**根拠**:
- NFR-301「システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない」
- NFR-204「システムはエラーメッセージを分かりやすい日本語で表示し、復旧方法を示さなければならない」

**検証方法**:
- ユニットテスト: TTSServiceエラー時の挙動確認
- インテグレーションテスト: エラー状態でのUI操作可能性確認

---

### NFR-063-004: アクセシビリティ - 操作の簡潔性 🔵
履歴の再読み上げは1タップで完了し、削除操作は2タップ（長押し+削除ボタン）+確認ダイアログ選択で完了する。

**根拠**:
- REQ-603「ワンタップで再読み上げ」
- NFR-201「システムは主要な操作（文字入力、定型文選択、読み上げ）を3タップ以内で完了できなければならない」
- REQ-5005「システムはタップ主体の操作で完結し、スワイプ等のジェスチャーへの依存を避けなければならない」

**検証方法**:
- 手動テスト: 操作フロー確認（タップ回数カウント）

---

## エッジケース・境界値

### EDGE-063-001: 履歴0件の状態で全削除ボタンをタップ 🟡
**WHEN** 履歴が0件の状態で「全削除」ボタンをタップした場合、**THEN** システムは何も行わないか、「削除する履歴がありません」というメッセージを表示する。

**実装案**:
- 履歴0件の場合は全削除ボタンを無効化（グレーアウト）
- または、ボタンタップ時に「削除する履歴がありません」スナックバー表示

---

### EDGE-063-002: 読み上げ中に削除操作 🟡
**WHEN** 読み上げ中の履歴を削除しようとした場合、**THEN** システムは読み上げを停止してから削除を実行する。

**実装案**:
- 削除実行前にTTSProvider.stop()を呼び出す
- または、削除確認ダイアログで「読み上げ中の履歴を削除しますか?」と明示

---

### EDGE-063-003: 50件上限到達後の削除と再追加 🟡
**WHEN** 履歴が50件の状態で1件削除し、新しい履歴を追加した場合、**THEN** システムは50件制限を正しく適用する。

**検証方法**:
- ユニットテスト: HistoryRepositoryの50件上限ロジックをテスト
- インテグレーションテスト: 削除→追加フローで件数確認

---

### EDGE-063-004: ネットワークエラー中の読み上げ 🔵
**WHEN** オフライン状態で履歴の読み上げを実行した場合、**THEN** システムはOS標準TTSを使用して正常に読み上げを実行する（ネットワーク不要）。

**根拠**:
- REQ-1001「システムは文字盤入力・定型文・履歴・TTSをオフライン環境で利用可能にしなければならない」
- OS標準TTSはオフラインで動作

**検証方法**:
- 手動テスト: 機内モードでの読み上げ動作確認

---

## テストケース概要

### 単体テスト（Unit Test）

#### UT-063-001: TTSService.speak() 呼び出しテスト
- **目的**: 履歴タップ時にTTSServiceが正しく呼ばれるか
- **入力**: HistoryItem(content: "こんにちは")
- **期待結果**: TTSService.speak("こんにちは")が呼ばれる

#### UT-063-002: HistoryRepository.delete() 正常系
- **目的**: 履歴削除が正しく動作するか
- **入力**: 既存の履歴ID
- **期待結果**: 履歴が削除され、getById()がnullを返す

#### UT-063-003: HistoryRepository.deleteAll() 正常系
- **目的**: 全削除が正しく動作するか
- **入力**: 5件の履歴が存在する状態
- **期待結果**: loadAll()が空リストを返す

#### UT-063-004: 存在しない履歴IDの削除（EDGE-063-001対応）
- **目的**: 存在しないIDの削除がエラーにならないか
- **入力**: 存在しない履歴ID
- **期待結果**: 例外が発生せず、正常終了

---

### ウィジェットテスト（Widget Test）

#### WT-063-001: 履歴項目タップでコールバック発火
- **目的**: HistoryListItemのonTapが動作するか
- **手順**: HistoryListItemをタップ
- **期待結果**: onTapコールバックが呼ばれる

#### WT-063-002: 履歴項目長押しでメニュー表示
- **目的**: 長押しでメニューが表示されるか
- **手順**: HistoryListItemを長押し
- **期待結果**: メニューに「削除」ボタンが表示される

#### WT-063-003: 個別削除ダイアログの表示内容
- **目的**: 確認ダイアログの内容が正しいか
- **手順**: メニューから「削除」選択
- **期待結果**: ダイアログに「履歴を削除しますか?」とボタンが表示

#### WT-063-004: 全削除ダイアログの表示内容
- **目的**: 全削除確認ダイアログの内容が正しいか
- **手順**: 「全削除」ボタンタップ
- **期待結果**: ダイアログに削除件数が表示される

---

### 統合テスト（Integration Test）

#### IT-063-001: 履歴タップから読み上げまでのフロー
- **目的**: E2Eフローが正しく動作するか
- **手順**:
  1. 履歴リストを表示
  2. 履歴項目をタップ
  3. 読み上げ開始を確認
- **期待結果**: タップから1秒以内に読み上げ開始

#### IT-063-002: 履歴削除フロー（個別）
- **目的**: 削除フロー全体が正しく動作するか
- **手順**:
  1. 履歴項目を長押し
  2. メニューから「削除」選択
  3. 確認ダイアログで「削除」選択
  4. リスト更新確認
- **期待結果**: 削除後にリストから履歴が消える

#### IT-063-003: 履歴全削除フロー
- **目的**: 全削除フロー全体が正しく動作するか
- **手順**:
  1. 「全削除」ボタンタップ
  2. 確認ダイアログで「すべて削除」選択
  3. 空リスト表示確認
- **期待結果**: 全削除後に「履歴がありません」メッセージ表示

#### IT-063-004: 読み上げ中に別の履歴をタップ
- **目的**: 読み上げ切り替えが正しく動作するか
- **手順**:
  1. 履歴Aをタップ（読み上げ開始）
  2. 読み上げ中に履歴Bをタップ
- **期待結果**: 履歴Aの読み上げが停止し、履歴Bの読み上げ開始

---

## 実装チェックリスト

### 機能実装

- [ ] HistoryListItemにonTapコールバック実装
- [ ] タップ時のTTSProvider.speak()呼び出し
- [ ] 読み上げ中の視覚的インジケーター表示
- [ ] HistoryListItemにonLongPressコールバック実装
- [ ] 長押しでコンテキストメニュー表示（削除）
- [ ] 個別削除の確認ダイアログ実装
- [ ] 全削除ボタンと確認ダイアログ実装
- [ ] HistoryRepository.delete()呼び出し
- [ ] HistoryRepository.deleteAll()呼び出し
- [ ] 削除後のProvider状態更新とリスト自動更新

### エラーハンドリング

- [ ] 空文字列の読み上げ防止（既存TTSService対応確認）
- [ ] 読み上げエラー時のエラーメッセージ表示
- [ ] 存在しない履歴IDの削除エラー防止（既存Repository対応確認）
- [ ] 読み上げ中の削除時の安全な停止処理

### UI/UX

- [ ] タップ領域サイズ44px × 44px以上
- [ ] タップ時の視覚的フィードバック（リップル効果）
- [ ] 長押し時の触覚フィードバック
- [ ] 削除ボタンの警告色表示
- [ ] 確認ダイアログのモーダル表示
- [ ] 削除後の通知（スナックバー等、オプション）

### テスト

- [ ] UT-063-001〜004: 単体テスト
- [ ] WT-063-001〜004: ウィジェットテスト
- [ ] IT-063-001〜004: 統合テスト
- [ ] パフォーマンステスト（読み上げ開始時間計測）
- [ ] 手動テスト（実機での操作確認）

---

## 関連ドキュメント

- [TASK-0063タスク定義](../../../tasks/kotonoha-phase4.md#day-3-task-0063---履歴再読み上げ削除機能)
- [要件定義書 - REQ-603, REQ-604](../../spec/kotonoha-requirements.md)
- [インターフェース定義 - History](../../design/kotonoha/interfaces.dart)
- [TASK-0061 - 履歴一覧UI実装](../TASK-0061/kotonoha-requirements.md)
- [TASK-0062 - 履歴Repository実装](../TASK-0062/kotonoha-requirements.md)
- [TASK-0048 - TTS連携実装](../TASK-0048/kotonoha-requirements.md)

---

## 更新履歴

- **2025-11-28**: TASK-0063要件定義書作成（TDD Redフェーズ準備）
