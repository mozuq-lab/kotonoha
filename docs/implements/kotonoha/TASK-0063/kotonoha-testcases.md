# TASK-0063: 履歴再読み上げ・削除機能 - テストケース定義書

## 概要

TASK-0063の実装に必要なテストケースを定義します。

**対象機能**: 履歴再読み上げ、履歴個別削除、履歴全削除
**関連要件定義書**: `docs/implements/kotonoha/TASK-0063/kotonoha-requirements.md`
**既存テスト**: TASK-0061, TASK-0062で作成されたテストと重複しないよう、新機能（再読み上げ・削除）に焦点を当てる

**信頼性レベル凡例**:
- 🔵 **青信号**: EARS要件定義書・設計文書・既存実装を参考にした確実なテストケース
- 🟡 **黄信号**: EARS要件定義書・設計文書から妥当な推測によるテストケース
- 🔴 **赤信号**: EARS要件定義書・設計文書にない推測によるテストケース

---

## テストカバレッジ概要

### 機能要件カバレッジ

| 要件ID | 要件概要 | テストケース | 優先度 |
|--------|----------|-------------|--------|
| FR-063-001 | 履歴タップによる再読み上げ | TC-063-001, TC-063-002, TC-063-003 | P0 |
| FR-063-002 | 読み上げ中の状態表示 | TC-063-004, TC-063-005 | P0 |
| FR-063-003 | 読み上げ中の再タップによる中断 | TC-063-006, TC-063-007 | P1 |
| FR-063-004 | 履歴長押しによるメニュー表示 | TC-063-008, TC-063-009 | P1 |
| FR-063-005 | 個別削除機能と確認ダイアログ | TC-063-010, TC-063-011, TC-063-012 | P0 |
| FR-063-006 | 全削除機能と確認ダイアログ | TC-063-013, TC-063-014, TC-063-015 | P0 |
| FR-063-007 | 削除後のリスト自動更新 | TC-063-016, TC-063-017 | P0 |
| FR-063-008 | 空文字列の読み上げ防止 | TC-063-018 | P1 |
| FR-063-009 | 読み上げエラー時の処理 | TC-063-019, TC-063-020 | P1 |

### 受け入れ基準カバレッジ

| AC ID | 受け入れ基準概要 | テストケース |
|-------|-----------------|-------------|
| AC-063-001 | 履歴タップで即座に読み上げ | TC-063-001, TC-063-002 |
| AC-063-002 | 読み上げ中に別の履歴タップで切り替わる | TC-063-006, TC-063-007 |
| AC-063-003 | 履歴長押しでメニュー表示 | TC-063-008, TC-063-009 |
| AC-063-004 | 個別削除時に確認ダイアログ表示 | TC-063-010, TC-063-011 |
| AC-063-005 | 全削除時に確認ダイアログ表示 | TC-063-013, TC-063-014 |
| AC-063-006 | 削除後にリストが自動更新される | TC-063-016, TC-063-017 |
| AC-063-007 | 読み上げエラー時にエラーメッセージ表示 | TC-063-019, TC-063-020 |

---

## 単体テスト（Unit Test）

### UT-063-001: TTSProvider.speak() 呼び出しテスト 🔵

**テストID**: TC-063-001
**優先度**: P0（必須）
**テスト種別**: UT（単体テスト）
**対応要件**: FR-063-001, AC-063-001

**テスト目的**: 履歴タップ時にTTSプロバイダーのspeak()メソッドが正しく呼ばれることを検証する

**テスト手順**:
1. HistoryScreenを表示する（モックプロバイダーを使用）
2. TTSProviderをモック化する
3. 履歴項目（content: "こんにちは"）をタップする
4. TTSProviderのspeak("こんにちは")が1回呼ばれることを検証する

**期待結果**:
- TTSProvider.speak("こんにちは")が1回呼び出される
- 引数として履歴のcontentが正しく渡される

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`
**実装クラス**: `HistoryScreen` (`lib/features/history/presentation/history_screen.dart`)

---

### UT-063-002: 空文字列の読み上げ防止テスト 🔵

**テストID**: TC-063-018
**優先度**: P1（重要）
**テスト種別**: UT（単体テスト）
**対応要件**: FR-063-008

**テスト目的**: 履歴の内容が空文字列の場合、読み上げが実行されないことを検証する

**テスト手順**:
1. 空文字列の履歴（content: ""）を作成する
2. TTSProviderをモック化する
3. 空履歴をタップする
4. TTSProvider.speak()が呼ばれないことを検証する

**期待結果**:
- TTSProvider.speak()が呼び出されない
- エラーが発生しない

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`
**実装クラス**: `HistoryScreen` (`lib/features/history/presentation/history_screen.dart`)

**備考**: TTSService内部で空文字列チェック済みだが、UI層でも防御的実装を確認

---

### UT-063-003: HistoryRepository.delete() 正常系テスト 🔵

**テストID**: TC-063-010
**優先度**: P0（必須）
**テスト種別**: UT（単体テスト）
**対応要件**: FR-063-005

**テスト目的**: 履歴削除が正しく動作することを検証する（既存テストの拡張）

**テスト手順**:
1. HistoryRepositoryに5件の履歴を保存する
2. 特定の履歴ID（例: "test_2"）を削除する
3. getById("test_2")がnullを返すことを検証する
4. loadAll()が4件の履歴を返すことを検証する

**期待結果**:
- 削除対象の履歴がgetById()でnullを返す
- loadAll()が4件の履歴を返す
- 削除されていない他の履歴は影響を受けない

**実装ファイル**: `test/features/history/data/history_repository_test.dart`（既存）
**実装クラス**: `HistoryRepository` (`lib/features/history/data/history_repository.dart`)

**備考**: TASK-0062で既に実装済みのため、追加テストケースとして確認

---

### UT-063-004: HistoryRepository.deleteAll() 正常系テスト 🔵

**テストID**: TC-063-013
**優先度**: P0（必須）
**テスト種別**: UT（単体テスト）
**対応要件**: FR-063-006

**テスト目的**: 全削除が正しく動作することを検証する（既存テストの拡張）

**テスト手順**:
1. HistoryRepositoryに5件の履歴を保存する
2. deleteAll()を実行する
3. loadAll()が空リストを返すことを検証する

**期待結果**:
- loadAll()が空リスト（[]）を返す
- すべての履歴が削除される

**実装ファイル**: `test/features/history/data/history_repository_test.dart`（既存）
**実装クラス**: `HistoryRepository` (`lib/features/history/data/history_repository.dart`)

**備考**: TASK-0062で既に実装済みのため、追加テストケースとして確認

---

### UT-063-005: 存在しない履歴IDの削除テスト 🟡

**テストID**: TC-063-011
**優先度**: P1（重要）
**テスト種別**: UT（単体テスト）
**対応要件**: FR-063-010（EDGE-063-001）

**テスト目的**: 存在しないIDの削除がエラーにならないことを検証する

**テスト手順**:
1. HistoryRepositoryに5件の履歴を保存する
2. 存在しないID（例: "non_existing_id"）を削除する
3. 例外が発生しないことを検証する
4. loadAll()が5件の履歴を返すことを検証する（件数が変わらない）

**期待結果**:
- 例外が発生せず、正常終了する
- loadAll()が5件の履歴を返す（削除されていない）

**実装ファイル**: `test/features/history/data/history_repository_test.dart`（既存）
**実装クラス**: `HistoryRepository` (`lib/features/history/data/history_repository.dart`)

**備考**: TASK-0062のEDGE-006対応として既に実装済みの可能性あり

---

## ウィジェットテスト（Widget Test）

### WT-063-001: 履歴項目タップでコールバック発火テスト 🔵

**テストID**: TC-063-002
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-001, AC-063-001

**テスト目的**: HistoryItemCardのonTapコールバックが正しく動作することを検証する

**テスト手順**:
1. HistoryItemCardを表示する（onTapコールバックを設定）
2. HistoryItemCardをタップする
3. onTapコールバックが1回呼ばれることを検証する

**期待結果**:
- onTapコールバックが1回呼び出される
- タップ時のリップル効果が表示される（視覚的フィードバック）

**実装ファイル**: `test/features/history/presentation/widgets/history_item_card_test.dart`（既存）
**実装クラス**: `HistoryItemCard` (`lib/features/history/presentation/widgets/history_item_card.dart`)

**備考**: TASK-0061で既に実装済み（TC-061-024）、再読み上げ機能との統合を確認

---

### WT-063-002: 読み上げ中の視覚的インジケーター表示テスト 🔵

**テストID**: TC-063-004
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-002, AC-063-001

**テスト目的**: 読み上げ中に視覚的インジケーター（ハイライト等）が表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する
2. TTSProviderの状態をspeakingに設定する（モック）
3. 現在読み上げ中の履歴項目がハイライト表示されることを検証する
4. ハイライト表示の有無を確認する（背景色変更、アイコン追加等）

**期待結果**:
- 読み上げ中の履歴項目がハイライト表示される
- 他の履歴項目は通常表示のまま

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`, `HistoryItemCard`

**備考**: UI実装の詳細（ハイライト方法）に応じてテストを調整

---

### WT-063-003: 読み上げ中の停止ボタン表示テスト 🟡

**テストID**: TC-063-005
**優先度**: P1（重要）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-002

**テスト目的**: 読み上げ中に停止ボタンが表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する
2. TTSProviderの状態をspeakingに設定する（モック）
3. 停止ボタンが表示されることを検証する

**期待結果**:
- 読み上げ中（TTSState.speaking）は停止ボタンが表示される
- アイドル状態（TTSState.idle）は停止ボタンが非表示または無効

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

**備考**: 停止ボタンの配置場所（グローバル or 履歴項目内）により実装が異なる

---

### WT-063-004: 履歴長押しでメニュー表示テスト 🟡

**テストID**: TC-063-008
**優先度**: P1（重要）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-004, AC-063-003

**テスト目的**: 履歴項目を長押しするとコンテキストメニューが表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴1件）
2. HistoryItemCardを長押しする（longPress）
3. コンテキストメニュー（BottomSheetまたはMenu）が表示されることを確認する
4. メニューに「削除」オプションが含まれることを検証する

**期待結果**:
- 長押し後にメニューが表示される
- メニューに「削除」ボタンが表示される
- （オプション）メニューに「お気に入りに追加」ボタンが表示される（Phase 4以降）

**実装ファイル**: `test/features/history/presentation/widgets/history_item_card_test.dart`（新規追加）
**実装クラス**: `HistoryItemCard`

**備考**: メニュー表示方法（BottomSheet vs PopupMenu）により実装が異なる

---

### WT-063-005: 長押し時の触覚フィードバックテスト 🟡

**テストID**: TC-063-009
**優先度**: P2（推奨）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-004

**テスト目的**: 長押し時に触覚フィードバック（HapticFeedback）が発生することを検証する

**テスト手順**:
1. HapticFeedbackをモック化する
2. HistoryItemCardを長押しする
3. HapticFeedback.mediumImpact()が呼ばれることを検証する

**期待結果**:
- HapticFeedback.mediumImpact()が1回呼び出される

**実装ファイル**: `test/features/history/presentation/widgets/history_item_card_test.dart`（新規追加）
**実装クラス**: `HistoryItemCard`

**備考**: 触覚フィードバックはプラットフォーム依存のため、モックでの検証が推奨

---

### WT-063-006: 個別削除確認ダイアログの表示テスト 🔵

**テストID**: TC-063-010
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-005, AC-063-004

**テスト目的**: 個別削除時に確認ダイアログが正しく表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する
2. 履歴項目の削除ボタンをタップする（または長押しメニューから削除選択）
3. AlertDialogが表示されることを確認する
4. ダイアログタイトル「履歴を削除しますか?」が表示されることを確認する
5. 「削除」ボタンと「キャンセル」ボタンが表示されることを確認する

**期待結果**:
- AlertDialogが表示される
- タイトル「履歴を削除しますか?」が表示される
- 削除対象の履歴内容の一部が表示される（最大50文字）
- 「削除」ボタンと「キャンセル」ボタンが表示される

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（既存拡張）
**実装クラス**: `HistoryScreen`

**備考**: TASK-0061のTC-061-008と類似、内容の詳細を確認

---

### WT-063-007: 個別削除ダイアログの「キャンセル」ボタンテスト 🔵

**テストID**: TC-063-012
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-005, AC-063-004

**テスト目的**: 削除確認ダイアログで「キャンセル」を選択すると削除されないことを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. 削除ボタンをタップしてダイアログを表示する
3. 「キャンセル」ボタンをタップする
4. ダイアログが閉じることを確認する
5. 履歴が削除されていないことを確認する（5件のまま）

**期待結果**:
- 「キャンセル」選択後、ダイアログが閉じる
- 履歴が削除されない（5件のまま）
- HistoryRepository.delete()が呼ばれない

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

---

### WT-063-008: 全削除確認ダイアログの表示テスト 🔵

**テストID**: TC-063-013
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-006, AC-063-005

**テスト目的**: 全削除時に確認ダイアログが正しく表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. AppBarの「全削除」ボタンをタップする
3. AlertDialogが表示されることを確認する
4. ダイアログタイトル「すべての履歴を削除しますか?」が表示されることを確認する
5. 削除件数「5件の履歴が削除されます」が表示されることを確認する
6. 「すべて削除」ボタンと「キャンセル」ボタンが表示されることを確認する

**期待結果**:
- AlertDialogが表示される
- タイトル「すべての履歴を削除しますか?」が表示される
- 削除件数「5件の履歴が削除されます」が表示される
- 「すべて削除」ボタンと「キャンセル」ボタンが表示される

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（既存拡張）
**実装クラス**: `HistoryScreen`

**備考**: TASK-0061のTC-061-012と類似、削除件数表示を追加確認

---

### WT-063-009: 全削除ダイアログの「キャンセル」ボタンテスト 🔵

**テストID**: TC-063-015
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-006, AC-063-005

**テスト目的**: 全削除確認ダイアログで「キャンセル」を選択すると削除されないことを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. 「全削除」ボタンをタップしてダイアログを表示する
3. 「キャンセル」ボタンをタップする
4. ダイアログが閉じることを確認する
5. 履歴が削除されていないことを確認する（5件のまま）

**期待結果**:
- 「キャンセル」選択後、ダイアログが閉じる
- 履歴が削除されない（5件のまま）
- HistoryRepository.deleteAll()が呼ばれない

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

---

### WT-063-010: 削除後のリスト自動更新テスト 🔵

**テストID**: TC-063-016
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-007, AC-063-006

**テスト目的**: 個別削除後にリストが自動的に更新されることを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. 1件目の履歴を削除する（削除ダイアログで「削除」選択）
3. リストが自動的に更新されることを確認する
4. 表示される履歴が4件になることを確認する
5. 削除した履歴が表示されていないことを確認する

**期待結果**:
- 削除後、リストが自動的に更新される
- 表示される履歴が4件になる
- 削除した履歴が表示されない
- リストの順序は変わらない（最新順を維持）

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

**備考**: Riverpod Providerの状態更新による自動再構築を検証

---

### WT-063-011: 全削除後の空リスト表示テスト 🔵

**テストID**: TC-063-017
**優先度**: P0（必須）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-007, AC-063-006

**テスト目的**: 全削除後に空リストメッセージが表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. 全削除を実行する（全削除ダイアログで「すべて削除」選択）
3. リストが自動的に更新されることを確認する
4. 「履歴がありません」メッセージが表示されることを確認する
5. 全削除ボタンが非表示になることを確認する

**期待結果**:
- 削除後、リストが空になる
- 「履歴がありません」メッセージが画面中央に表示される
- 全削除ボタンが非表示になる

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

**備考**: EDGE-063-001対応を含む

---

### WT-063-012: 読み上げエラー時のエラーメッセージ表示テスト 🔵

**テストID**: TC-063-019
**優先度**: P1（重要）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-009, AC-063-007

**テスト目的**: 読み上げエラー時にエラーメッセージが表示されることを検証する

**テスト手順**:
1. HistoryScreenを表示する
2. TTSProviderをモック化し、speak()実行時にエラー状態にする
3. 履歴項目をタップする
4. エラーメッセージが表示されることを確認する（例: 「読み上げに失敗しました」）
5. アプリが継続動作することを確認する（クラッシュしない）

**期待結果**:
- エラーメッセージが表示される（スナックバーまたはダイアログ）
- アプリが継続動作する（クラッシュしない）
- 他の履歴項目のタップ、削除操作は可能

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

**備考**: NFR-301（エラー耐性）、NFR-204（エラーメッセージ表示）を検証

---

### WT-063-013: 読み上げエラー後の操作継続テスト 🟡

**テストID**: TC-063-020
**優先度**: P1（重要）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: FR-063-009, NFR-063-003

**テスト目的**: 読み上げエラー後も他の操作が可能であることを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴2件）
2. TTSProviderをモック化し、1回目のspeak()でエラー、2回目は成功とする
3. 1件目の履歴をタップする（エラー発生）
4. エラーメッセージが表示されることを確認する
5. 2件目の履歴をタップする（成功）
6. 2件目の読み上げが正常に実行されることを確認する

**期待結果**:
- 1件目のエラー後も2件目の読み上げが正常に実行される
- 削除操作も正常に動作する

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

---

## 統合テスト（Integration Test）

### IT-063-001: 履歴タップから読み上げまでのE2Eフロー 🔵

**テストID**: TC-063-003
**優先度**: P0（必須）
**テスト種別**: IT（統合テスト）
**対応要件**: FR-063-001, AC-063-001, NFR-063-001

**テスト目的**: 履歴タップから読み上げ開始までのE2Eフローが正しく動作することを検証する

**テスト手順**:
1. HistoryScreenを表示する（実際のHistoryRepositoryとTTSProviderを使用）
2. HistoryRepositoryに履歴を保存する（content: "こんにちは"）
3. 履歴リストを表示する
4. 履歴項目をタップする
5. 読み上げが開始されることを確認する（TTSState.speakingに変化）
6. タップから読み上げ開始までの時間を計測する

**期待結果**:
- タップから1秒以内に読み上げが開始される（NFR-063-001）
- TTSState.speakingに状態が変化する
- 読み上げ完了後、TTSState.idleに戻る

**実装ファイル**: `integration_test/features/history/history_replay_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `HistoryRepository`, `TTSProvider`

**備考**: パフォーマンス要件（1秒以内）を実機で検証

---

### IT-063-002: 読み上げ中に別の履歴をタップするE2Eフロー 🟡

**テストID**: TC-063-006
**優先度**: P1（重要）
**テスト種別**: IT（統合テスト）
**対応要件**: FR-063-003, AC-063-002

**テスト目的**: 読み上げ中に別の履歴をタップすると切り替わることを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴2件: "履歴A", "履歴B"）
2. 履歴Aをタップする（読み上げ開始）
3. 読み上げ中（TTSState.speaking）であることを確認する
4. 読み上げ中に履歴Bをタップする
5. 履歴Aの読み上げが停止されることを確認する
6. 履歴Bの読み上げが開始されることを確認する
7. 履歴Bがハイライト表示されることを確認する

**期待結果**:
- 履歴Aの読み上げが即座に停止される
- 履歴Bの読み上げが開始される
- 履歴Bがハイライト表示される
- 履歴Aのハイライトが解除される

**実装ファイル**: `integration_test/features/history/history_replay_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `TTSProvider`

**備考**: TTSService内部の停止ロジック（EDGE-2対応）を統合テストで検証

---

### IT-063-003: 履歴削除フロー（個別）のE2Eテスト 🔵

**テストID**: TC-063-014
**優先度**: P0（必須）
**テスト種別**: IT（統合テスト）
**対応要件**: FR-063-005, FR-063-007, AC-063-004, AC-063-006

**テスト目的**: 個別削除フロー全体が正しく動作することを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. 1件目の履歴の削除ボタンをタップする（または長押しメニューから削除選択）
3. 確認ダイアログが表示されることを確認する
4. 「削除」ボタンをタップする
5. HistoryRepository.delete()が呼ばれることを確認する
6. リストが自動的に更新されることを確認する
7. 表示される履歴が4件になることを確認する
8. 削除した履歴が表示されていないことを確認する

**期待結果**:
- 削除フロー全体が正常に動作する
- 削除後、リストから履歴が消える
- 削除後のリスト件数が4件になる
- リストの順序は変わらない（最新順を維持）

**実装ファイル**: `integration_test/features/history/history_delete_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `HistoryRepository`

---

### IT-063-004: 履歴全削除フローのE2Eテスト 🔵

**テストID**: TC-063-015
**優先度**: P0（必須）
**テスト種別**: IT（統合テスト）
**対応要件**: FR-063-006, FR-063-007, AC-063-005, AC-063-006

**テスト目的**: 全削除フロー全体が正しく動作することを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴5件）
2. AppBarの「全削除」ボタンをタップする
3. 確認ダイアログが表示されることを確認する
4. 「すべて削除」ボタンをタップする
5. HistoryRepository.deleteAll()が呼ばれることを確認する
6. リストが自動的に更新されることを確認する
7. 「履歴がありません」メッセージが表示されることを確認する
8. 全削除ボタンが非表示になることを確認する

**期待結果**:
- 全削除フロー全体が正常に動作する
- 全削除後、「履歴がありません」メッセージが表示される
- 全削除ボタンが非表示になる

**実装ファイル**: `integration_test/features/history/history_delete_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `HistoryRepository`

---

### IT-063-005: 読み上げ中の削除操作E2Eテスト 🟡

**テストID**: TC-063-007
**優先度**: P1（重要）
**テスト種別**: IT（統合テスト）
**対応要件**: EDGE-063-002

**テスト目的**: 読み上げ中の履歴を削除すると読み上げが停止することを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴1件）
2. 履歴をタップして読み上げを開始する
3. 読み上げ中（TTSState.speaking）であることを確認する
4. 読み上げ中に削除ボタンをタップする
5. 削除確認ダイアログが表示されることを確認する
6. 「削除」ボタンをタップする
7. 読み上げが停止されることを確認する（TTSProvider.stop()呼び出し）
8. 履歴が削除されることを確認する

**期待結果**:
- 削除実行前に読み上げが停止される
- 削除後、「履歴がありません」メッセージが表示される

**実装ファイル**: `integration_test/features/history/history_delete_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `TTSProvider`

**備考**: 読み上げ中の削除は安全に処理される必要がある

---

## エッジケース・境界値テスト

### EDGE-063-001: 履歴0件で全削除ボタンタップテスト 🟡

**テストID**: TC-063-021
**優先度**: P2（推奨）
**テスト種別**: WT（ウィジェットテスト）
**対応要件**: EDGE-063-001

**テスト目的**: 履歴が0件の状態で全削除ボタンの挙動を検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴0件）
2. 全削除ボタンが非表示または無効化されていることを確認する

**期待結果**:
- 履歴0件の場合、全削除ボタンが非表示または無効化される

**実装ファイル**: `test/features/history/presentation/history_screen_test.dart`（新規追加）
**実装クラス**: `HistoryScreen`

**備考**: TASK-0061のTC-061-005と関連

---

### EDGE-063-002: オフライン状態での読み上げテスト 🔵

**テストID**: TC-063-022
**優先度**: P1（重要）
**テスト種別**: IT（統合テスト）
**対応要件**: EDGE-063-004

**テスト目的**: オフライン状態でも履歴の読み上げが正常に動作することを検証する

**テスト手順**:
1. HistoryScreenを表示する（履歴1件）
2. ネットワークをオフラインに設定する（機内モード）
3. 履歴項目をタップする
4. 読み上げが正常に開始されることを確認する

**期待結果**:
- オフライン状態でも読み上げが正常に動作する
- エラーが発生しない

**実装ファイル**: `integration_test/features/history/history_offline_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `TTSProvider`

**備考**: OS標準TTSはオフラインで動作するため、問題なく読み上げられる

---

## テスト実装チェックリスト

### 単体テスト（Unit Test）

- [ ] TC-063-001: TTSProvider.speak() 呼び出しテスト
- [ ] TC-063-018: 空文字列の読み上げ防止テスト
- [ ] TC-063-010: HistoryRepository.delete() 正常系テスト（既存拡張）
- [ ] TC-063-013: HistoryRepository.deleteAll() 正常系テスト（既存拡張）
- [ ] TC-063-011: 存在しない履歴IDの削除テスト

### ウィジェットテスト（Widget Test）

- [ ] TC-063-002: 履歴項目タップでコールバック発火テスト（既存確認）
- [ ] TC-063-004: 読み上げ中の視覚的インジケーター表示テスト
- [ ] TC-063-005: 読み上げ中の停止ボタン表示テスト
- [ ] TC-063-008: 履歴長押しでメニュー表示テスト
- [ ] TC-063-009: 長押し時の触覚フィードバックテスト
- [ ] TC-063-010: 個別削除確認ダイアログの表示テスト（既存拡張）
- [ ] TC-063-012: 個別削除ダイアログの「キャンセル」ボタンテスト
- [ ] TC-063-013: 全削除確認ダイアログの表示テスト（既存拡張）
- [ ] TC-063-015: 全削除ダイアログの「キャンセル」ボタンテスト
- [ ] TC-063-016: 削除後のリスト自動更新テスト
- [ ] TC-063-017: 全削除後の空リスト表示テスト
- [ ] TC-063-019: 読み上げエラー時のエラーメッセージ表示テスト
- [ ] TC-063-020: 読み上げエラー後の操作継続テスト

### 統合テスト（Integration Test）

- [ ] TC-063-003: 履歴タップから読み上げまでのE2Eフロー
- [ ] TC-063-006: 読み上げ中に別の履歴をタップするE2Eフロー
- [ ] TC-063-014: 履歴削除フロー（個別）のE2Eテスト
- [ ] TC-063-015: 履歴全削除フローのE2Eテスト
- [ ] TC-063-007: 読み上げ中の削除操作E2Eテスト

### エッジケース・境界値テスト

- [ ] TC-063-021: 履歴0件で全削除ボタンタップテスト
- [ ] TC-063-022: オフライン状態での読み上げテスト

---

## パフォーマンステスト

### NFR-063-001: 読み上げ開始時間テスト 🔵

**テスト目的**: 履歴タップから読み上げ開始までの時間が1秒以内であることを検証する

**テスト手順**:
1. HistoryScreenを表示する（実機使用）
2. 履歴項目をタップする
3. タップ時刻を記録する
4. 読み上げ開始時刻を記録する（TTSState.speakingへの変化）
5. 時間差を計測する

**期待結果**:
- タップから読み上げ開始までの時間が1000ms以内（目標: 500ms以内）

**実装ファイル**: `integration_test/features/history/history_performance_test.dart`（新規作成）
**実装クラス**: `HistoryScreen`, `TTSProvider`

**備考**: NFR-001（TTS読み上げ開始1秒以内）を検証

---

## テストカバレッジ目標

### 全体カバレッジ目標

- **全体カバレッジ**: 80%以上
- **ビジネスロジック**: 90%以上（HistoryProvider, TTSProvider）
- **UI層**: 75%以上（HistoryScreen, HistoryItemCard）

### 優先度別テストケース数

| 優先度 | テストケース数 | 内訳 |
|--------|--------------|------|
| P0（必須） | 18 | UT: 4, WT: 9, IT: 5 |
| P1（重要） | 7 | UT: 1, WT: 4, IT: 2 |
| P2（推奨） | 2 | WT: 1, EDGE: 1 |
| **合計** | **27** | - |

---

## テスト実行順序

### TDD Redフェーズ（テストファースト）

1. **単体テスト作成**: UT-063-001〜UT-063-005
2. **ウィジェットテスト作成**: WT-063-001〜WT-063-013
3. **統合テスト作成**: IT-063-001〜IT-063-005

### TDD Greenフェーズ（実装）

1. **HistoryScreen実装**: 再読み上げ機能、長押しメニュー、削除機能
2. **HistoryItemCard拡張**: 長押し対応、メニュー表示
3. **HistoryProvider拡張**: 削除メソッド連携

### TDD Refactorフェーズ（リファクタリング）

1. **コード整理**: 定数抽出、重複コード削除
2. **エッジケーステスト追加**: EDGE-063-001, EDGE-063-002
3. **パフォーマンステスト**: NFR-063-001

---

## 関連ドキュメント

- [TASK-0063タスク定義](../../../tasks/kotonoha-phase4.md#day-3-task-0063---履歴再読み上げ削除機能)
- [TASK-0063要件定義書](./kotonoha-requirements.md)
- [TASK-0061要件定義書](../TASK-0061/kotonoha-requirements.md)（既存履歴UI）
- [TASK-0062要件定義書](../TASK-0062/kotonoha-requirements.md)（既存Repository）
- [TASK-0048要件定義書](../TASK-0048/kotonoha-requirements.md)（既存TTS）
- [要件定義書 - REQ-603, REQ-604](../../spec/kotonoha-requirements.md)

---

## 更新履歴

- **2025-11-28**: TASK-0063テストケース定義書作成（TDD Redフェーズ準備）
