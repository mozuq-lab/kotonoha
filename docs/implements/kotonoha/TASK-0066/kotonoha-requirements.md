# TASK-0066: お気に入り追加・削除・並び替え機能 - TDD要件定義

## タスク概要

- **タスクID**: TASK-0066
- **タスク名**: お気に入り追加・削除・並び替え機能
- **推定工数**: 8時間
- **タスクタイプ**: TDD
- **関連要件**: REQ-701, REQ-703, REQ-704, REQ-2002

## 依存タスク

- TASK-0064: お気に入り一覧UI実装 ✅ 完了
- TASK-0065: お気に入りHiveモデル・リポジトリ実装 ✅ 完了

## 機能要件（EARS記法）

### 🔵 青信号: 要件定義書ベース

#### FR-066-001: お気に入り追加（履歴から）
- **EARS**: WHEN ユーザーが履歴画面で履歴項目を長押しした場合、THEN システムはコンテキストメニューに「お気に入りに追加」オプションを表示しなければならない
- **対応要件**: REQ-701

#### FR-066-002: お気に入り追加実行
- **EARS**: WHEN ユーザーが「お気に入りに追加」をタップした場合、THEN システムはその項目をお気に入りに追加し、成功メッセージを表示しなければならない
- **対応要件**: REQ-701

#### FR-066-003: 重複追加防止
- **EARS**: WHERE 同一内容がお気に入りに既に存在する場合、WHEN ユーザーが「お気に入りに追加」をタップした場合、THEN システムは追加せず「既にお気に入りに登録されています」メッセージを表示しなければならない
- **対応要件**: REQ-701

#### FR-066-004: 削除確認ダイアログ（個別削除）
- **EARS**: WHEN ユーザーがお気に入りの削除ボタンをタップした場合、THEN システムは確認ダイアログを表示しなければならない
- **対応要件**: REQ-704, REQ-2002
- **既存実装**: FavoritesScreen._showDeleteDialog() ✅

#### FR-066-005: 削除確認ダイアログ（全削除）
- **EARS**: WHEN ユーザーがお気に入りの全削除ボタンをタップした場合、THEN システムは確認ダイアログを表示しなければならない
- **対応要件**: REQ-704, REQ-2002
- **既存実装**: FavoritesScreen._showDeleteAllDialog() ✅

#### FR-066-006: 並び順変更（ドラッグ&ドロップ）
- **EARS**: WHEN ユーザーがお気に入り項目をドラッグして別の位置にドロップした場合、THEN システムは項目を新しい位置に移動し、displayOrderを更新しなければならない
- **対応要件**: REQ-703

#### FR-066-007: 並び順変更の自動保存
- **EARS**: WHEN お気に入りの並び順が変更された場合、THEN システムは即座にHiveストレージに変更を永続化しなければならない
- **対応要件**: REQ-703

#### FR-066-008: 編集モードトグル
- **EARS**: WHEN ユーザーが編集ボタンをタップした場合、THEN システムは編集モードに切り替え、ドラッグハンドルを表示しなければならない
- **対応要件**: REQ-703

### 🟡 黄信号: 要件定義書から妥当な推測

#### FR-066-009: お気に入り追加の上限
- **EARS**: WHERE お気に入りが最大件数（100件）に達している場合、WHEN ユーザーが「お気に入りに追加」をタップした場合、THEN システムは警告メッセージを表示しなければならない
- **推測根拠**: 履歴が50件上限であることからの類推

## 非機能要件

### NFR-066-001: 並び順変更の応答時間
- 並び順変更操作は100ms以内にUIに反映されなければならない
- 🟡 黄信号: NFR-003（100ms以内のタップ応答）から推測

### NFR-066-002: タップターゲットサイズ
- ドラッグハンドル、追加ボタンは最小44px × 44px
- 🔵 青信号: REQ-5001

### NFR-066-003: アクセシビリティ
- スクリーンリーダー対応（Semantics）
- 🔵 青信号: WCAG 2.1準拠

## 受け入れ基準

### AC-066-001: 履歴からお気に入り追加
- [ ] 履歴画面で履歴項目を長押しするとコンテキストメニューが表示される
- [ ] 「お気に入りに追加」をタップすると項目がお気に入りに追加される
- [ ] 追加成功時にスナックバーで成功メッセージが表示される

### AC-066-002: 重複追加防止
- [ ] 同一内容が既に存在する場合、追加されない
- [ ] 「既にお気に入りに登録されています」メッセージが表示される

### AC-066-003: 削除確認ダイアログ
- [ ] 個別削除ボタンタップで確認ダイアログが表示される ✅ 既存実装
- [ ] 全削除ボタンタップで確認ダイアログが表示される ✅ 既存実装
- [ ] ダイアログ外タップで閉じない（誤操作防止） ✅ 既存実装

### AC-066-004: 並び順変更UI
- [ ] 編集モードに入るとドラッグハンドルが表示される
- [ ] 項目をドラッグ&ドロップで並び替えできる
- [ ] 並び替え後、表示順序が即座に反映される

### AC-066-005: 並び順の永続化
- [ ] 並び順変更後、Hiveに自動保存される
- [ ] アプリ再起動後も並び順が維持される

## テスト要件

### Unit Tests
- FavoriteNotifier.reorderFavorite()のテスト
- FavoriteRepository.reorderFavorites()のテスト

### Widget Tests
- 履歴画面での長押しメニュー表示テスト
- お気に入り追加成功/失敗テスト
- ドラッグ&ドロップ並び替えUIテスト
- 編集モードトグルテスト

### Integration Tests
- 履歴→お気に入り追加→お気に入り画面で表示確認
- 並び替え→アプリ再起動→順序維持確認

## 実装計画

### 1. 履歴画面への「お気に入り追加」機能追加
- HistoryItemCardに長押しメニュー追加
- HistoryScreenからFavoriteNotifierを呼び出し

### 2. FavoriteNotifierのHive連携強化
- addFavoriteをHive永続化対応
- reorderFavoriteをHive永続化対応

### 3. FavoritesScreenに編集モード追加
- 編集モードトグルボタン
- ReorderableListView導入
- ドラッグハンドル表示

### 4. お気に入り追加の重複チェック・上限チェック

## 既存コードの確認

### 活用できる既存実装
- `FavoriteRepository.saveFromHistory()` - 履歴からお気に入り作成
- `FavoriteRepository.isDuplicate()` - 重複チェック
- `FavoriteNotifier.reorderFavorite()` - 並び替えロジック（メモリのみ）
- `FavoritesScreen._showDeleteDialog()` - 削除確認ダイアログ

### 拡張が必要な箇所
- `HistoryScreen` - 長押しメニュー追加
- `HistoryItemCard` - onLongPress対応
- `FavoriteNotifier` - Hive連携
- `FavoritesScreen` - ReorderableListView導入

## 更新履歴

- 2025-11-29: 初版作成（TDD Requirementsフェーズ）
