# TTS読み上げ速度の追加オプション機能 要件定義書

## 機能概要

**機能名**: TTS読み上げ速度の追加オプション（より遅い速度の追加）

**タスクID**: TDD-TTS-SLOWER-SPEED

**作成日**: 2025-12-04

---

## 1. 機能の概要（EARS要件定義書・設計文書ベース）

### 1.1 何をする機能か

🔵 **現状の問題**:
- 現在のTTS読み上げ速度は「遅い（0.7倍速）」「普通（1.0倍速）」「速い（1.3倍速）」の3段階
- 「遅い」設定（0.7倍速）でも速いと感じるユーザーが存在
- 特に高齢者や聴覚に配慮が必要なユーザーにとって、より遅い速度が必要

🔵 **解決策**:
- TTS読み上げ速度に「とても遅い」オプションを追加
- flutter_ttsの速度範囲（0.0〜1.0）を活用し、0.5倍速程度の速度を追加
- UIも4段階の選択肢に拡張

### 1.2 どのような問題を解決するか

🔵 **ユーザーの課題**:
- 発話困難な方の支援者・家族が読み上げ内容を聞き取る際、現在の「遅い」設定でも速すぎる場合がある
- 高齢者や聴覚に配慮が必要な方にとって、より遅い速度が必要
- ユーザーヒアリングに基づく実際のフィードバック

🔵 **参照したEARS要件**:
- REQ-404: システムは読み上げ速度を「遅い」「普通」「速い」の3段階から選択できなければならない
  - → **拡張**: 「とても遅い」を追加して4段階に
- NFR-001: システムはTTS読み上げ開始までの時間を1秒以内としなければならない
  - → 速度変更後も引き続き準拠

### 1.3 想定されるユーザー

🔵 **主要ユーザー**:
- 脳梗塞・ALS・筋疾患などで発話が困難な方
- 上記ユーザーの家族・介護者・支援者（読み上げ内容を聞く側）
- 高齢者や聴覚に配慮が必要な方

🟡 **使用シーン**:
- 介護施設でのスタッフとのやり取り
- 病院・診察時の医師・看護師とのコミュニケーション
- 自宅での家族との会話

### 1.4 システム内での位置づけ

🔵 **参照した設計文書**: architecture.md

**コンポーネント構成**:
```
[設定画面] → [TTSSpeedSettingsWidget]
                    ↓
            [SettingsNotifier] → [SharedPreferences] (永続化)
                    ↓
            [TTSNotifier] → [TTSService] → [FlutterTts]
```

**影響範囲**:
1. `TTSSpeed` enum（速度定義）
2. `TTSSpeedExtension`（速度値マッピング）
3. `TTSSpeedSettingsWidget`（UI）
4. `AppSettings`（設定モデル - fromJson/toJsonの互換性確保）
5. 関連するテストファイル

---

## 2. 入力・出力の仕様（EARS機能要件・型定義ベース）

### 2.1 入力パラメータ

🔵 **TTSSpeed enum（拡張後）**:
```dart
enum TTSSpeed {
  verySlow,  // 🆕 とても遅い（0.5倍速）- 新規追加
  slow,      // 遅い（0.7倍速）
  normal,    // 普通（1.0倍速）
  fast,      // 速い（1.3倍速）
}
```

🔵 **速度値の定義**:
| 速度 | enum値 | double値 | 用途 |
|------|--------|----------|------|
| とても遅い | `verySlow` | 0.5 | 聞き取りが難しいユーザー向け |
| 遅い | `slow` | 0.7 | 聞き取りやすさを重視 |
| 普通 | `normal` | 1.0 | 標準的な読み上げ速度 |
| 速い | `fast` | 1.3 | 効率的なコミュニケーション |

### 2.2 出力値

🔵 **UI表示**:
- 4つの選択肢ボタン: 「とても遅い」「遅い」「普通」「速い」
- 現在選択中の速度をハイライト表示

🔵 **永続化データ**:
- SharedPreferencesに保存されるJSON形式:
  ```json
  {
    "tts_speed": "verySlow" | "slow" | "normal" | "fast"
  }
  ```

### 2.3 データフロー

🔵 **参照した設計文書**: dataflow.md

```
[ユーザーがボタンをタップ]
    ↓
[TTSSpeedSettingsWidget._onSpeedChanged()]
    ↓
[SettingsNotifier.setTTSSpeed(TTSSpeed)]
    ↓
[SharedPreferencesに保存] + [TTSNotifier.setSpeed()呼び出し]
    ↓
[TTSService.setSpeed(TTSSpeed)]
    ↓
[FlutterTts.setSpeechRate(double)]
    ↓
[次回読み上げから新速度適用]
```

---

## 3. 制約条件（EARS非機能要件・アーキテクチャ設計ベース）

### 3.1 パフォーマンス要件

🔵 **参照したEARS要件**: NFR-001, NFR-003

- TTS読み上げ開始までの時間: **1秒以内**（変更なし）
- 速度変更のUIタップ応答: **100ms以内**（変更なし）
- 速度変更処理自体: **即座**（FlutterTtsのsetSpeechRateは同期的に完了）

### 3.2 互換性要件

🔵 **後方互換性**:
- 既存の設定値（"slow", "normal", "fast"）は引き続き正常に読み込み可能
- "verySlow"が存在しない古い設定ファイルからの移行時はデフォルト値を使用

🟡 **flutter_tts仕様準拠**:
- 速度値は0.0〜1.0の範囲（iOS）、0.0〜2.0の範囲（Android）
- 0.5は両プラットフォームで有効な値
- 参考: [flutter_tts | Flutter package](https://pub.dev/packages/flutter_tts)

### 3.3 アクセシビリティ要件

🔵 **参照したEARS要件**: REQ-5001

- タップターゲットサイズ: **最小44px × 44px**
- 4つのボタンが画面幅に収まる設計
  - 横幅が不足する場合は2行に折り返し、または文字サイズ調整

### 3.4 UI設計制約

🟡 **既存UIとの整合性**:
- 現在の3ボタン（Row配置）から4ボタンに拡張
- ボタン幅を調整して1行に収める、または折り返しレイアウトを検討
- タブレット端末（9.7インチ以上）を主要対象としているため、4ボタンは1行で収まる想定

---

## 4. 想定される使用例（EARSEdgeケース・データフローベース）

### 4.1 基本的な使用パターン

🔵 **正常系フロー**:
1. ユーザーが設定画面を開く
2. 「読み上げ速度」セクションで4つのボタン（とても遅い/遅い/普通/速い）が表示される
3. ユーザーが「とても遅い」をタップ
4. ボタンがハイライト表示に切り替わる
5. 設定がSharedPreferencesに保存される
6. 次回の読み上げから0.5倍速で再生される

### 4.2 エッジケース

🟡 **EDGE-TTS-001: 既存設定からの移行**
- 条件: 古いバージョンのアプリ設定（"verySlow"が存在しない）を読み込む
- 期待動作: 既存の設定値（"slow", "normal", "fast"）は正常に読み込まれる
- フォールバック: 不正な値の場合はデフォルト（normal）を使用

🟡 **EDGE-TTS-002: 画面幅が狭い場合**
- 条件: スマートフォンなど画面幅が狭いデバイス
- 期待動作: 4つのボタンが適切に配置される（折り返しまたはサイズ調整）
- 制約: タップターゲットサイズ44px以上は維持

🔵 **EDGE-TTS-003: 速度変更後の即時読み上げ**
- 条件: ユーザーが速度を変更した直後に読み上げを実行
- 期待動作: 新しい速度で即座に読み上げが開始される
- 参照: 現在の実装でSettingsNotifier.setTTSSpeed()がTTSNotifier.setSpeed()を呼び出す

### 4.3 エラーケース

🟡 **ERROR-TTS-001: 無効な速度値の永続化データ**
- 条件: SharedPreferencesに無効な値（例: "invalid"）が保存されている
- 期待動作: AppSettings.fromJson()でデフォルト値（TTSSpeed.normal）にフォールバック
- 参照: 現在の実装でorElse句が定義済み

---

## 5. EARS要件・設計文書との対応関係

### 5.1 参照したユーザストーリー

🔵 **US-TTS**: TTSの読み上げ設定
- 「発話困難なユーザーとして、読み上げ速度を調整したい、なぜなら聞き手の聴覚に合わせた速度で読み上げたいから」

### 5.2 参照した機能要件

| 要件ID | 内容 | 本機能での対応 |
|--------|------|----------------|
| REQ-404 | 読み上げ速度を「遅い」「普通」「速い」の3段階から選択できなければならない | **拡張**: 4段階に変更 |
| REQ-401 | システムは入力欄のテキストをOS標準TTSで読み上げる機能を提供しなければならない | 変更なし |
| REQ-403 | システムは読み上げ中の停止・中断機能を提供しなければならない | 変更なし |

### 5.3 参照した非機能要件

| 要件ID | 内容 | 本機能での対応 |
|--------|------|----------------|
| NFR-001 | TTS読み上げ開始までの時間を1秒以内 | 維持 |
| NFR-003 | 文字盤タップから入力欄への文字反映までの遅延を100ms以内 | UI操作にも適用 |

### 5.4 参照した設計文書

| 文書 | 該当セクション | 内容 |
|------|----------------|------|
| architecture.md | パフォーマンス、コンポーネント構成 | TTS読み上げ1秒以内、オフラインファースト |
| dataflow.md | 基本コミュニケーションフロー | TTS→OS標準TTSの流れ |
| interfaces.dart | TTSSpeed定義 | 速度enumの定義箇所（※本機能で拡張） |

---

## 6. 実装方針

### 6.1 変更対象ファイル

1. **`lib/features/tts/domain/models/tts_speed.dart`**
   - `TTSSpeed` enumに`verySlow`を追加
   - `TTSSpeedExtension.value`に0.5を追加

2. **`lib/features/settings/presentation/widgets/tts_speed_settings_widget.dart`**
   - 4つ目のボタン「とても遅い」を追加
   - レイアウト調整（必要に応じて）

3. **`lib/features/settings/models/app_settings.dart`**
   - `fromJson`での後方互換性確認（既存実装で対応済みの可能性）

4. **テストファイル**
   - 新しい速度オプションのテストを追加
   - 後方互換性テストを追加

### 6.2 テスト戦略

🔵 **単体テスト**:
- `TTSSpeed.verySlow.value == 0.5`の検証
- `AppSettings.fromJson`での後方互換性テスト
- `TTSService.setSpeed(TTSSpeed.verySlow)`の動作確認

🔵 **Widgetテスト**:
- 4つのボタンが表示されること
- 「とても遅い」ボタンタップで速度が変更されること
- 選択状態のハイライト表示

🟡 **統合テスト**:
- 速度変更→設定保存→再読み込み→正しい速度が適用される

---

## 7. 品質判定

### 判定結果: ✅ 高品質

| 基準 | 状態 | 説明 |
|------|------|------|
| 要件の曖昧さ | なし | 追加する速度値（0.5倍速）とUI変更が明確 |
| 入出力定義 | 完全 | TTSSpeed enum、double値、UI表示が定義済み |
| 制約条件 | 明確 | flutter_tts仕様、アクセシビリティ要件を確認済み |
| 実装可能性 | 確実 | 既存実装の拡張で対応可能、破壊的変更なし |

---

## 8. 次のステップ

次のお勧めステップ: `/tdd-testcases` でテストケースの洗い出しを行います。

---

## 参考資料

- [flutter_tts | Flutter package](https://pub.dev/packages/flutter_tts)
- [Flutter Text-to-Speech: A Comprehensive Guide](https://www.videosdk.live/developer-hub/ai/flutter-text-to-speech)
- kotonoha要件定義書: `docs/spec/kotonoha-requirements.md`
- アーキテクチャ設計: `docs/design/kotonoha/architecture.md`
