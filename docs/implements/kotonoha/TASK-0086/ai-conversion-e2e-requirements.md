# TASK-0086: AI変換E2Eテスト - 要件定義書

## タスク情報

- **タスクID**: TASK-0086
- **タスクタイプ**: TDD (E2Eテスト)
- **推定工数**: 8時間
- **作成日**: 2025-11-30

## 概要

AI変換機能のE2Eテストを実装する。入力テキストからAI変換、結果表示、採用/再生成/元の文選択、読み上げまでの一連のユーザーフローを検証する。発話困難な方がスムーズにAI変換機能を利用できることを保証する。

## 1. 機能の概要

### 🔵 青信号 - 要件定義書ベース

- **何をする機能か**: 短い入力テキストをより丁寧で自然な文章に変換し、ユーザーが採用・再生成・元の文を選択できるフロー
- **どのような問題を解決するか**: 発話困難なユーザーが少ない操作で適切な丁寧さのコミュニケーションを実現
- **想定されるユーザー**: 発話が困難だがタブレット操作が可能な方
- **システム内での位置づけ**: フロントエンド（Flutter）からバックエンド（FastAPI）を経由した外部AI APIへの変換リクエスト

### 参照した要件

- **ユーザストーリー**: US-006（AI変換機能利用）
- **機能要件**: REQ-901, REQ-902, REQ-903, REQ-904
- **非機能要件**: NFR-002

## 2. 入力・出力の仕様

### 🔵 青信号 - API仕様ベース

### 入力パラメータ

| パラメータ | 型 | 制約 | 説明 |
|-----------|---|------|------|
| input_text | string | 2文字以上500文字以下 | 変換元テキスト |
| politeness_level | enum | casual/normal/polite | 丁寧さレベル |

### 出力値

| フィールド | 型 | 説明 |
|-----------|---|------|
| converted_text | string | 変換後のテキスト |
| original_text | string | 元のテキスト |
| politeness_level | string | 使用した丁寧さレベル |
| processing_time_ms | integer | 処理時間（ミリ秒） |

### データフロー

1. ユーザーが入力欄にテキストを入力
2. AI変換ボタンをタップ
3. フロントエンドがバックエンドAPIを呼び出し
4. バックエンドが外部AI APIを呼び出し
5. 変換結果をフロントエンドに返却
6. 結果ダイアログを表示
7. ユーザーが採用/再生成/元の文を選択
8. 選択結果を入力欄に反映

### 参照した設計文書

- **API仕様**: api-endpoints.md の `/api/v1/ai/convert`
- **型定義**: interfaces.dart の AIConversionRequest, AIConversionResponse

## 3. 制約条件

### 🔵 青信号 - 要件定義書ベース

### パフォーマンス要件

| 要件ID | 制約 | 目標値 |
|--------|------|--------|
| NFR-002 | AI変換応答時間 | 平均3秒以内 |
| REQ-2006 | ローディング表示 | 3秒超過時に表示 |

### オフライン対応

| 要件ID | 制約 |
|--------|------|
| REQ-1002 | オフライン時にAI変換が利用不可であることを明示 |
| REQ-1003 | オフライン時のフォールバック（元の文をそのまま使用） |
| REQ-3004 | オフライン時はAI変換ボタンを無効化/グレーアウト |

### API制約

- タイムアウト: 10秒
- レート制限: 1分間に10リクエスト

### 参照した要件

- **パフォーマンス**: NFR-002
- **オフライン**: REQ-1002, REQ-1003, REQ-3004

## 4. 想定される使用例

### 🔵 青信号 - 要件定義書ベース

### 正常系フロー

#### TC-E2E-086-001: 入力 → AI変換 → 結果表示 → 採用

1. ユーザーが「水 ぬるく」と入力
2. AI変換ボタンをタップ
3. 変換結果「お水をぬるめでお願いします」が表示される
4. 「採用」をタップ
5. 入力欄に変換結果が反映される

#### TC-E2E-086-002: AI変換 → 再生成

1. AI変換結果が表示される
2. 「再生成」をタップ
3. 新しい変換結果が表示される

#### TC-E2E-086-003: AI変換 → 元の文を使う

1. AI変換結果が表示される
2. 「元の文を使う」をタップ
3. 入力欄に元のテキストが反映される

#### TC-E2E-086-004: 丁寧さレベル3段階の動作確認

- カジュアル: 「腹減った」→「お腹すいた」
- 普通: 「水 ぬるく」→「お水をぬるめでお願いします」
- 丁寧: 「痛い 腰」→「腰が痛いです」

### 🟡 黄信号 - 要件からの推測

### エッジケース

#### TC-E2E-086-005: 3秒超過時のローディング表示

1. AI変換リクエストが3秒以上かかる
2. ローディングインジケーターが表示される

#### TC-E2E-086-006: オフライン時の動作

1. ネットワーク接続なしの状態
2. AI変換ボタンが無効化される
3. オフラインインジケーターが表示される

#### TC-E2E-086-007: 入力が2文字未満の場合

1. 入力欄に1文字のみ入力
2. AI変換ボタンが無効化される

### 🔵 青信号 - EDGE要件ベース

### エラーケース

#### TC-E2E-086-008: AI変換APIエラー時のフォールバック (EDGE-002)

1. AI変換APIがエラーを返す
2. 元の文をそのまま使用できるオプションが提示される

#### TC-E2E-086-009: ネットワークタイムアウト時 (EDGE-001)

1. AI変換リクエストがタイムアウト
2. エラーメッセージと再試行オプションが表示される

### 参照したEdgeケース

- **EDGE-001**: ネットワークタイムアウト
- **EDGE-002**: AI変換APIエラー

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー

- US-006: AI変換機能利用

### 参照した機能要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| REQ-901 | AI変換機能 | 短い入力を丁寧で自然な文章に変換 |
| REQ-902 | AI変換結果表示 | 結果を表示し、採用・却下を選択可能 |
| REQ-903 | 丁寧さレベル | カジュアル/普通/丁寧の3段階選択 |
| REQ-904 | 再生成・元の文 | 再生成または元の文のまま使用可能 |

### 参照した条件付き要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| REQ-2003 | オフライン時フォールバック | オフライン時は元の文を使用するオプションを提示 |
| REQ-2006 | ローディング表示 | 3秒超過時にローディング表示 |

### 参照した状態要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| REQ-3004 | オフライン時AI変換無効化 | オフライン時はボタンを無効化 |

### 参照した非機能要件

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| NFR-002 | AI変換応答時間 | 平均3秒以内 |

### 参照したEdgeケース

| 要件ID | 要件名 | 概要 |
|--------|--------|------|
| EDGE-001 | ネットワークタイムアウト | 再試行オプション提供 |
| EDGE-002 | AI変換APIエラー | 元の文を使用可能にするフォールバック |

### 参照した設計文書

- **API仕様**: api-endpoints.md の `/api/v1/ai/convert`, `/api/v1/ai/regenerate`
- **型定義**: interfaces.dart の AIConversionRequest, AIConversionResponse
- **実装ウィジェット**: ai_conversion_button.dart, ai_conversion_result_dialog.dart

## 受け入れ基準

### AC-001: AI変換フロー

- [ ] 入力 → AI変換 → 結果表示 → 採用のフローが動作する
- [ ] 再生成で新しい変換結果が取得できる
- [ ] 「元の文を使う」で元のテキストが使用できる

### AC-002: 丁寧さレベル

- [ ] カジュアル/普通/丁寧の3段階が選択できる
- [ ] 選択したレベルに応じた変換結果が得られる

### AC-003: パフォーマンス

- [ ] AI変換応答時間が平均3秒以内
- [ ] 3秒超過時にローディング表示が出る

### AC-004: オフライン対応

- [ ] オフライン時にAI変換ボタンが無効化される
- [ ] オフラインインジケーターが表示される
- [ ] オフライン時にフォールバックが機能する

### AC-005: エラー処理

- [ ] APIエラー時にフォールバック処理が実行される
- [ ] タイムアウト時に再試行オプションが提供される

## 品質判定

✅ **高品質**:
- 要件の曖昧さ: なし（REQ-901〜REQ-904に明確に記載）
- 入出力定義: 完全（API仕様が明確）
- 制約条件: 明確（NFR-002, REQ-2006, REQ-3004）
- 実装可能性: 確実（既存実装とモックサーバーが利用可能）

## 信頼性レベル

🔵 青信号 - EARS要件定義書（REQ-901〜REQ-904, EDGE-001, EDGE-002）およびAPI設計文書に基づく明確な要件定義

---

次のお勧めステップ: `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。
