# TASK-0047: 緊急音・画面赤表示実装 - 要件定義書

## 概要

緊急ボタンの2段階確認（TASK-0046）で「はい」をタップした後に実行される緊急処理を実装する。緊急時に周囲の人に確実に気づいてもらうため、大音量の緊急音を連続再生し、画面全体を赤く表示する。マナーモード時の対応やリセット機能も含む。

**タスクタイプ**: TDD
**推定工数**: 8時間

## 関連要件

### 直接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-303 | システムは緊急ボタン押下時に周囲の人が気づきやすい音を発生させなければならない | 🔵 |
| REQ-304 | システムは緊急ボタン押下時に画面全体を目立つ色（赤など）で表示しなければならない | 🟡 |
| EDGE-203 | マナーモード有効時に緊急ボタンが押された場合、システムはマナーモードを一時的に解除して緊急音を鳴らす、または明確な警告を表示しなければならない | 🟡 |

### 間接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-301 | システムは緊急呼び鈴ボタンをすべての画面で表示しなければならない | 🔵 |
| REQ-302 | システムは緊急ボタンを2段階確認（1回目タップ→確認ダイアログ→2回目確認タップ）で動作させなければならない | 🔵 |
| REQ-2005 | 緊急呼び出しの確認ダイアログで「はい」をタップした場合、システムは緊急音を発生させ、画面を緊急表示に切り替えなければならない | 🔵 |
| REQ-5002 | システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない | 🔵 |
| REQ-803 | システムは「ライトモード」「ダークモード」「高コントラストモード」の3つのテーマを提供しなければならない | 🔵 |

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### FR-001: 緊急音の再生
- **要件**: システムは緊急呼び出し確認後に、周囲の人が気づきやすい大音量の緊急音を発生させなければならない
- **根拠**: REQ-303、REQ-2005
- **信頼性**: 🔵 青信号

#### FR-002: 緊急音の連続再生
- **要件**: システムは緊急音をリセットされるまで連続的（ループ）で再生しなければならない
- **根拠**: REQ-303、周囲への通知を確実にするため
- **信頼性**: 🟡 黄信号

#### FR-003: 緊急音の音量
- **要件**: システムは緊急音を端末の最大音量、または可能な限り大きな音量で再生しなければならない
- **根拠**: REQ-303「気づきやすい音」
- **信頼性**: 🟡 黄信号

#### FR-004: 画面全体の赤表示
- **要件**: システムは緊急呼び出し確認後に、画面全体を赤色で表示しなければならない
- **根拠**: REQ-304、REQ-2005
- **信頼性**: 🔵 青信号

#### FR-005: 緊急画面のオーバーレイ表示
- **要件**: システムは緊急状態時に、既存の画面コンテンツを覆う形で赤い緊急オーバーレイを表示しなければならない
- **根拠**: REQ-304、視覚的な目立ちやすさ
- **信頼性**: 🟡 黄信号

#### FR-006: リセットボタンの表示
- **要件**: システムは緊急画面にリセットボタンを表示し、ユーザーが緊急状態を解除できるようにしなければならない
- **根拠**: REQ-304（画面表示）、操作の完結性
- **信頼性**: 🟡 黄信号

#### FR-007: リセットによる通常状態への復帰
- **要件**: システムはリセットボタンタップ時に、緊急音の停止および赤画面の解除を行い、通常状態に復帰しなければならない
- **根拠**: 操作の完結性
- **信頼性**: 🟡 黄信号

#### FR-008: 緊急メッセージの表示
- **要件**: システムは緊急画面に「緊急呼び出し中」などの明確なメッセージを表示しなければならない
- **根拠**: REQ-304、ユーザー・周囲への状態通知
- **信頼性**: 🟡 黄信号

### 条件付き要件（WHEN/IF-THEN）

#### FR-101: 緊急呼び出し確認後の処理開始
- **条件**: 緊急呼び出しの確認ダイアログで「はい」ボタンをタップした場合
- **動作**: システムは以下の処理を同時に実行しなければならない:
  1. 緊急音の再生を開始する
  2. 画面全体を赤く表示する緊急オーバーレイを表示する
- **根拠**: REQ-2005
- **信頼性**: 🔵 青信号

#### FR-102: リセットボタンタップ時の処理
- **条件**: 緊急画面でリセットボタンをタップした場合
- **動作**: システムは以下の処理を実行しなければならない:
  1. 緊急音の再生を停止する
  2. 緊急オーバーレイを非表示にする
  3. 通常画面に戻る
- **根拠**: 操作の完結性
- **信頼性**: 🟡 黄信号

#### FR-103: マナーモード時の警告表示
- **条件**: マナーモード（サイレントモード）が有効な状態で緊急呼び出しが実行された場合
- **動作**: システムは以下のいずれかの処理を実行しなければならない:
  - **オプションA**: マナーモードを一時的に解除して緊急音を再生する
  - **オプションB**: 「マナーモードのため音が鳴りません」という明確な警告メッセージを表示する
- **根拠**: EDGE-203
- **信頼性**: 🟡 黄信号

#### FR-104: 音量ゼロ時の警告表示
- **条件**: 端末の音量が0（ミュート）の状態で緊急呼び出しが実行された場合
- **動作**: システムは「音量が0です」という視覚的警告を緊急画面に表示しなければならない
- **根拠**: EDGE-202（類似ケース）
- **信頼性**: 🟡 黄信号

#### FR-105: アプリバックグラウンド化時の動作
- **条件**: 緊急状態中にアプリがバックグラウンドに移動した場合
- **動作**: システムは緊急音の再生を継続しなければならない（可能な範囲で）
- **根拠**: REQ-303、緊急性の確保
- **信頼性**: 🔴 赤信号

### 制約要件（MUST）

#### FR-201: audioplayers パッケージの使用
- **要件**: システムは緊急音の再生に audioplayers パッケージを使用しなければならない
- **根拠**: タスクファイルの指定、Flutter標準的なオーディオ処理
- **信頼性**: 🔵 青信号

#### FR-202: タップ操作での完結
- **要件**: 緊急画面のリセット操作は、タップのみで完結し、スワイプやロングプレスを必須としてはならない
- **根拠**: REQ-5005
- **信頼性**: 🔵 青信号

#### FR-203: リセットボタンの最小サイズ
- **要件**: リセットボタンは、タップターゲットサイズ44px × 44px以上を確保しなければならない
- **根拠**: REQ-5001
- **信頼性**: 🔵 青信号

#### FR-204: 緊急音ファイルの同梱
- **要件**: 緊急音のオーディオファイルはアプリに同梱し、オフライン環境でも再生可能としなければならない
- **根拠**: REQ-1001（オフライン対応）
- **信頼性**: 🟡 黄信号

### オプション要件（MAY）

#### FR-301: 緊急画面のアニメーション
- **要件**: システムは緊急画面の表示時に、点滅（フラッシュ）アニメーションを適用してもよい
- **根拠**: 視覚的な目立ちやすさ向上
- **信頼性**: 🔴 赤信号

#### FR-302: バイブレーションの併用
- **要件**: システムは緊急音と併せて端末のバイブレーション機能を使用してもよい
- **根拠**: 多感覚での通知
- **信頼性**: 🔴 赤信号

#### FR-303: リセット確認ダイアログ
- **要件**: システムはリセットボタンタップ時に確認ダイアログを表示してもよい
- **根拠**: 誤操作防止（ただし緊急解除は迅速性が重要なため任意）
- **信頼性**: 🔴 赤信号

## 非機能要件

### パフォーマンス

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-P001 | 確認ダイアログ「はい」タップから緊急音再生開始まで500ms以内 | UX標準、緊急性 | 🟡 |
| NFR-P002 | 確認ダイアログ「はい」タップから赤画面表示まで300ms以内 | UX標準、緊急性 | 🟡 |
| NFR-P003 | リセットボタンタップから音停止・画面復帰まで300ms以内 | UX標準 | 🟡 |
| NFR-P004 | 緊急音の連続再生においてギャップ（無音部分）が100ms以下 | 連続音の確保 | 🟡 |

### ユーザビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-U001 | 緊急画面は周囲の人にも状況が一目でわかるデザイン | REQ-303, REQ-304 | 🔵 |
| NFR-U002 | リセットボタンは緊急画面内で見つけやすい位置に配置 | 操作性 | 🟡 |
| NFR-U003 | 警告メッセージは明確で理解しやすい日本語 | NFR-204 | 🔵 |
| NFR-U004 | リセットボタンは大きく押しやすいサイズ（推奨80px × 48px以上） | NFR-202, REQ-5001 | 🟡 |

### アクセシビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-A001 | 緊急画面にSemantics「緊急呼び出し中」を設定 | WCAG、スクリーンリーダー対応 | 🟡 |
| NFR-A002 | リセットボタンのSemanticsに「緊急呼び出しを解除」を設定 | WCAG | 🟡 |
| NFR-A003 | 視覚的な警告（赤画面）と聴覚的な警告（緊急音）の両方を提供 | マルチモーダル対応 | 🔵 |
| NFR-A004 | マナーモード時の警告は視覚的に明確に表示 | EDGE-203 | 🟡 |

### テーマ対応

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-T001 | 緊急画面の赤色は全テーマで統一（視認性重視） | REQ-304 | 🟡 |
| NFR-T002 | リセットボタンはテーマに関係なく白背景・黒文字（赤背景上での視認性確保） | コントラスト確保 | 🟡 |

## エッジケース・境界値

### エッジケース

#### EDGE-001: マナーモード有効時
- **状況**: マナーモード（サイレントモード）が有効な状態で緊急呼び出しが実行された場合
- **期待動作**:
  - オプションA: システムがマナーモードを一時解除して音を再生
  - オプションB: 「マナーモードのため音が鳴りません」と警告表示
- **信頼性**: 🟡 黄信号
- **備考**: OSの制限により実装難易度が異なる。Flutter/audioplayers の制約を確認要

#### EDGE-002: 音量ゼロ時
- **状況**: 端末の音量設定が0（ミュート）の状態で緊急呼び出しが実行された場合
- **期待動作**: 「音量が0です」という視覚的警告を緊急画面に表示
- **信頼性**: 🟡 黄信号

#### EDGE-003: 緊急音ファイル読み込み失敗
- **状況**: 緊急音のオーディオファイルの読み込みに失敗した場合
- **期待動作**:
  - 音なしで赤画面表示を継続
  - エラーログを記録
  - 可能であれば警告メッセージ表示
- **信頼性**: 🟡 黄信号

#### EDGE-004: 緊急状態中のアプリ終了
- **状況**: 緊急画面表示中にユーザーがアプリを強制終了した場合
- **期待動作**: アプリ再起動時は通常状態から開始（緊急状態は永続化しない）
- **信頼性**: 🟡 黄信号

#### EDGE-005: 緊急状態中のアプリバックグラウンド化
- **状況**: 緊急画面表示中にアプリがバックグラウンドに移動した場合
- **期待動作**:
  - 可能な範囲で緊急音を継続
  - フォアグラウンド復帰時に緊急画面を維持
- **信頼性**: 🔴 赤信号
- **備考**: OSの制限により完全な制御は困難な場合がある

#### EDGE-006: リセットボタン連続タップ
- **状況**: リセットボタンを短時間に複数回タップした場合
- **期待動作**: 1回目のタップでリセット処理が実行され、後続タップは無視される
- **信頼性**: 🟡 黄信号

#### EDGE-007: 緊急状態中の画面回転
- **状況**: 緊急画面表示中にデバイスが回転した場合
- **期待動作**: 緊急画面を維持し、レイアウトを適切に調整。音は継続
- **信頼性**: 🟡 黄信号

#### EDGE-008: オーディオ再生中の他アプリ割り込み
- **状況**: 緊急音再生中に電話着信などで他アプリが割り込んだ場合
- **期待動作**: 割り込み終了後に緊急音を再開する（可能な範囲で）
- **信頼性**: 🔴 赤信号

### 境界値

| 項目 | 最小値 | 推奨値 | 最大値 |
|------|--------|--------|--------|
| リセットボタン幅 | 80px | 120px | 画面幅の50% |
| リセットボタン高さ | 44px | 56px | 80px |
| 緊急音ループ間隔 | 0ms | 0ms | 100ms |
| 赤画面表示までの時間 | - | 200ms | 500ms |
| 緊急音ファイルサイズ | - | 100KB | 500KB |
| 緊急音の長さ（1ループ） | 0.5秒 | 2秒 | 5秒 |

## 受け入れ基準

### 緊急音再生テスト

- [ ] AC-001: 緊急呼び出し確認後に緊急音が再生される
- [ ] AC-002: 緊急音がループ再生される（リセットまで継続）
- [ ] AC-003: 緊急音が大きな音量で再生される
- [ ] AC-004: リセットボタンタップで緊急音が停止する
- [ ] AC-005: オフライン環境でも緊急音が再生される

### 画面表示テスト

- [ ] AC-006: 緊急呼び出し確認後に画面全体が赤く表示される
- [ ] AC-007: 緊急画面に「緊急呼び出し中」メッセージが表示される
- [ ] AC-008: 緊急画面にリセットボタンが表示される
- [ ] AC-009: リセットボタンタップで赤画面が解除される
- [ ] AC-010: リセット後に通常画面に戻る

### マナーモード・音量ゼロ対応テスト

- [ ] AC-011: マナーモード時に適切な警告または対応がされる
- [ ] AC-012: 音量ゼロ時に「音量が0です」警告が表示される

### 統合テスト

- [ ] AC-013: 緊急音再生と画面赤表示が同時に開始される
- [ ] AC-014: リセットで音停止と画面解除が同時に行われる
- [ ] AC-015: 2段階確認→緊急処理→リセットの一連のフローが正常動作

### アクセシビリティテスト

- [ ] AC-016: リセットボタンのタップターゲットが44px × 44px以上
- [ ] AC-017: 緊急画面にSemantics情報が設定されている
- [ ] AC-018: リセットボタンにSemantics情報が設定されている

### エッジケーステスト

- [ ] AC-019: リセットボタン連続タップで二重処理が発生しない
- [ ] AC-020: 緊急音ファイル読み込み失敗時に赤画面は表示される
- [ ] AC-021: 画面回転時に緊急状態が維持される

## 技術仕様

### 新規コンポーネント

| コンポーネント名 | パス | 説明 |
|------------------|------|------|
| `EmergencyAlertScreen` | `lib/features/emergency/presentation/screens/emergency_alert_screen.dart` | 緊急画面（赤背景オーバーレイ） |
| `EmergencyAudioService` | `lib/features/emergency/domain/services/emergency_audio_service.dart` | 緊急音再生サービス |
| `EmergencyState` | `lib/features/emergency/domain/models/emergency_state.dart` | 緊急状態管理（Riverpod） |

### 既存コンポーネントとの連携

| コンポーネント名 | パス | 連携方法 |
|------------------|------|----------|
| `EmergencyButtonWithConfirmation` | `lib/features/emergency/presentation/widgets/emergency_button_with_confirmation.dart` | `onEmergencyConfirmed`コールバックから緊急処理を呼び出す |
| `EmergencyConfirmationDialog` | `lib/features/emergency/presentation/widgets/emergency_confirmation_dialog.dart` | 確認ダイアログからの連携 |
| `EmergencyState` enum | `lib/design/kotonoha/interfaces.dart` | 状態管理で使用 |

### 使用パッケージ

| パッケージ名 | バージョン | 用途 |
|--------------|------------|------|
| audioplayers | ^5.x または ^6.x | 緊急音再生 |
| volume_controller (オプション) | ^2.x | マナーモード検知・音量制御 |
| vibration (オプション) | ^1.x | バイブレーション |

### 緊急音ファイル仕様

- **形式**: MP3 または WAV
- **ファイル名**: `emergency_alarm.mp3`
- **配置場所**: `assets/audio/emergency_alarm.mp3`
- **推奨長さ**: 2-3秒（ループ再生）
- **特性**: 高音域を含む注意喚起音（サイレン風）

### 主要実装ポイント

#### 1. 緊急音再生サービス

```dart
class EmergencyAudioService {
  final AudioPlayer _player = AudioPlayer();

  /// 緊急音の再生開始（ループ）
  Future<void> startEmergencySound() async {
    await _player.setReleaseMode(ReleaseMode.loop);
    await _player.setVolume(1.0); // 最大音量
    await _player.play(AssetSource('audio/emergency_alarm.mp3'));
  }

  /// 緊急音の停止
  Future<void> stopEmergencySound() async {
    await _player.stop();
  }

  /// リソースの解放
  Future<void> dispose() async {
    await _player.dispose();
  }
}
```

#### 2. 緊急画面オーバーレイ

```dart
class EmergencyAlertScreen extends StatelessWidget {
  final VoidCallback onReset;

  const EmergencyAlertScreen({
    super.key,
    required this.onReset,
  });

  @override
  Widget build(BuildContext context) {
    return Material(
      color: Colors.red, // 画面全体を赤に
      child: SafeArea(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(
              Icons.warning,
              color: Colors.white,
              size: 100,
            ),
            const SizedBox(height: 24),
            const Text(
              '緊急呼び出し中',
              style: TextStyle(
                color: Colors.white,
                fontSize: 32,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 48),
            ElevatedButton(
              onPressed: onReset,
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.white,
                foregroundColor: Colors.black,
                minimumSize: const Size(120, 56),
              ),
              child: const Text('リセット'),
            ),
          ],
        ),
      ),
    );
  }
}
```

#### 3. 緊急状態管理（Riverpod）

```dart
/// 緊急状態の通知クラス
@riverpod
class EmergencyStateNotifier extends _$EmergencyStateNotifier {
  EmergencyAudioService? _audioService;

  @override
  EmergencyStateEnum build() => EmergencyStateEnum.normal;

  /// 緊急呼び出しを開始
  Future<void> startEmergency() async {
    _audioService ??= EmergencyAudioService();
    await _audioService!.startEmergencySound();
    state = EmergencyStateEnum.alertActive;
  }

  /// 緊急呼び出しをリセット
  Future<void> resetEmergency() async {
    await _audioService?.stopEmergencySound();
    state = EmergencyStateEnum.normal;
  }
}
```

### 緊急画面デザイン

```
+------------------------------------------+
|                                          |
|                                          |
|             ⚠️ (大きい警告アイコン)        |
|                                          |
|          緊急呼び出し中                   |
|                                          |
|     ※ マナーモード中のため               |
|       音が鳴りません（警告時のみ表示）     |
|                                          |
|                                          |
|           +----------------+             |
|           |    リセット    |             |
|           +----------------+             |
|           (白背景・黒文字)               |
|                                          |
+------------------------------------------+
背景: 全面赤色 (#FF0000 または AppColors.emergency)
```

### 緊急処理フロー図

```
[確認ダイアログで「はい」タップ]
           |
           v
[onEmergencyConfirmed コールバック呼び出し]
           |
           +---> [EmergencyStateNotifier.startEmergency()]
                           |
                           +---> [緊急音再生開始]
                           |
                           +---> [状態を alertActive に変更]
                           |
                           v
                 [EmergencyAlertScreen 表示]
                           |
                           v
               [ユーザーがリセットボタンタップ]
                           |
                           v
          [EmergencyStateNotifier.resetEmergency()]
                           |
                           +---> [緊急音停止]
                           |
                           +---> [状態を normal に変更]
                           |
                           v
                 [通常画面に戻る]
```

### マナーモード検知フロー

```
[緊急呼び出し開始時]
       |
       v
[マナーモード/音量状態をチェック]
       |
       +---> [マナーモードON?]
       |            |
       |            +---> [はい] --> [警告メッセージ表示]
       |            |                「マナーモードのため音が鳴りません」
       |            |
       |            +---> [いいえ] --> [音量ゼロ?]
       |                                    |
       |                              +-----+-----+
       |                              |           |
       |                           [はい]      [いいえ]
       |                              |           |
       |                              v           v
       |                    [警告表示]    [通常再生]
       |                  「音量が0です」
       |
       v
[緊急音再生（可能な場合）]
[赤画面表示]
```

## 依存関係

### 依存するタスク（完了済み）

- TASK-0017: 共通UIコンポーネント実装（EmergencyButtonの基本実装） ✅
- TASK-0016: テーマ実装（ライト・ダーク・高コントラスト） ✅
- TASK-0045: 緊急ボタンUI実装（EmergencyButtonWithConfirmation、EmergencyConfirmationDialog） ✅
- TASK-0046: 緊急ボタン2段階確認実装（確認ダイアログ動作検証） ✅

### 後続タスクへの影響

- TASK-0048: OS標準TTS連携
  - 緊急メッセージの読み上げ機能（必要に応じて連携）
- メイン画面実装
  - EmergencyAlertScreenのオーバーレイ表示連携

## 実装チェックリスト

### Phase 1: 基盤実装
- [ ] audioplayers パッケージの追加
- [ ] 緊急音ファイルの準備と配置
- [ ] pubspec.yaml への assets 追加
- [ ] EmergencyAudioService の実装
- [ ] 緊急音再生・停止の単体テスト

### Phase 2: UI実装
- [ ] EmergencyAlertScreen の実装
- [ ] リセットボタンの実装
- [ ] 警告メッセージ表示の実装
- [ ] Semantics の設定
- [ ] ウィジェットテスト

### Phase 3: 状態管理実装
- [ ] EmergencyStateNotifier の実装（Riverpod）
- [ ] 状態遷移のテスト
- [ ] EmergencyButtonWithConfirmation との連携

### Phase 4: エッジケース対応
- [ ] マナーモード検知の実装（可能な範囲で）
- [ ] 音量ゼロ検知と警告表示
- [ ] 連続タップ防止
- [ ] エラーハンドリング

### Phase 5: 統合テスト
- [ ] 2段階確認→緊急処理→リセットの統合テスト
- [ ] iOS/Android 両プラットフォームでの動作確認
- [ ] パフォーマンステスト

## 備考

- 信頼性レベル凡例:
  - 🔵 **青信号**: 要件定義書に明確に記載された要件
  - 🟡 **黄信号**: 要件定義書から妥当に推測される要件
  - 🔴 **赤信号**: 要件定義書にない推測による要件

- マナーモードの検知・解除はOSの制限により完全な制御が困難な場合がある。Flutter/audioplayers の制約を事前に調査し、実現可能な範囲で対応する

- 緊急音ファイルは著作権フリーまたは自作の音源を使用する

- バックグラウンドでの音声再生はiOS/Androidでそれぞれ追加設定が必要な場合がある

- TASK-0046で実装済みの2段階確認機能（EmergencyButtonWithConfirmation）の `onEmergencyConfirmed` コールバックから本タスクの緊急処理を呼び出す

---

**ドキュメント作成日**: 2025-11-24
**タスクID**: TASK-0047
**関連要件**: REQ-303, REQ-304, EDGE-203
