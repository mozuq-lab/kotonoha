# TASK-0051: OS音量0の警告表示 - 要件定義書

## 作成日: 2025-11-26
## 作成者: Claude Code
## 信頼性レベル: 🟡 黄信号

---

## 1. 機能の概要

### 🟡 何をする機能か
OSの音量が0（ミュート）の状態で読み上げを実行した場合、ユーザーに「音量が0です」という視覚的警告を表示する機能。

### 🟡 どのような問題を解決するか
- **問題**: 発話困難な方がTTS読み上げを実行しても、音量が0だと音が出ず、相手に伝わらない状況が発生する
- **解決**: 読み上げ実行前にOS音量を確認し、音量0の場合は視覚的な警告を表示してユーザーに気づかせる
- **効果**: ユーザーが「なぜ音が出ないのか」を即座に理解し、音量調整アクションを取れる

### 🔵 想定されるユーザー
- 脳梗塞・ALS・筋疾患などで発話が困難な方
- タブレットのタップ操作がある程度可能な方
- 家族、介護スタッフ、医療従事者

### 🟡 システム内での位置づけ
- **レイヤー**: フロントエンド（Flutter）のTTS機能の補助機能
- **依存**: TTSService、TTSProvider、volume_controllerパッケージ
- **連携**: TTS読み上げボタン、緊急ボタン（緊急音再生）など音声出力機能全般

### 参照したEARS要件
- **EDGE-202**: OSの音量が0（ミュート）の状態で読み上げを実行した場合、システムは「音量が0です」という視覚的警告を表示しなければならない 🟡
- **REQ-4003**: システムは音量調整へのクイックアクセスを提供してもよい 🟡

### 参照した設計文書
- `docs/design/kotonoha/interfaces.dart`: TTSSpeed、AppSettings

---

## 2. 入力・出力の仕様

### 🟡 入力パラメータ

#### VolumeService
| パラメータ | 型 | 説明 | 制約 |
|-----------|-----|------|------|
| なし | - | OS音量は自動取得 | - |

#### VolumeWarningWidget
| パラメータ | 型 | 説明 | 制約 |
|-----------|-----|------|------|
| isVisible | bool | 警告表示の可否 | required |
| onDismiss | VoidCallback | 閉じるボタンのコールバック | required |
| onOpenSettings | VoidCallback? | 音量設定を開くコールバック | optional |

### 🟡 出力値

#### VolumeService
| 出力 | 型 | 説明 | 例 |
|------|-----|------|-----|
| currentVolume | double | 現在のOS音量 (0.0〜1.0) | 0.0, 0.5, 1.0 |
| isMuted | bool | ミュート状態かどうか | true/false |
| isVolumeZero | bool | 音量が0かどうか | true/false |

#### VolumeWarningWidget
| 出力 | 型 | 説明 |
|------|-----|------|
| 視覚的警告UI | Widget | 「音量が0です」メッセージ、アイコン、閉じるボタン |

### 🟡 データフロー

```
[ユーザー]
    ↓ 読み上げボタンをタップ
[TTSButton / TTSProvider]
    ↓ speak() 呼び出し前に音量チェック
[VolumeService]
    ↓ OS音量取得 (volume_controller)
    ↓ isVolumeZero判定
[VolumeWarningProvider]
    ↓ showVolumeWarning = true
[VolumeWarningWidget]
    ↓ 警告UI表示
[ユーザー]
    ↓ 警告を確認、音量調整
```

### 参照したEARS要件
- EDGE-202: 視覚的警告を表示

### 参照した設計文書
- `docs/design/kotonoha/dataflow.md`: TTS読み上げフロー

---

## 3. 制約条件

### 🟡 パフォーマンス要件
- **音量チェック時間**: 読み上げ開始を遅延させないよう、100ms以内で完了すること
- **UI表示**: 警告表示は即座に（50ms以内）表示されること

### 🟡 セキュリティ要件
- 音量情報はプライバシーに関わらないため、特別な保護は不要
- ローカルデバイスの音量取得のみ、外部通信なし

### 🟡 互換性要件
- **iOS**: 14.0以上でvolume_controller対応
- **Android**: 10以上でvolume_controller対応
- **Web**: Web環境では音量取得APIが制限されるため、警告機能は無効化

### 🟡 アーキテクチャ制約
- 既存のTTSService、TTSProviderと統合
- Riverpodパターンに従った状態管理
- volume_controllerパッケージの追加が必要

### 🔵 データベース制約
- 該当なし（ローカルストレージに保存するデータなし）

### 🔵 API制約
- 該当なし（外部API呼び出しなし）

### 参照したEARS要件
- NFR-401: iOS 14.0以上、Android 10以上で動作

### 参照した設計文書
- `docs/tech-stack.md`: 技術スタック定義

---

## 4. 想定される使用例

### 🟡 基本的な使用パターン

#### ケース1: 音量0での読み上げ試行
1. ユーザーが文字盤で「こんにちは」と入力
2. 読み上げボタンをタップ
3. システムがOS音量を確認 → 0を検出
4. 「音量が0です」警告を画面に表示
5. ユーザーが警告を確認し、端末の音量ボタンで音量を上げる
6. 再度読み上げボタンをタップ → 正常に読み上げ

#### ケース2: 音量正常での読み上げ
1. ユーザーが文字盤で「ありがとう」と入力
2. 読み上げボタンをタップ
3. システムがOS音量を確認 → 0より大きい
4. 警告表示なし、即座に読み上げ開始

#### ケース3: 緊急ボタンでの音量警告（REQ-4003関連）
1. ユーザーが緊急ボタンをタップ
2. 2段階確認ダイアログで「はい」をタップ
3. システムがOS音量を確認 → 0を検出
4. 緊急音再生と同時に「音量が0です。緊急音が聞こえない可能性があります」警告表示
5. 画面は緊急表示（赤色）に切り替え

### 🟡 エッジケース

#### EDGE-1: 音量チェック中に読み上げボタンが再タップされた場合
- 前回のチェック結果を使用し、二重チェックは行わない
- チェック完了を待ってから読み上げ開始

#### EDGE-2: 音量取得に失敗した場合（デバイス制限等）
- 警告は表示せず、読み上げを続行
- エラーログを記録
- Web環境ではこのケースが発生

#### EDGE-3: 警告表示中にOS音量が変更された場合
- 警告は自動で消えない（ユーザーが閉じる操作が必要）
- 次回の読み上げ時に再チェック

#### EDGE-4: 定型文・大ボタンの即座読み上げでの警告
- 定型文タップ → 音量チェック → 警告表示（音量0の場合）
- 大ボタン（「はい」「いいえ」）タップ → 音量チェック → 警告表示（音量0の場合）

### 🟡 エラーケース

#### ERROR-1: volume_controllerパッケージが初期化できない
- エラーをキャッチし、音量チェック機能を無効化
- 読み上げ機能は正常動作（NFR-301準拠）

#### ERROR-2: OS権限が不足している
- Android/iOSの音量取得権限が拒否された場合
- 警告機能を無効化し、読み上げは正常動作

### 参照したEARS要件
- EDGE-202: OSの音量が0の状態で読み上げを実行した場合の警告
- NFR-301: 重大なエラーでも基本機能は継続動作

### 参照した設計文書
- `docs/design/kotonoha/dataflow.md`: TTS読み上げフロー図

---

## 5. EARS要件・設計文書との対応関係

### 参照したユーザストーリー
- US-007: 発話困難なユーザーとして、入力したテキストを音声で読み上げてもらいたい

### 参照した機能要件
- **REQ-401**: システムは入力欄のテキストをOS標準TTSで読み上げる機能を提供しなければならない
- **REQ-403**: システムは読み上げ中の停止・中断機能を提供しなければならない
- **REQ-4003**: システムは音量調整へのクイックアクセスを提供してもよい（MAY）

### 参照した非機能要件
- **NFR-001**: TTS読み上げ開始までの時間を1秒以内
- **NFR-204**: エラーメッセージを分かりやすい日本語で表示
- **NFR-301**: 重大なエラーでも基本機能は継続動作

### 参照したEdgeケース
- **EDGE-202**: OSの音量が0（ミュート）の状態で読み上げを実行した場合、システムは「音量が0です」という視覚的警告を表示しなければならない
- **EDGE-004**: TTS音声再生エラー時、システムはテキスト表示のみで継続

### 参照した受け入れ基準
- TTS読み上げ時に音量0の場合、警告が表示されること
- 警告表示後も読み上げ操作が可能であること

### 参照した設計文書
- **アーキテクチャ**: `docs/design/kotonoha/architecture.md` - フロントエンドレイヤー
- **データフロー**: `docs/design/kotonoha/dataflow.md` - TTS読み上げフロー
- **型定義**: `docs/design/kotonoha/interfaces.dart` - TTSSpeed、AppSettings
- **データベース**: 該当なし
- **API仕様**: 該当なし

---

## 6. 技術的実装方針

### 🟡 追加パッケージ
```yaml
# pubspec.yaml に追加
dependencies:
  volume_controller: ^2.0.7
```

### 🟡 新規作成ファイル
```
lib/features/tts/
├── domain/
│   └── services/
│       └── volume_service.dart          # 音量取得サービス
├── providers/
│   └── volume_warning_provider.dart     # 音量警告状態管理
└── presentation/
    └── widgets/
        └── volume_warning_widget.dart   # 警告表示ウィジェット
```

### 🟡 既存ファイル修正
- `lib/features/tts/providers/tts_provider.dart`: 読み上げ前の音量チェック統合
- `lib/features/tts/presentation/widgets/tts_button.dart`: 警告ウィジェット統合
- `pubspec.yaml`: volume_controllerパッケージ追加

---

## 7. 品質判定

### ✅ 高品質
- **要件の曖昧さ**: なし - EDGE-202に基づく明確な要件
- **入出力定義**: 完全 - VolumeService、VolumeWarningWidgetの入出力を詳細に定義
- **制約条件**: 明確 - パフォーマンス、互換性、アーキテクチャ制約を明記
- **実装可能性**: 確実 - volume_controllerパッケージの使用で実装可能

---

## 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2025-11-26 | Claude Code | 初版作成（TDD要件定義フェーズ） |
