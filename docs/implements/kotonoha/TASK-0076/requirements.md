# TASK-0076: ネットワーク状態管理Provider - 要件定義

## タスク概要

- **タスクID**: TASK-0076
- **タスク名**: ネットワーク状態管理Provider実装
- **関連要件**: REQ-1001, REQ-1002, REQ-1003, REQ-3004
- **依存タスク**: TASK-0057 (Provider構造)

## 関連要件（EARS記法）

### REQ-1001: オフライン時AI変換無効化 🔵

**EARS記法**: State-driven
> システムがオフライン状態にある場合、AI変換機能は無効化されなければならない

**受け入れ基準**:
- オフライン時にisAIConversionAvailableがfalseを返す
- オンライン復帰時にisAIConversionAvailableがtrueに戻る

### REQ-1002: オフライン状態表示 🔵

**EARS記法**: State-driven
> システムがオフライン状態にある場合、ユーザーに視覚的に通知しなければならない

**受け入れ基準**:
- ネットワーク状態がProviderで管理される
- オフライン時にUI更新用の状態が提供される

### REQ-1003: オフライン時基本機能動作 🔵

**EARS記法**: State-driven
> システムがオフライン状態にある場合、基本機能（文字盤入力、定型文、TTS）は引き続き動作しなければならない

**受け入れ基準**:
- オフライン状態でも基本機能の状態は影響を受けない
- AI変換のみが無効化される

### REQ-3004: ネットワーク状態の正確な検知 🔵

**EARS記法**: Ubiquitous
> システムはネットワーク接続状態を正確に検知しなければならない

**受け入れ基準**:
- WiFi/Mobile/Ethernet接続時にオンライン状態
- 接続なし時にオフライン状態
- 接続状態変更時にリアルタイムで検知

## 機能要件

### 1. ConnectivityService

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| CONN-001 | connectivity_plusをラップしたサービスを提供する | 高 |
| CONN-002 | checkConnectivity()で現在の接続状態を取得できる | 高 |
| CONN-003 | onConnectivityChangedで接続状態変更を購読できる | 高 |
| CONN-004 | テスト時にモック可能なProviderとして提供する | 高 |

### 2. NetworkNotifier拡張

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| NET-001 | ConnectivityServiceを依存性注入で受け取る | 高 |
| NET-002 | initializeWithConnectivity()で接続状態を初期化する | 高 |
| NET-003 | startListening()で接続状態変更リスナーを開始する | 高 |
| NET-004 | stopListening()でリスナーを停止する | 中 |
| NET-005 | WiFi接続時にオンライン状態に設定する | 高 |
| NET-006 | モバイルデータ接続時にオンライン状態に設定する | 高 |
| NET-007 | イーサネット接続時にオンライン状態に設定する | 高 |
| NET-008 | 接続なし時にオフライン状態に設定する | 高 |
| NET-009 | 複数の接続タイプがある場合はオンライン状態に設定する | 中 |
| NET-010 | エラー発生時は安全側にオフライン扱いにする | 高 |

### 3. 接続状態変更検知

| 要件ID | 説明 | 優先度 |
|--------|------|--------|
| CHG-001 | WiFi→オフライン変更を検知する | 高 |
| CHG-002 | オフライン→WiFi変更を検知する | 高 |
| CHG-003 | 状態変更時にUIに通知される | 高 |

## 非機能要件

| 要件ID | 説明 | 基準値 |
|--------|------|--------|
| NFR-NET-001 | 接続状態変更検知 | 100ms以内にUI反映 |
| NFR-NET-002 | 接続確認API呼び出し | 非同期、UIブロックなし |
| NFR-NET-003 | エラーハンドリング | 安全側（オフライン）にフォールバック |

## 技術仕様

### 使用パッケージ
- `connectivity_plus: ^6.1.3`

### 接続タイプと状態のマッピング

| ConnectivityResult | NetworkState |
|-------------------|--------------|
| wifi | online |
| mobile | online |
| ethernet | online |
| none | offline |
| (empty list) | offline |
| (error) | offline |

## 信頼性レベル

- 🔵 **青信号**: REQ-1001〜1003, REQ-3004 - EARS要件定義書に明記
