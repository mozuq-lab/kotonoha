# TASK-0025: レート制限ミドルウェア実装 - テストケース一覧

## 1. テスト概要

### 1.1 テスト対象

レート制限ミドルウェアのテストケースを網羅的に定義します。

- **対象機能**: レート制限ミドルウェア（slowapi使用）
- **対象エンドポイント**: `/api/v1/ai/convert`, `/api/v1/ai/regenerate`
- **レート制限設定**: 1リクエスト/10秒/IP（TASK-0025仕様）

### 1.2 テストファイル構成

```
backend/tests/
├── test_api/
│   └── test_rate_limit.py       # レート制限テスト
└── conftest.py                   # テストフィクスチャ
```

### 1.3 開発言語・フレームワーク

- **プログラミング言語**: Python 3.10+
  - **言語選択の理由**: バックエンドがFastAPI（Python）で実装されているため
  - **テストに適した機能**: asyncio対応、型ヒント、デコレーター
- **テストフレームワーク**: pytest + pytest-asyncio + httpx
  - **フレームワーク選択の理由**: FastAPI公式推奨、非同期テスト対応
  - **テスト実行環境**: ローカル開発環境、CI/CD（GitHub Actions）
- 🔵 この内容は要件定義書とtech-stack.mdに基づく

---

## 2. 正常系テストケース

### TC-001: 正常リクエストテスト（制限内）

- **テスト名**: 制限内のリクエストが正常に処理される
  - **何をテストするか**: レート制限内の最初のリクエストが正常に処理されることを確認
  - **期待される動作**: リクエストが後続のハンドラーに転送され、正常なレスポンスが返される
- **入力値**:
  - エンドポイント: `/api/v1/ai/convert`
  - リクエストボディ: `{"input_text": "水 ぬるく", "politeness_level": "normal"}`
  - **入力データの意味**: 最も基本的なAI変換リクエスト
- **期待される結果**:
  - HTTPステータスコード: 200 OK
  - **期待結果の理由**: 制限内のリクエストは正常に処理されるべき
- **テストの目的**: レート制限が制限内のリクエストを妨げないことを確認
  - **確認ポイント**: ミドルウェアがリクエストを透過的に通すこと
- 🔵 この内容は要件定義書（4.1 ユースケース1）に基づく

### TC-002: X-RateLimitヘッダーテスト

- **テスト名**: レスポンスにX-RateLimit-*ヘッダーが含まれる
  - **何をテストするか**: 正常レスポンスにレート制限情報ヘッダーが付与されることを確認
  - **期待される動作**: X-RateLimit-Limit、X-RateLimit-Remaining、X-RateLimit-Resetヘッダーが設定される
- **入力値**:
  - エンドポイント: `/api/v1/ai/convert`
  - リクエストボディ: `{"input_text": "テスト", "politeness_level": "normal"}`
  - **入力データの意味**: レート制限情報を確認するための標準リクエスト
- **期待される結果**:
  - `X-RateLimit-Limit: 1`（制限回数）
  - `X-RateLimit-Remaining: 0`（リクエスト後の残り回数）
  - `X-RateLimit-Reset: [UNIXタイムスタンプ]`（リセット時刻）
  - **期待結果の理由**: クライアントがレート制限状況を把握するため
- **テストの目的**: APIドキュメント（2.2 出力値）に記載されたヘッダー仕様を検証
  - **確認ポイント**: ヘッダー名、データ型、値の妥当性
- 🔵 この内容は要件定義書（2.2 出力値）に基づく

### TC-003: 制限リセットテスト

- **テスト名**: 制限時間経過後にリクエストが許可される
  - **何をテストするか**: 10秒経過後に制限がリセットされることを確認
  - **期待される動作**: 制限超過後、10秒待機すると再度リクエストが許可される
- **入力値**:
  - 1回目リクエスト → 10秒以上待機 → 2回目リクエスト
  - **入力データの意味**: スライディングウィンドウの挙動確認
- **期待される結果**:
  - 1回目: 200 OK
  - 2回目: 200 OK（制限リセット後）
  - **期待結果の理由**: 制限時間経過でカウンターがリセットされるべき
- **テストの目的**: スライディングウィンドウ方式の正常動作を確認
  - **確認ポイント**: 正確に10秒後にリセットされること
- 🔵 この内容は要件定義書（4.2 エッジケース1）に基づく

### TC-004: IP別制限テスト

- **テスト名**: 異なるIPは独立して制限される
  - **何をテストするか**: IPアドレスごとに個別のレート制限が適用されることを確認
  - **期待される動作**: IP Aのリクエストは IP Bの制限に影響しない
- **入力値**:
  - IP A: リクエスト送信
  - IP B: リクエスト送信
  - **入力データの意味**: 異なるクライアントからの同時アクセスを模擬
- **期待される結果**:
  - IP A: 200 OK
  - IP B: 200 OK（独立した制限）
  - **期待結果の理由**: IPごとに独立した制限カウンターを持つべき
- **テストの目的**: IPベースのレート制限が正しく機能することを確認
  - **確認ポイント**: 異なるIPからの同時リクエストが両方とも許可される
- 🔵 この内容は要件定義書（4.2 エッジケース2）に基づく

### TC-005: 非AI系エンドポイント除外テスト

- **テスト名**: 非AI系エンドポイントはレート制限対象外
  - **何をテストするか**: `/health`などのエンドポイントにレート制限が適用されないことを確認
  - **期待される動作**: ヘルスチェックは何度呼び出しても429エラーにならない
- **入力値**:
  - エンドポイント: `/health`
  - 連続リクエスト: 10回以上
  - **入力データの意味**: レート制限対象外のエンドポイントをテスト
- **期待される結果**:
  - 全リクエスト: 200 OK
  - X-RateLimit-*ヘッダー: なし
  - **期待結果の理由**: AI変換以外のエンドポイントは制限対象外
- **テストの目的**: レート制限のスコープが正しく設定されていることを確認
  - **確認ポイント**: `/api/v1/ai/*`以外は制限なし
- 🔵 この内容は要件定義書（3.5 API制約）に基づく

---

## 3. 異常系テストケース

### TC-101: レート制限超過テスト

- **テスト名**: 連続リクエストで429エラーが返される
  - **エラーケースの概要**: 10秒以内に2回目のリクエストを送信した場合
  - **エラー処理の重要性**: 過負荷防止、コスト管理のためのレート制限
- **入力値**:
  - 1回目リクエスト → 即座に2回目リクエスト
  - **不正な理由**: 1リクエスト/10秒の制限を超過
  - **実際の発生シナリオ**: ユーザーが連続でAI変換ボタンを押した場合
- **期待される結果**:
  - 1回目: 200 OK
  - 2回目: 429 Too Many Requests
  - **エラーメッセージの内容**: "リクエスト数が上限に達しました。しばらく待ってから再試行してください。"
  - **システムの安全性**: AI APIへの過負荷を防止
- **テストの目的**: レート制限が正しく機能することを確認
  - **品質保証の観点**: NFR-101（レート制限）の要件を満たす
- 🔵 この内容は要件定義書（4.1 ユースケース2）に基づく

### TC-102: Retry-Afterヘッダーテスト

- **テスト名**: 429レスポンスにRetry-Afterヘッダーが含まれる
  - **エラーケースの概要**: レート制限超過時のレスポンスヘッダー検証
  - **エラー処理の重要性**: クライアントが再試行可能時刻を把握できる
- **入力値**:
  - レート制限超過状態でのリクエスト
  - **不正な理由**: 制限超過
  - **実際の発生シナリオ**: 連続リクエスト時
- **期待される結果**:
  - HTTPステータスコード: 429
  - `Retry-After: [残り秒数]`（1-10の間）
  - **エラーメッセージの内容**: ヘッダーでリトライ可能時刻を通知
  - **システムの安全性**: クライアントが適切なタイミングで再試行可能
- **テストの目的**: RFC 6585準拠のレスポンスを確認
  - **品質保証の観点**: 標準仕様に準拠したエラーレスポンス
- 🔵 この内容は要件定義書（2.2 出力値）に基づく

### TC-103: エラーレスポンス形式テスト

- **テスト名**: 429エラーのレスポンス形式が仕様に準拠
  - **エラーケースの概要**: エラーレスポンスのJSON形式検証
  - **エラー処理の重要性**: クライアントがエラーを正しくパースできる
- **入力値**:
  - レート制限超過状態でのリクエスト
  - **不正な理由**: 制限超過
  - **実際の発生シナリオ**: 連続リクエスト時
- **期待される結果**:
  ```json
  {
    "success": false,
    "data": null,
    "error": {
      "code": "RATE_LIMIT_EXCEEDED",
      "message": "リクエスト数が上限に達しました。しばらく待ってから再試行してください。",
      "status_code": 429,
      "retry_after": [残り秒数]
    }
  }
  ```
  - **エラーメッセージの内容**: 日本語で分かりやすいメッセージ（NFR-204）
  - **システムの安全性**: 標準化されたエラーフォーマット
- **テストの目的**: api-endpoints.mdのエラーレスポンス仕様を検証
  - **品質保証の観点**: フロントエンドとの整合性
- 🔵 この内容は要件定義書（2.2 出力値）とapi-endpoints.mdに基づく

### TC-104: 複数エンドポイントでのレート制限テスト

- **テスト名**: `/convert`と`/regenerate`で共通のレート制限が適用される
  - **エラーケースの概要**: 異なるAIエンドポイントへのアクセスが同一制限を共有するか確認
  - **エラー処理の重要性**: AIエンドポイント全体でのコスト管理
- **入力値**:
  - `/api/v1/ai/convert`にリクエスト → `/api/v1/ai/regenerate`にリクエスト
  - **不正な理由**: 合計2リクエストが10秒以内
  - **実際の発生シナリオ**: ユーザーが変換後すぐに再生成を試みた場合
- **期待される結果**:
  - `/convert`: 200 OK
  - `/regenerate`: 429 Too Many Requests
  - **エラーメッセージの内容**: 同一IPからの全AIエンドポイントへのアクセスをカウント
  - **システムの安全性**: AI APIコストの全体管理
- **テストの目的**: レート制限がAIエンドポイント全体に適用されることを確認
  - **品質保証の観点**: 3.5 API制約（`/api/v1/ai/*`エンドポイント対象）
- 🟡 この内容は要件定義書から妥当な推測

---

## 4. 境界値テストケース

### TC-201: 境界値テスト - ちょうど制限内（1リクエスト）

- **テスト名**: 制限ちょうどのリクエストが許可される
  - **境界値の意味**: 1リクエスト/10秒の制限境界
  - **境界値での動作保証**: 境界値でも正常に処理されることを確認
- **入力値**:
  - ウィンドウ内で1回目のリクエスト
  - **境界値選択の根拠**: 制限値=1の境界
  - **実際の使用場面**: 通常の利用パターン
- **期待される結果**:
  - HTTPステータスコード: 200 OK
  - X-RateLimit-Remaining: 0
  - **境界での正確性**: 1回目のリクエストは必ず許可
  - **一貫した動作**: 制限値ちょうどは許可、超過は拒否
- **テストの目的**: 境界値での正常動作を確認
  - **堅牢性の確認**: 制限値設定が正確であること
- 🔵 この内容は要件定義書（2.1 レート制限設定）に基づく

### TC-202: 境界値テスト - 制限超過（2リクエスト）

- **テスト名**: 制限を1つ超過すると拒否される
  - **境界値の意味**: 制限値+1の境界
  - **境界値での動作保証**: 超過時に確実に429が返ることを確認
- **入力値**:
  - ウィンドウ内で2回目のリクエスト
  - **境界値選択の根拠**: 制限値=1を超える最小値=2
  - **実際の使用場面**: 連続でボタンを押した場合
- **期待される結果**:
  - HTTPステータスコード: 429 Too Many Requests
  - **境界での正確性**: 2回目のリクエストは必ず拒否
  - **一貫した動作**: 境界を超えた瞬間に拒否
- **テストの目的**: 境界超過での動作を確認
  - **堅牢性の確認**: オフバイワンエラーがないこと
- 🔵 この内容は要件定義書（4.1 ユースケース2）に基づく

### TC-203: 境界値テスト - ウィンドウリセット境界（9.9秒 vs 10.1秒）

- **テスト名**: ウィンドウリセットの時間境界テスト
  - **境界値の意味**: 10秒ウィンドウの境界
  - **境界値での動作保証**: 正確に10秒でリセットされることを確認
- **入力値**:
  - パターンA: 1回目リクエスト → 9.9秒待機 → 2回目リクエスト
  - パターンB: 1回目リクエスト → 10.1秒待機 → 2回目リクエスト
  - **境界値選択の根拠**: ウィンドウサイズ=10秒の前後
  - **実際の使用場面**: ユーザーが再試行する際のタイミング
- **期待される結果**:
  - パターンA（9.9秒後）: 429 Too Many Requests
  - パターンB（10.1秒後）: 200 OK
  - **境界での正確性**: ミリ秒単位での正確なウィンドウ管理
  - **一貫した動作**: 10秒未満は拒否、10秒以上は許可
- **テストの目的**: スライディングウィンドウの正確性を確認
  - **堅牢性の確認**: タイミング境界でのレースコンディションがないこと
- 🟡 この内容は要件定義書から妥当な推測（ウィンドウ方式の詳細動作）

### TC-204: 境界値テスト - Retry-After値の範囲

- **テスト名**: Retry-After値が0-10秒の範囲内
  - **境界値の意味**: Retry-Afterヘッダーの値範囲
  - **境界値での動作保証**: 不正な値（負数、10超過）が返されないこと
- **入力値**:
  - 制限超過直後（残り約10秒）
  - 制限超過から9秒経過後（残り約1秒）
  - **境界値選択の根拠**: ウィンドウサイズ内の両端
  - **実際の使用場面**: クライアントの再試行ロジック
- **期待される結果**:
  - `Retry-After: 1` 〜 `Retry-After: 10`の範囲内
  - 負数や10を超える値は返されない
  - **境界での正確性**: 常に妥当な値が返される
  - **一貫した動作**: 時間経過に応じて減少
- **テストの目的**: Retry-Afterヘッダーの値検証
  - **堅牢性の確認**: クライアントが安全に再試行可能
- 🟡 この内容は要件定義書から妥当な推測

---

## 5. エッジケーステスト

### TC-301: X-Forwarded-Forヘッダーテスト

- **テスト名**: プロキシ経由のIPアドレス取得が正しい
  - **何をテストするか**: X-Forwarded-Forヘッダーから実際のクライアントIPを取得できることを確認
  - **期待される動作**: プロキシIPではなく、実際のクライアントIPでレート制限が適用される
- **入力値**:
  - `X-Forwarded-For: 192.168.1.100`ヘッダーを付与したリクエスト
  - **入力データの意味**: ロードバランサー/リバースプロキシ経由のアクセスを模擬
- **期待される結果**:
  - レート制限が192.168.1.100に対して適用される
  - **期待結果の理由**: プロキシ環境での正しいクライアント識別
- **テストの目的**: 本番環境（プロキシ経由）での動作を確認
  - **確認ポイント**: X-Forwarded-Forの最初のIPを使用すること
- 🔵 この内容は要件定義書（4.2 エッジケース3）に基づく

### TC-302: 不正IPフォールバックテスト

- **テスト名**: IPが取得できない場合のフォールバック動作
  - **何をテストするか**: IPアドレスが取得できない/不正な場合のシステム動作
  - **期待される動作**: システムがクラッシュせず、フォールバック動作を行う
- **入力値**:
  - クライアントIPが取得できないリクエスト（モック）
  - **入力データの意味**: 異常なネットワーク状態を模擬
- **期待される結果**:
  - システムは正常に動作を継続
  - デフォルト値（例: "unknown"）でレート制限が適用される
  - **期待結果の理由**: NFR-301（基本機能の継続性）に準拠
- **テストの目的**: 異常状態でのシステム安定性を確認
  - **確認ポイント**: エラーが発生してもAPIは応答を返す
- 🟡 この内容は要件定義書（4.3 エラーケース1）に基づく

### TC-303: 複数X-Forwarded-Forヘッダーテスト

- **テスト名**: 複数IPがX-Forwarded-Forに含まれる場合
  - **何をテストするか**: カンマ区切りで複数IPが指定された場合の処理
  - **期待される動作**: 最初（最左）のIPアドレスが使用される
- **入力値**:
  - `X-Forwarded-For: 192.168.1.100, 10.0.0.1, 172.16.0.1`
  - **入力データの意味**: 複数プロキシを経由したリクエスト
- **期待される結果**:
  - レート制限が192.168.1.100に対して適用される
  - **期待結果の理由**: RFC 7239準拠（最左が元クライアント）
- **テストの目的**: プロキシチェーンでの正しい動作を確認
  - **確認ポイント**: 最初のIPのみを使用すること
- 🟡 この内容は要件定義書から妥当な推測（X-Forwarded-Forの標準仕様）

### TC-304: 高頻度リクエストテスト

- **テスト名**: 大量の連続リクエストでシステムが安定動作
  - **何をテストするか**: 短時間に多数のリクエストが発生した場合のシステム安定性
  - **期待される動作**: 1リクエスト目は成功、以降は429で安定して応答
- **入力値**:
  - 同一IPから100連続リクエスト
  - **入力データの意味**: DoS攻撃的なアクセスパターン
- **期待される結果**:
  - 1リクエスト目: 200 OK
  - 2-100リクエスト目: 429 Too Many Requests
  - システムリソース枯渇なし
  - **期待結果の理由**: レート制限によるシステム保護
- **テストの目的**: 高負荷時のシステム安定性を確認
  - **確認ポイント**: メモリリーク、接続枯渇がないこと
- 🟡 この内容は要件定義書（7.3 エッジケーステスト TC-203）に基づく

### TC-305: 空文字列・特殊文字IPテスト

- **テスト名**: 不正なIP形式でのフォールバック動作
  - **何をテストするか**: 空文字列や特殊文字がIPとして渡された場合の処理
  - **期待される動作**: システムがクラッシュせず、フォールバック処理を行う
- **入力値**:
  - パターンA: `X-Forwarded-For: ""`（空文字列）
  - パターンB: `X-Forwarded-For: "invalid-ip"`（不正形式）
  - パターンC: `X-Forwarded-For: "::1"`（IPv6ループバック）
  - **入力データの意味**: エッジケースのIP値
- **期待される結果**:
  - 全パターンでシステムは正常に動作
  - フォールバック値またはそのまま使用
  - **期待結果の理由**: 堅牢なエラーハンドリング
- **テストの目的**: 入力バリデーションの堅牢性を確認
  - **確認ポイント**: 例外が発生しないこと
- 🔴 この内容は要件定義書にない推測（セキュリティベストプラクティス）

---

## 6. パフォーマンステスト

### TC-401: レート制限チェック遅延テスト

- **テスト名**: レート制限チェックが10ms以内で完了する
  - **何をテストするか**: レート制限ミドルウェアのオーバーヘッドがパフォーマンス要件を満たすことを確認
  - **期待される動作**: レート制限チェック処理が10ms以内で完了
- **入力値**:
  - 正常なリクエスト（レート制限チェックのみ計測）
  - **入力データの意味**: パフォーマンス計測用リクエスト
- **期待される結果**:
  - レート制限チェック遅延: 10ms未満
  - **期待結果の理由**: NFR-002（AI変換の応答時間平均3秒以内）への影響を最小化
- **テストの目的**: パフォーマンス要件（3.1）を満たすことを確認
  - **確認ポイント**: ミドルウェアのオーバーヘッドが許容範囲内
- 🔵 この内容は要件定義書（3.1 パフォーマンス要件）に基づく

---

## 7. 統合テスト

### TC-501: AI変換エンドポイント統合テスト

- **テスト名**: `/api/v1/ai/convert`でレート制限が機能する
  - **何をテストするか**: 実際のAI変換エンドポイントとレート制限ミドルウェアの統合
  - **期待される動作**: AI変換リクエストにレート制限が正しく適用される
- **入力値**:
  - 有効なAI変換リクエスト
  - **入力データの意味**: 実際のユースケースに近いテスト
- **期待される結果**:
  - レート制限ヘッダーが付与される
  - 制限超過時は429が返される
  - **期待結果の理由**: ミドルウェアとエンドポイントの統合動作
- **テストの目的**: 統合環境での動作を確認
  - **確認ポイント**: ミドルウェアがルーターに正しく適用されている
- 🔵 この内容は要件定義書（7.2 統合テスト TC-101）に基づく

### TC-502: AI再生成エンドポイント統合テスト

- **テスト名**: `/api/v1/ai/regenerate`でレート制限が機能する
  - **何をテストするか**: AI再生成エンドポイントとレート制限ミドルウェアの統合
  - **期待される動作**: AI再生成リクエストにレート制限が正しく適用される
- **入力値**:
  - 有効なAI再生成リクエスト
  - **入力データの意味**: 再生成機能のテスト
- **期待される結果**:
  - レート制限ヘッダーが付与される
  - 制限超過時は429が返される
  - **期待結果の理由**: 全AIエンドポイントでの一貫した動作
- **テストの目的**: regenerateエンドポイントでの統合動作を確認
  - **確認ポイント**: convertと同じレート制限が適用される
- 🔵 この内容は要件定義書（7.2 統合テスト TC-102）に基づく

---

## 8. テストケースサマリー

| カテゴリ | テストID | テスト名 | 信頼性 |
|---------|---------|---------|--------|
| 正常系 | TC-001 | 正常リクエストテスト（制限内） | 🔵 |
| 正常系 | TC-002 | X-RateLimitヘッダーテスト | 🔵 |
| 正常系 | TC-003 | 制限リセットテスト | 🔵 |
| 正常系 | TC-004 | IP別制限テスト | 🔵 |
| 正常系 | TC-005 | 非AI系エンドポイント除外テスト | 🔵 |
| 異常系 | TC-101 | レート制限超過テスト | 🔵 |
| 異常系 | TC-102 | Retry-Afterヘッダーテスト | 🔵 |
| 異常系 | TC-103 | エラーレスポンス形式テスト | 🔵 |
| 異常系 | TC-104 | 複数エンドポイントでのレート制限テスト | 🟡 |
| 境界値 | TC-201 | 境界値テスト - ちょうど制限内（1リクエスト） | 🔵 |
| 境界値 | TC-202 | 境界値テスト - 制限超過（2リクエスト） | 🔵 |
| 境界値 | TC-203 | 境界値テスト - ウィンドウリセット境界 | 🟡 |
| 境界値 | TC-204 | 境界値テスト - Retry-After値の範囲 | 🟡 |
| エッジケース | TC-301 | X-Forwarded-Forヘッダーテスト | 🔵 |
| エッジケース | TC-302 | 不正IPフォールバックテスト | 🟡 |
| エッジケース | TC-303 | 複数X-Forwarded-Forヘッダーテスト | 🟡 |
| エッジケース | TC-304 | 高頻度リクエストテスト | 🟡 |
| エッジケース | TC-305 | 空文字列・特殊文字IPテスト | 🔴 |
| パフォーマンス | TC-401 | レート制限チェック遅延テスト | 🔵 |
| 統合 | TC-501 | AI変換エンドポイント統合テスト | 🔵 |
| 統合 | TC-502 | AI再生成エンドポイント統合テスト | 🔵 |

---

## 9. 品質判定

### 判定結果: 高品質

```
テストケース分類: 正常系・異常系・境界値が網羅されている
- 正常系: 5件（基本動作、ヘッダー、リセット、IP分離、除外）
- 異常系: 4件（超過、ヘッダー、レスポンス形式、複数エンドポイント）
- 境界値: 4件（制限内、超過、時間境界、Retry-After範囲）
- エッジケース: 5件（プロキシ、フォールバック、複数IP、高頻度、不正IP）
- パフォーマンス: 1件（遅延テスト）
- 統合: 2件（convert、regenerate）

期待値定義: 各テストケースの期待値が明確
- HTTPステータスコード、ヘッダー値、レスポンスボディを具体的に定義
- 境界値での動作を明示

技術選択: プログラミング言語・テストフレームワークが確定
- Python 3.10+ / pytest + pytest-asyncio + httpx
- 既存テストパターン（test_api/test_health_endpoints.py）に準拠

実装可能性: 現在の技術スタックで実現可能
- slowapi 0.1.9を使用
- 既存のconftest.pyフィクスチャを活用可能
```

---

## 10. 更新履歴

| 日付 | バージョン | 変更内容 |
|-----|----------|---------|
| 2025-11-22 | 1.0.0 | 初版作成（TDDテストケース洗い出しフェーズ） |

---

次のお勧めステップ: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
