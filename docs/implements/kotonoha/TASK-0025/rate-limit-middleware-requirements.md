# TASK-0025: レート制限ミドルウェア実装 - TDD要件定義書

## 1. 機能の概要

### 1.1 機能説明 🔵

レート制限ミドルウェアは、AI変換APIへのリクエスト数を制限し、システムの安定性と公平なリソース配分を確保する機能です。

- **何をする機能か**: AI変換APIエンドポイント（`/api/v1/ai/convert`, `/api/v1/ai/regenerate`）へのリクエストを、IPアドレス単位で制限する
- **どのような問題を解決するか**:
  - 過負荷防止: 同一ユーザーからの大量リクエストによるサービス品質低下を防ぐ
  - コスト管理: 外部AI API呼び出しコストの制御
  - 公平性確保: 全ユーザーに対する均等なサービス提供
- **想定されるユーザー**: kotonohaアプリを利用する発話困難者（アプリのフロントエンドを通じてAPIを呼び出す）
- **システム内での位置づけ**: FastAPIバックエンドのミドルウェア層に配置され、AI変換エンドポイントへのアクセスを制御

**参照したEARS要件**: NFR-101, NFR-002
**参照した設計文書**: api-endpoints.md（レート制限セクション）, architecture.md（エラーハンドリング戦略）

### 1.2 ユーザーストーリー 🟡

```
利用者として、
AI変換機能を適度な頻度で利用したい、
そうすることで、システムが安定して動作し、いつでも必要なときに機能を使えるようになる。

管理者として、
AI変換APIへのリクエスト数を制限したい、
そうすることで、外部AI APIのコストを管理し、サービスの安定性を維持できる。
```

## 2. 入力・出力の仕様

### 2.1 入力パラメータ 🔵

レート制限ミドルウェアは以下の情報を基に制限を適用します:

| パラメータ | 型 | 説明 | 取得元 |
|-----------|---|------|--------|
| `client_ip` | string | クライアントのIPアドレス | `Request.client.host` または `X-Forwarded-For` ヘッダー |
| `endpoint_path` | string | リクエスト先のエンドポイントパス | `Request.url.path` |

**レート制限設定**:

| 設定項目 | 値 | 説明 |
|---------|---|------|
| `rate_limit` | 1リクエスト/10秒/IP | TASK情報に基づく制限値 |
| `window_type` | sliding | スライディングウィンドウ方式 |

### 2.2 出力値 🔵

#### 正常時（レート制限内）

リクエストはそのまま後続のエンドポイントハンドラーに渡され、通常のレスポンスが返される。

**レスポンスヘッダー（追加）**:

| ヘッダー名 | 型 | 説明 |
|-----------|---|------|
| `X-RateLimit-Limit` | integer | 制限回数（例: 1） |
| `X-RateLimit-Remaining` | integer | 残りリクエスト可能回数 |
| `X-RateLimit-Reset` | integer | 制限リセット時刻（UNIXタイムスタンプ） |

#### レート制限超過時 🔵

**HTTPステータスコード**: `429 Too Many Requests`

**レスポンスボディ**:

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "リクエスト数が上限に達しました。しばらく待ってから再試行してください。",
    "status_code": 429,
    "retry_after": 10
  }
}
```

**レスポンスヘッダー**:

| ヘッダー名 | 型 | 説明 |
|-----------|---|------|
| `X-RateLimit-Limit` | integer | 制限回数 |
| `X-RateLimit-Remaining` | integer | 0 |
| `X-RateLimit-Reset` | integer | 制限リセット時刻（UNIXタイムスタンプ） |
| `Retry-After` | integer | 再試行可能までの秒数 |

**参照したEARS要件**: REQ-901, NFR-204（分かりやすいエラーメッセージ）
**参照した設計文書**: api-endpoints.md（HTTPステータスコード、エラーコード一覧）

### 2.3 データフロー 🔵

```
[リクエスト受信]
    ↓
[レート制限ミドルウェア]
    ├─ [IPアドレス取得]
    │      ↓
    ├─ [レート制限カウンター確認]
    │      ↓
    ├─ [制限超過チェック]
    │      ├─ 超過: → [429レスポンス返却]
    │      └─ 未超過: → [カウンターインクリメント]
    │                      ↓
    │                 [レスポンスヘッダー設定]
    │                      ↓
    └──────────────── [後続ハンドラーへ転送]
                           ↓
                     [通常レスポンス返却]
```

## 3. 制約条件

### 3.1 パフォーマンス要件 🔵

| 要件 | 値 | 根拠 |
|-----|---|------|
| レート制限チェック遅延 | 10ms以内 | NFR-002（AI変換の応答時間平均3秒以内）への影響を最小化 |
| メモリ使用量 | IPあたり100bytes以下 | 軽負荷環境（NFR-005）での安定動作 |

**参照したEARS要件**: NFR-002, NFR-005

### 3.2 セキュリティ要件 🔵

| 要件 | 説明 | 根拠 |
|-----|------|------|
| IPスプーフィング対策 | X-Forwarded-Forヘッダーの信頼性検証 | NFR-104（通信セキュリティ） |
| レート制限バイパス防止 | 複数IPからの連続アクセス検知（将来拡張） | 🔴 推測による追加要件 |

**参照したEARS要件**: NFR-104

### 3.3 互換性要件 🔵

| 要件 | 説明 |
|-----|------|
| FastAPI互換 | FastAPI 0.121+との互換性 |
| slowapi互換 | slowapi 0.1.9を使用 |
| Python互換 | Python 3.10+対応 |

**参照した設計文書**: tech-stack.md

### 3.4 アーキテクチャ制約 🔵

| 制約 | 説明 |
|-----|------|
| ミドルウェア配置 | CORSミドルウェアの後、ルーター登録の前 |
| ストレージ | メモリ内カウンター（MVP段階）、将来的にはRedis対応可能 |
| スコープ | AI変換エンドポイントのみに適用 |

**参照した設計文書**: architecture.md

### 3.5 API制約 🔵

| 制約 | 値 | 根拠 |
|-----|---|------|
| レート制限対象 | `/api/v1/ai/*` エンドポイント | api-endpoints.md |
| 制限値 | 1リクエスト/10秒/IP | TASK-0025実装詳細 |

**注意**: api-endpoints.mdでは「1分間に10リクエスト」と記載されていますが、TASK-0025の実装詳細では「1リクエスト/10秒」と指定されています。本要件定義では**TASK-0025の仕様（1リクエスト/10秒）を優先**します。

**参照した設計文書**: api-endpoints.md（レート制限セクション）

## 4. 想定される使用例

### 4.1 基本的な使用パターン 🔵

#### ユースケース1: 正常なAI変換リクエスト

```
1. ユーザーがAI変換をリクエスト（1回目）
2. レート制限チェック → OK
3. カウンターインクリメント（1/1）
4. AI変換実行、結果返却
5. レスポンスヘッダーにX-RateLimit-*情報付与
```

**期待される結果**:
- HTTPステータス: 200 OK
- X-RateLimit-Limit: 1
- X-RateLimit-Remaining: 0
- X-RateLimit-Reset: [現在時刻+10秒のUNIXタイムスタンプ]

#### ユースケース2: レート制限超過

```
1. ユーザーが10秒以内に2回目のAI変換をリクエスト
2. レート制限チェック → NG（制限超過）
3. 429レスポンス返却（Retry-After: 残り秒数）
4. AI変換は実行されない
```

**期待される結果**:
- HTTPステータス: 429 Too Many Requests
- Retry-After: [残り秒数]
- エラーコード: RATE_LIMIT_EXCEEDED

**参照したEARS要件**: REQ-901, REQ-904

### 4.2 エッジケース 🟡

#### エッジケース1: 制限時間経過後のリクエスト

```
1. ユーザーがAI変換をリクエスト（1回目）
2. 10秒以上経過
3. ユーザーがAI変換をリクエスト（2回目）
4. レート制限チェック → OK（制限リセット済み）
5. AI変換実行、結果返却
```

**期待される結果**:
- HTTPステータス: 200 OK
- X-RateLimit-Remaining: 0

#### エッジケース2: 複数IPからのリクエスト 🔵

```
1. IPアドレスAからリクエスト → OK
2. IPアドレスBからリクエスト → OK（別のIPなので制限適用されない）
```

**期待される結果**:
- 両方とも200 OK（IPごとに独立した制限）

#### エッジケース3: プロキシ経由のリクエスト 🟡

```
1. プロキシサーバー経由でリクエスト
2. X-Forwarded-Forヘッダーから実際のクライアントIPを取得
3. クライアントIP単位でレート制限適用
```

**期待される結果**:
- 実際のクライアントIPに基づいて制限が適用される

### 4.3 エラーケース 🟡

#### エラーケース1: 不正なIPアドレス形式

```
1. IPアドレスが取得できない/不正な形式
2. デフォルト値（例: "unknown"）を使用
3. 全未知IPに対して共有の制限を適用
```

**期待される結果**:
- システムはクラッシュせず、フォールバック動作

**参照したEARS要件**: NFR-301（基本機能の継続性）

## 5. EARS要件・設計文書との対応関係

### 5.1 参照したユーザストーリー
- なし（レート制限は非機能要件として定義）

### 5.2 参照した機能要件
- **REQ-901**: AI変換機能（レート制限の対象）
- **REQ-904**: AI変換結果の再生成（レート制限の対象）

### 5.3 参照した非機能要件
- **NFR-002**: AI変換の応答時間を平均3秒以内（レート制限チェックのオーバーヘッド考慮）
- **NFR-005**: 同時に10人以下の利用者数を想定した軽負荷環境で安定動作
- **NFR-101**: 利用者の会話内容を端末内にのみ保存（レート制限ログにはプライバシー配慮）
- **NFR-104**: HTTPS通信、API通信を暗号化
- **NFR-204**: エラーメッセージを分かりやすい日本語で表示
- **NFR-301**: 重大なエラーが発生しても基本機能を継続利用可能

### 5.4 参照したEdgeケース
- **EDGE-001**: ネットワークタイムアウト時のエラーメッセージ表示（参考）
- **EDGE-002**: AI変換APIエラー時のフォールバック処理（参考）

### 5.5 参照した受け入れ基準
- API変換の429エラー時の適切なエラーレスポンス形式

### 5.6 参照した設計文書

| 文書 | 該当セクション |
|-----|--------------|
| architecture.md | エラーハンドリング戦略、セキュリティ・プライバシー設計 |
| api-endpoints.md | レート制限セクション、HTTPステータスコード、エラーコード一覧 |
| tech-stack.md | バックエンド（FastAPI）、セキュリティ |

## 6. 技術的実装方針

### 6.1 使用ライブラリ 🔵

```python
# requirements.txt追加
slowapi==0.1.9
```

**slowapiの選択理由**:
- FastAPIとの統合が容易
- デコレーターベースの簡潔な実装
- メモリ内ストレージ（開発）とRedis（本番）の切り替えが可能
- Retry-Afterヘッダーの自動設定

### 6.2 実装ファイル構成 🔵

```
backend/
├── app/
│   ├── core/
│   │   ├── rate_limit.py       # レート制限設定・Limiter定義
│   │   └── ...
│   ├── api/
│   │   └── v1/
│   │       ├── endpoints/
│   │       │   └── ai.py       # レート制限デコレーター適用
│   │       └── api.py
│   └── main.py                 # レート制限ミドルウェア統合
├── tests/
│   └── test_api/
│       └── test_rate_limit.py  # レート制限テスト
└── requirements.txt            # slowapi追加
```

### 6.3 実装詳細 🔵

#### rate_limit.py

```python
from slowapi import Limiter
from slowapi.util import get_remote_address

# IPアドレス取得関数
def get_client_ip(request):
    # X-Forwarded-For対応
    ...

# Limiter初期化
limiter = Limiter(key_func=get_client_ip)

# AI変換用レート制限（1リクエスト/10秒/IP）
AI_RATE_LIMIT = "1/10seconds"
```

#### エラーハンドラー

```python
from slowapi.errors import RateLimitExceeded

async def rate_limit_exceeded_handler(request, exc):
    return JSONResponse(
        status_code=429,
        content={
            "success": False,
            "data": None,
            "error": {
                "code": "RATE_LIMIT_EXCEEDED",
                "message": "リクエスト数が上限に達しました。しばらく待ってから再試行してください。",
                "status_code": 429,
                "retry_after": exc.retry_after
            }
        },
        headers={
            "Retry-After": str(exc.retry_after)
        }
    )
```

## 7. テストケース概要

### 7.1 単体テスト 🔵

| テストID | テスト名 | 説明 |
|---------|--------|------|
| TC-001 | 正常リクエストテスト | 制限内のリクエストが正常に処理される |
| TC-002 | レート制限超過テスト | 連続リクエストで429エラーが返される |
| TC-003 | Retry-Afterヘッダーテスト | 429レスポンスにRetry-Afterヘッダーが含まれる |
| TC-004 | X-RateLimitヘッダーテスト | レスポンスにX-RateLimit-*ヘッダーが含まれる |
| TC-005 | 制限リセットテスト | 制限時間経過後にリクエストが許可される |
| TC-006 | IP別制限テスト | 異なるIPは独立して制限される |
| TC-007 | エラーレスポンス形式テスト | 429エラーのレスポンス形式が仕様に準拠 |

### 7.2 統合テスト 🟡

| テストID | テスト名 | 説明 |
|---------|--------|------|
| TC-101 | AI変換エンドポイント統合テスト | `/api/v1/ai/convert`でレート制限が機能する |
| TC-102 | AI再生成エンドポイント統合テスト | `/api/v1/ai/regenerate`でレート制限が機能する |
| TC-103 | 非AI系エンドポイント除外テスト | `/health`などはレート制限対象外 |

### 7.3 エッジケーステスト 🟡

| テストID | テスト名 | 説明 |
|---------|--------|------|
| TC-201 | X-Forwarded-Forテスト | プロキシ経由のIPアドレス取得が正しい |
| TC-202 | 不正IPフォールバックテスト | IPが取得できない場合のフォールバック動作 |
| TC-203 | 高頻度リクエストテスト | 大量の連続リクエストでシステムが安定動作 |

## 8. 完了条件

### 8.1 機能完了条件 🔵

- [ ] slowapi==0.1.9がrequirements.txtに追加されている
- [ ] app/core/rate_limit.pyが実装されている
- [ ] Limiter設定が1リクエスト/10秒/IPで設定されている
- [ ] カスタムエラーハンドラーが実装されている
- [ ] app/main.pyにレート制限が統合されている
- [ ] AI変換エンドポイントにレート制限デコレーターが適用されている

### 8.2 テスト完了条件 🔵

- [ ] レート制限動作テストが成功する
- [ ] レート制限エラーレスポンステストが成功する
- [ ] Retry-Afterヘッダーテストが成功する
- [ ] X-RateLimitヘッダーテストが成功する
- [ ] テストカバレッジが90%以上（NFR-502準拠）

### 8.3 品質完了条件 🔵

- [ ] Ruff + Blackによる静的解析がパスする
- [ ] 型ヒントが全ての関数に付与されている
- [ ] docstringがGoogle Styleで記述されている

## 9. 品質判定

### 判定結果: 高品質

```
要件の曖昧さ: なし
- レート制限の対象、制限値、エラーレスポンス形式が明確に定義
- TASK-0025の実装詳細に基づく具体的な仕様

入出力定義: 完全
- 入力パラメータ（IPアドレス）と出力（レスポンスヘッダー、エラーレスポンス）が詳細に定義

制約条件: 明確
- パフォーマンス要件、セキュリティ要件、互換性要件が具体的な数値・条件で定義

実装可能性: 確実
- slowapiライブラリを使用した実装方針が明確
- 既存のFastAPI構造との統合方法が定義
```

## 10. 更新履歴

| 日付 | バージョン | 変更内容 |
|-----|----------|---------|
| 2025-11-22 | 1.0.0 | 初版作成（TDD要件定義フェーズ） |

---

次のステップ: `/tsumiki:tdd-testcases` でテストケースの洗い出しを行います。
