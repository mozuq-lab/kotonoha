# TASK-0064: お気に入り一覧UI実装 - 要件定義書

## 概要

お気に入り一覧画面（FavoritesScreen）の実装を行います。定型文または履歴からお気に入り登録されたテキストを表示し、ユーザーが再読み上げ、削除、並び替えなどの操作を行える機能を提供します。

## 関連要件

### 機能要件
- **REQ-701**: システムは定型文または履歴をお気に入りとして登録する機能を提供しなければならない 🔵
- **REQ-702**: システムはお気に入りをリスト上部に優先表示しなければならない 🔵
- **REQ-703**: システムはお気に入りの並び順を変更できる機能を提供しなければならない 🔵
- **REQ-704**: システムはお気に入り削除時に確認ダイアログを表示しなければならない 🔵

### 非機能要件
- **NFR-004**: システムは定型文一覧の表示（100件程度）を1秒以内に完了しなければならない 🟡
  - お気に入りも同様に100件程度の表示を1秒以内に完了すること

### Edgeケース
- **EDGE-104**: お気に入りが0件の状態でお気に入り画面にアクセスした場合、システムは「お気に入りがありません」というメッセージを表示しなければならない 🟡

## 機能要件詳細（EARS記法）

### 通常要件（SHALL）

#### お気に入り一覧表示機能
- **FR-064-001**: システムはお気に入り一覧画面にすべてのお気に入りを並び順（displayOrder昇順）に表示しなければならない 🔵
  - **根拠**: REQ-702（リスト上部に優先表示）、REQ-703（並び順の変更）

- **FR-064-002**: システムは各お気に入り項目に以下の情報を表示しなければならない 🔵
  - お気に入りのテキスト内容
  - 作成日時（「MM/DD HH:mm」形式）
  - **根拠**: REQ-701、interfaces.dartのFavoriteエンティティ

- **FR-064-003**: システムはお気に入り項目を視認性の高いカード形式で表示しなければならない 🔵
  - タップ領域：最小44px × 44px、推奨60px以上
  - 各カード間に適切な余白を設ける
  - **根拠**: REQ-5001（タップターゲットサイズ）、NFR-202

#### 空状態の表示
- **FR-064-004**: お気に入りが0件の場合、システムは「お気に入りがありません」というメッセージを画面中央に表示しなければならない 🔵
  - **根拠**: EDGE-104

#### スクロール機能
- **FR-064-005**: システムはお気に入り一覧をスクロール可能なリスト（ListView）として実装しなければならない 🔵
  - 100件程度のお気に入りを滑らかにスクロール可能
  - **根拠**: NFR-004（定型文一覧の表示パフォーマンス）

#### お気に入りタップで読み上げ機能
- **FR-064-006**: システムはお気に入り項目をタップすると、その内容を即座に読み上げる機能を提供しなければならない 🔵
  - TTS読み上げ開始まで1秒以内
  - **根拠**: REQ-701（お気に入り登録機能）から類推、REQ-103（定型文の即座読み上げ）のパターン適用

#### お気に入り削除機能
- **FR-064-007**: システムは各お気に入り項目に削除ボタンを表示しなければならない 🔵
  - アイコンボタンまたはスワイプアクション
  - **根拠**: REQ-701（お気に入り登録・削除機能）

- **FR-064-008**: システムはお気に入り項目の削除時に確認ダイアログを表示しなければならない 🔵
  - 「このお気に入りを削除しますか？」メッセージ
  - **根拠**: REQ-704

- **FR-064-009**: システムはお気に入り一覧画面に「全削除」ボタンを提供しなければならない 🟡
  - AppBarのアクションボタンとして配置
  - **根拠**: REQ-604（履歴の全削除）のパターンを適用

- **FR-064-010**: システムは全削除実行時に確認ダイアログを表示しなければならない 🟡
  - 「すべてのお気に入りを削除しますか？」メッセージ
  - **根拠**: REQ-704、REQ-5002（誤操作防止）

#### 並び替え機能（優先表示）
- **FR-064-011**: システムはお気に入りをdisplayOrder昇順でソートして表示しなければならない 🔵
  - displayOrderが小さい順に上から表示
  - **根拠**: REQ-702（リスト上部に優先表示）、REQ-703（並び順変更）

- **FR-064-012**: システムはお気に入りの並び順を変更する機能を提供しなければならない 🔵
  - ドラッグ＆ドロップまたは上下移動ボタン
  - **根拠**: REQ-703

### 条件付き要件（WHEN/IF-THEN）

- **FR-064-013**: ユーザーがお気に入り項目をタップした場合、システムは即座にTTS読み上げを開始しなければならない 🔵
  - 読み上げ中は「停止」ボタンを表示
  - **根拠**: REQ-103（定型文の即座読み上げ）、REQ-403（読み上げ停止機能）

- **FR-064-014**: ユーザーが削除ボタンをタップした場合、システムは確認ダイアログを表示し、「はい」選択時のみ削除を実行しなければならない 🔵
  - **根拠**: REQ-704、REQ-5002

- **FR-064-015**: ユーザーが「全削除」ボタンをタップした場合、システムは確認ダイアログを表示し、「はい」選択時のみ全削除を実行しなければならない 🟡
  - **根拠**: REQ-704、REQ-5002、REQ-2001（全消去時の確認ダイアログ）

### 状態要件（WHERE）

- **FR-064-016**: お気に入りが0件の状態にある場合、システムは空状態メッセージを表示し、削除ボタンを非表示にしなければならない 🔵
  - **根拠**: EDGE-104

- **FR-064-017**: 読み上げが実行中の状態にある場合、システムは該当お気に入り項目に「読み上げ中」インジケーターを表示しなければならない 🟡
  - **根拠**: REQ-3003（読み上げ中は停止ボタン表示）

## 非機能要件

### パフォーマンス要件

- **NFR-064-001**: システムは100件程度のお気に入りを1秒以内に表示しなければならない 🔵
  - 初回ロード時
  - **根拠**: NFR-004（定型文一覧の表示パフォーマンス）

- **NFR-064-002**: システムはお気に入り項目のタップから読み上げ開始まで1秒以内に完了しなければならない 🔵
  - **根拠**: NFR-001（TTS読み上げ開始時間）

- **NFR-064-003**: システムはお気に入り項目の削除操作を即座に（100ms以内）UI上で反映しなければならない 🟡
  - **根拠**: NFR-003（文字盤タップの応答時間パターン）

- **NFR-064-004**: システムはお気に入りの並び替え操作を滑らかにアニメーション表示しなければならない 🟡
  - ドラッグ中のフィードバック表示
  - **根拠**: NFR-201（操作性の高さ）

### ユーザビリティ要件

- **NFR-064-005**: システムはお気に入り項目のタップターゲットを最低44px × 44px、推奨60px以上のサイズで実装しなければならない 🔵
  - **根拠**: REQ-5001、NFR-202

- **NFR-064-006**: システムはお気に入り項目の日時表示を読みやすい形式（「MM/DD HH:mm」）で表示しなければならない 🟡
  - 例: 「11/28 14:30」
  - **根拠**: NFR-204（エラーメッセージの分かりやすさ）、履歴機能のパターン

- **NFR-064-007**: システムはフォントサイズ設定（小/中/大）に応じてお気に入り項目のテキストサイズを調整しなければならない 🔵
  - **根拠**: REQ-801、REQ-802

- **NFR-064-008**: システムは選択されたテーマ（ライト/ダーク/高コントラスト）に応じてお気に入り項目の配色を調整しなければならない 🔵
  - **根拠**: REQ-803、REQ-5006

### アクセシビリティ要件

- **NFR-064-009**: システムはお気に入り項目に適切なセマンティクスラベルを提供しなければならない 🟡
  - スクリーンリーダー対応
  - **根拠**: REQ-803（テーマ設定）、アクセシビリティ配慮

- **NFR-064-010**: システムは高コントラストモードでお気に入り項目の視認性を確保しなければならない 🔵
  - コントラスト比4.5:1以上
  - **根拠**: REQ-5006、REQ-803

## Edgeケース・境界値

### エラー処理

- **EDGE-064-001**: お気に入り読み込みエラー時、システムはエラーメッセージを表示し、再試行オプションを提供しなければならない 🟡
  - 「お気に入りの読み込みに失敗しました」メッセージ
  - **根拠**: NFR-204（エラーメッセージの表示）

- **EDGE-064-002**: TTS読み上げエラー時、システムはエラー通知を表示し、お気に入り項目は選択状態のままにしなければならない 🟡
  - **根拠**: EDGE-004（TTS音声再生エラー）

- **EDGE-064-003**: お気に入り削除エラー時、システムはエラーメッセージを表示し、削除を中止しなければならない 🟡
  - 「削除に失敗しました」メッセージ
  - **根拠**: NFR-204、NFR-304

### 境界値

- **EDGE-064-004**: お気に入りが0件の場合、システムは「お気に入りがありません」メッセージと使い方のヒントを表示しなければならない 🔵
  - 「履歴や定型文からお気に入りを登録できます」などのガイダンス
  - **根拠**: EDGE-104

- **EDGE-064-005**: お気に入り項目の内容が非常に長い場合（500文字以上）、システムは最初の100文字程度を表示し、「...」で省略しなければならない 🟡
  - タップで全文読み上げ
  - **根拠**: EDGE-102（定型文の文字数制限）、EDGE-101パターン

- **EDGE-064-006**: お気に入りが100件を超える場合、システムは警告メッセージを表示し、古いものの削除を促してもよい 🔴
  - 「お気に入りが多くなっています。不要なものを削除することをおすすめします」
  - **根拠**: パフォーマンス維持のための推測

### 異常系・特殊ケース

- **EDGE-064-007**: アプリがバックグラウンドから復帰した場合、システムはお気に入り一覧の状態を復元しなければならない 🟡
  - スクロール位置の保持
  - **根拠**: EDGE-201

- **EDGE-064-008**: 読み上げ中に別のお気に入り項目をタップした場合、システムは現在の読み上げを停止し、新しい項目の読み上げを開始しなければならない 🟡
  - **根拠**: REQ-403（読み上げの停止・中断機能）

- **EDGE-064-009**: OSの音量が0（ミュート）の状態でお気に入り項目をタップした場合、システムは「音量が0です」という視覚的警告を表示しなければならない 🟡
  - **根拠**: EDGE-202

- **EDGE-064-010**: 並び替え中にアプリがクラッシュした場合、システムは復帰時に並び順を元の状態に戻すか、最後に保存した状態を復元しなければならない 🟡
  - **根拠**: NFR-302（アプリクラッシュからの復旧）

## 受け入れ基準（Acceptance Criteria）

### 必須受け入れ基準 🔵

#### AC-064-001: お気に入り一覧表示
- **GIVEN**: お気に入りが5件存在する状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - すべてのお気に入りがdisplayOrder昇順に表示される
  - 各お気に入りに日時、内容が表示される
  - スクロールが可能である
  - 1秒以内に表示が完了する

#### AC-064-002: 空状態の表示
- **GIVEN**: お気に入りが0件の状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - 「お気に入りがありません」メッセージが表示される
  - 削除ボタンが非表示になる

#### AC-064-003: 再読み上げ機能
- **GIVEN**: お気に入り一覧が表示されている状態
- **WHEN**: 任意のお気に入り項目をタップする
- **THEN**:
  - 該当テキストがTTSで読み上げられる
  - 読み上げ開始まで1秒以内である
  - 読み上げ中は「読み上げ中」インジケーターが表示される

#### AC-064-004: 個別削除機能
- **GIVEN**: お気に入り一覧が表示されている状態
- **WHEN**: お気に入り項目の削除ボタンをタップし、確認ダイアログで「はい」を選択する
- **THEN**:
  - 「このお気に入りを削除しますか？」ダイアログが表示される
  - 「はい」選択後、該当お気に入りが削除される
  - 削除後、一覧が即座に更新される

#### AC-064-005: 並び順表示
- **GIVEN**: お気に入りが3件存在し、displayOrderが2, 0, 1の状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - displayOrder昇順（0 → 1 → 2）に表示される
  - 最も小さいdisplayOrderの項目がリスト上部に表示される

#### AC-064-006: パフォーマンス
- **GIVEN**: お気に入りが100件存在する状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - 1秒以内にすべてのお気に入りが表示される
  - スクロールが滑らかである

#### AC-064-007: アクセシビリティ
- **GIVEN**: フォントサイズが「大」に設定されている状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - すべてのテキストが大きく表示される
  - タップ領域が推奨サイズ（60px以上）である

#### AC-064-008: テーマ対応
- **GIVEN**: 高コントラストモードが有効な状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - すべての要素が高コントラスト配色で表示される
  - コントラスト比が4.5:1以上である

### オプション受け入れ基準 🟡

#### AC-064-009: 全削除機能
- **GIVEN**: お気に入りが複数件存在する状態
- **WHEN**: 「全削除」ボタンをタップし、確認ダイアログで「はい」を選択する
- **THEN**:
  - 「すべてのお気に入りを削除しますか？」ダイアログが表示される
  - 「はい」選択後、すべてのお気に入りが削除される
  - 空状態メッセージが表示される

#### AC-064-010: エラーハンドリング
- **GIVEN**: TTS機能がエラーを起こす状態
- **WHEN**: お気に入り項目をタップする
- **THEN**:
  - エラーメッセージが表示される
  - アプリがクラッシュしない

#### AC-064-011: 長文表示
- **GIVEN**: 500文字の長いお気に入りが存在する状態
- **WHEN**: お気に入り画面を開く
- **THEN**:
  - 最初の100文字程度が表示され、「...」で省略される
  - タップすると全文が読み上げられる

## 技術実装要件

### 使用技術
- **Flutter**: 3.38.1
- **状態管理**: Riverpod 2.x
- **データモデル**: 既存の`Favorite`エンティティ（`features/favorite/domain/models/favorite.dart`）
- **状態管理**: 既存の`FavoriteProvider`（`features/favorite/providers/favorite_provider.dart`）

### 実装パターン
- **画面構成**: StatelessWidget + ConsumerWidget
- **リスト表示**: ListView.builder（パフォーマンス最適化）または ReorderableListView（並び替え対応）
- **空状態**: 条件分岐で空状態ウィジェット表示
- **削除確認**: showDialog（AlertDialog）
- **並び替え**: ReorderableListView + onReorder コールバック

### ファイル構成
```
frontend/kotonoha_app/lib/features/
├── favorite/                       # お気に入り機能（既存）
│   ├── domain/
│   │   └── models/
│   │       └── favorite.dart       # 既存
│   └── providers/
│       └── favorite_provider.dart  # 既存
└── favorites/                      # お気に入り画面（更新対象）
    └── presentation/
        ├── favorites_screen.dart   # 更新対象（スケルトン→フル実装）
        └── widgets/
            ├── favorite_item_card.dart     # 新規作成
            └── empty_favorite_widget.dart  # 新規作成
```

### コーディング規約
- Null Safety有効
- `const`コンストラクタを可能な限り使用
- ウィジェットは`key`パラメータを持つ
- コメントにタスクID（TASK-0064）、信頼性レベル（🔵/🟡/🔴）を記載

## 依存関係

### 先行タスク（完了済み）
- TASK-0015: go_routerナビゲーション設定・ルーティング実装（お気に入り画面ルート）
- TASK-0048: TTS読み上げ機能実装（OS標準TTS統合）
- TASK-0054: Hive初期化・セットアップ（ローカルストレージ）
- TASK-0057: Provider構造の整備（Riverpod統合）

### 後続タスク
- TASK-0065: お気に入りの並び替え機能実装（ドラッグ＆ドロップUI）
- TASK-0066: 履歴からお気に入り登録機能（後続実装）

### 既存実装の参考
- **履歴機能**: `frontend/kotonoha_app/lib/features/history/`
  - 履歴画面: `presentation/history_screen.dart`
  - HistoryRepository: `data/history_repository.dart`
  - 一覧表示、削除、再読み上げなどの機能が参考になる

## テスト要件

### 単体テスト
- お気に入り項目ウィジェットの表示テスト
- 空状態ウィジェットの表示テスト
- 日時フォーマットのテスト

### ウィジェットテスト
- お気に入り一覧の表示テスト（5件、100件）
- 空状態の表示テスト（0件）
- displayOrder昇順のソート表示テスト
- タップイベントのテスト（再読み上げ）
- 削除ボタンのテスト（個別削除、全削除）
- 確認ダイアログの表示・動作テスト

### 統合テスト
- お気に入り画面への遷移テスト
- お気に入りの読み込みテスト（Provider連携）
- TTS読み上げ連携テスト
- パフォーマンステスト（100件表示で1秒以内）

### テストカバレッジ目標
- 全体: 80%以上
- ビジネスロジック: 90%以上

## 信頼性レベルサマリー

- 🔵 **青信号**（確実な要件）: FR-064-001〜008, FR-064-011〜014, FR-064-016, NFR-064-001〜003, NFR-064-005, NFR-064-007〜008, NFR-064-010, AC-064-001〜008
  - 要件定義書（REQ-701〜704、EDGE-104）、設計文書（interfaces.dart）に基づく
- 🟡 **黄信号**（妥当な推測）: FR-064-009〜010, FR-064-015, FR-064-017, NFR-064-004, NFR-064-006, NFR-064-009, EDGE-064-001〜010
  - 要件定義書から推測される誤操作防止、エラーハンドリング、履歴機能のパターン適用
- 🔴 **赤信号**（完全な推測）: EDGE-064-006
  - お気に入り上限警告は要件定義書に明記なし

## 参考資料

- 要件定義書: `/Volumes/external/dev/kotonoha/docs/spec/kotonoha-requirements.md`
- インターフェース定義: `/Volumes/external/dev/kotonoha/docs/design/kotonoha/interfaces.dart`
- 既存実装:
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/favorite/domain/models/favorite.dart`
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/favorite/providers/favorite_provider.dart`
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/favorites/presentation/favorites_screen.dart`（現在はスケルトン）
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/history/presentation/history_screen.dart`（参考実装）
