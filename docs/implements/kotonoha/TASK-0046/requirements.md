# TASK-0046: 緊急ボタン2段階確認実装 - 要件定義書

## 概要

緊急ボタンの2段階確認機能を実装・検証する。誤操作を防ぐため、緊急ボタンを1回タップすると確認ダイアログが表示され、ユーザーが「はい」を選択した場合のみ緊急処理が実行される。「いいえ」を選択するか、ダイアログ外をタップしても閉じない仕様で、確実な意思確認を行う。

**タスクタイプ**: TDD
**推定工数**: 4時間

## 関連要件

### 直接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-302 | システムは緊急ボタンを2段階確認（1回目タップ→確認ダイアログ→2回目確認タップ）で動作させなければならない | 🔵 |
| REQ-2004 | ユーザーが緊急ボタンを1回タップした場合、システムは「緊急呼び出しを実行しますか?」という確認ダイアログを表示しなければならない | 🔵 |
| REQ-2005 | 緊急呼び出しの確認ダイアログで「はい」をタップした場合、システムは緊急音を発生させ、画面を緊急表示に切り替えなければならない | 🔵 |
| REQ-5002 | システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない | 🔵 |

### 間接関連要件

| 要件ID | 要件内容 | 信頼性 |
|--------|----------|--------|
| REQ-301 | システムは緊急呼び鈴ボタンをすべての画面で表示しなければならない | 🔵 |
| REQ-303 | システムは緊急ボタン押下時に周囲の人が気づきやすい音を発生させなければならない | 🔵 |
| REQ-304 | システムは緊急ボタン押下時に画面全体を目立つ色（赤など）で表示しなければならない | 🟡 |
| REQ-5001 | システムはタップターゲット（ボタン・キー）のサイズを44px × 44px以上としなければならない | 🟡 |
| REQ-5005 | システムはタップ主体の操作で完結し、スワイプ等のジェスチャーへの依存を避けなければならない | 🔵 |

## 機能要件（EARS記法）

### 通常要件（SHALL）

#### FR-001: 確認ダイアログの表示
- **要件**: システムは緊急ボタンの1回目タップ時に、確認ダイアログを表示しなければならない
- **根拠**: REQ-302、REQ-2004
- **信頼性**: 🔵 青信号

#### FR-002: ダイアログのタイトルとメッセージ
- **要件**: システムは確認ダイアログに「緊急呼び出し」というタイトルと「緊急呼び出しを実行しますか?」というメッセージを表示しなければならない
- **根拠**: REQ-2004
- **信頼性**: 🔵 青信号

#### FR-003: 「はい」「いいえ」ボタン
- **要件**: システムは確認ダイアログに「はい」と「いいえ」の2つのボタンを表示しなければならない
- **根拠**: REQ-302、REQ-2004
- **信頼性**: 🔵 青信号

#### FR-004: 「はい」ボタンの視覚的強調
- **要件**: システムは「はい」ボタンを赤色背景で表示し、緊急性を視覚的に強調しなければならない
- **根拠**: REQ-5002、視覚的一貫性
- **信頼性**: 🔵 青信号

#### FR-005: 「いいえ」ボタンの視覚的区別
- **要件**: システムは「いいえ」ボタンをグレー系背景で表示し、「はい」ボタンと視覚的に区別しなければならない
- **根拠**: REQ-5002、誤操作防止
- **信頼性**: 🟡 黄信号

#### FR-006: ボタンの配置順序
- **要件**: システムは確認ダイアログのボタンを「いいえ」「はい」の順（左→右）で配置しなければならない
- **根拠**: REQ-5002、誤操作防止（誤って「はい」を押しにくくする）
- **信頼性**: 🟡 黄信号

### 条件付き要件（WHEN/IF-THEN）

#### FR-101: 「はい」タップ時の緊急処理実行
- **条件**: 確認ダイアログで「はい」ボタンをタップした場合
- **動作**: システムは以下の処理を実行しなければならない:
  1. 確認ダイアログを閉じる
  2. onEmergencyConfirmedコールバックを呼び出す（緊急処理の実行）
- **根拠**: REQ-2005
- **信頼性**: 🔵 青信号

#### FR-102: 「いいえ」タップ時のキャンセル処理
- **条件**: 確認ダイアログで「いいえ」ボタンをタップした場合
- **動作**: システムは以下の処理を実行しなければならない:
  1. 確認ダイアログを閉じる
  2. 緊急処理を実行しない（通常状態に戻る）
- **根拠**: REQ-302、REQ-5002
- **信頼性**: 🔵 青信号

#### FR-103: ダイアログ外タップ時の動作（誤操作防止）
- **条件**: 確認ダイアログ表示中にダイアログ外をタップした場合
- **動作**: システムはダイアログを閉じてはならない（`barrierDismissible: false`）
- **根拠**: REQ-5002、誤操作防止
- **信頼性**: 🔵 青信号

#### FR-104: 連続タップ時の重複防止
- **条件**: 緊急ボタンが短時間に連続でタップされた場合
- **動作**: システムは最初のタップで確認ダイアログを表示し、ダイアログ表示中は後続のタップを無視しなければならない
- **根拠**: REQ-5002、誤操作防止
- **信頼性**: 🟡 黄信号

#### FR-105: 確認ダイアログ表示中の緊急ボタン無効化
- **条件**: 確認ダイアログが表示されている状態で緊急ボタン領域がタップされた場合
- **動作**: システムはモーダルバリアにより緊急ボタンへのタップを遮断し、複数のダイアログが表示されないようにしなければならない
- **根拠**: REQ-5002、誤操作防止
- **信頼性**: 🟡 黄信号

### 制約要件（MUST）

#### FR-201: 2段階確認の必須化
- **要件**: 緊急ボタンの発動には必ず2段階確認（ボタンタップ→確認ダイアログ→確認タップ）を必須としなければならない
- **根拠**: REQ-302、REQ-5002
- **信頼性**: 🔵 青信号

#### FR-202: タップ操作のみでの完結
- **要件**: 緊急ボタンの操作および確認ダイアログの操作は、タップのみで完結し、スワイプやロングプレスを必須としてはならない
- **根拠**: REQ-5005
- **信頼性**: 🔵 青信号

#### FR-203: ダイアログボタンの最小サイズ
- **要件**: 確認ダイアログの「はい」「いいえ」ボタンは、タップターゲットサイズ44px × 44px以上を確保しなければならない
- **根拠**: REQ-5001
- **信頼性**: 🔵 青信号

### オプション要件（MAY）

#### FR-301: 補足メッセージの表示
- **要件**: システムは確認ダイアログに「周囲に緊急音が鳴り、画面が赤くなります。」という補足メッセージを表示してもよい
- **根拠**: REQ-303、REQ-304、ユーザー理解の促進
- **信頼性**: 🟡 黄信号

#### FR-302: 確認ダイアログのアニメーション
- **要件**: システムは確認ダイアログの表示・非表示時にフェードイン/フェードアウトアニメーションを適用してもよい
- **根拠**: UX向上
- **信頼性**: 🔴 赤信号

## 非機能要件

### パフォーマンス

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-P001 | 緊急ボタンタップから確認ダイアログ表示まで300ms以内 | UX標準 | 🟡 |
| NFR-P002 | 「はい」タップからダイアログ閉じるまで100ms以内 | UX標準 | 🟡 |
| NFR-P003 | 「いいえ」タップからダイアログ閉じるまで100ms以内 | UX標準 | 🟡 |

### ユーザビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-U001 | 確認ダイアログの文言は明確で理解しやすい日本語 | NFR-204 | 🔵 |
| NFR-U002 | 「はい」「いいえ」ボタンは大きく押しやすいサイズ（推奨120px幅以上） | NFR-202、REQ-5001 | 🟡 |
| NFR-U003 | 誤操作しにくいボタン配置（「いいえ」が左、「はい」が右） | REQ-5002 | 🟡 |
| NFR-U004 | 2段階確認の意図（誤操作防止）がユーザーに伝わる設計 | REQ-5002 | 🟡 |

### アクセシビリティ

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-A001 | 確認ダイアログにSemantics「緊急呼び出し確認ダイアログ」を設定 | WCAG、スクリーンリーダー対応 | 🟡 |
| NFR-A002 | 「はい」ボタンのSemanticsに適切なラベルを設定 | WCAG | 🟡 |
| NFR-A003 | 「いいえ」ボタンのSemanticsに適切なラベルを設定 | WCAG | 🟡 |
| NFR-A004 | 高コントラストモードでもボタンと文字の視認性を確保 | REQ-5006 | 🔵 |

### テーマ対応

| 要件ID | 内容 | 根拠 | 信頼性 |
|--------|------|------|--------|
| NFR-T001 | ライトモードで適切な配色（赤:D32F2F、グレー:757575） | REQ-803 | 🔵 |
| NFR-T002 | ダークモードで適切な配色（赤:EF5350、グレー:BDBDBD） | REQ-803 | 🔵 |
| NFR-T003 | 高コントラストモードで適切な配色（赤:FF0000、黒:000000白文字） | REQ-803、REQ-5006 | 🔵 |

## エッジケース・境界値

### エッジケース

#### EDGE-001: 連続タップ防止
- **状況**: ユーザーが緊急ボタンを短時間に複数回タップした場合
- **期待動作**: 最初のタップで確認ダイアログが表示され、ダイアログ表示中は後続タップを無視する
- **信頼性**: 🔵 青信号

#### EDGE-002: ダイアログ表示中の他タップ
- **状況**: 確認ダイアログ表示中にダイアログ外（モーダルバリア）をタップした場合
- **期待動作**: ダイアログは閉じない（`barrierDismissible: false`）
- **信頼性**: 🔵 青信号

#### EDGE-003: 「はい」ボタン連続タップ
- **状況**: 「はい」ボタンを短時間に複数回タップした場合
- **期待動作**: コールバックは1回のみ呼び出され、ダイアログは閉じる
- **信頼性**: 🟡 黄信号

#### EDGE-004: 「いいえ」ボタン連続タップ
- **状況**: 「いいえ」ボタンを短時間に複数回タップした場合
- **期待動作**: ダイアログは1回のみ閉じ、通常状態に戻る
- **信頼性**: 🟡 黄信号

#### EDGE-005: ダイアログ表示中のアプリバックグラウンド化
- **状況**: 確認ダイアログ表示中にアプリがバックグラウンドに移動した場合
- **期待動作**: フォアグラウンド復帰時にダイアログを維持する、または閉じて通常状態に戻る
- **信頼性**: 🟡 黄信号

#### EDGE-006: ダイアログ表示中の画面回転
- **状況**: 確認ダイアログ表示中にデバイスが回転した場合
- **期待動作**: ダイアログを維持し、レイアウトを適切に調整する
- **信頼性**: 🟡 黄信号

### 境界値

| 項目 | 最小値 | 推奨値 | 最大値 |
|------|--------|--------|--------|
| 「はい」ボタン幅 | 100px | 120px | 画面幅の40% |
| 「いいえ」ボタン幅 | 100px | 120px | 画面幅の40% |
| 「はい」ボタン高さ | 44px | 48px | 60px |
| 「いいえ」ボタン高さ | 44px | 48px | 60px |
| ダイアログ表示アニメーション時間 | 100ms | 200ms | 300ms |
| ボタン間の間隔 | 8px | 16px | 24px |

## 受け入れ基準

### 機能テスト

- [ ] AC-001: 緊急ボタン1回目タップで確認ダイアログが表示される
- [ ] AC-002: 確認ダイアログに「緊急呼び出し」タイトルが表示される
- [ ] AC-003: 確認ダイアログに「緊急呼び出しを実行しますか?」メッセージが表示される
- [ ] AC-004: 確認ダイアログに「はい」ボタンが表示される
- [ ] AC-005: 確認ダイアログに「いいえ」ボタンが表示される
- [ ] AC-006: 「はい」タップでonEmergencyConfirmedコールバックが呼び出される
- [ ] AC-007: 「はい」タップで確認ダイアログが閉じる
- [ ] AC-008: 「いいえ」タップで確認ダイアログが閉じる
- [ ] AC-009: 「いいえ」タップでonEmergencyConfirmedコールバックは呼び出されない
- [ ] AC-010: ダイアログ外タップでダイアログが閉じない（誤操作防止）

### 誤操作防止テスト

- [ ] AC-011: 連続タップ時に複数のダイアログが表示されない
- [ ] AC-012: ダイアログ表示中は緊急ボタンへのタップが遮断される
- [ ] AC-013: 「はい」ボタン連続タップでコールバックが1回のみ呼ばれる
- [ ] AC-014: 「いいえ」ボタン連続タップでダイアログが正常に閉じる

### アクセシビリティテスト

- [ ] AC-015: 「はい」ボタンのタップターゲットが44px × 44px以上
- [ ] AC-016: 「いいえ」ボタンのタップターゲットが44px × 44px以上
- [ ] AC-017: 確認ダイアログにSemantics情報が設定されている

### テーマ対応テスト

- [ ] AC-018: ライトモードで「はい」ボタンが赤色で表示される
- [ ] AC-019: ダークモードで「はい」ボタンが明るい赤色で表示される
- [ ] AC-020: 高コントラストモードで適切なコントラスト比が確保されている

### 統合テスト

- [ ] AC-021: 2段階確認フロー全体（ボタンタップ→確認→実行）が正しく動作する
- [ ] AC-022: キャンセルフロー全体（ボタンタップ→確認→キャンセル）が正しく動作する
- [ ] AC-023: タップ操作のみで全操作が完結する

## 技術仕様

### 既存コンポーネント（TASK-0045で実装済み）

| ウィジェット名 | パス | 説明 |
|----------------|------|------|
| `EmergencyButton` | `lib/shared/widgets/emergency_button.dart` | 基本的な緊急ボタン（TASK-0017） |
| `EmergencyButtonWithConfirmation` | `lib/features/emergency/presentation/widgets/emergency_button_with_confirmation.dart` | 確認ダイアログ付き緊急ボタン |
| `EmergencyConfirmationDialog` | `lib/features/emergency/presentation/widgets/emergency_confirmation_dialog.dart` | 緊急呼び出し確認ダイアログ |

### 主要実装ポイント

#### 1. ダイアログ外タップ防止
```dart
await showDialog<void>(
  context: context,
  barrierDismissible: false, // REQ-5002: 誤操作防止
  builder: (dialogContext) {
    return EmergencyConfirmationDialog(
      onConfirm: onConfirm,
      onCancel: onCancel,
    );
  },
);
```

#### 2. 確認後のコールバック実行
```dart
void onConfirm() {
  Navigator.of(context).pop(); // ダイアログを閉じる
  onEmergencyConfirmed();       // 緊急処理を実行
}

void onCancel() {
  Navigator.of(context).pop(); // ダイアログを閉じるのみ
}
```

#### 3. ボタン配色（テーマ対応）
```dart
/// 「はい」ボタン: 赤色（テーマに応じて調整）
/// ライトモード: #D32F2F
/// ダークモード: #EF5350
/// 高コントラスト: #FF0000

/// 「いいえ」ボタン: グレー系（テーマに応じて調整）
/// ライトモード: #757575
/// ダークモード: #BDBDBD
/// 高コントラスト: #000000（白文字）
```

### 確認ダイアログデザイン

```
+------------------------------------------+
|                                          |
|         緊急呼び出し                      |
|                                          |
|   緊急呼び出しを実行しますか?             |
|                                          |
|   周囲に緊急音が鳴り、画面が              |
|   赤くなります。                          |
|                                          |
|   +----------+      +----------+         |
|   |  いいえ  |      |   はい   |         |
|   +----------+      +----------+         |
|   (グレー)           (赤色)              |
|                                          |
+------------------------------------------+

※ ダイアログ外タップでは閉じない
※ 「いいえ」は左側、「はい」は右側（誤操作防止）
```

### 2段階確認フロー図

```
[通常状態]
    |
    v
[緊急ボタンタップ] -----> [確認ダイアログ表示]
                              |
                    +---------+---------+
                    |                   |
                    v                   v
              [「はい」タップ]    [「いいえ」タップ]
                    |                   |
                    v                   v
        [ダイアログ閉じる]     [ダイアログ閉じる]
                    |                   |
                    v                   v
        [onEmergencyConfirmed]   [通常状態に戻る]
                    |
                    v
        [緊急処理実行]
        (後続タスクで実装)
```

## 依存関係

### 依存するタスク（完了済み）

- TASK-0017: 共通UIコンポーネント実装（EmergencyButtonの基本実装） ✅
- TASK-0016: テーマ実装（ライト・ダーク・高コントラスト） ✅
- TASK-0045: 緊急ボタンUI実装（EmergencyButtonWithConfirmation、EmergencyConfirmationDialog） ✅

### 後続タスクへの影響

- TASK-0047: 緊急音再生・画面表示
  - onEmergencyConfirmedコールバックで緊急音再生・画面変更を実行
- TASK-0048: OS標準TTS連携
  - 緊急メッセージの読み上げ機能

## TASK-0045との差分

TASK-0045では基本的なUIコンポーネント（EmergencyButtonWithConfirmation、EmergencyConfirmationDialog）が実装されました。TASK-0046では以下の追加検証・改善を行います:

### 検証項目
1. **誤操作防止の徹底検証**: ダイアログ外タップ、連続タップ、ダイアログ表示中の緊急ボタンタップなど
2. **エッジケースの網羅的テスト**: 画面回転、アプリバックグラウンド化など
3. **アクセシビリティ要件の検証**: タップターゲットサイズ、Semantics設定など
4. **テーマ対応の検証**: 全テーマでの表示確認

### 実装の確認・改善
- 既存実装が要件を満たしているかの確認
- 必要に応じた追加実装・修正

## 備考

- 信頼性レベル凡例:
  - 🔵 **青信号**: 要件定義書に明確に記載された要件
  - 🟡 **黄信号**: 要件定義書から妥当に推測される要件
  - 🔴 **赤信号**: 要件定義書にない推測による要件

- TASK-0045で実装済みのコンポーネントを活用し、2段階確認機能の完成度を高める
- 緊急音再生・画面全体の赤表示は後続タスク（TASK-0047）で実装
- 本タスクは主にテスト・検証に焦点を当て、必要に応じて実装を改善する

---

**ドキュメント作成日**: 2025-11-24
**タスクID**: TASK-0046
**関連要件**: REQ-302, REQ-2004, REQ-2005, REQ-5002
