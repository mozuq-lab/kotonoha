# TASK-0055: 定型文ローカル保存（Hive）テストケース一覧

## 概要

**タスクID**: TASK-0055
**機能名**: 定型文ローカル保存（Hive）
**テストフレームワーク**: flutter_test + Hive Testing + Riverpod
**プログラミング言語**: Dart 3.10+

## 信頼性レベル凡例

- 🔵 **青信号**: 要件定義書・テストケース定義書に基づく確実なテスト
- 🟡 **黄信号**: 要件定義書から妥当な推測によるテスト
- 🔴 **赤信号**: 要件定義書にない推測によるテスト

---

## 1. 正常系テストケース（基本的な動作）

### TC-055-001: Repository経由で定型文を1件保存できる 🔵

- **テスト名**: Repository経由で定型文を1件保存できる
  - **何をテストするか**: PresetPhraseRepository.save()メソッドの基本動作
  - **期待される動作**: 定型文がHive Boxに正しく保存される
- **入力値**:
  ```dart
  PresetPhrase(
    id: 'test-uuid-001',
    content: 'こんにちは',
    category: 'daily',
    isFavorite: false,
    displayOrder: 0,
    createdAt: DateTime(2025, 11, 26, 10, 0),
    updatedAt: DateTime(2025, 11, 26, 10, 0),
  )
  ```
  - **入力データの意味**: 基本的な定型文データ（日常カテゴリ、お気に入りなし）
- **期待される結果**: Hive Boxに保存され、loadAll()で取得可能
  - **期待結果の理由**: REQ-104の定型文追加機能の基本動作
- **テストの目的**: Hive永続化の基本機能確認
  - **確認ポイント**: save()後にloadAll()で取得できること
- **関連要件**: REQ-104, REQ-5003

### TC-055-002: Repository経由で複数の定型文を保存できる 🔵

- **テスト名**: Repository経由で複数の定型文を保存できる
  - **何をテストするか**: saveAll()メソッドによる一括保存
  - **期待される動作**: 複数件の定型文がすべて保存される
- **入力値**: 3件の定型文（daily×2, health×1）
  - **入力データの意味**: 複数カテゴリにまたがる一括保存シナリオ
- **期待される結果**: 3件すべて保存され、カテゴリ別に取得可能
  - **期待結果の理由**: REQ-106のカテゴリ分類と合わせた動作確認
- **テストの目的**: 一括保存機能の確認
  - **確認ポイント**: 全件が正確に保存されること

### TC-055-003: Repository経由で定型文を更新できる 🔵

- **テスト名**: Repository経由で定型文を更新できる
  - **何をテストするか**: save()メソッドによる既存データの上書き更新
  - **期待される動作**: 同じIDのデータが新しい内容で上書きされる
- **入力値**:
  - 初期: `content: '元の内容'`
  - 更新後: `content: '更新後の内容'`
  - **入力データの意味**: 内容変更シナリオ
- **期待される結果**: contentが更新され、件数は増えない
  - **期待結果の理由**: Hiveのput()は同一キーで上書き
- **テストの目的**: 更新機能の確認
  - **確認ポイント**: 件数が変わらず内容のみ更新
- **関連要件**: REQ-104

### TC-055-004: Repository経由で定型文を削除できる 🔵

- **テスト名**: Repository経由で定型文を削除できる
  - **何をテストするか**: delete()メソッドの正常動作
  - **期待される動作**: 指定IDの定型文が削除される
- **入力値**: 削除対象のID `'test-uuid-001'`
  - **入力データの意味**: 削除操作シナリオ
- **期待される結果**: 指定IDのデータがなくなり、件数が1減る
  - **期待結果の理由**: REQ-104の削除機能要件
- **テストの目的**: 削除機能の確認
  - **確認ポイント**: 削除後にget()でnullが返ること
- **関連要件**: REQ-104

### TC-055-005: お気に入りフラグがHiveに正しく保存される 🔵

- **テスト名**: お気に入りフラグがHiveに正しく保存される
  - **何をテストするか**: isFavoriteフィールドの永続化
  - **期待される動作**: true/falseが正確に保存・読み込みされる
- **入力値**: `isFavorite: true` と `isFavorite: false` の2件
  - **入力データの意味**: お気に入り状態の保存テスト
- **期待される結果**: 両方のフラグ値が保持される
  - **期待結果の理由**: REQ-105のお気に入り機能の基盤
- **テストの目的**: bool型フィールドの永続化確認
  - **確認ポイント**: true/falseが混同されないこと
- **関連要件**: REQ-105

### TC-055-006: カテゴリ情報がHiveに正しく保存される 🔵

- **テスト名**: カテゴリ情報がHiveに正しく保存される
  - **何をテストするか**: categoryフィールドの永続化
  - **期待される動作**: 'daily', 'health', 'other'が正確に保存される
- **入力値**: 3種類のカテゴリの定型文各1件
  - **入力データの意味**: REQ-106のカテゴリ分類テスト
- **期待される結果**: カテゴリ別にフィルタリング可能
  - **期待結果の理由**: カテゴリ表示機能の基盤
- **テストの目的**: カテゴリ永続化の確認
  - **確認ポイント**: 3種類すべてが識別可能
- **関連要件**: REQ-106

### TC-055-007: アプリ再起動後も定型文が保持される 🔵

- **テスト名**: アプリ再起動後も定型文が保持される
  - **何をテストするか**: Hiveのディスク永続化機能
  - **期待される動作**: Box close/re-open後もデータが保持される
- **入力値**: 定型文1件を保存後、Boxをclose→re-open
  - **入力データの意味**: アプリ再起動シミュレーション
- **期待される結果**: re-open後に同じデータが取得できる
  - **期待結果の理由**: REQ-5003の永続化要件
- **テストの目的**: データ永続性の確認
  - **確認ポイント**: 全フィールドが完全に復元
- **関連要件**: REQ-5003, NFR-101

### TC-055-008: PresetPhraseNotifierがRepository経由でHiveに保存する 🔵

- **テスト名**: PresetPhraseNotifierがRepository経由でHiveに保存する
  - **何をテストするか**: NotifierとRepositoryの統合動作
  - **期待される動作**: addPhrase()呼び出し時にHiveにも保存される
- **入力値**: `notifier.addPhrase('テスト', 'daily')`
  - **入力データの意味**: UI操作からのデータフロー
- **期待される結果**: 状態更新と同時にHiveにも保存
  - **期待結果の理由**: オフラインファースト設計
- **テストの目的**: Notifier-Repository統合の確認
  - **確認ポイント**: 両方に反映されること

### TC-055-009: loadPhrases()でHiveからデータを読み込む 🔵

- **テスト名**: loadPhrases()でHiveからデータを読み込む
  - **何をテストするか**: Hiveからの読み込み機能
  - **期待される動作**: Hive Box内のデータが状態に反映される
- **入力値**: 事前にHive Boxに3件保存
  - **入力データの意味**: アプリ起動時の読み込みシナリオ
- **期待される結果**: 3件が状態に読み込まれる
  - **期待結果の理由**: アプリ起動時のデータ復元
- **テストの目的**: 読み込み機能の確認
  - **確認ポイント**: 全件が正確に読み込まれること

### TC-055-010: 初回起動時にデフォルト定型文がHiveに保存される 🔵

- **テスト名**: 初回起動時にデフォルト定型文がHiveに保存される
  - **何をテストするか**: initializeDefaultPhrases()のHive保存
  - **期待される動作**: 70件程度のデフォルトデータがHiveに保存される
- **入力値**: 空のHive Box状態でinitializeDefaultPhrases()呼び出し
  - **入力データの意味**: 初回起動シナリオ
- **期待される結果**: DefaultPhrases.totalCount件がHiveに保存
  - **期待結果の理由**: REQ-107の初期データ提供
- **テストの目的**: 初期化とHive永続化の統合確認
  - **確認ポイント**: 件数とカテゴリ分類が正しいこと
- **関連要件**: REQ-107

---

## 2. 異常系テストケース（エラーハンドリング）

### TC-055-011: 存在しないIDで削除しても例外が発生しない 🟡

- **テスト名**: 存在しないIDで削除しても例外が発生しない
  - **エラーケースの概要**: 無効なIDでの削除操作
  - **エラー処理の重要性**: UIからの不正操作への耐性
- **入力値**: `delete('non-existent-id')`
  - **不正な理由**: Hive Boxに存在しないキー
  - **実際の発生シナリオ**: 同時削除操作、キャッシュ不整合
- **期待される結果**: 例外なく正常終了、状態変化なし
  - **エラーメッセージの内容**: なし（サイレント処理）
  - **システムの安全性**: 他データへの影響なし
- **テストの目的**: 堅牢性の確認
  - **品質保証の観点**: EDGE-010対応
- **関連要件**: EDGE-010

### TC-055-012: 存在しないIDで更新しても例外が発生しない 🟡

- **テスト名**: 存在しないIDで更新しても例外が発生しない
  - **エラーケースの概要**: 無効なIDでの更新操作
  - **エラー処理の重要性**: データ整合性の維持
- **入力値**: `save(PresetPhrase(id: 'non-existent-id', ...))`
  - **不正な理由**: 更新対象が存在しない
  - **実際の発生シナリオ**: 同時編集、キャッシュ不整合
- **期待される結果**: 新規保存として処理（Hiveのput動作）
  - **エラーメッセージの内容**: なし
  - **システムの安全性**: 意図しないデータ追加の可能性あり
- **テストの目的**: エッジケース動作の確認
  - **品質保証の観点**: EDGE-009対応
- **関連要件**: EDGE-009

### TC-055-013: Hive Box未オープン時の適切なエラーハンドリング 🟡

- **テスト名**: Hive Box未オープン時の適切なエラーハンドリング
  - **エラーケースの概要**: Hive初期化前のアクセス
  - **エラー処理の重要性**: アプリクラッシュ防止
- **入力値**: Hive.openBox()前にrepository.loadAll()呼び出し
  - **不正な理由**: 初期化順序の問題
  - **実際の発生シナリオ**: 起動シーケンスのバグ
- **期待される結果**: HiveError例外のキャッチ、エラー状態設定
  - **エラーメッセージの内容**: 「データベースの初期化に失敗しました」
  - **システムの安全性**: アプリは継続動作、メモリ内で動作
- **テストの目的**: 初期化エラーへの耐性確認
  - **品質保証の観点**: NFR-304対応
- **関連要件**: NFR-304, EDGE-HIVE-001

### TC-055-014: 書き込みエラー時の状態復元 🟡

- **テスト名**: 書き込みエラー時の状態復元
  - **エラーケースの概要**: Hive書き込み失敗
  - **エラー処理の重要性**: データ整合性の維持
- **入力値**: モックでHiveError例外を発生させる
  - **不正な理由**: ディスクエラー、権限問題等
  - **実際の発生シナリオ**: ストレージ容量不足、権限変更
- **期待される結果**: エラー状態が設定され、UI通知可能
  - **エラーメッセージの内容**: 「保存に失敗しました」
  - **システムの安全性**: 状態とHiveの整合性維持
- **テストの目的**: 書き込みエラーへの耐性確認
  - **品質保証の観点**: EDGE-003, NFR-304対応
- **関連要件**: EDGE-003, NFR-304

---

## 3. 境界値テストケース（最小値、最大値、null等）

### TC-055-015: 空文字の定型文を保存できる 🟡

- **テスト名**: 空文字の定型文を保存できる
  - **境界値の意味**: content最小長（0文字）
  - **境界値での動作保証**: 空文字でも保存可能
- **入力値**: `content: ''`
  - **境界値選択の根拠**: EDGE-102の文字数制限下限
  - **実際の使用場面**: ユーザーが誤って空で保存
- **期待される結果**: 保存成功（バリデーションは別レイヤー）
  - **境界での正確性**: Hive層ではバリデーションなし
  - **一貫した動作**: 保存・読み込みが一致
- **テストの目的**: 最小長の動作確認
  - **堅牢性の確認**: 空文字での予期しない動作なし

### TC-055-016: 500文字の定型文を保存できる 🔵

- **テスト名**: 500文字の定型文を保存できる
  - **境界値の意味**: content最大長（EDGE-102）
  - **境界値での動作保証**: 最大長でも完全に保存
- **入力値**: `content: 'あ' * 500`
  - **境界値選択の根拠**: EDGE-102の文字数制限
  - **実際の使用場面**: 長文の定型文登録
- **期待される結果**: 500文字すべてが保存・読み込み可能
  - **境界での正確性**: 文字欠落なし
  - **一貫した動作**: 保存・読み込みで長さが一致
- **テストの目的**: 最大長の動作確認
  - **堅牢性の確認**: 文字数制限ギリギリでの動作
- **関連要件**: EDGE-102

### TC-055-017: displayOrder最大値での保存 🟡

- **テスト名**: displayOrder最大値での保存
  - **境界値の意味**: int型の上限付近
  - **境界値での動作保証**: 大きな値でも正確に保存
- **入力値**: `displayOrder: 9999`
  - **境界値選択の根拠**: 大量の定型文登録シナリオ
  - **実際の使用場面**: 長期利用でのデータ蓄積
- **期待される結果**: 値が正確に保存・読み込み
  - **境界での正確性**: int型オーバーフローなし
  - **一貫した動作**: 保存・読み込みで値が一致
- **テストの目的**: 数値型境界値の確認
  - **堅牢性の確認**: 大きな数値での動作

### TC-055-018: 0件の状態でloadAll()を呼び出す 🔵

- **テスト名**: 0件の状態でloadAll()を呼び出す
  - **境界値の意味**: データなし状態
  - **境界値での動作保証**: 空リストが返る
- **入力値**: 空のHive Box
  - **境界値選択の根拠**: 初回起動、全削除後
  - **実際の使用場面**: 新規インストール直後
- **期待される結果**: 空のList<PresetPhrase>が返る
  - **境界での正確性**: nullではなく空リスト
  - **一貫した動作**: 例外なく正常終了
- **テストの目的**: 空データでの動作確認
  - **堅牢性の確認**: null参照エラーなし
- **関連要件**: EDGE-104

### TC-055-019: 100件の定型文を一括保存・読み込み 🟡

- **テスト名**: 100件の定型文を一括保存・読み込み
  - **境界値の意味**: REQ-107の上限値
  - **境界値での動作保証**: パフォーマンス要件内で動作
- **入力値**: 100件のPresetPhrase
  - **境界値選択の根拠**: REQ-107の「50-100個程度」
  - **実際の使用場面**: 初期データ投入
- **期待される結果**: 全件が1秒以内に保存・読み込み
  - **境界での正確性**: 全件が正確に保存
  - **一貫した動作**: NFR-004のパフォーマンス要件内
- **テストの目的**: 大量データでの動作確認
  - **堅牢性の確認**: パフォーマンス劣化なし
- **関連要件**: REQ-107, NFR-004

### TC-055-020: DateTime境界値（極端な日付）での保存 🟡

- **テスト名**: DateTime境界値（極端な日付）での保存
  - **境界値の意味**: createdAt/updatedAtの極端な値
  - **境界値での動作保証**: 日付が正確に保存される
- **入力値**:
  - `createdAt: DateTime(1970, 1, 1)`
  - `updatedAt: DateTime(2099, 12, 31)`
  - **境界値選択の根拠**: DateTimeの一般的な使用範囲
  - **実際の使用場面**: システム日付異常、データ移行
- **期待される結果**: 日付が正確に保存・読み込み
  - **境界での正確性**: ミリ秒単位での一致
  - **一貫した動作**: タイムゾーン問題なし
- **テストの目的**: 日付型境界値の確認
  - **堅牢性の確認**: 極端な日付での動作

---

## 4. 統合テストケース

### TC-055-021: CRUD操作の完全サイクル 🔵

- **テスト名**: CRUD操作の完全サイクル
  - **何をテストするか**: Create→Read→Update→Delete の一連の流れ
  - **期待される動作**: 各操作が正常に実行され、Hiveに反映
- **入力値**: 定型文の作成、読み込み、更新、削除の順
- **期待される結果**: 各段階で状態とHiveが一致
- **テストの目的**: エンドツーエンドの動作確認
- **関連要件**: REQ-104

### TC-055-022: お気に入り切替のHive同期 🔵

- **テスト名**: お気に入り切替のHive同期
  - **何をテストするか**: toggleFavorite()後のHive永続化
  - **期待される動作**: お気に入り状態がHiveに保存される
- **入力値**: `notifier.toggleFavorite(id)`
- **期待される結果**: Hive内のisFavoriteが更新される
- **テストの目的**: 状態変更のHive同期確認
- **関連要件**: REQ-105, CRUD-007

### TC-055-023: アプリ再起動後のお気に入りソート順維持 🔵

- **テスト名**: アプリ再起動後のお気に入りソート順維持
  - **何をテストするか**: 再起動後もお気に入り優先表示が維持される
  - **期待される動作**: loadPhrases()後にお気に入りが上部に表示
- **入力値**: お気に入り登録後、Box close→re-open→loadPhrases()
- **期待される結果**: お気に入りが一覧上部に表示される
- **テストの目的**: REQ-105の永続化確認
- **関連要件**: REQ-105

---

## 5. モック戦略

### Repository モック

```dart
import 'package:mocktail/mocktail.dart';

class MockPresetPhraseRepository extends Mock implements PresetPhraseRepository {}
```

### 使用パターン

```dart
late MockPresetPhraseRepository mockRepository;

setUp(() {
  mockRepository = MockPresetPhraseRepository();

  // デフォルト動作設定
  when(() => mockRepository.loadAll())
      .thenAnswer((_) async => []);
  when(() => mockRepository.save(any()))
      .thenAnswer((_) async {});
  when(() => mockRepository.delete(any()))
      .thenAnswer((_) async {});
});
```

### エラーシミュレーション

```dart
// Hive書き込みエラーをシミュレート
when(() => mockRepository.save(any()))
    .thenThrow(HiveError('Storage full'));
```

---

## 6. テスト実装ファイル構成

| ファイルパス | 内容 |
|------------|------|
| `test/features/preset_phrase/data/preset_phrase_repository_test.dart` | Repository単体テスト |
| `test/features/preset_phrase/providers/preset_phrase_notifier_hive_test.dart` | Notifier+Hive統合テスト |
| `test/mocks/mock_preset_phrase_repository.dart` | Repositoryモック |

---

## 7. セットアップ・クリーンアップパターン

```dart
void main() {
  late Directory tempDir;
  late Box<PresetPhrase> presetBox;
  late PresetPhraseRepository repository;

  setUp(() async {
    // 【テスト前準備】: Hive環境を初期化
    // 【環境初期化】: 各テストが独立して実行できるよう、クリーンな状態から開始
    await Hive.close();
    tempDir = await Directory.systemTemp.createTemp('hive_test_');
    Hive.init(tempDir.path);

    // TypeAdapter登録（重複登録回避）
    if (!Hive.isAdapterRegistered(1)) {
      Hive.registerAdapter(PresetPhraseAdapter());
    }

    presetBox = await Hive.openBox<PresetPhrase>('test_presetPhrases');
    repository = PresetPhraseRepository(box: presetBox);
  });

  tearDown(() async {
    // 【テスト後処理】: Hiveボックスをクローズし、ディスクから削除
    // 【状態復元】: 次のテストに影響しないよう、テストデータを削除
    await presetBox.close();
    await Hive.deleteBoxFromDisk('test_presetPhrases');
    await Hive.close();

    if (tempDir.existsSync()) {
      await tempDir.delete(recursive: true);
    }
  });
}
```

---

## 8. 品質判定

### ✅ 高品質

- **テストケース分類**: 正常系（10件）、異常系（4件）、境界値（6件）、統合（3件）= 計23件
- **期待値定義**: 各テストケースの期待値が明確に定義されている
- **技術選択**: flutter_test + Hive Testing + mocktail で確定
- **実装可能性**: 既存のテストパターン（TASK-0014, TASK-0041）に基づき実現可能

---

## 9. 次のステップ

次のお勧めステップ: `/tsumiki:tdd-red` でRedフェーズ（失敗テスト作成）を開始します。
