# TASK-0073: テーマ切り替えUI・適用 テストケース定義書

## 開発言語・フレームワーク

- **プログラミング言語**: Dart
  - **言語選択の理由**: Flutter アプリケーションの開発言語
  - **テストに適した機能**: Null Safety、強い型付け、非同期テストサポート
- **テストフレームワーク**: flutter_test + flutter_riverpod
  - **フレームワーク選択の理由**: Flutter 公式テストフレームワーク、Riverpod の状態管理テスト対応
  - **テスト実行環境**: Flutter テストランナー（`flutter test`）
- 🔵 青信号: `docs/tech-stack.md` で定義された技術スタック

---

## テストケース概要

| カテゴリ | テストケース数 | 対応要件 |
|---------|---------------|---------|
| 正常系 | 8 | REQ-803, REQ-2008, REQ-5003 |
| 異常系 | 2 | NFR-301, EDGE-201 |
| 境界値 | 3 | REQ-803, REQ-5006 |
| **合計** | **13** | |

---

## 1. 正常系テストケース（基本動作）

### TC-073-001: 設定画面でテーマ選択UIが表示される

- **テスト名**: テーマ選択UI表示テスト
  - **何をテストするか**: 設定画面にテーマ選択UIが表示されること
  - **期待される動作**: 「テーマ」ラベルと3つの選択肢（ライト/ダーク/高コントラスト）が表示される
- **入力値**: なし（設定画面を表示）
  - **入力データの意味**: ユーザーが設定画面を開いた状態
- **期待される結果**: ThemeSettingsWidget が表示される
  - **期待結果の理由**: TASK-0071 で実装済みのUIが正常に動作することを確認
- **テストの目的**: REQ-803 の UI 部分の確認
  - **確認ポイント**: セグメントボタンが3つ表示される
- 🔵 青信号: REQ-803「3つのテーマを提供」

### TC-073-002: テーマ「ライト」の選択と適用

- **テスト名**: ライトテーマ選択テスト
  - **何をテストするか**: テーマ「ライト」が正しく選択・適用されること
  - **期待される動作**: theme = light が状態に保存され、UIに反映される
- **入力値**: AppTheme.light
  - **入力データの意味**: ユーザーが「ライト」を選択
- **期待される結果**: settings.theme == AppTheme.light
  - **期待結果の理由**: REQ-803 の3種類選択
- **テストの目的**: 3種類選択の網羅（ライト）
  - **確認ポイント**: 状態更新と永続化が正常に動作する
- 🔵 青信号: REQ-803「ライトモード」

### TC-073-003: テーマ「ダーク」の選択と適用

- **テスト名**: ダークテーマ選択テスト
  - **何をテストするか**: テーマ「ダーク」が正しく選択・適用されること
  - **期待される動作**: theme = dark が状態に保存され、UIに反映される
- **入力値**: AppTheme.dark
  - **入力データの意味**: ユーザーが「ダーク」を選択
- **期待される結果**: settings.theme == AppTheme.dark
  - **期待結果の理由**: REQ-803 の3種類選択
- **テストの目的**: 3種類選択の網羅（ダーク）
  - **確認ポイント**: 状態更新と永続化が正常に動作する
- 🔵 青信号: REQ-803「ダークモード」

### TC-073-004: テーマ「高コントラスト」の選択と適用

- **テスト名**: 高コントラストテーマ選択テスト
  - **何をテストするか**: テーマ「高コントラスト」が正しく選択・適用されること
  - **期待される動作**: theme = highContrast が状態に保存され、UIに反映される
- **入力値**: AppTheme.highContrast
  - **入力データの意味**: 視覚障害のあるユーザーが「高コントラスト」を選択
- **期待される結果**: settings.theme == AppTheme.highContrast
  - **期待結果の理由**: REQ-803 の3種類選択
- **テストの目的**: 3種類選択の網羅（高コントラスト）
  - **確認ポイント**: 状態更新と永続化が正常に動作する
- 🔵 青信号: REQ-803「高コントラストモード」

### TC-073-005: テーマ変更が即座に反映される

- **テスト名**: テーマ即座反映テスト
  - **何をテストするか**: 設定変更後すぐにUIに反映されること
  - **期待される動作**: setTheme() 呼び出し直後に state が更新される
- **入力値**: setTheme(AppTheme.dark)
  - **入力データの意味**: ユーザーがテーマを変更した操作
- **期待される結果**: 楽観的更新で即座に state が更新される
  - **期待結果の理由**: REQ-2008「即座にすべての画面の配色を変更」
- **テストの目的**: REQ-2008 の即座反映確認
  - **確認ポイント**: await 完了後に state.theme が更新されている
- 🔵 青信号: REQ-2008「テーマ変更時に即座に変更」

### TC-073-006: アプリ再起動後のテーマ設定復元

- **テスト名**: テーマ設定復元テスト
  - **何をテストするか**: アプリ再起動後に保存したテーマが復元されること
  - **期待される動作**: SharedPreferences に保存した値が build() で読み込まれる
- **入力値**: SharedPreferences に theme = dark.index を保存
  - **入力データの意味**: 前回セッションで「ダーク」を選択した状態
- **期待される結果**: settings.theme == AppTheme.dark
  - **期待結果の理由**: REQ-5003「アプリ強制終了しても設定を失わない」
- **テストの目的**: REQ-5003 の永続化確認
  - **確認ポイント**: 保存値が正しく復元される
- 🔵 青信号: REQ-5003「永続化機構を実装」

### TC-073-007: currentThemeProviderがテーマ変更に追従する

- **テスト名**: currentThemeProvider追従テスト
  - **何をテストするか**: テーマ変更時にcurrentThemeProviderが正しいThemeDataを返すこと
  - **期待される動作**: setTheme(dark) → currentThemeProvider が darkTheme を返す
- **入力値**: setTheme(AppTheme.dark)
  - **入力データの意味**: テーマをダークに変更
- **期待される結果**: currentThemeProvider の値が darkTheme と一致
  - **期待結果の理由**: テーマプロバイダーが設定と連携していることを確認
- **テストの目的**: Provider間の連携確認
  - **確認ポイント**: ThemeDataが正しく切り替わる
- 🔵 青信号: REQ-803、REQ-2008

### TC-073-008: デフォルトテーマ（ライト）でのHomeScreen表示

- **テスト名**: デフォルトテーマHomeScreen表示テスト
  - **何をテストするか**: デフォルト設定（テーマ「ライト」）でHomeScreenが正常に表示されること
  - **期待される動作**: ライトテーマでHomeScreenが表示される
- **入力値**: デフォルト設定
  - **入力データの意味**: 初回起動時のデフォルト状態
- **期待される結果**: HomeScreenが正常に表示される
  - **期待結果の理由**: デフォルト設定での動作保証
- **テストの目的**: 基本動作の確認
  - **確認ポイント**: HomeScreenの主要ウィジェットが表示される
- 🔵 青信号: REQ-803（デフォルトはライト）

---

## 2. 異常系テストケース（エラーハンドリング）

### TC-073-009: 設定読み込み中のデフォルトテーマ使用

- **テスト名**: 設定読み込み中フォールバックテスト
  - **エラーケースの概要**: 設定の非同期読み込み中にUIが表示される場合
  - **エラー処理の重要性**: ローディング中もアプリが動作する必要がある
- **入力値**: settingsNotifierProvider が AsyncLoading 状態
  - **不正な理由**: まだ設定が読み込まれていない
  - **実際の発生シナリオ**: アプリ起動直後、SharedPreferences 読み込み中
- **期待される結果**: デフォルトテーマ（ライト）でUIが表示される
  - **エラーメッセージの内容**: なし（正常動作）
  - **システムの安全性**: ローディング中もUIが崩れない
- **テストの目的**: ローディング状態のハンドリング確認
  - **品質保証の観点**: UX を損なわない非同期処理
- 🟡 黄信号: EDGE-201、NFR-301 から推測

### TC-073-010: 不正な保存値のフォールバック

- **テスト名**: 不正値フォールバックテスト
  - **エラーケースの概要**: SharedPreferences に不正な値が保存されている場合
  - **エラー処理の重要性**: 設定ファイルの破損時もアプリが起動する必要がある
- **入力値**: SharedPreferences に theme = 99（範囲外の値）を保存
  - **不正な理由**: AppTheme enum の範囲外（0-2）
  - **実際の発生シナリオ**: 設定ファイル破損、古いバージョンからのアップグレード
- **期待される結果**: デフォルト値（ライト）にフォールバック
  - **エラーメッセージの内容**: なし（サイレントフォールバック）
  - **システムの安全性**: 不正値でもアプリがクラッシュしない
- **テストの目的**: 防御的プログラミングの確認
  - **品質保証の観点**: 堅牢性の確保
- 🟡 黄信号: NFR-301「基本機能継続」から推測

---

## 3. 境界値テストケース

### TC-073-011: AppTheme enum の最小値（light = 0）

- **テスト名**: AppTheme 最小値テスト
  - **境界値の意味**: enum の最初の値（index = 0）
  - **境界値での動作保証**: 最小値でも正常に動作する
- **入力値**: AppTheme.light (index = 0)
  - **境界値選択の根拠**: enum の最小インデックス
  - **実際の使用場面**: デフォルト設定
- **期待される結果**: theme = light が正常に保存・復元される
  - **境界での正確性**: SharedPreferences に 0 が保存される
  - **一貫した動作**: 他の値と同様に動作する
- **テストの目的**: 境界値（最小）の動作確認
  - **堅牢性の確認**: インデックス 0 でも正常動作
- 🔵 青信号: REQ-803 の3種類（最小）

### TC-073-012: AppTheme enum の最大値（highContrast = 2）

- **テスト名**: AppTheme 最大値テスト
  - **境界値の意味**: enum の最後の値（index = 2）
  - **境界値での動作保証**: 最大値でも正常に動作する
- **入力値**: AppTheme.highContrast (index = 2)
  - **境界値選択の根拠**: enum の最大インデックス
  - **実際の使用場面**: 視覚障害のあるユーザー
- **期待される結果**: theme = highContrast が正常に保存・復元される
  - **境界での正確性**: SharedPreferences に 2 が保存される
  - **一貫した動作**: 他の値と同様に動作する
- **テストの目的**: 境界値（最大）の動作確認
  - **堅牢性の確認**: インデックス 2 でも正常動作
- 🔵 青信号: REQ-803 の3種類（最大）

### TC-073-013: 高コントラストモードのコントラスト比検証

- **テスト名**: WCAG 2.1 AAコントラスト比テスト
  - **境界値の意味**: アクセシビリティ基準（4.5:1以上）
  - **境界値での動作保証**: 視覚障害者が読みやすいコントラストを確保
- **入力値**: highContrastTheme の colorScheme
  - **境界値選択の根拠**: WCAG 2.1 AAレベルの基準値
  - **実際の使用場面**: 視覚障害のあるユーザーがアプリを使用
- **期待される結果**: 背景色と前景色のコントラスト比が4.5:1以上
  - **境界での正確性**: #FFFFFF と #000000 は 21:1（基準を大幅に上回る）
  - **一貫した動作**: 全テキスト要素で基準を満たす
- **テストの目的**: REQ-5006 のWCAG準拠確認
  - **堅牢性の確認**: アクセシビリティ要件を満たす
- 🟡 黄信号: REQ-5006「WCAG 2.1 AAレベル」

---

## テストファイル構成

```
test/features/settings/
├── providers/
│   ├── settings_provider_test.dart           # 既存（TC-001〜TC-016）
│   ├── settings_provider_font_size_test.dart # 既存（TASK-0072）
│   └── settings_provider_theme_test.dart     # 新規（TC-073-001〜TC-073-013）
├── presentation/
│   ├── settings_screen_test.dart             # 既存
│   └── widgets/
│       └── theme_settings_widget_test.dart   # 新規（UIテスト）
└── integration/
    └── theme_application_test.dart           # 新規（アプリ全体への反映テスト）
```

---

## 品質判定

✅ **高品質**

| 基準 | 状態 |
|------|------|
| テストケース分類 | 正常系8件、異常系2件、境界値3件 で網羅 |
| 期待値定義 | 各テストケースの期待値が具体的に定義済み |
| 技術選択 | flutter_test + flutter_riverpod で確定 |
| 実装可能性 | 既存のテストパターンを踏襲可能 |

---

**次のステップ**: TDD Redフェーズ（失敗テスト作成）を開始します。
