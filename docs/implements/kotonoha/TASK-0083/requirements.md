# TASK-0083 定型文E2Eテスト TDD要件定義書

## 概要

- **タスクID**: TASK-0083
- **タスク名**: 定型文E2Eテスト
- **タスクタイプ**: TDD
- **作成日時**: 2025-11-29
- **関連要件**: REQ-101, REQ-102, REQ-103, REQ-104, REQ-105, REQ-106, REQ-107, NFR-004
- **依存タスク**: TASK-0081 (E2Eテスト環境構築) - 完了済み

## タスクの目的

このタスクは、kotonohaアプリの定型文機能に関するエンドツーエンド（E2E）テストを実装し、以下を保証することを目的とします。

1. **機能正常性**: 定型文の表示・選択・即座読み上げが正しく動作すること
2. **パフォーマンス**: NFR-004（100件表示1秒以内）を満たすこと
3. **ユーザビリティ**: お気に入り優先表示、カテゴリ分類が正しく機能すること
4. **データ管理**: 定型文のCRUD操作（作成・読み取り・更新・削除）が正常動作すること
5. **信頼性**: 境界値（0件、100件）や異常系でも安定動作すること

---

## 機能要件の詳細

### 1. 定型文表示機能 (REQ-101, REQ-105, REQ-106, REQ-107)

#### REQ-101: 定型文を一覧表示

- **要件内容**: システムは定型文を一覧表示しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-2で明確）
- **受け入れ基準**:
  - 登録済みの定型文がリスト形式で表示される
  - 各定型文がタップ可能なボタンとして表示される
  - ボタンサイズが最小44px × 44px以上（REQ-5001）
- **E2Eテストでの確認ポイント**:
  - 定型文一覧画面が正しく表示されること
  - すべての定型文がタップ可能であること

#### REQ-105: お気に入り定型文を一覧上部に優先表示

- **要件内容**: システムはお気に入り定型文を一覧上部に優先表示しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-2で明確）
- **受け入れ基準**:
  - お気に入りに登録された定型文が一覧の最上部に表示される
  - お気に入りマーク（星アイコンなど）が視覚的に表示される
  - お気に入りの順序は登録順または並び順設定に従う
- **E2Eテストでの確認ポイント**:
  - お気に入り定型文が一覧の上部に表示されること
  - お気に入りマークが表示されること

#### REQ-106: 定型文をカテゴリで分類

- **要件内容**: システムは定型文を2-3種類のシンプルなカテゴリ（「日常」「体調」「その他」など）で分類しなければならない
- **信頼性レベル**: 🔵 青信号（ユーザヒアリングで明確）
- **受け入れ基準**:
  - 定型文がカテゴリごとにグループ化される
  - カテゴリ名が視認しやすく表示される
  - カテゴリ間の切り替えが容易である
- **E2Eテストでの確認ポイント**:
  - カテゴリごとに定型文が分類されていること
  - カテゴリの切り替えが動作すること

#### REQ-107: 初期データとして汎用的な定型文サンプルを提供

- **要件内容**: システムは50-100個程度の汎用的な定型文サンプルを初期データとして提供しなければならない
- **信頼性レベル**: 🔵 青信号（ユーザヒアリングで明確）
- **受け入れ基準**:
  - アプリ初回起動時に50-100個の定型文が準備されている
  - 日常生活、体調管理に関連する汎用的な定型文が含まれる
  - 各定型文が適切なカテゴリに分類されている
- **E2Eテストでの確認ポイント**:
  - 初期状態で50件以上の定型文が表示されること
  - 各カテゴリに定型文が含まれること

### 2. 定型文選択・読み上げ機能 (REQ-102, REQ-103)

#### REQ-102: 定型文をタップすると入力欄に反映

- **要件内容**: システムは定型文をタップすると入力欄に反映する機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-2で明確）
- **受け入れ基準**:
  - 定型文をタップすると、文字盤画面の入力欄に定型文が反映される
  - 入力欄の内容は上書きされる（既存の内容は消去される）
  - 入力欄に反映後、読み上げボタンで読み上げ可能
- **E2Eテストでの確認ポイント**:
  - 定型文タップで入力欄に反映されること
  - その後読み上げができること

#### REQ-103: 定型文を直接タップで即座に読み上げ

- **要件内容**: システムは定型文を直接タップで即座に読み上げる機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-2で明確）
- **受け入れ基準**:
  - 定型文をタップすると、読み上げボタンを押すことなく即座にTTSで読み上げられる
  - タップから読み上げ開始まで1秒以内（NFR-001）
  - 読み上げ中は停止ボタンが表示される
- **E2Eテストでの確認ポイント**:
  - 定型文タップで即座に読み上げが開始されること
  - 読み上げ中に停止ボタンが表示されること

### 3. 定型文CRUD操作 (REQ-104)

#### REQ-104: 定型文の追加・編集・削除機能

- **要件内容**: システムは定型文の追加・編集・削除機能を提供しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 5-1-2で明確）
- **受け入れ基準**:
  - **追加**: 新規定型文を作成できる（テキスト、カテゴリ、お気に入りフラグを設定）
  - **編集**: 既存定型文の内容、カテゴリ、お気に入りフラグを変更できる
  - **削除**: 定型文を削除できる（確認ダイアログ付き）
  - すべての操作がローカルストレージ（Hive）に永続化される
- **E2Eテストでの確認ポイント**:
  - 新規定型文を追加できること
  - 定型文を編集できること
  - 定型文を削除できること（確認ダイアログ付き）
  - アプリ再起動後も変更が保持されること

---

## 非機能要件の詳細

### 1. パフォーマンス要件

#### NFR-004: 定型文一覧の表示（100件程度）を1秒以内に完了

- **要件内容**: システムは定型文一覧の表示（100件程度）を1秒以内に完了しなければならない
- **信頼性レベル**: 🟡 黄信号（mvp-requirements-original.md 6-2から推測）
- **受け入れ基準**:
  - 定型文画面への遷移から一覧表示完了まで1秒（1000ms）以内
  - 100件以上の定型文でもスクロールが滑らか
  - キャッシュ機能により2回目以降の表示が高速化される
- **E2Eテストでの計測方法**:
  - Stopwatchを使用して画面遷移から表示完了までの時間を計測
  - 100件の定型文を準備して計測
  - 複数回計測して平均値が1秒以内であることを確認

### 2. ユーザビリティ要件

#### NFR-201: 主要な操作を3タップ以内で完了

- **要件内容**: システムは主要な操作（文字入力、定型文選択、読み上げ）を3タップ以内で完了できなければならない
- **信頼性レベル**: 🟡 黄信号（mvp-requirements-original.md 3から具体化）
- **受け入れ基準**:
  - 定型文即座読み上げ: 1タップ（定型文タップのみ）
  - 定型文選択→読み上げ: 2タップ（定型文タップ→読み上げボタン）
  - 定型文追加: 3タップ以内（追加ボタン→入力→保存）
- **E2Eテストでの確認ポイント**:
  - 操作フローがシンプルであること
  - タップ数が要件内であること

#### REQ-5002: 誤操作防止の仕組み

- **要件内容**: システムは重要な操作（緊急ボタン、全消去など）に誤操作防止の仕組みを設けなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 6-1で明確）
- **受け入れ基準**:
  - 定型文削除時に確認ダイアログが表示される
  - ダイアログで「いいえ」を選択すると削除がキャンセルされる
- **E2Eテストでの確認ポイント**:
  - 削除時の確認ダイアログが正しく動作すること

### 3. 信頼性要件

#### NFR-301: 重大エラーでも基本機能を継続利用可能

- **要件内容**: システムは重大なエラーが発生しても、基本機能（文字盤+読み上げ）を継続して利用可能に保たなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 6-4で明確）
- **受け入れ基準**:
  - 定型文読み込みエラーが発生しても、アプリは継続動作する
  - 空の定型文一覧でもエラーにならない
  - データ破損時もアプリがクラッシュしない
- **E2Eテストでの確認ポイント**:
  - 異常系テストでアプリがクラッシュしないこと

#### REQ-5003: データ永続化機構

- **要件内容**: システムはアプリが強制終了しても定型文・設定・履歴を失わない永続化機構を実装しなければならない
- **信頼性レベル**: 🔵 青信号（mvp-requirements-original.md 6-4で明確）
- **受け入れ基準**:
  - 定型文の追加・編集・削除がローカルストレージ（Hive）に保存される
  - アプリ再起動後も定型文が保持される
  - お気に入りフラグやカテゴリ設定も永続化される
- **E2Eテストでの確認ポイント**:
  - アプリ再起動後も定型文が保持されること

---

## 境界値・エッジケースの詳細

### 1. 定型文0件の状態

- **エッジケース**: 定型文が1件も登録されていない状態
- **信頼性レベル**: 🟡 黄信号（妥当な推測）
- **期待される動作**:
  - 定型文一覧画面に「定型文がありません」というメッセージが表示される
  - 追加ボタンは表示され、新規作成が可能
  - エラーやクラッシュが発生しない
- **E2Eテストでの確認ポイント**:
  - 空メッセージが表示されること
  - 追加ボタンから新規作成できること

### 2. 定型文100件の表示パフォーマンス

- **境界値**: 100件の定型文を表示
- **信頼性レベル**: 🟡 黄信号（NFR-004から推測）
- **期待される動作**:
  - 100件の定型文が1秒以内に表示される
  - スクロールが滑らかで遅延がない
  - タップ操作が正常に機能する
- **E2Eテストでの確認ポイント**:
  - 1秒以内に表示完了すること
  - スクロール操作が滑らかであること

### 3. 定型文500文字制限

- **境界値**: 定型文の最大文字数
- **信頼性レベル**: 🟡 黄信号（EDGE-102から推測）
- **期待される動作**:
  - 500文字までは正常に保存できる
  - 501文字目以降は入力されない
  - 制限に達した際に警告が表示される
- **E2Eテストでの確認ポイント**:
  - 500文字まで入力・保存できること
  - 501文字目が制限されること

### 4. カテゴリが空の場合

- **エッジケース**: 特定のカテゴリに定型文が0件
- **信頼性レベル**: 🟡 黄信号（EDGE-204から推測）
- **期待される動作**:
  - カテゴリを非表示にする、または「このカテゴリには定型文がありません」と表示
  - エラーやクラッシュが発生しない
- **E2Eテストでの確認ポイント**:
  - 空カテゴリが適切に処理されること

---

## テスト対象範囲

### 含まれる機能（スコープ内）

1. **定型文表示機能**:
   - 定型文一覧表示
   - お気に入り優先表示
   - カテゴリ分類表示
   - 初期データ（50-100件）の表示

2. **定型文選択・読み上げ機能**:
   - 定型文タップで入力欄に反映
   - 定型文タップで即座読み上げ
   - 読み上げ中の停止

3. **定型文CRUD操作**:
   - 新規定型文の追加
   - 定型文の編集
   - 定型文の削除（確認ダイアログ付き）
   - お気に入りフラグの切り替え
   - カテゴリの変更

4. **パフォーマンス**:
   - 定型文100件表示1秒以内
   - 定型文即座読み上げ1秒以内

5. **境界値・異常系**:
   - 定型文0件の状態
   - 定型文100件の表示
   - 定型文500文字制限
   - カテゴリが空の場合
   - 削除のキャンセル

### 含まれない機能（スコープ外）

1. **定型文のエクスポート/インポート機能**: MVP範囲外（REQ-4004）
2. **カテゴリ順序のカスタマイズ**: オプション要件（REQ-4001）
3. **お気に入りの並び順変更詳細**: 別タスク（TASK-0085）で詳細テスト
4. **AI変換との連携**: 別タスクでテスト
5. **履歴との連携詳細**: 別タスク（TASK-0085）で詳細テスト

---

## 受け入れ基準

### 機能正常性

- [ ] TC-E2E-083-001: 定型文一覧が正しく表示される ✅
- [ ] TC-E2E-083-002: お気に入り定型文が一覧上部に表示される ✅
- [ ] TC-E2E-083-003: カテゴリごとに定型文が分類表示される ✅
- [ ] TC-E2E-083-004: 初期データとして50件以上の定型文が表示される ✅
- [ ] TC-E2E-083-005: 定型文タップで即座に読み上げが開始される ✅
- [ ] TC-E2E-083-006: 定型文タップで入力欄に反映される ✅
- [ ] TC-E2E-083-007: 新規定型文を追加できる ✅
- [ ] TC-E2E-083-008: 定型文を編集できる ✅
- [ ] TC-E2E-083-009: 定型文を削除できる（確認ダイアログ付き） ✅
- [ ] TC-E2E-083-010: お気に入りフラグを切り替えられる ✅

### 異常系・エラーハンドリング

- [ ] TC-E2E-083-011: 定型文0件の状態で適切なメッセージが表示される ✅
- [ ] TC-E2E-083-012: 削除確認ダイアログでキャンセルすると削除されない ✅
- [ ] TC-E2E-083-013: カテゴリが空の場合でも安全に処理される ✅

### 境界値

- [ ] TC-E2E-083-014: 定型文500文字まで保存できる ✅
- [ ] TC-E2E-083-015: 定型文501文字目が制限される ✅

### パフォーマンス

- [ ] TC-E2E-083-016: 定型文100件表示が1秒以内 ✅
- [ ] TC-E2E-083-017: 定型文即座読み上げが1秒以内 ✅

### データ永続化

- [ ] TC-E2E-083-018: アプリ再起動後も定型文が保持される ✅
- [ ] TC-E2E-083-019: お気に入り設定がアプリ再起動後も保持される ✅

### 統合テスト

- [ ] TC-E2E-083-020: 定型文追加→お気に入り登録→即座読み上げの一連フローが正常動作 ✅

---

## 技術的実装方針

### テストフレームワーク

- **使用パッケージ**: `integration_test`（Flutter公式E2Eテストフレームワーク）
- **テスト実行環境**: Chrome（Web）、iOS/Androidエミュレータ/実機
- **選択理由**: Flutter公式で推奨、ウィジェットテストの拡張としてE2Eテストが可能

### パフォーマンス計測

- **計測方法**: Dartの`Stopwatch`クラスを使用
- **計測ポイント**:
  - 画面遷移から定型文一覧表示完了までの時間
  - 定型文タップからTTS再生開始までの時間
- **合格基準**:
  - 定型文100件表示: 1秒（1000ms）以内
  - 定型文即座読み上げ: 1秒（1000ms）以内

### テストデータ準備

- **初期データ**: 50-100件の定型文サンプル
  - 日常カテゴリ: 「おはようございます」「こんにちは」「ありがとうございます」など
  - 体調カテゴリ: 「少し疲れました」「痛いです」「お水をください」など
  - その他カテゴリ: 「はい」「いいえ」「少し待ってください」など
- **テスト用定型文**: 境界値テスト用の500文字の定型文

### ヘルパー関数の活用

TASK-0081で実装済みのヘルパー関数を活用:

- `pumpApp(tester)`: アプリを初期化してホーム画面を表示
- `navigateTo(tester, screenName)`: 指定画面に遷移
- `tapButton(tester, buttonLabel)`: ボタンをタップ
- `measurePerformance(name, maxMilliseconds, action)`: パフォーマンス計測

---

## テストケース一覧

詳細なテストケースは別ファイル参照:
- **ファイル**: `testcases.md`
- **テストケース総数**: 20件
  - 正常系: 10件
  - 異常系: 3件
  - 境界値: 2件
  - パフォーマンス: 2件
  - データ永続化: 2件
  - 統合テスト: 1件

---

## 品質基準

### コードカバレッジ

- **目標カバレッジ**: 80%以上（NFR-501）
- **対象範囲**:
  - 定型文表示ロジック
  - 定型文CRUD操作ロジック
  - お気に入り優先表示ロジック
  - カテゴリ分類ロジック
  - ローカルストレージ（Hive）連携

### テスト成功基準

- [ ] すべてのテストケース（20件）がGREENで成功
- [ ] パフォーマンステストがすべて基準値以内
- [ ] 異常系テストでアプリがクラッシュしない
- [ ] データ永続化テストが成功する
- [ ] コードカバレッジが80%以上

---

## 信頼性レベル内訳

### 🔵 青信号（確実な要件）: 11件

- REQ-101: 定型文を一覧表示
- REQ-102: 定型文をタップすると入力欄に反映
- REQ-103: 定型文を直接タップで即座に読み上げ
- REQ-104: 定型文の追加・編集・削除機能
- REQ-105: お気に入り定型文を一覧上部に優先表示
- REQ-106: 定型文をカテゴリで分類
- REQ-107: 初期データとして汎用的な定型文サンプルを提供
- REQ-5002: 誤操作防止の仕組み
- REQ-5003: データ永続化機構
- NFR-301: 重大エラーでも基本機能を継続利用可能
- NFR-004: 定型文一覧の表示（100件程度）を1秒以内

### 🟡 黄信号（妥当な推測）: 9件

- 定型文0件の状態での処理
- 定型文100件の表示パフォーマンス
- 定型文500文字制限（EDGE-102）
- 定型文501文字目の制限動作
- カテゴリが空の場合の処理（EDGE-204）
- 削除のキャンセル処理
- アプリ再起動後のデータ保持
- お気に入り設定の永続化
- 統合フローの安定性

### 🔴 赤信号（推測）: 0件

---

## 開発フロー

### TDDサイクル

1. **RED（失敗テスト作成）**:
   - `/tsumiki:tdd-red`コマンドで実行
   - 20個のテストケースを実装
   - すべてのテストが失敗することを確認

2. **GREEN（テストを通す実装）**:
   - `/tsumiki:tdd-green`コマンドで実行
   - 定型文表示、CRUD、読み上げ機能を実装
   - すべてのテストが成功することを確認

3. **REFACTOR（リファクタリング）**:
   - `/tsumiki:tdd-refactor`コマンドで実行
   - コード品質の向上
   - パフォーマンス最適化

4. **VERIFY（完了検証）**:
   - `/tsumiki:tdd-verify-complete`コマンドで実行
   - すべてのテストが成功
   - カバレッジが80%以上
   - パフォーマンス要件を満たす

---

## 次のステップ

このTDD要件定義書の確認後、次のステップに進んでください:

1. `/tsumiki:tdd-testcases` - テストケース洗い出し（詳細なテストケース作成）
2. `/tsumiki:tdd-red` - REDフェーズ（失敗するテストを作成）
3. `/tsumiki:tdd-green` - GREENフェーズ（テストを通す実装）
4. `/tsumiki:tdd-refactor` - REFACTORフェーズ（リファクタリング）
5. `/tsumiki:tdd-verify-complete` - VERIFY（完了検証）

---

## 関連ドキュメント

- **要件定義書**: `docs/spec/kotonoha-requirements.md`
- **テストケース一覧**: `docs/implements/kotonoha/TASK-0083/testcases.md`
- **E2Eテスト環境構築**: TASK-0081の実装記録
- **技術スタック**: `docs/tech-stack.md`
- **データフロー図**: `docs/design/kotonoha/dataflow.md`（定型文管理フロー参照）
- **Phase 5タスク**: `docs/tasks/kotonoha-phase5.md`

---

## 参考: 定型文データ構造

```dart
// 定型文エンティティ（Hive）
@HiveType(typeId: 1)
class PresetPhrase {
  @HiveField(0)
  final String id; // UUID

  @HiveField(1)
  final String text; // 定型文テキスト（最大500文字）

  @HiveField(2)
  final String category; // カテゴリ（「日常」「体調」「その他」）

  @HiveField(3)
  final bool isFavorite; // お気に入りフラグ

  @HiveField(4)
  final DateTime createdAt; // 作成日時

  @HiveField(5)
  final DateTime? updatedAt; // 更新日時
}
```

---

## 更新履歴

- **2025-11-29**: TDD要件定義書作成
  - 機能要件の詳細化（REQ-101〜REQ-107）
  - 非機能要件の詳細化（NFR-004、NFR-201、NFR-301、REQ-5002、REQ-5003）
  - 境界値・エッジケースの明確化（0件、100件、500文字制限、空カテゴリ）
  - テスト対象範囲の定義
  - 受け入れ基準の設定（20件のテストケース）
  - 信頼性レベル内訳の整理（🔵11件、🟡9件、🔴0件）
