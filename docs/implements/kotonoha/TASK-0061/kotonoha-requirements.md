# TASK-0061: 履歴一覧UI実装 - 要件定義書

## 概要

履歴一覧画面（HistoryScreen）の実装を行います。読み上げまたは表示したテキストを時系列順に表示し、ユーザーが再読み上げや削除などの操作を行える機能を提供します。

## 関連要件

### 機能要件
- **REQ-601**: システムは読み上げまたは表示した文章を自動的に履歴として保存しなければならない 🔵
- **REQ-602**: システムは履歴を最大50件まで保持し、古いものから自動削除しなければならない 🔵
- **REQ-603**: システムは履歴一覧からワンタップで再読み上げ・再表示できる機能を提供しなければならない 🔵
- **REQ-604**: システムは履歴の個別削除および全削除機能を提供しなければならない 🔵

### 非機能要件
- **NFR-004**: システムは定型文一覧の表示（100件程度）を1秒以内に完了しなければならない 🟡
  - 履歴も同様に50件の表示を1秒以内に完了すること

### Edgeケース
- **EDGE-103**: 履歴が0件の状態で履歴画面にアクセスした場合、システムは「履歴がありません」というメッセージを表示しなければならない 🟡

## 機能要件詳細（EARS記法）

### 通常要件（SHALL）

#### 履歴一覧表示機能
- **FR-061-001**: システムは履歴一覧画面にすべての履歴を時系列順（新しい順）に表示しなければならない 🔵
  - **根拠**: REQ-601, REQ-602、dataflow.mdの履歴管理フロー

- **FR-061-002**: システムは各履歴項目に以下の情報を表示しなければならない 🔵
  - 読み上げ・表示したテキスト内容
  - 作成日時（「MM/DD HH:mm」形式）
  - 履歴の種類（文字盤入力/定型文/AI変換結果/大ボタン）
  - **根拠**: REQ-601、interfaces.dartのHistoryエンティティ

- **FR-061-003**: システムは履歴項目を視認性の高いカード形式で表示しなければならない 🔵
  - タップ領域：最小44px × 44px、推奨60px以上
  - 各カード間に適切な余白を設ける
  - **根拠**: NFR-202（タップ領域の推奨サイズ）

#### 空状態の表示
- **FR-061-004**: 履歴が0件の場合、システムは「履歴がありません」というメッセージを画面中央に表示しなければならない 🔵
  - **根拠**: EDGE-103

#### スクロール機能
- **FR-061-005**: システムは履歴一覧をスクロール可能なリスト（ListView）として実装しなければならない 🔵
  - 50件の履歴を滑らかにスクロール可能
  - **根拠**: REQ-602（最大50件保持）

#### 再読み上げ機能
- **FR-061-006**: システムは履歴項目をタップすると、その内容を即座に読み上げる機能を提供しなければならない 🔵
  - TTS読み上げ開始まで1秒以内
  - **根拠**: REQ-603、NFR-001

#### 履歴削除機能
- **FR-061-007**: システムは各履歴項目に削除ボタンを表示しなければならない 🔵
  - スワイプまたは長押しで削除オプションを表示
  - **根拠**: REQ-604

- **FR-061-008**: システムは履歴項目の削除時に確認ダイアログを表示しなければならない 🟡
  - 誤操作防止のため
  - **根拠**: REQ-5002（重要な操作に誤操作防止の仕組み）

- **FR-061-009**: システムは履歴一覧画面に「全削除」ボタンを提供しなければならない 🔵
  - AppBarのアクションボタンとして配置
  - **根拠**: REQ-604

- **FR-061-010**: システムは全削除実行時に確認ダイアログを表示しなければならない 🔵
  - 「すべての履歴を削除しますか？」メッセージ
  - **根拠**: REQ-2001（全消去時の確認ダイアログ）、REQ-5002

### 条件付き要件（WHEN/IF-THEN）

- **FR-061-011**: ユーザーが履歴項目をタップした場合、システムは即座にTTS読み上げを開始しなければならない 🔵
  - 読み上げ中は「停止」ボタンを表示
  - **根拠**: REQ-603、REQ-3003

- **FR-061-012**: ユーザーが削除ボタンをタップした場合、システムは確認ダイアログを表示し、「はい」選択時のみ削除を実行しなければならない 🟡
  - **根拠**: REQ-2001、REQ-5002

- **FR-061-013**: ユーザーが「全削除」ボタンをタップした場合、システムは確認ダイアログを表示し、「はい」選択時のみ全削除を実行しなければならない 🔵
  - **根拠**: REQ-2001、REQ-5002

### 状態要件（WHERE）

- **FR-061-014**: 履歴が0件の状態にある場合、システムは空状態メッセージを表示し、削除ボタンを非表示にしなければならない 🟡
  - **根拠**: EDGE-103、EDGE-104パターン

- **FR-061-015**: 読み上げが実行中の状態にある場合、システムは該当履歴項目に「読み上げ中」インジケーターを表示しなければならない 🟡
  - **根拠**: REQ-3003

## 非機能要件

### パフォーマンス要件

- **NFR-061-001**: システムは50件の履歴を1秒以内に表示しなければならない 🔵
  - 初回ロード時
  - **根拠**: NFR-004（定型文一覧の表示パフォーマンス）

- **NFR-061-002**: システムは履歴項目のタップから読み上げ開始まで1秒以内に完了しなければならない 🔵
  - **根拠**: NFR-001（TTS読み上げ開始時間）

- **NFR-061-003**: システムは履歴項目の削除操作を即座に（100ms以内）UI上で反映しなければならない 🟡
  - **根拠**: NFR-003（文字盤タップの応答時間パターン）

### ユーザビリティ要件

- **NFR-061-004**: システムは履歴項目のタップターゲットを最低44px × 44px、推奨60px以上のサイズで実装しなければならない 🔵
  - **根拠**: REQ-5001、NFR-202

- **NFR-061-005**: システムは履歴項目の日時表示を読みやすい形式（「MM/DD HH:mm」）で表示しなければならない 🟡
  - 例: 「11/28 14:30」
  - **根拠**: NFR-201（主要操作を3タップ以内）、NFR-204

- **NFR-061-006**: システムはフォントサイズ設定（小/中/大）に応じて履歴項目のテキストサイズを調整しなければならない 🔵
  - **根拠**: REQ-801、REQ-802

- **NFR-061-007**: システムは選択されたテーマ（ライト/ダーク/高コントラスト）に応じて履歴項目の配色を調整しなければならない 🔵
  - **根拠**: REQ-803、REQ-5006

### アクセシビリティ要件

- **NFR-061-008**: システムは履歴項目の種類を視覚的に区別できるアイコンを表示しなければならない 🟡
  - 文字盤入力: キーボードアイコン
  - 定型文: リストアイコン
  - AI変換結果: AIアイコン
  - 大ボタン: ボタンアイコン
  - **根拠**: REQ-803（テーマ設定）、アクセシビリティ配慮

- **NFR-061-009**: システムは高コントラストモードで履歴項目の視認性を確保しなければならない 🔵
  - コントラスト比4.5:1以上
  - **根拠**: REQ-5006、REQ-803

## Edgeケース・境界値

### エラー処理

- **EDGE-061-001**: 履歴読み込みエラー時、システムはエラーメッセージを表示し、再試行オプションを提供しなければならない 🟡
  - 「履歴の読み込みに失敗しました」メッセージ
  - **根拠**: NFR-204（エラーメッセージの表示）

- **EDGE-061-002**: TTS読み上げエラー時、システムはエラー通知を表示し、履歴項目は選択状態のままにしなければならない 🟡
  - **根拠**: EDGE-004（TTS音声再生エラー）

- **EDGE-061-003**: 履歴削除エラー時、システムはエラーメッセージを表示し、削除を中止しなければならない 🟡
  - 「削除に失敗しました」メッセージ
  - **根拠**: NFR-204、NFR-304

### 境界値

- **EDGE-061-004**: 履歴が0件の場合、システムは「履歴がありません」メッセージと使い方のヒントを表示しなければならない 🔵
  - **根拠**: EDGE-103

- **EDGE-061-005**: 履歴が50件（上限）の場合、システムは「履歴が上限に達しています」という通知を表示してもよい 🔴
  - 新しい履歴追加時に古いものが自動削除されることを示唆
  - **根拠**: REQ-602、REQ-3002

- **EDGE-061-006**: 履歴項目の内容が非常に長い場合（1000文字）、システムは最初の100文字程度を表示し、「...」で省略しなければならない 🟡
  - タップで全文表示または読み上げ
  - **根拠**: EDGE-101（入力欄の文字数制限）

### 異常系・特殊ケース

- **EDGE-061-007**: アプリがバックグラウンドから復帰した場合、システムは履歴一覧の状態を復元しなければならない 🟡
  - スクロール位置の保持
  - **根拠**: EDGE-201

- **EDGE-061-008**: 読み上げ中に別の履歴項目をタップした場合、システムは現在の読み上げを停止し、新しい項目の読み上げを開始しなければならない 🟡
  - **根拠**: REQ-403（読み上げの停止・中断機能）

- **EDGE-061-009**: OSの音量が0（ミュート）の状態で履歴項目をタップした場合、システムは「音量が0です」という視覚的警告を表示しなければならない 🟡
  - **根拠**: EDGE-202

## 受け入れ基準（Acceptance Criteria）

### 必須受け入れ基準 🔵

#### AC-061-001: 履歴一覧表示
- **GIVEN**: 履歴が5件存在する状態
- **WHEN**: 履歴画面を開く
- **THEN**:
  - すべての履歴が新しい順に表示される
  - 各履歴に日時、内容、種類が表示される
  - スクロールが可能である
  - 1秒以内に表示が完了する

#### AC-061-002: 空状態の表示
- **GIVEN**: 履歴が0件の状態
- **WHEN**: 履歴画面を開く
- **THEN**:
  - 「履歴がありません」メッセージが表示される
  - 削除ボタンが非表示になる

#### AC-061-003: 再読み上げ機能
- **GIVEN**: 履歴一覧が表示されている状態
- **WHEN**: 任意の履歴項目をタップする
- **THEN**:
  - 該当テキストがTTSで読み上げられる
  - 読み上げ開始まで1秒以内である
  - 読み上げ中は「読み上げ中」インジケーターが表示される

#### AC-061-004: 個別削除機能
- **GIVEN**: 履歴一覧が表示されている状態
- **WHEN**: 履歴項目の削除ボタンをタップし、確認ダイアログで「はい」を選択する
- **THEN**:
  - 確認ダイアログが表示される
  - 「はい」選択後、該当履歴が削除される
  - 削除後、一覧が即座に更新される

#### AC-061-005: 全削除機能
- **GIVEN**: 履歴が複数件存在する状態
- **WHEN**: 「全削除」ボタンをタップし、確認ダイアログで「はい」を選択する
- **THEN**:
  - 「すべての履歴を削除しますか？」ダイアログが表示される
  - 「はい」選択後、すべての履歴が削除される
  - 空状態メッセージが表示される

#### AC-061-006: パフォーマンス
- **GIVEN**: 履歴が50件存在する状態
- **WHEN**: 履歴画面を開く
- **THEN**:
  - 1秒以内にすべての履歴が表示される
  - スクロールが滑らかである

#### AC-061-007: アクセシビリティ
- **GIVEN**: フォントサイズが「大」に設定されている状態
- **WHEN**: 履歴画面を開く
- **THEN**:
  - すべてのテキストが大きく表示される
  - タップ領域が推奨サイズ（60px以上）である

#### AC-061-008: テーマ対応
- **GIVEN**: 高コントラストモードが有効な状態
- **WHEN**: 履歴画面を開く
- **THEN**:
  - すべての要素が高コントラスト配色で表示される
  - コントラスト比が4.5:1以上である

### オプション受け入れ基準 🟡

#### AC-061-009: エラーハンドリング
- **GIVEN**: TTS機能がエラーを起こす状態
- **WHEN**: 履歴項目をタップする
- **THEN**:
  - エラーメッセージが表示される
  - アプリがクラッシュしない

#### AC-061-010: 長文表示
- **GIVEN**: 500文字の長い履歴が存在する状態
- **WHEN**: 履歴画面を開く
- **THEN**:
  - 最初の100文字程度が表示され、「...」で省略される
  - タップすると全文が読み上げられる

## 技術実装要件

### 使用技術
- **Flutter**: 3.38.1
- **状態管理**: Riverpod 2.x
- **データモデル**: 既存の`History`エンティティ（`features/history/domain/models/history.dart`）
- **状態管理**: 既存の`HistoryProvider`（`features/history/providers/history_provider.dart`）

### 実装パターン
- **画面構成**: StatelessWidget + ConsumerWidget
- **リスト表示**: ListView.builder（パフォーマンス最適化）
- **空状態**: 条件分岐で空状態ウィジェット表示
- **削除確認**: showDialog（AlertDialog）

### ファイル構成
```
frontend/kotonoha_app/lib/features/history/
├── domain/
│   └── models/
│       ├── history.dart              # 既存
│       └── history_type.dart         # 既存
├── providers/
│   └── history_provider.dart         # 既存（必要に応じて拡張）
└── presentation/
    ├── history_screen.dart           # 更新対象
    └── widgets/
        ├── history_item_card.dart    # 新規作成
        └── empty_history_widget.dart # 新規作成
```

### コーディング規約
- Null Safety有効
- `const`コンストラクタを可能な限り使用
- ウィジェットは`key`パラメータを持つ
- コメントにタスクID（TASK-0061）、信頼性レベル（🔵/🟡/🔴）を記載

## 依存関係

### 先行タスク（完了済み）
- TASK-0015: go_routerナビゲーション設定・ルーティング実装（履歴画面ルート）
- TASK-0048: TTS読み上げ機能実装（OS標準TTS統合）
- TASK-0059: 履歴保存・読み込み実装（Hive統合）

### 後続タスク
- TASK-0062: 履歴からお気に入り登録機能
- TASK-0063: 履歴の詳細表示・編集機能（オプション）

## テスト要件

### 単体テスト
- 履歴項目ウィジェットの表示テスト
- 空状態ウィジェットの表示テスト
- 日時フォーマットのテスト

### ウィジェットテスト
- 履歴一覧の表示テスト（5件、50件）
- 空状態の表示テスト（0件）
- タップイベントのテスト（再読み上げ）
- 削除ボタンのテスト（個別削除、全削除）
- 確認ダイアログの表示・動作テスト

### 統合テスト
- 履歴画面への遷移テスト
- 履歴の読み込みテスト（Hive連携）
- TTS読み上げ連携テスト
- パフォーマンステスト（50件表示で1秒以内）

### テストカバレッジ目標
- 全体: 80%以上
- ビジネスロジック: 90%以上

## 信頼性レベルサマリー

- 🔵 **青信号**（確実な要件）: FR-061-001〜014、NFR-061-001〜009、AC-061-001〜008
  - 要件定義書（REQ-601〜604）、設計文書（dataflow.md、interfaces.dart）に基づく
- 🟡 **黄信号**（妥当な推測）: FR-061-008、FR-061-012〜015、EDGE-061-001〜009
  - 要件定義書から推測される誤操作防止、エラーハンドリング
- 🔴 **赤信号**（完全な推測）: EDGE-061-005
  - 履歴上限通知は要件定義書に明記なし

## 参考資料

- 要件定義書: `/Volumes/external/dev/kotonoha/docs/spec/kotonoha-requirements.md`
- データフロー図: `/Volumes/external/dev/kotonoha/docs/design/kotonoha/dataflow.md`
- インターフェース定義: `/Volumes/external/dev/kotonoha/docs/design/kotonoha/interfaces.dart`
- 既存実装:
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/history/domain/models/history.dart`
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/history/providers/history_provider.dart`
  - `/Volumes/external/dev/kotonoha/frontend/kotonoha_app/lib/features/history/presentation/history_screen.dart`
