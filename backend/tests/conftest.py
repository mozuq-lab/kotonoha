"""
pytestãƒ†ã‚¹ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®šç¾©ã™ã‚‹ã€‚

ã€å®Ÿè£…æ–¹é‡ã€‘: pytest-asyncio 0.25.x ã®æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã„ã€å„ãƒ†ã‚¹ãƒˆã§ç‹¬ç«‹ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨
ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ†é›¢ã—ã€ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã‚’é˜²æ­¢
ğŸ”µ ã“ã®å®Ÿè£…ã¯è¦ä»¶å®šç¾©æ›¸ï¼ˆline 67-75ï¼‰ã¨pytest-asyncioå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«åŸºã¥ã
"""

import os
from collections.abc import AsyncGenerator

import pytest
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine

# ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šURLã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
# ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: æœ¬ç•ªç’°å¢ƒã¨ã¯ç•°ãªã‚‹ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿ã®åˆ†é›¢ã‚’ä¿è¨¼
# ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®èª¤æ¥ç¶šã‚’é˜²ããŸã‚ã€æ˜ç¤ºçš„ã«ãƒ†ã‚¹ãƒˆDB URLã‚’æŒ‡å®š
# ğŸ”µ NFR-105ï¼ˆç’°å¢ƒå¤‰æ•°ã‚’ã‚¢ãƒ—ãƒªå†…ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã›ãšã€å®‰å…¨ã«ç®¡ç†ï¼‰ã«åŸºã¥ã
TEST_DATABASE_URL = os.getenv(
    "TEST_DATABASE_URL",
    "postgresql+asyncpg://kotonoha_user:your_secure_password_here@localhost:5432/kotonoha_test"
)


@pytest.fixture(scope="function")
async def test_engine():
    """
    ãƒ†ã‚¹ãƒˆç”¨ã®éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆï¼ˆå„ãƒ†ã‚¹ãƒˆé–¢æ•°ã”ã¨ã«ä½œæˆï¼‰

    ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã‚¨ãƒ³ã‚¸ãƒ³ã‚’æä¾›
    ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: SQLAlchemy 2.x ã®éåŒæœŸã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã®åŸºç›¤ã‚’æä¾›
    ã€å®Ÿè£…æ–¹é‡ã€‘: å„ãƒ†ã‚¹ãƒˆã”ã¨ã«ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆãƒ»ç ´æ£„ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—å•é¡Œã‚’å›é¿
    ğŸ”µ ã“ã®å†…å®¹ã¯è¦ä»¶å®šç¾©æ›¸ï¼ˆline 67-75ï¼‰ã«åŸºã¥ã

    Yields:
        AsyncEngine: ãƒ†ã‚¹ãƒˆç”¨ã®éåŒæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ³ã‚¸ãƒ³
    """
    # ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½œæˆ
    # ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: echo=False ã§SQLå‡ºåŠ›ã‚’æŠ‘åˆ¶ï¼ˆå¿…è¦ã«å¿œã˜ã¦Trueã«å¤‰æ›´å¯èƒ½ï¼‰
    # ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã€‘: pool_size=5 ã§æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚’åˆ¶é™ï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯å°‘æ•°ã§ååˆ†ï¼‰
    engine = create_async_engine(
        TEST_DATABASE_URL,
        echo=False,
        pool_pre_ping=True,  # ã€æ¥ç¶šå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã€‘: æ¥ç¶šã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä½¿ç”¨
        pool_size=5,  # ã€æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚ºã€‘: ãƒ†ã‚¹ãƒˆç”¨ã«å°ã•ã‚ã«è¨­å®š
        max_overflow=5,  # ã€è¿½åŠ æ¥ç¶šæ•°ã€‘: å¿…è¦ã«å¿œã˜ã¦è¿½åŠ æ¥ç¶šã‚’è¨±å¯
    )

    yield engine

    # ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ã‚¨ãƒ³ã‚¸ãƒ³ã¨ã™ã¹ã¦ã®æ¥ç¶šã‚’é©åˆ‡ã«ã‚¯ãƒ­ãƒ¼ã‚º
    # ã€ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯é˜²æ­¢ã€‘: ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚¯ãƒ­ãƒ¼ã‚ºå‰ã«æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    # ğŸ”µ SQLAlchemy 2.x ã®æ¨å¥¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ‰‹é †
    await engine.dispose()


@pytest.fixture(scope="function")
async def test_session_maker(test_engine):
    """
    ãƒ†ã‚¹ãƒˆç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ

    ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ä½¿ç”¨ã™ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¯ãƒˆãƒªã‚’æä¾›
    ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: async_sessionmakerã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç”Ÿæˆã‚’å¯èƒ½ã«ã™ã‚‹
    ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã§ãã‚‹
    ã€å®Ÿè£…æ–¹é‡ã€‘: test_engineã«ä¾å­˜ã—ã€ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã¨åŒæœŸ
    ğŸ”µ ã“ã®å†…å®¹ã¯è¦ä»¶å®šç¾©æ›¸ï¼ˆline 67-75ï¼‰ã«åŸºã¥ã

    Returns:
        async_sessionmaker: ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆãƒ•ã‚¡ã‚¯ãƒˆãƒª
    """
    # ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
    # ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: expire_on_commit=False ã§ã‚³ãƒŸãƒƒãƒˆå¾Œã‚‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    session_maker = async_sessionmaker(
        bind=test_engine,
        class_=AsyncSession,
        expire_on_commit=False,
        autocommit=False,
        autoflush=False,
    )
    return session_maker


@pytest.fixture(scope="function")
async def db_session(test_session_maker) -> AsyncGenerator[AsyncSession, None]:
    """
    å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ

    ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æä¾›
    ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: ãƒ†ã‚¹ãƒˆé–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã‚’ä¿è¨¼ã—ã€å„ãƒ†ã‚¹ãƒˆãŒç‹¬ç«‹ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹
    ã€å®Ÿè£…æ–¹é‡ã€‘: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    ğŸ”µ ã“ã®å†…å®¹ã¯è¦ä»¶å®šç¾©æ›¸ï¼ˆline 180-188ï¼‰ã«åŸºã¥ã

    Yields:
        AsyncSession: ãƒ†ã‚¹ãƒˆç”¨ã®éåŒæœŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
    """
    # ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    # ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¯ãƒªãƒ¼ãƒ³ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æä¾›
    async with test_session_maker() as session:
        yield session
        # ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
        # ã€çŠ¶æ…‹å¾©å…ƒã€‘: ãƒ†ã‚¹ãƒˆã§ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ç ´æ£„ã—ã€æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
        await session.rollback()
        # ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒ­ãƒ¼ã‚ºã€‘: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ˜ç¤ºçš„ã«ã‚¯ãƒ­ãƒ¼ã‚º
        await session.close()


@pytest.fixture(scope="function")
async def test_client_with_db(test_engine, test_session_maker):
    """
    ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹FastAPIãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ

    ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›
    ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: get_dbä¾å­˜æ€§ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã€ãƒ†ã‚¹ãƒˆç”¨DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
    ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: APIå‘¼ã³å‡ºã—ãŒãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹
    ã€å®Ÿè£…æ–¹é‡ã€‘: FastAPIã®ä¾å­˜æ€§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ç”¨
    ğŸ”µ FastAPIå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã

    Yields:
        FastAPI: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    """
    from app.main import app
    from app.db.session import get_db

    # ã€ä¾å­˜æ€§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰é–¢æ•°ã€‘: ãƒ†ã‚¹ãƒˆç”¨DBã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿”ã™
    async def override_get_db() -> AsyncGenerator[AsyncSession, None]:
        """ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æä¾›"""
        async with test_session_maker() as session:
            try:
                yield session
            finally:
                await session.close()

    # ã€ä¾å­˜æ€§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã€‘: æœ¬ç•ªDBã®ä»£ã‚ã‚Šã«ãƒ†ã‚¹ãƒˆç”¨DBã‚’ä½¿ç”¨
    app.dependency_overrides[get_db] = override_get_db

    yield app

    # ã€ãƒ†ã‚¹ãƒˆå¾Œå‡¦ç†ã€‘: ä¾å­˜æ€§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    app.dependency_overrides.clear()
